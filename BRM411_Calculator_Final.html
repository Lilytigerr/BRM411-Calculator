<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRM411 è¨ªè¦–è¨ˆç®—å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4a5fc1 0%, #5e4b9f 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .header .subtitle {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .clear-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .clear-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .input-section {
            padding: 25px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #4a5fc1;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        select, input[type="date"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            transition: all 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .validation-msg {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .validation-msg.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #dc2626;
        }
        
        .validation-msg.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .v1a-input {
            margin-top: 15px;
            padding: 15px;
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 10px;
        }
        
        .v1a-label {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .suggestion-box {
            background: white;
            border: 2px solid #fde68a;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .suggestion-label {
            font-weight: 600;
            color: #78350f;
            margin-bottom: 5px;
        }
        
        .suggestion-value {
            color: #92400e;
            line-height: 1.6;
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #4f46e5;
            color: white;
        }
        
        .btn-primary:hover {
            background: #4338ca;
        }
        
        /* æ—¥æœŸé¸æ“‡æŒ‰éˆ• */
        .date-selector {
            margin-top: 12px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .date-selector-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .date-options {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .date-option {
            flex: 1;
            min-width: 60px;
            padding: 8px 6px;
            font-size: 11px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .date-option:hover:not(.disabled) {
            border-color: #4f46e5;
            background: #eef2ff;
        }
        
        .date-option.selected {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
            font-weight: 600;
        }
        
        .date-option.disabled {
            background: #f3f4f6;
            color: #9ca3af;
            border-color: #e5e7eb;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .date-option.conflict {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fca5a5;
        }
        
        .date-option-date {
            display: block;
            font-weight: 600;
        }
        
        .date-option-label {
            display: block;
            font-size: 10px;
            margin-top: 2px;
        }
        
        .results {
            padding: 20px;
        }
        
        .results-title {
            font-size: 18px;
            font-weight: 600;
            color: #4a5fc1;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .visit-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }
        
        .visit-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .visit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .visit-name {
            font-weight: 600;
            font-size: 17px;
            color: #1f2937;
        }
        
        .badge {
            font-size: 11px;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .badge-screening {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-baseline {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-treatment {
            background: #dcfce7;
            color: #166534;
        }
        
        .badge-followup {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .visit-info {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.7;
            margin-bottom: 10px;
        }
        
        .visit-date {
            background: #f0f4ff;
            color: #667eea;
            padding: 10px 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 15px;
        }
        
        .warning {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            border-left: 4px solid;
            font-size: 13px;
            font-weight: 600;
        }
        
        .warning.weekend {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }
        
        .warning.holiday {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .empty {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .notes {
            background: #fffbeb;
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            border-left: 4px solid #fbbf24;
        }
        
        .notes-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 12px;
            font-size: 15px;
        }
        
        .notes ul {
            margin-left: 20px;
            font-size: 13px;
            color: #78350f;
            line-height: 1.9;
        }
        
        .notes li strong {
            color: #92400e;
        }
        
        /* æ‰‹æ©Ÿç‰ˆé¢å„ªåŒ– */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            .container {
                padding: 10px;
                max-width: 100%;
            }
            
            .header {
                padding: 18px 12px;
                position: relative;
            }
            
            .header h1 {
                font-size: 18px;
                margin-bottom: 6px;
                padding-right: 70px; /* ç»™æ¸…ç©ºæŒ‰é’®ç•™ç©ºé—´ */
            }
            
            .header .subtitle {
                font-size: 11px;
                line-height: 1.4;
            }
            
            .clear-btn {
                position: absolute;
                top: 12px;
                right: 12px;
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .form-group {
                margin-bottom: 16px;
            }
            
            .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
                display: block;
            }
            
            .form-group select,
            .form-group input[type="date"] {
                font-size: 14px;
                padding: 12px;
                width: 100%;
                box-sizing: border-box;
            }
            
            /* æŒ‰éˆ•çµ„ - å‚ç›´æ’åˆ— */
            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-top: 12px;
            }
            
            .btn-group button {
                width: 100%;
                font-size: 13px;
                padding: 12px 16px;
                white-space: normal;
                text-align: center;
                line-height: 1.4;
                min-height: 48px; /* å¢åŠ æœ€å°é«˜åº¦ï¼Œæ›´å®¹æ˜“é»æ“Š */
                word-wrap: break-word;
                box-sizing: border-box;
            }
            
            /* å»ºè­°æ¡†å„ªåŒ– */
            .suggestion-box {
                padding: 12px;
                font-size: 12px;
                margin-top: 12px;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .suggestion-label {
                font-size: 13px;
                margin-bottom: 8px;
                font-weight: 600;
            }
            
            .suggestion-value {
                font-size: 12px;
                line-height: 1.6;
            }
            
            .v1a-label {
                font-size: 13px;
                margin-bottom: 8px;
                display: block;
                font-weight: 600;
            }
            
            /* V1a è¼¸å…¥æ¡†å„ªåŒ– */
            #v1aInput {
                font-size: 14px !important;
                padding: 12px !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* è¨ªè¦–å¡ç‰‡å„ªåŒ– */
            .visit-card {
                padding: 14px;
                margin-bottom: 12px;
            }
            
            .visit-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .visit-name {
                font-size: 15px;
            }
            
            .visit-date {
                font-size: 18px;
                margin: 10px 0;
            }
            
            .visit-info {
                font-size: 12px;
                line-height: 1.6;
            }
            
            .badge {
                font-size: 10px;
                padding: 4px 10px;
            }
            
            /* è­¦å‘Šè¨Šæ¯å„ªåŒ– */
            .warning {
                font-size: 12px;
                padding: 10px 12px;
                margin-top: 8px;
                line-height: 1.5;
            }
            
            .validation-msg {
                font-size: 12px;
                padding: 10px 12px;
                line-height: 1.5;
            }
            
            /* ä½¿ç”¨èªªæ˜å„ªåŒ– */
            .notes {
                padding: 14px;
                margin-top: 16px;
            }
            
            .notes-title {
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .notes ul {
                font-size: 12px;
                margin-left: 20px;
                line-height: 1.8;
            }
            
            .notes li {
                margin-bottom: 8px;
            }
            
            .empty {
                font-size: 13px;
                padding: 30px 16px;
            }
            
            /* æ—¥æœŸé¸æ“‡å™¨æ‰‹æ©Ÿå„ªåŒ– */
            .date-selector {
                padding: 8px;
            }
            
            .date-selector-label {
                font-size: 11px;
            }
            
            .date-options {
                flex-direction: column;
                gap: 8px;
            }
            
            .date-option {
                min-width: 100%;
                padding: 10px 8px;
                font-size: 12px;
            }
            
            .date-option-date {
                font-size: 13px;
            }
            
            .date-option-label {
                font-size: 10px;
            }
            
            /* æ™ºèƒ½åŠ©æ‰‹æŒ‰éˆ•æ‰‹æ©Ÿå„ªåŒ– */
            button[onclick="autoAvoidHolidays()"] {
                width: 90% !important;
                padding: 14px 20px !important;
                font-size: 15px !important;
            }
            
            /* ç¢ºä¿æ‰€æœ‰ inline style çš„å…ƒç´ ä¹ŸéŸ¿æ‡‰ */
            div[style*="display: flex"] {
                flex-wrap: wrap;
            }
        }
        
        /* è¶…å°å±å¹•å„ªåŒ– (iPhone SE ç­‰) */
        @media (max-width: 375px) {
            .container {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .form-group select,
            .form-group input[type="date"] {
                font-size: 13px;
                padding: 10px;
            }
            
            .btn-group button {
                font-size: 12px;
                padding: 10px 14px;
                min-height: 44px;
            }
            
            .suggestion-box {
                padding: 10px;
                font-size: 11px;
            }
            
            .visit-card {
                padding: 12px;
            }
            
            .date-option {
                padding: 8px 6px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="clear-btn" onclick="clearAll()">ğŸ”„ æ¸…ç©ºé‡è¨­</button>
            <h1>BRM411 è¨ªè¦–è¨ˆç®—å™¨</h1>
            <p class="subtitle">è‡¨åºŠè©¦é©—è¨ªè¦–æ—¥æœŸè¦åŠƒå·¥å…·</p>
        </div>
        
        <div class="input-section">
            <div class="form-group">
                <label>å—è©¦è€…é¡å‹</label>
                <select id="subjectType" onchange="toggleDrugSelection(); validateDates()">
                    <option value="">-- è«‹é¸æ“‡ --</option>
                    <option value="naive">Naive (æœªç”¨è—¥å—è©¦è€…)</option>
                    <option value="washout">Washout (æ´—é™¤æœŸå—è©¦è€…)</option>
                </select>
            </div>
            
            <div class="form-group" id="drugTypeGroup" style="display: none;">
                <label>éœ€æ´—é™¤çš„è—¥ç‰©é¡å‹</label>
                <select id="drugType" onchange="visit1aDate=''; calculateV2Suggestion(); validateDates()">
                    <option value="">-- è«‹é¸æ“‡è—¥ç‰©é¡å‹ --</option>
                    <option value="28">Prostaglandins / Î²-blockers / Kinase inhibitors (28 å¤©)</option>
                    <option value="14">Adrenergic agonists (14 å¤©)</option>
                    <option value="7">Muscarinic agonists / Carbonic anhydrase inhibitors (7 å¤©)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Visit 1 æ—¥æœŸ (ç¯©é¸æ—¥)</label>
                <input type="date" id="visit1" onchange="checkDateWarning('visit1'); calculateV2Suggestion(); validateDates(); if(visit1aDate) validateV1a();">
                <div id="visit1Warning"></div>
            </div>
            
            <div class="form-group">
                <label>Visit 2 æ—¥æœŸ (åŸºç·šæ—¥/éš¨æ©Ÿåˆ†é…æ—¥)</label>
                <input type="date" id="visit2" onchange="checkDateWarning('visit2'); validateDates(); if(visit1aDate) validateV1a();">
                <div id="visit2Warning"></div>
                <div id="v2Suggestion"></div>
                <div id="validation"></div>
            </div>
            
            <div id="v1aSuggestion"></div>
        </div>
        
        <div class="results">
            <h2 class="results-title">è¨ªè¦–æ’ç¨‹ç¸½è¦½</h2>
            <div id="output"></div>
        </div>
        
        <div class="notes">
            <div class="notes-title">ä½¿ç”¨èªªæ˜</div>
            <ul>
                <li><strong>Step 1:</strong> é¸æ“‡å—è©¦è€…é¡å‹</li>
                <li><strong>Step 2:</strong> å¦‚é¸æ“‡ Washoutï¼Œéœ€é¸æ“‡è—¥ç‰©é¡å‹ï¼ˆæ±ºå®šæ´—é™¤æœŸé•·åº¦ï¼‰</li>
                <li><strong>Step 3:</strong> è¼¸å…¥ Visit 1 æ—¥æœŸï¼ˆç¯©é¸æ—¥æœŸï¼‰</li>
                <li><strong>Step 4:</strong> è¼¸å…¥ Visit 2 æ—¥æœŸï¼ˆåŸºç·šæ—¥æœŸï¼‰</li>
                <li><strong>Step 5:</strong> é¸æ“‡ Visit 1a æ—¥æœŸ</li>
                <li><strong>æ´—é™¤æœŸé•·åº¦ï¼š</strong>
                    <ul style="margin-top: 5px;">
                        <li>Prostaglandins / Î²-blockers / Kinase inhibitors: 28 å¤©</li>
                        <li>Adrenergic agonists: 14 å¤©</li>
                        <li>Muscarinic agonists / Carbonic anhydrase inhibitors: 7 å¤©</li>
                    </ul>
                </li>
                <li><strong>é—œéµå·®ç•°ï¼š</strong>
                    <ul style="margin-top: 5px;">
                        <li><strong>Naive:</strong> V1a å¯åœ¨ V1 å’Œ V2 ä¹‹é–“ä»»é¸ï¼ˆé€šå¸¸èˆ‡ V1 åŒå¤©ï¼‰</li>
                        <li><strong>Washout:</strong> V1a å¿…é ˆåœ¨ V2 å‰ 1-7 å¤©ï¼ˆDay -7 to -1ï¼‰</li>
                    </ul>
                </li>
                <li><strong>Naive:</strong> V1 åˆ° V2 éœ€è¦ 1-35 å¤©ï¼ŒV1 å’Œ V1a é€šå¸¸åŒä¸€å¤©</li>
                <li><strong>Washout:</strong> V1 åˆ° V2 æœ€å¤š 35 å¤©ï¼ŒV1 åˆ° V1a è‡³å°‘ = æœ€å°æ´—é™¤æœŸï¼ŒV1a åˆ° V2 éœ€ 1-7 å¤©</li>
                <li>âš ï¸ <strong>å³æ™‚æé†’ï¼š</strong>è¼¸å…¥æ—¥æœŸå¾Œç«‹å³æª¢æŸ¥é€±æœ«å’Œå°ç£åœ‹å®šå‡æ—¥ï¼ˆ2025-2027ï¼‰</li>
                <li>ğŸ¯ <strong>æ™ºèƒ½å»ºè­°ï¼š</strong>ç³»çµ±è‡ªå‹•æä¾›ã€Œé¿é–‹å‡æ—¥ã€æŒ‰éˆ•ï¼Œå¿«é€Ÿé¸æ“‡å·¥ä½œæ—¥</li>
            </ul>
        </div>
    </div>
    
    <script>
        // Working weekends (è£œç­æ—¥ - weekends that are working days)
        var workingWeekends = {
            '2025': [
                '01-04', // è£œ 1/28 (æ˜¥ç¯€èª¿æ•´)
                '02-08'  // è£œ 2/3 (æ˜¥ç¯€èª¿æ•´)
            ],
            '2026': [
                '01-03', // è£œ 2/16 (æ˜¥ç¯€èª¿æ•´)
                '02-14', // è£œ 2/21 (æ˜¥ç¯€èª¿æ•´)
                '06-27', // è£œ 6/20 (ç«¯åˆç¯€èª¿æ•´)
                '10-03'  // è£œ 10/9 (åœ‹æ…¶æ—¥èª¿æ•´)
            ],
            '2027': [
                '01-23', // è£œ 1/29 (æ˜¥ç¯€èª¿æ•´)
                '02-27'  // è£œ 3/1 (å’Œå¹³ç´€å¿µæ—¥èª¿æ•´)
            ]
        };
        
        var holidays = {
            '2025': {
                '01-01': 'å…ƒæ—¦',
                '01-28': 'æ˜¥ç¯€(é™¤å¤•)', '01-29': 'æ˜¥ç¯€(åˆä¸€)', '01-30': 'æ˜¥ç¯€(åˆäºŒ)',
                '01-31': 'æ˜¥ç¯€(åˆä¸‰)', '02-01': 'æ˜¥ç¯€(åˆå››)', '02-02': 'æ˜¥ç¯€(åˆäº”)', '02-03': 'æ˜¥ç¯€(åˆå…­)',
                '02-28': 'å’Œå¹³ç´€å¿µæ—¥',
                '04-03': 'å…’ç«¥ç¯€', '04-04': 'æ¸…æ˜ç¯€', '04-05': 'æ¸…æ˜ç¯€è£œå‡', '04-06': 'å…’ç«¥ç¯€è£œå‡',
                '05-01': 'å‹å‹•ç¯€',
                '05-31': 'ç«¯åˆç¯€', '06-02': 'ç«¯åˆç¯€è£œå‡',
                '10-06': 'ä¸­ç§‹ç¯€', '10-07': 'ä¸­ç§‹ç¯€è£œå‡',
                '10-10': 'åœ‹æ…¶æ—¥', '10-11': 'åœ‹æ…¶æ—¥è£œå‡',
                '12-25': 'è¡Œæ†²ç´€å¿µæ—¥'
            },
            '2026': {
                '01-01': 'å…ƒæ—¦',
                '02-16': 'æ˜¥ç¯€(é™¤å¤•)', '02-17': 'æ˜¥ç¯€(åˆä¸€)', '02-18': 'æ˜¥ç¯€(åˆäºŒ)',
                '02-19': 'æ˜¥ç¯€(åˆä¸‰)', '02-20': 'æ˜¥ç¯€(åˆå››)', '02-21': 'æ˜¥ç¯€(åˆäº”)', '02-22': 'æ˜¥ç¯€(åˆå…­)',
                '02-28': 'å’Œå¹³ç´€å¿µæ—¥',
                '04-03': 'å…’ç«¥ç¯€', '04-04': 'æ¸…æ˜ç¯€', '04-05': 'æ¸…æ˜ç¯€è£œå‡', '04-06': 'å…’ç«¥ç¯€è£œå‡',
                '05-01': 'å‹å‹•ç¯€', '05-02': 'å‹å‹•ç¯€è£œå‡',
                '06-19': 'ç«¯åˆç¯€', '06-20': 'ç«¯åˆç¯€å½ˆæ€§æ”¾å‡',
                '09-28': 'ä¸­ç§‹ç¯€',
                '10-09': 'åœ‹æ…¶æ—¥å½ˆæ€§æ”¾å‡', '10-10': 'åœ‹æ…¶æ—¥', '10-11': 'åœ‹æ…¶æ—¥è£œå‡',
                '12-25': 'è¡Œæ†²ç´€å¿µæ—¥', '12-26': 'è¡Œæ†²ç´€å¿µæ—¥è£œå‡'
            },
            '2027': {
                '01-01': 'å…ƒæ—¦', '01-02': 'å…ƒæ—¦è£œå‡',
                '02-05': 'æ˜¥ç¯€(é™¤å¤•)', '02-06': 'æ˜¥ç¯€(åˆä¸€)', '02-07': 'æ˜¥ç¯€(åˆäºŒ)',
                '02-08': 'æ˜¥ç¯€(åˆä¸‰)', '02-09': 'æ˜¥ç¯€(åˆå››)', '02-10': 'æ˜¥ç¯€(åˆäº”)', '02-11': 'æ˜¥ç¯€(åˆå…­)',
                '02-28': 'å’Œå¹³ç´€å¿µæ—¥', '03-01': 'å’Œå¹³ç´€å¿µæ—¥è£œå‡',
                '04-04': 'å…’ç«¥ç¯€', '04-05': 'æ¸…æ˜ç¯€', '04-06': 'æ¸…æ˜ç¯€è£œå‡',
                '05-01': 'å‹å‹•ç¯€',
                '06-09': 'ç«¯åˆç¯€', '06-10': 'ç«¯åˆç¯€è£œå‡',
                '09-15': 'ä¸­ç§‹ç¯€', '09-16': 'ä¸­ç§‹ç¯€è£œå‡',
                '10-10': 'åœ‹æ…¶æ—¥', '10-11': 'åœ‹æ…¶æ—¥è£œå‡',
                '12-25': 'è¡Œæ†²ç´€å¿µæ—¥', '12-27': 'è¡Œæ†²ç´€å¿µæ—¥è£œå‡'
            }
        };
        
        var visit1aDate = '';
        var selectedV3 = null; // User selected Visit 3 date
        var selectedV4 = null; // User selected Visit 4 date
        var selectedV5 = null; // User selected Visit 5 date
        
        // Select a visit date (V3, V4, or V5)
        function selectVisitDate(visitNum, dateStr) {
            if (visitNum === 3) selectedV3 = dateStr;
            else if (visitNum === 4) selectedV4 = dateStr;
            else if (visitNum === 5) selectedV5 = dateStr;
            
            calculateVisits(); // Recalculate to update UI
        }
        
        // Check if a date conflicts with other visits
        function checkDateConflict(dateStr, excludeVisit, allVisits) {
            var date = parseDate(dateStr);
            
            for (var i = 0; i < allVisits.length; i++) {
                var visit = allVisits[i];
                if (visit.name === excludeVisit) continue; // Skip the visit being checked
                
                if (visit.date && formatDate(parseDate(visit.date)) === dateStr) {
                    return visit.name; // Return conflicting visit name
                }
            }
            
            return null; // No conflict
        }
        
        // Generate date selector buttons for a visit
        function generateDateSelector(visitNum, centerDate, v2, allVisits) {
            var visitName = 'Visit ' + visitNum;
            var selectedDate = null;
            if (visitNum === 3) selectedDate = selectedV3;
            else if (visitNum === 4) selectedDate = selectedV4;
            else if (visitNum === 5) selectedDate = selectedV5;
            
            // If no selection, use center date (or next workday if center is holiday)
            if (!selectedDate) {
                var suggestedDate = centerDate;
                // If suggested date is holiday, find next workday
                if (checkHoliday(centerDate)) {
                    suggestedDate = getNextWorkday(centerDate);
                }
                selectedDate = formatDate(suggestedDate);
                // Auto-select suggested date on first render
                if (visitNum === 3) selectedV3 = selectedDate;
                else if (visitNum === 4) selectedV4 = selectedDate;
                else if (visitNum === 5) selectedV5 = selectedDate;
            }
            
            var html = '<div class="date-selector">';
            html += '<div class="date-selector-label">é¸æ“‡è¨ªè¦–æ—¥æœŸï¼ˆÂ±2 å¤©å½ˆæ€§çª—å£ï¼‰</div>';
            html += '<div class="date-options">';
            
            // Track if all options are disabled
            var allDisabled = true;
            var optionsHtml = '';
            
            // Generate 5 options: -2, -1, 0, +1, +2
            for (var i = -2; i <= 2; i++) {
                var optionDate = addDays(centerDate, i);
                var optionDateStr = formatDate(optionDate);
                var isSelected = (optionDateStr === selectedDate);
                var conflict = checkDateConflict(optionDateStr, visitName, allVisits);
                var holiday = checkHoliday(optionDate);
                
                var btnClass = 'date-option';
                var isDisabled = false;
                
                if (isSelected) {
                    btnClass += ' selected';
                }
                
                // Holidays and conflicts are both disabled
                if (conflict || holiday) {
                    btnClass += ' disabled';
                    isDisabled = true;
                    if (conflict) btnClass += ' conflict';
                } else {
                    allDisabled = false; // Found at least one enabled option
                }
                
                var label = '';
                if (i === -2) label = 'å¾€å‰2å¤©';
                else if (i === -1) label = 'å¾€å‰1å¤©';
                else if (i === 0) label = 'å»ºè­°';
                else if (i === 1) label = 'å¾€å¾Œ1å¤©';
                else if (i === 2) label = 'å¾€å¾Œ2å¤©';
                
                optionsHtml += '<button class="' + btnClass + '"';
                if (!isDisabled) {
                    optionsHtml += ' onclick="selectVisitDate(' + visitNum + ', \'' + optionDateStr + '\')"';
                }
                optionsHtml += '>';
                optionsHtml += '<span class="date-option-date">' + formatDateShort(optionDate) + '</span>';
                optionsHtml += '<span class="date-option-label">' + label + '</span>';
                
                if (conflict) {
                    optionsHtml += '<span class="date-option-label" style="color: #dc2626;">âš ï¸ è¡çª</span>';
                } else if (holiday) {
                    optionsHtml += '<span class="date-option-label" style="color: #dc2626;">ğŸš« å‡æ—¥</span>';
                }
                optionsHtml += '</button>';
            }
            
            html += optionsHtml;
            html += '</div>';
            
            // If all options are disabled, suggest adjusting V2 or V1
            if (allDisabled) {
                var v1Input = document.getElementById('visit1').value;
                var v2Input = document.getElementById('visit2').value;
                var v1Date = parseDate(v1Input);
                var v2Date = parseDate(v2Input);
                
                // Find a better V2 date
                var suggestedV2 = findBetterV2Date(v2Date, visitNum);
                
                html += '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 8px;">';
                html += '<div style="font-weight: 600; font-size: 13px; color: #dc2626; margin-bottom: 6px;">âš ï¸ æ‰€æœ‰æ—¥æœŸéƒ½ç„¡æ³•é¸æ“‡</div>';
                
                if (suggestedV2) {
                    html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">å»ºè­°èª¿æ•´ Visit 2 æ—¥æœŸä»¥ç²å¾—å¯ç”¨é¸é …</div>';
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #92400e; margin-bottom: 6px;">ğŸ’¡ ç³»çµ±å»ºè­°ï¼š</div>';
                    html += '<div style="font-size: 13px; font-weight: 600; color: #1f2937;">å°‡ Visit 2 æ”¹ç‚ºï¼š<span style="color: #dc2626;">' + formatDate(suggestedV2) + '</span></div>';
                    html += '<button class="btn btn-primary" style="width: 100%; margin-top: 8px; background: #dc2626;" onclick="adjustV2Date(\'' + formatDate(suggestedV2) + '\')">';
                    html += 'âœ¨ æ¡ç”¨å»ºè­°ä¸¦é‡æ–°è¨ˆç®—';
                    html += '</button>';
                    html += '</div>';
                } else {
                    // If no suitable V2 adjustment found, suggest moving to nearest workday
                    var nearestV1 = findNearestWorkday(v1Date);
                    var nearestV2 = findNearestWorkday(v2Date);
                    
                    html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">åœ¨ Â±10 å¤©ç¯„åœå…§æ‰¾ä¸åˆ°åˆé©çš„ V2 èª¿æ•´</div>';
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #92400e; margin-bottom: 8px;">ğŸ’¡ å»ºè­°èª¿æ•´åˆ°æœ€è¿‘çš„å·¥ä½œæ—¥ï¼š</div>';
                    
                    // Suggest V1
                    if (nearestV1 && formatDate(nearestV1) !== formatDate(v1Date)) {
                        html += '<div style="margin-bottom: 8px;">';
                        html += '<div style="font-size: 12px; font-weight: 600; color: #1f2937; margin-bottom: 4px;">æ–¹æ¡ˆ Aï¼šèª¿æ•´ Visit 1</div>';
                        html += '<div style="font-size: 13px; color: #1f2937;">å¾ ' + formatDate(v1Date) + ' â†’ <span style="color: #dc2626; font-weight: 600;">' + formatDate(nearestV1) + '</span></div>';
                        html += '<button class="btn btn-primary" style="width: 100%; margin-top: 6px; background: #dc2626; font-size: 12px;" onclick="adjustV1Date(\'' + formatDate(nearestV1) + '\')">';
                        html += 'æ¡ç”¨æ–¹æ¡ˆ A';
                        html += '</button>';
                        html += '</div>';
                    }
                    
                    // Suggest V2
                    if (nearestV2 && formatDate(nearestV2) !== formatDate(v2Date)) {
                        html += '<div style="margin-bottom: 8px;">';
                        html += '<div style="font-size: 12px; font-weight: 600; color: #1f2937; margin-bottom: 4px;">æ–¹æ¡ˆ Bï¼šèª¿æ•´ Visit 2</div>';
                        html += '<div style="font-size: 13px; color: #1f2937;">å¾ ' + formatDate(v2Date) + ' â†’ <span style="color: #dc2626; font-weight: 600;">' + formatDate(nearestV2) + '</span></div>';
                        html += '<button class="btn btn-primary" style="width: 100%; margin-top: 6px; background: #dc2626; font-size: 12px;" onclick="adjustV2Date(\'' + formatDate(nearestV2) + '\')">';
                        html += 'æ¡ç”¨æ–¹æ¡ˆ B';
                        html += '</button>';
                        html += '</div>';
                    }
                    
                    if ((!nearestV1 || formatDate(nearestV1) === formatDate(v1Date)) && 
                        (!nearestV2 || formatDate(nearestV2) === formatDate(v2Date))) {
                        html += '<div style="font-size: 12px; color: #991b1b;">V1 å’Œ V2 å·²ç¶“æ˜¯æœ€è¿‘çš„å·¥ä½œæ—¥ï¼Œå»ºè­°é‡æ–°è¦åŠƒæ•´é«”æ’ç¨‹</div>';
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            
            return html;
        }
        
        // Find nearest workday from a given date (forward search)
        function findNearestWorkday(date) {
            var maxSearch = 30; // Search up to 30 days
            var testDate = new Date(date);
            
            for (var i = 0; i < maxSearch; i++) {
                if (i > 0) {
                    testDate = addDays(testDate, 1);
                }
                if (!checkHoliday(testDate)) {
                    return testDate;
                }
            }
            
            return null; // Could not find workday
        }
        
        // Find a better V2 date that allows valid options for this visit
        function findBetterV2Date(currentV2, visitNum) {
            var daysOffset;
            if (visitNum === 3) daysOffset = 7;
            else if (visitNum === 4) daysOffset = 14;
            else if (visitNum === 5) daysOffset = 28;
            
            // Try adjusting V2 forward and backward
            var maxAdjust = 10; // Try up to 10 days adjustment
            
            for (var adjust = 1; adjust <= maxAdjust; adjust++) {
                // Try moving V2 forward
                var newV2Forward = addDays(currentV2, adjust);
                // CRITICAL: V2 itself must be a workday
                if (!checkHoliday(newV2Forward) && hasValidOptions(newV2Forward, daysOffset)) {
                    return newV2Forward;
                }
                
                // Try moving V2 backward
                var newV2Backward = addDays(currentV2, -adjust);
                // CRITICAL: V2 itself must be a workday
                if (!checkHoliday(newV2Backward) && hasValidOptions(newV2Backward, daysOffset)) {
                    return newV2Backward;
                }
            }
            
            return null; // Could not find better date within range
        }
        
        // Check if a V2 date would give valid options for a visit
        function hasValidOptions(v2Date, daysOffset) {
            var centerDate = addDays(v2Date, daysOffset);
            
            // Check if any date in the Â±2 range is valid (not holiday)
            for (var i = -2; i <= 2; i++) {
                var testDate = addDays(centerDate, i);
                if (!checkHoliday(testDate)) {
                    return true; // Found at least one non-holiday
                }
            }
            
            return false; // All dates are holidays
        }
        
        // Adjust V1 date and recalculate
        function adjustV1Date(newV1) {
            document.getElementById('visit1').value = newV1;
            
            // Clear previous selections
            visit1aDate = '';
            selectedV3 = null;
            selectedV4 = null;
            selectedV5 = null;
            
            // Recalculate
            checkDateWarning('visit1');
            calculateV2Suggestion();
            document.getElementById('v1aSuggestion').innerHTML = '';
            document.getElementById('validation').innerHTML = '';
            calculateVisits();
        }
        
        // Adjust V2 date and recalculate
        function adjustV2Date(newV2) {
            document.getElementById('visit2').value = newV2;
            
            // Clear previous selections
            selectedV3 = null;
            selectedV4 = null;
            selectedV5 = null;
            
            // Recalculate
            checkDateWarning('visit2');
            calculateV2Suggestion();
            validateV1a();
            calculateVisits();
        }
        
        // Format date in short form (MM/DD)
        function formatDateShort(date) {
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            return month + '/' + day;
        }
        
        // Auto-adjust all visits to avoid holidays (one-click)
        function autoAvoidHolidays() {
            var v2Input = document.getElementById('visit2').value;
            if (!v2Input) {
                alert('è«‹å…ˆè¼¸å…¥ Visit 2 æ—¥æœŸ');
                return;
            }
            
            var v2 = parseDate(v2Input);
            var changed = false;
            
            // Visit 3: Day 8 (V2 + 7)
            var v3_center = addDays(v2, 7);
            if (checkHoliday(v3_center)) {
                var v3_workday = getNextWorkday(v3_center);
                // Make sure still in range (V2+5 to V2+9)
                if (v3_workday <= addDays(v2, 9)) {
                    selectedV3 = formatDate(v3_workday);
                    changed = true;
                }
            } else {
                selectedV3 = formatDate(v3_center);
            }
            
            // Visit 4: Day 15 (V2 + 14)
            var v4_center = addDays(v2, 14);
            if (checkHoliday(v4_center)) {
                var v4_workday = getNextWorkday(v4_center);
                // Make sure still in range (V2+12 to V2+16)
                if (v4_workday <= addDays(v2, 16)) {
                    selectedV4 = formatDate(v4_workday);
                    changed = true;
                }
            } else {
                selectedV4 = formatDate(v4_center);
            }
            
            // Visit 5: Day 29 (V2 + 28)
            var v5_center = addDays(v2, 28);
            if (checkHoliday(v5_center)) {
                var v5_workday = getNextWorkday(v5_center);
                // Make sure still in range (V2+26 to V2+30)
                if (v5_workday <= addDays(v2, 30)) {
                    selectedV5 = formatDate(v5_workday);
                    changed = true;
                }
            } else {
                selectedV5 = formatDate(v5_center);
            }
            
            calculateVisits(); // Recalculate to update UI
            
            if (changed) {
                alert('âœ… å·²è‡ªå‹•èª¿æ•´ Visit æ—¥æœŸé¿é–‹å‡æ—¥');
            } else {
                alert('âœ… æ‰€æœ‰ Visit æ—¥æœŸå·²æ˜¯å·¥ä½œæ—¥');
            }
        }
        
        function clearAll() {
            // Clear all form inputs
            document.getElementById('subjectType').value = '';
            document.getElementById('drugType').value = '';
            document.getElementById('visit1').value = '';
            document.getElementById('visit2').value = '';
            
            // Clear V1a date
            visit1aDate = '';
            
            // Clear selected visit dates
            selectedV3 = null;
            selectedV4 = null;
            selectedV5 = null;
            
            // Hide drug type selection
            document.getElementById('drugTypeGroup').style.display = 'none';
            
            // Clear all display areas
            document.getElementById('v2Suggestion').innerHTML = '';
            document.getElementById('validation').innerHTML = '';
            document.getElementById('v1aSuggestion').innerHTML = '';
            document.getElementById('output').innerHTML = '<div class="empty">è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ä»¥è¨ˆç®—è¨ªè¦–æ—¥æœŸ</div>';
            
            // Clear warnings
            document.getElementById('visit1Warning').innerHTML = '';
            document.getElementById('visit2Warning').innerHTML = '';
            
            clearV1aValidation();
        }
        
        function checkDateWarning(inputId) {
            var warningDivId = inputId + 'Warning';
            var warningDiv = document.getElementById(warningDivId);
            
            if (!warningDiv) {
                return;
            }
            
            var dateValue = '';
            if (inputId === 'v1a') {
                dateValue = visit1aDate;
            } else {
                var inputElement = document.getElementById(inputId);
                if (!inputElement) {
                    return;
                }
                dateValue = inputElement.value;
            }
            
            if (!dateValue) {
                warningDiv.innerHTML = '';
                return;
            }
            
            var date = parseDate(dateValue);
            var holidayInfo = checkHoliday(date);
            
            if (holidayInfo) {
                warningDiv.innerHTML = '<div class="warning ' + holidayInfo.type + '" style="margin-top: 8px;">' + holidayInfo.msg + '</div>';
            } else {
                warningDiv.innerHTML = '';
            }
        }
        
        function toggleDrugSelection() {
            var type = document.getElementById('subjectType').value;
            var drugTypeGroup = document.getElementById('drugTypeGroup');
            
            if (type === 'washout') {
                drugTypeGroup.style.display = 'block';
            } else {
                drugTypeGroup.style.display = 'none';
                document.getElementById('drugType').value = '';
            }
            
            // Clear V1a date and suggestion when type changes
            visit1aDate = '';
            var v1aSuggDiv = document.getElementById('v1aSuggestion');
            if (v1aSuggDiv) {
                v1aSuggDiv.innerHTML = '';
            }
            
            calculateV2Suggestion();
        }
        
        function calculateV2Suggestion() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2SuggDiv = document.getElementById('v2Suggestion');
            
            if (!type || !v1Input) {
                v2SuggDiv.innerHTML = '';
                return;
            }
            
            var v1 = parseDate(v1Input);
            var html = '';
            
            if (type === 'naive') {
                // Naive: V2 should be 1-35 days after V1
                var v2_min = addDays(v1, 1);
                var v2_max = addDays(v1, 35);
                var v2_suggested = v2_min; // Use minimum (shortest time)
                
                // Check if suggested date is holiday/weekend
                var v2_workday = v2_suggested;
                var isHoliday = checkHoliday(v2_suggested);
                if (isHoliday) {
                    v2_workday = getNextWorkday(v2_suggested);
                }
                
                html = '<div style="margin-top: 12px; padding: 12px; background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 8px;">';
                html += '<div style="font-weight: 600; font-size: 13px; color: #1e40af; margin-bottom: 6px;">Visit 2 å»ºè­°</div>';
                html += '<div style="font-size: 12px; color: #3b82f6; margin-bottom: 8px;">å»ºè­°ç¯„åœï¼š' + formatDate(v2_min) + ' ~ ' + formatDate(v2_max) + ' (V1 å¾Œ 1-35 å¤©)</div>';
                html += '<div class="btn-group">';
                html += '<button onclick="useV2Date(\'' + formatDate(v2_suggested) + '\')" class="btn btn-primary">æœ€çŸ­æ™‚é–“ (' + formatDate(v2_suggested) + ')</button>';
                if (isHoliday && v2_workday <= v2_max) {
                    html += '<button onclick="useV2Date(\'' + formatDate(v2_workday) + '\')" class="btn btn-primary">é¿é–‹å‡æ—¥ (' + formatDate(v2_workday) + ')</button>';
                }
                html += '</div>';
                html += '</div>';
            } else if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                
                if (drugType) {
                    var washoutDays = parseInt(drugType);
                    var v2_min = addDays(v1, washoutDays + 1);
                    var v2_max = addDays(v1, Math.min(washoutDays + 7, 35)); // Maximum 35 days from V1
                    var v2_suggested = v2_min; // Use minimum (shortest time)
                    
                    // Check if suggested date is holiday/weekend
                    var v2_workday = v2_suggested;
                    var isHoliday = checkHoliday(v2_suggested);
                    if (isHoliday) {
                        v2_workday = getNextWorkday(v2_suggested);
                    }
                    
                    html = '<div style="margin-top: 12px; padding: 12px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px;">';
                    html += '<div style="font-weight: 600; font-size: 13px; color: #92400e; margin-bottom: 6px;">Visit 2 å»ºè­°</div>';
                    html += '<div style="font-size: 12px; color: #92400e; margin-bottom: 8px;">å»ºè­°ç¯„åœï¼š' + formatDate(v2_min) + ' ~ ' + formatDate(v2_max);
                    html += '<br>ï¼ˆV1 å¾Œ ' + (washoutDays + 1) + '-' + Math.min(washoutDays + 7, 35) + ' å¤©ï¼ŒV1 åˆ° V2 æœ€å¤š 35 å¤©ï¼‰</div>';
                    html += '<div class="btn-group">';
                    html += '<button onclick="useV2Date(\'' + formatDate(v2_suggested) + '\')" class="btn btn-primary">æœ€çŸ­æ™‚é–“ (' + formatDate(v2_suggested) + ')</button>';
                    if (isHoliday && v2_workday <= v2_max) {
                        html += '<button onclick="useV2Date(\'' + formatDate(v2_workday) + '\')" class="btn btn-primary">é¿é–‹å‡æ—¥ (' + formatDate(v2_workday) + ')</button>';
                    }
                    html += '</div>';
                    html += '</div>';
                }
            }
            
            v2SuggDiv.innerHTML = html;
        }
        
        function useV2Date(date) {
            document.getElementById('visit2').value = date;
            checkDateWarning('visit2');
            validateDates();
        }
        
        function parseDate(dateStr) {
            // Parse YYYY-MM-DD without timezone issues
            var parts = dateStr.split('-');
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }
        
        function addDays(date, days) {
            var result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }
        
        function formatDate(date) {
            var y = date.getFullYear();
            var m = String(date.getMonth() + 1).padStart(2, '0');
            var d = String(date.getDate()).padStart(2, '0');
            return y + '-' + m + '-' + d;
        }
        
        function getDaysDiff(date1, date2) {
            var diff = Math.floor((date2 - date1) / (1000 * 60 * 60 * 24));
            return diff;
        }
        
        function checkHoliday(date) {
            if (!date || isNaN(date.getTime())) {
                return null;
            }
            
            var day = date.getDay();
            var weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            
            var year = String(date.getFullYear());
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var dateStr = String(date.getDate()).padStart(2, '0');
            var key = month + '-' + dateStr;
            
            // Check if it's a working weekend (è£œç­æ—¥)
            if ((day === 0 || day === 6) && workingWeekends[year] && workingWeekends[year].includes(key)) {
                return null; // It's a working weekend, not a holiday
            }
            
            // Check if it's a weekend
            if (day === 0 || day === 6) {
                return { type: 'weekend', msg: 'âš ï¸ ' + weekdays[day] + ' (é€±æœ«)' };
            }
            
            // Check if it's a holiday
            if (holidays[year] && holidays[year][key]) {
                return { type: 'holiday', msg: 'âš ï¸ ' + holidays[year][key] + ' (åœ‹å®šå‡æ—¥)' };
            }
            
            return null;
        }
        
        function getNextWorkday(date) {
            // Find next workday (not weekend, not holiday)
            var nextDate = new Date(date);
            var maxAttempts = 14; // Avoid infinite loop
            var attempts = 0;
            
            while (attempts < maxAttempts) {
                nextDate = addDays(nextDate, 1);
                var holidayInfo = checkHoliday(nextDate);
                
                if (!holidayInfo) {
                    // Found a workday
                    return nextDate;
                }
                attempts++;
            }
            
            // If couldn't find workday in 14 days, return original date + 1
            return addDays(date, 1);
        }
        
        function getHolidayWarningHtml(holidayInfo) {
            if (!holidayInfo) return '';
            return '<div class="warning ' + holidayInfo.type + '">' + holidayInfo.msg + '</div>';
        }
        
        function validateDates() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var validationDiv = document.getElementById('validation');
            var v1aSuggDiv = document.getElementById('v1aSuggestion');
            
            // Clear all validation messages and suggestions at start
            validationDiv.innerHTML = '';
            clearV1aValidation();
            
            if (!type || !v1Input || !v2Input) {
                v1aSuggDiv.innerHTML = '';
                calculateVisits();
                return;
            }
            
            // For Washout, drug type must be selected
            if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                if (!drugType) {
                    validationDiv.innerHTML = '<div class="validation-msg error">è«‹å…ˆé¸æ“‡éœ€æ´—é™¤çš„è—¥ç‰©é¡å‹</div>';
                    v1aSuggDiv.innerHTML = '';
                    calculateVisits();
                    return;
                }
            }
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            var daysDiff = getDaysDiff(v1, v2);
            
            var isValid = false;
            var message = '';
            var msgClass = '';
            
            if (type === 'naive') {
                if (daysDiff < 1) {
                    message = 'âŒ V1 åˆ° V2 é–“éš”éçŸ­ï¼ˆ' + daysDiff + ' å¤©ï¼‰ã€‚Naive å—è©¦è€…éœ€è¦ 1-35 å¤©ã€‚';
                    msgClass = 'error';
                } else if (daysDiff > 35) {
                    message = 'âŒ V1 åˆ° V2 é–“éš”éé•·ï¼ˆ' + daysDiff + ' å¤©ï¼‰ã€‚Naive å—è©¦è€…éœ€è¦ 1-35 å¤©ã€‚';
                    msgClass = 'error';
                } else {
                    message = 'âœ“ æ—¥æœŸé–“éš”ç¬¦åˆè¦å®šï¼ˆ' + daysDiff + ' å¤©ï¼Œç¯„åœ 1-35 å¤©ï¼‰';
                    msgClass = 'success';
                    isValid = true;
                }
            } else if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                var washoutDays = parseInt(drugType);
                var minDays = washoutDays + 1;  // washout + 1 day to V2
                var maxDays = Math.min(washoutDays + 7, 35);  // washout + 7 days to V2, but max 35 days total
                
                if (daysDiff < minDays) {
                    message = 'âŒ V1 åˆ° V2 é–“éš”éçŸ­ï¼ˆ' + daysDiff + ' å¤©ï¼‰ã€‚éœ€è¦ ' + minDays + '-' + maxDays + ' å¤©ï¼ˆ' + washoutDays + 'å¤©æ´—é™¤æœŸ + 1-7å¤©åˆ°V2ï¼‰ã€‚';
                    msgClass = 'error';
                } else if (daysDiff > 35) {
                    message = 'âŒ V1 åˆ° V2 é–“éš”éé•·ï¼ˆ' + daysDiff + ' å¤©ï¼‰ã€‚Washout å—è©¦è€… V1 åˆ° V2 æœ€å¤š 35 å¤©ã€‚';
                    msgClass = 'error';
                } else if (daysDiff > maxDays) {
                    message = 'âŒ V1 åˆ° V2 é–“éš”éé•·ï¼ˆ' + daysDiff + ' å¤©ï¼‰ã€‚éœ€è¦ ' + minDays + '-' + maxDays + ' å¤©ã€‚';
                    msgClass = 'error';
                } else {
                    message = 'âœ“ æ—¥æœŸé–“éš”ç¬¦åˆè¦å®šï¼ˆ' + daysDiff + ' å¤©ï¼Œç¯„åœ ' + minDays + '-' + maxDays + ' å¤©ï¼‰';
                    msgClass = 'success';
                    isValid = true;
                }
            }
            
            validationDiv.innerHTML = '<div class="validation-msg ' + msgClass + '">' + message + '</div>';
            
            // Show V1a suggestion
            if (isValid) {
                var html = '<div class="v1a-input">';
                
                if (type === 'naive') {
                    // Naive: V1a can be anywhere between V1 and V2
                    html += '<div class="v1a-label">Visit 1a æ—¥æœŸï¼ˆå¯åœ¨ V1 å’Œ V2 ä¹‹é–“ä»»é¸ï¼‰</div>';
                    
                    // Auto set V1a = V1 by default
                    if (!visit1aDate) {
                        visit1aDate = formatDate(v1);
                    }
                    
                    // Check if V1 is holiday/weekend
                    var v1_workday = v1;
                    var isV1Holiday = checkHoliday(v1);
                    if (isV1Holiday) {
                        v1_workday = getNextWorkday(v1);
                        // Make sure workday is before V2
                        if (v1_workday >= v2) {
                            v1_workday = v1;
                        }
                    }
                    
                    html += '<div class="suggestion-box">';
                    html += '<div class="suggestion-label">å½ˆæ€§ç¯„åœ</div>';
                    html += '<div class="suggestion-value">' + formatDate(v1) + ' ~ ' + formatDate(v2) + '<br>';
                    html += 'Naive å—è©¦è€…çš„ V1a æ²’æœ‰å›ºå®šé™åˆ¶ï¼Œé€šå¸¸é¸æ“‡èˆ‡ V1 åŒä¸€å¤©</div>';
                    html += '</div>';
                    
                    html += '<input type="date" id="v1aInput" value="' + visit1aDate + '" onchange="visit1aDate=this.value; checkDateWarning(\'v1a\'); validateV1a(); calculateVisits();" style="width: 100%; padding: 10px; margin-top: 10px; border: 2px solid #fbbf24; border-radius: 8px;">';
                    html += '<div id="v1aWarning" style="margin-top: 5px;"></div>';
                    html += '<div class="btn-group">';
                    html += '<button class="btn btn-primary" onclick="useV1ForV1a()">é‡è¨­ç‚º V1</button>';
                    if (isV1Holiday && v1_workday < v2) {
                        html += '<button class="btn btn-primary" onclick="useDate(\'' + formatDate(v1_workday) + '\')">é¿é–‹å‡æ—¥ (' + formatDate(v1_workday) + ')</button>';
                    }
                    html += '</div>';
                } else if (type === 'washout') {
                    // Washout: V1a must be 1-7 days before V2
                    html += '<div class="v1a-label">Visit 1a æ—¥æœŸï¼ˆå¿…é ˆåœ¨ V2 å‰ 1-7 å¤©ï¼‰</div>';
                    
                    var drugType = document.getElementById('drugType').value;
                    var washoutDays = parseInt(drugType);
                    var v1a_calculated = addDays(v1, washoutDays);
                    
                    var v1a_early = addDays(v2, -7);
                    var v1a_late = addDays(v2, -1);
                    
                    var drugTypeName = '';
                    if (washoutDays === 28) drugTypeName = 'Prostaglandins / Î²-blockers / Kinase inhibitors';
                    else if (washoutDays === 14) drugTypeName = 'Adrenergic agonists';
                    else if (washoutDays === 7) drugTypeName = 'Muscarinic agonists / Carbonic anhydrase inhibitors';
                    
                    html += '<div class="suggestion-box">';
                    html += '<div class="suggestion-label">Washout è¦å‰‡</div>';
                    html += '<div class="suggestion-value">';
                    html += 'â€¢ è—¥ç‰©é¡å‹ï¼š' + drugTypeName + '<br>';
                    html += 'â€¢ <strong>æœ€å°æ´—é™¤æœŸï¼š' + washoutDays + ' å¤©</strong>ï¼ˆå¯æ›´é•·ï¼‰<br>';
                    html += 'â€¢ <strong>V1a æœ€æ—©ï¼š</strong>V1 + ' + washoutDays + ' å¤© = <strong>' + formatDate(v1a_calculated) + '</strong><br>';
                    html += 'â€¢ <strong>V1a å¿…é ˆï¼š</strong>V2 å‰ 1-7 å¤© = <strong>' + formatDate(v1a_early) + ' ~ ' + formatDate(v1a_late) + '</strong><br>';
                    html += 'â€¢ <strong>å¯é¸ç¯„åœï¼š</strong>' + formatDate(v1a_calculated) + ' ~ ' + formatDate(v1a_late) + '<br><br>';
                    
                    // Check if calculated V1a is within valid range
                    if (v1a_calculated >= v1a_early && v1a_calculated <= v1a_late) {
                        html += 'âœ“ <strong style="color: #059669;">å»ºè­° ' + formatDate(v1a_calculated) + 'ï¼ˆæ´—é™¤æœŸå‰›å¥½ ' + washoutDays + ' å¤©ï¼‰</strong>';
                    } else {
                        html += 'âŒ <strong style="color: #dc2626;">æœ€æ—©å¯ç”¨çš„ V1a (' + formatDate(v1a_calculated) + ') ä¸åœ¨ V2 å‰ 1-7 å¤©ç¯„åœå…§</strong><br>';
                        html += '<span style="font-size: 12px; color: #92400e;">å»ºè­°ï¼šèª¿æ•´ V2 åˆ° ' + formatDate(addDays(v1a_calculated, 1)) + ' æˆ–æ›´æ™š</span>';
                    }
                    html += '</div>';
                    html += '</div>';
                    
                    html += '<input type="date" id="v1aInput" value="' + formatDate(v1a_calculated) + '" onchange="visit1aDate=this.value; checkDateWarning(\'v1a\'); validateV1a(); calculateVisits();" style="width: 100%; padding: 10px; margin-top: 10px; border: 2px solid #fbbf24; border-radius: 8px;">';
                    html += '<div id="v1aWarning" style="margin-top: 5px;"></div>';
                    
                    // Only show button if V1a is valid (within V2 -7 to -1 range)
                    if (v1a_calculated >= v1a_early && v1a_calculated <= v1a_late) {
                        // Check if calculated V1a is holiday/weekend
                        var v1a_workday = v1a_calculated;
                        var isV1aHoliday = checkHoliday(v1a_calculated);
                        if (isV1aHoliday) {
                            v1a_workday = getNextWorkday(v1a_calculated);
                            // Make sure workday is still within valid range and meets minimum washout
                            var workday_washout = getDaysDiff(v1, v1a_workday);
                            if (v1a_workday > v1a_late || workday_washout < washoutDays) {
                                isV1aHoliday = null; // Don't show avoid button
                            }
                        }
                        
                        html += '<div class="btn-group">';
                        html += '<button class="btn btn-primary" onclick="useDate(\'' + formatDate(v1a_calculated) + '\')">ä½¿ç”¨æœ€æ—©æ—¥æœŸ (' + formatDate(v1a_calculated) + ')</button>';
                        if (isV1aHoliday) {
                            html += '<button class="btn btn-primary" onclick="useDate(\'' + formatDate(v1a_workday) + '\')">é¿é–‹å‡æ—¥ (' + formatDate(v1a_workday) + ')</button>';
                        }
                        html += '</div>';
                    }
                    
                    visit1aDate = formatDate(v1a_calculated);
                }
                
                html += '</div>';
                
                v1aSuggDiv.innerHTML = html;
                
                // Auto validate V1a if it's set
                if (visit1aDate) {
                    validateV1a();
                    // Check for holidays immediately
                    setTimeout(function() {
                        checkDateWarning('v1a');
                    }, 100);
                }
            } else {
                v1aSuggDiv.innerHTML = '';
            }
            
            calculateVisits();
        }
        
        function useDate(date) {
            visit1aDate = date;
            document.getElementById('v1aInput').value = date;
            checkDateWarning('v1a');
            validateV1a();
            calculateVisits();
        }
        
        function useV1ForV1a() {
            var v1 = document.getElementById('visit1').value;
            if (v1) {
                visit1aDate = v1;
                document.getElementById('v1aInput').value = v1;
                checkDateWarning('v1a');
                validateV1a();
                calculateVisits();
            }
        }
        
        function validateV1a() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            
            if (!type || !v1Input || !v2Input || !visit1aDate) {
                // Clear V1a validation if no V1a date
                clearV1aValidation();
                return;
            }
            
            var v1 = parseDate(v1Input);
            var v1a = parseDate(visit1aDate);
            var v2 = parseDate(v2Input);
            
            var v1_v1a_diff = getDaysDiff(v1, v1a);
            var v1a_v2_diff = getDaysDiff(v1a, v2);
            
            var validationDiv = document.getElementById('validation');
            var v1aValidationDiv = document.getElementById('v1aValidation');
            
            // Create V1a validation div if it doesn't exist
            if (!v1aValidationDiv) {
                v1aValidationDiv = document.createElement('div');
                v1aValidationDiv.id = 'v1aValidation';
                validationDiv.appendChild(v1aValidationDiv);
            }
            
            var msgHtml = '';
            
            if (type === 'naive') {
                // For Naive: V1a just needs to be between V1 and V2
                if (v1_v1a_diff < 0) {
                    msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">âŒ V1a ä¸èƒ½æ—©æ–¼ V1</div>';
                } else if (v1a_v2_diff < 0) {
                    msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">âŒ V1a ä¸èƒ½æ™šæ–¼ V2</div>';
                } else {
                    if (v1_v1a_diff === 0) {
                        msgHtml = '<div class="validation-msg success" style="margin-top: 10px;">âœ“ V1a èˆ‡ V1 åŒä¸€å¤©ï¼ˆNaive å…è¨±ï¼‰</div>';
                    } else {
                        msgHtml = '<div class="validation-msg success" style="margin-top: 10px;">âœ“ V1a æ—¥æœŸç¬¦åˆè¦å®šï¼ˆV1 å¾Œ ' + v1_v1a_diff + ' å¤©ï¼ŒV2 å‰ ' + v1a_v2_diff + ' å¤©ï¼‰</div>';
                    }
                }
            } else if (type === 'washout') {
                // For Washout: V1a must be 1-7 days before V2
                if (v1a_v2_diff < 1 || v1a_v2_diff > 7) {
                    msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">âŒ V1a åˆ° V2 é–“éš”ä¸ç¬¦ï¼ˆ' + v1a_v2_diff + ' å¤©ï¼‰ã€‚Washout å¿…é ˆæ˜¯ 1-7 å¤©ã€‚</div>';
                } else {
                    // Check if V1a meets minimum washout period
                    var drugType = document.getElementById('drugType').value;
                    var washoutDays = parseInt(drugType);
                    
                    if (v1_v1a_diff < washoutDays) {
                        msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">âŒ V1 åˆ° V1a é–“éš”ä¸è¶³ï¼ˆ' + v1_v1a_diff + ' å¤©ï¼‰ã€‚æœ€å°æ´—é™¤æœŸæ˜¯ ' + washoutDays + ' å¤©ã€‚</div>';
                    } else {
                        if (v1_v1a_diff === washoutDays) {
                            msgHtml = '<div class="validation-msg success" style="margin-top: 10px;">âœ“ V1a ç¬¦åˆè¦å®šï¼ˆæ´—é™¤æœŸ ' + washoutDays + ' å¤©ï¼ŒV1aåˆ°V2 ' + v1a_v2_diff + ' å¤©ï¼‰</div>';
                        } else {
                            msgHtml = '<div class="validation-msg success" style="margin-top: 10px;">âœ“ V1a ç¬¦åˆè¦å®šï¼ˆæ´—é™¤æœŸ ' + v1_v1a_diff + ' å¤© â‰¥ æœ€å° ' + washoutDays + ' å¤©ï¼ŒV1aåˆ°V2 ' + v1a_v2_diff + ' å¤©ï¼‰</div>';
                        }
                    }
                }
            }
            
            v1aValidationDiv.innerHTML = msgHtml;
        }
        
        function clearV1aValidation() {
            var v1aValidationDiv = document.getElementById('v1aValidation');
            if (v1aValidationDiv) {
                v1aValidationDiv.innerHTML = '';
            }
        }
        
        function calculateVisits() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var output = document.getElementById('output');
            
            if (!type || !v1Input || !v2Input) {
                output.innerHTML = '<div class="empty">è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ä»¥è¨ˆç®—è¨ªè¦–æ—¥æœŸ</div>';
                return;
            }
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            var html = '';
            
            // Add "Auto-Avoid Holidays" button at top
            html += '<div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #fef3c7; border-radius: 12px; border: 2px solid #fbbf24;">';
            html += '<div style="font-weight: 600; color: #92400e; margin-bottom: 8px; font-size: 14px;">ğŸ¯ æ™ºèƒ½æ’ç¨‹åŠ©æ‰‹</div>';
            html += '<button onclick="autoAvoidHolidays()" style="background: #f59e0b; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.3s;" onmouseover="this.style.background=\'#d97706\'" onmouseout="this.style.background=\'#f59e0b\'">âœ¨ ä¸€éµé¿é–‹å‡æ—¥</button>';
            html += '<div style="font-size: 12px; color: #92400e; margin-top: 8px;">è‡ªå‹•èª¿æ•´ Visit 3, 4, 5 åˆ°æœ€è¿‘çš„å·¥ä½œæ—¥</div>';
            html += '</div>';
            
            // Visit 1
            var w1 = checkHoliday(v1);
            html += '<div class="visit-card">';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 1</div>';
            html += '<div class="badge badge-screening">ç¯©é¸æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day -35 to -1<br>èªªæ˜: ç¯©é¸è¨ªè¦–</div>';
            html += '<div class="visit-date">' + formatDate(v1) + '</div>';
            html += getHolidayWarningHtml(w1);
            html += '</div>';
            
            // Visit 1a
            if (visit1aDate) {
                var v1a = parseDate(visit1aDate);
                var w1a = checkHoliday(v1a);
                html += '<div class="visit-card">';
                html += '<div class="visit-header">';
                html += '<div class="visit-name">Visit 1a</div>';
                html += '<div class="badge badge-screening">ç¯©é¸æœŸ</div>';
                html += '</div>';
                html += '<div class="visit-info">';
                if (type === 'naive') {
                    html += 'Study Day: Day -35 to -1 (å½ˆæ€§)<br>èªªæ˜: è³‡æ ¼ç¢ºèªï¼ˆé€šå¸¸èˆ‡ V1 åŒå¤©ï¼‰';
                } else {
                    html += 'Study Day: Day -7 to -1<br>èªªæ˜: æ´—é™¤å¾Œè³‡æ ¼ç¢ºèªï¼ˆå¿…é ˆ V2 å‰ 1-7 å¤©ï¼‰';
                }
                html += '</div>';
                html += '<div class="visit-date">' + formatDate(v1a) + '</div>';
                html += getHolidayWarningHtml(w1a);
                html += '</div>';
            }
            
            // Visit 2
            var w2 = checkHoliday(v2);
            html += '<div class="visit-card">';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 2</div>';
            html += '<div class="badge badge-baseline">åŸºç·šæœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 1<br>èªªæ˜: éš¨æ©Ÿåˆ†é… & åŸºç·šè©•ä¼°</div>';
            html += '<div class="visit-date">' + formatDate(v2) + '</div>';
            html += getHolidayWarningHtml(w2);
            html += '</div>';
            
            // Day 2
            var day2 = addDays(v2, 1);
            var wd2 = checkHoliday(day2);
            html += '<div class="visit-card">';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Day 2</div>';
            html += '<div class="badge badge-treatment">æ²»ç™‚æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 2<br>èªªæ˜: é–‹å§‹æ²»ç™‚</div>';
            html += '<div class="visit-date">' + formatDate(day2) + '</div>';
            html += getHolidayWarningHtml(wd2);
            html += '</div>';
            
            // Calculate all visit dates first
            var v3_center = addDays(v2, 7);
            var v4_center = addDays(v2, 14);
            var v5_center = addDays(v2, 28);
            
            // Get actual dates (use selected if available, otherwise use center)
            var v3_date = selectedV3 ? parseDate(selectedV3) : v3_center;
            var v4_date = selectedV4 ? parseDate(selectedV4) : v4_center;
            var v5_date = selectedV5 ? parseDate(selectedV5) : v5_center;
            
            // Collect all visit dates for conflict detection
            var allVisits = [
                { name: 'Visit 1', date: v1Input },
                { name: 'Visit 1a', date: visit1aDate },
                { name: 'Visit 2', date: v2Input },
                { name: 'Day 2', date: formatDate(day2) },
                { name: 'Visit 3', date: formatDate(v3_date) },
                { name: 'Visit 4', date: formatDate(v4_date) },
                { name: 'Visit 5', date: formatDate(v5_date) }
            ];
            
            // Visit 3
            var w3 = checkHoliday(v3_date);
            html += '<div class="visit-card">';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 3</div>';
            html += '<div class="badge badge-treatment">æ²»ç™‚æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 8 (Â±2)<br>ç¯„åœ: ' + formatDate(addDays(v2, 5)) + ' ~ ' + formatDate(addDays(v2, 9)) + '</div>';
            html += '<div class="visit-date">' + formatDate(v3_date) + '</div>';
            html += getHolidayWarningHtml(w3);
            html += generateDateSelector(3, v3_center, v2, allVisits);
            html += '</div>';
            
            // Visit 4
            var w4 = checkHoliday(v4_date);
            html += '<div class="visit-card">';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 4</div>';
            html += '<div class="badge badge-treatment">æ²»ç™‚æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 15 (Â±2)<br>ç¯„åœ: ' + formatDate(addDays(v2, 12)) + ' ~ ' + formatDate(addDays(v2, 16)) + '</div>';
            html += '<div class="visit-date">' + formatDate(v4_date) + '</div>';
            html += getHolidayWarningHtml(w4);
            html += generateDateSelector(4, v4_center, v2, allVisits);
            html += '</div>';
            
            // Visit 5
            var w5 = checkHoliday(v5_date);
            html += '<div class="visit-card">';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 5</div>';
            html += '<div class="badge badge-treatment">æ²»ç™‚æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 29 (Â±2) EOT<br>ç¯„åœ: ' + formatDate(addDays(v2, 26)) + ' ~ ' + formatDate(addDays(v2, 30)) + '</div>';
            html += '<div class="visit-date">' + formatDate(v5_date) + '</div>';
            html += getHolidayWarningHtml(w5);
            html += generateDateSelector(5, v5_center, v2, allVisits);
            html += '</div>';
            
            // Visit 6
            var v6_start = addDays(v2, 29);
            var v6_end = addDays(v2, 50);
            var w6 = checkHoliday(v6_start);
            html += '<div class="visit-card">';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 6</div>';
            html += '<div class="badge badge-followup">è¿½è¹¤æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 30-51 (+7) EOS<br>èªªæ˜: End of Study</div>';
            html += '<div class="visit-date">' + formatDate(v6_start) + ' ~ ' + formatDate(v6_end) + '</div>';
            html += getHolidayWarningHtml(w6);
            html += '</div>';
            
            output.innerHTML = html;
        }
        
        // Initialize
        validateDates();
    </script>
</body>
</html>
