<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRM411 Ë®™Ë¶ñË®àÁÆóÂô®</title>
    <style>
        /* ========================================
           CSS ËÆäÈáèÁ≥ªÁµ± - Ë®≠Ë®à‰ª§Áâå
           ======================================== */
        :root {
            /* ÂìÅÁâåËâ≤ - Notion È¢®Ê†ºÁÅ∞ËóçËâ≤ */
            --primary-50: #f0f4f8;
            --primary-100: #e1e8ed;
            --primary-200: #c4d1dc;
            --primary-300: #a6baca;
            --primary-400: #89a3b8;
            --primary-500: #0b6ac9;
            --primary-600: #0959a8;
            --primary-700: #415464;
            --primary-800: #2c3842;
            --primary-900: #171c21;
            
            /* ÊàêÂäüËâ≤ - ÊîπÁÇ∫ËóçËâ≤ÔºàËàá‰∏ªËâ≤‰∏ÄËá¥Ôºâ */
            --success-50: #f0f7fd;
            --success-100: #dcecfa;
            --success-200: #b9d9f5;
            --success-300: #8ac0ed;
            --success-400: #5b9dd9;
            --success-500: #0b6ac9;
            --success-600: #0959a8;
            --success-700: #074887;
            --success-800: #053766;
            
            /* Ë≠¶ÂëäËâ≤ - Notion ÊüîÂíåÊ©ò */
            --warning-50: #fef8f0;
            --warning-100: #fdefd9;
            --warning-200: #fbdeb3;
            --warning-300: #f7c482;
            --warning-400: #f3a84f;
            --warning-500: #e08d2e;
            --warning-600: #c67320;
            --warning-700: #a35a19;
            --warning-800: #824713;
            
            /* ÈåØË™§Ëâ≤ - Notion ÊüîÂíåÁ¥Ö */
            --error-50: #fef5f5;
            --error-100: #fde8e8;
            --error-200: #fbd4d4;
            --error-300: #f7b3b3;
            --error-400: #f18787;
            --error-500: #e05c5c;
            --error-600: #c94545;
            --error-700: #a63636;
            --error-800: #852b2b;
            
            /* Ë≥áË®äËâ≤ - Notion ÊüîÂíåËóç */
            --info-50: #f0f7fd;
            --info-100: #dcecfa;
            --info-200: #b9d9f5;
            --info-500: #5b9dd9;
            --info-600: #4285c4;
            --info-700: #3369a0;
            
            /* ‰∏≠ÊÄßËâ≤ - Notion ÊöñÁÅ∞Èöé */
            --gray-50: #fafaf9;
            --gray-100: #f5f5f4;
            --gray-200: #e7e5e4;
            --gray-300: #d6d3d1;
            --gray-400: #a8a29e;
            --gray-500: #78716c;
            --gray-600: #57534e;
            --gray-700: #44403c;
            --gray-800: #292524;
            --gray-900: #1c1917;
            
            /* Èô∞ÂΩ±Á≥ªÁµ± */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
            --shadow-2xl: 0 25px 50px rgba(0, 0, 0, 0.25);
            --shadow-primary: 0 8px 20px rgba(102, 126, 234, 0.35);
            --shadow-success: 0 4px 12px rgba(16, 185, 129, 0.4);
            
            /* ÈñìË∑ùÁ≥ªÁµ± */
            --space-1: 0.25rem;  /* 4px */
            --space-2: 0.5rem;   /* 8px */
            --space-3: 0.75rem;  /* 12px */
            --space-4: 1rem;     /* 16px */
            --space-5: 1.25rem;  /* 20px */
            --space-6: 1.5rem;   /* 24px */
            --space-8: 2rem;     /* 32px */
            
            /* ÂúìËßíÁ≥ªÁµ± - Áµ±‰∏ÄÁÇ∫ 6px */
            --radius-sm: 6px;
            --radius-md: 6px;
            --radius-lg: 6px;
            --radius-xl: 6px;
            --radius-full: 9999px;
            
            /* ÈÅéÊ∏°ÊôÇÈñì */
            --transition-instant: 0.1s;
            --transition-fast: 0.15s;
            --transition-base: 0.3s;
            --transition-slow: 0.5s;
            --transition-slower: 0.8s;
            
            /* Á∑©ÂãïÂáΩÊï∏ - Â∞àÊ•≠Á¥ö */
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);        /* Ê®ôÊ∫ñÂπ≥Êªë */
            --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55); /* ÂΩàË∑≥ÊïàÊûú */
            --ease-snap: cubic-bezier(0.33, 1, 0.68, 1);        /* Âø´ÈÄüÂΩàÂá∫ */
            --ease-elegant: cubic-bezier(0.25, 0.46, 0.45, 0.94); /* ÂÑ™ÈõÖ */
            
            /* Ëß∏Ë¶∫ÂèçÈ•ã */
            --tap-scale: 0.95;           /* Êåâ‰∏ãÁ∏ÆÂ∞èÂà∞95% */
            --hover-scale: 1.02;         /* Êá∏ÂÅúÊîæÂ§ßÂà∞102% */
            --active-translate: 2px;     /* Êåâ‰∏ãÁßªÂãï2px */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif;
            background: #fafaf9;
            min-height: 100vh;
            padding: 0;
            line-height: 1.6;
            color: #1c1917;
        }
        
        .container {
            max-width: 680px;
            margin: 24px auto;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }
        
        .header {
            background: #ffffff;
            color: #37352f;
            padding: 32px 24px;
            text-align: center;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            border-bottom: 1px solid #e7e5e4;
        }
        
        .header::before {
            display: none;
        }
        
        .header h1 {
            font-size: 26px;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.01em;
            position: relative;
            z-index: 1;
            line-height: 1.3;
            color: #57534e;
        }
        
        .header .subtitle {
            font-size: 14px;
            color: #9b9a97;
            line-height: 1.5;
            position: relative;
            z-index: 1;
            font-weight: 400;
        }
        
        /* Êìç‰ΩúÊåâÈàïÂçÄ */
        .action-bar {
            padding: 12px 20px;
            background: #fafaf9;
            border-bottom: 1px solid #e7e5e4;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .clear-btn {
            background: white;
            color: #37352f;
            border: 1px solid #e9e9e7;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .clear-btn:hover {
            background: #f7f6f3;
        }
        
        .clear-btn:active {
            transform: translateY(0) scale(0.97);
        }
        
        .input-section {
            padding: 24px;
            background: #fafaf9;
            border-bottom: 2px solid #e7e5e4;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #57534e;
            margin-bottom: 8px;
            font-size: 14px;
            letter-spacing: 0;
            line-height: 1.5;
        }
        
        select, input[type="date"], input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            font-size: 15px;
            font-weight: 400;
            border: 1px solid #e9e9e7;
            border-radius: 6px;
            background: white;
            transition: all 0.15s ease;
            box-sizing: border-box;
            height: auto;
            line-height: 1.5;
            text-align: left;
            color: #37352f;
        }
        
        select:focus, input[type="date"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #0b6ac9;
            box-shadow: 0 0 0 1px #0b6ac9;
        }
        
        /* ‰∏∫selectÊ∑ªÂä†‰∏ãÊãâÁÆ≠Â§¥ */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2337352f' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 36px;
            cursor: pointer;
        }
        
        /* selectÁöÑoption‰πüÂ±Ö‰∏≠Ôºå‰∏¶Èò≤Ê≠¢ÊèõË°å */
        select option {
            text-align: left;
            padding: 12px 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 15px;
        }
        
        /* input[type="date"]‰πüÂ±Ö‰∏≠ */
        input[type="date"] {
            text-align: left;
        }
        
        select:hover, input[type="text"]:hover {
            background: #fafaf9;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #0b6ac9;
            box-shadow: 0 0 0 1px #0b6ac9;
        }
        
        select:active, input[type="text"]:active {
            transform: scale(0.98);
        }
        
        /* Êó•ÊúüËº∏ÂÖ•ÊåâÈàïÂ∞àÁî®Ê®£Âºè */
        .date-input-button {
            position: relative;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .date-input-button:hover {
            border-color: #5b9dd9 !important;
            transform: translateY(-1px) !important;
        }
        
        .date-input-button:active {
            transform: translateY(0) scale(0.98) !important;
        }
        
        .date-input-button::after {
            content: 'ÈªûÊìäÈáçÊñ∞ÈÅ∏Êìá';
            position: absolute;
            bottom: -22px;
            left: 0;
            font-size: 11px;
            color: var(--primary-600);
            opacity: 0;
            transition: opacity var(--transition-fast);
            pointer-events: none;
            font-weight: 500;
        }
        
        .date-input-button:hover::after {
            opacity: 1;
        }
        
        .validation-msg {
            margin-top: 10px;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .validation-msg.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #dc2626;
        }
        
        .validation-msg.success {
            background: transparent;
            color: #57534e;
            border: none;
            padding: 6px 0;
            margin-top: 16px;
            margin-bottom: 4px;
            font-weight: 400;
            line-height: 1.6;
        }
        
        .v1a-input {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-left: 4px solid #9b9a97;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .v1a-label {
            font-weight: 700;
            color: #57534e;
            margin-bottom: 16px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .v1a-label::before {
            content: 'üìã';
            font-size: 18px;
        }
        
        .suggestion-box {
            background: #fef3c7;
            border: 1px solid #57534e;
            border-radius: 6px;
            padding: 16px 20px;
            margin-bottom: 16px;
            font-size: 14px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .suggestion-label {
            font-weight: 700;
            color: #57534e;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .suggestion-value {
            color: #78350f;
            line-height: 1.6;
            font-size: 13px;
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 165px;
            width: 100%;
            text-align: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: block;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            overflow: hidden;
            letter-spacing: 0;
            line-height: 1.5;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        
        .btn:active::before {
            width: 400px;
            height: 400px;
        }
        
        .btn-primary {
            background: #0b6ac9;
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            background: #0959a8;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: none;
        }
        
        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }
        
        .btn-primary:focus {
            outline: none;
        }
        
        /* Êó•ÊúüÈÅ∏ÊìáÊåâÈàï */
        .date-selector {
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .date-selector-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            line-height: 1;
        }
        
        .date-options {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .date-option {
            flex: 1;
            min-width: 60px;
            padding: 10px 8px;
            font-size: 11px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-sm);
            background: white;
            cursor: pointer;
            transition: all var(--transition-fast) var(--ease-smooth);
            text-align: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .date-option:hover:not(.disabled) {
            border-color: var(--primary-600);
            background: var(--primary-50);
            transform: translateY(-2px) scale(1.03);
            box-shadow: var(--shadow-md);
        }
        
        .date-option:active:not(.disabled) {
            transform: translateY(0) scale(0.98);
            box-shadow: var(--shadow-xs);
        }
        
        .date-option.selected {
            background: var(--primary-600) !important;
            color: white !important;
            border-color: var(--primary-600) !important;
            font-weight: 600 !important;
            box-shadow: var(--shadow-primary) !important;
            pointer-events: auto !important;
            cursor: pointer !important;
            opacity: 1 !important;
        }
        
        .date-option.selected:hover {
            background: var(--primary-700) !important;
            border-color: var(--primary-700) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4) !important;
        }
        
        .date-option.selected:active {
            transform: translateY(0) !important;
            box-shadow: var(--shadow-primary) !important;
        }
        
        .date-option.disabled {
            background: var(--gray-50) !important;
            color: var(--gray-400) !important;
            border-color: var(--gray-300) !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
            pointer-events: none !important;
            position: relative;
        }
        
        .date-option.disabled::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(0,0,0,0.03) 5px,
                rgba(0,0,0,0.03) 10px
            );
            border-radius: var(--radius-sm);
            pointer-events: none;
        }
        
        .date-option.conflict {
            background: var(--error-50);
            color: var(--error-600);
            border-color: var(--error-300);
        }
        
        .date-option-date {
            display: block;
            font-weight: 600;
            pointer-events: none; /* ËÆìÈªûÊìä‰∫ã‰ª∂Á©øÈÄèÂà∞Áà∂ÊåâÈàï */
        }
        
        .date-option-label {
            display: block;
            font-size: 10px;
            margin-top: 2px;
            pointer-events: none; /* ËÆìÈªûÊìä‰∫ã‰ª∂Á©øÈÄèÂà∞Áà∂ÊåâÈàï */
        }
        
        .results {
            padding: 20px;
        }
        
        .results-title {
            font-size: 18px;
            font-weight: 600;
            color: #4a5fc1;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .visit-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 150ms ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        
        .visit-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: #0b6ac9;
            opacity: 0;
            transition: opacity 150ms ease;
        }
        
        .visit-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transform: translateY(-1px);
            border-color: #0b6ac9;
        }
        
        .visit-card:hover::before {
            opacity: 1;
        }
        
        .visit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .visit-name {
            font-weight: 700;
            font-size: 20px;
            color: #1f2937;
            letter-spacing: -0.01em;
            line-height: 1.3;
        }
        
        .badge {
            font-size: 12px;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 700;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            line-height: 1;
        }
        
        .badge-screening {
            background: #f5f5f4;
            color: #57534e;
            border: 1px solid #e7e5e4;
        }
        
        .badge-baseline {
            background: #f5f5f4;
            color: #57534e;
            border: 1px solid #e7e5e4;
        }
        
        .badge-treatment {
            background: #f5f5f4;
            color: #57534e;
            border: 1px solid #e7e5e4;
        }
        
        .badge-followup {
            background: #f5f5f4;
            color: #57534e;
            border: 1px solid #e7e5e4;
        }
        
        .visit-info {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 12px;
            padding: 8px 0;
            font-weight: 500;
        }
        
        .visit-date {
            background: #0b6ac9;
            color: white;
            padding: 16px 20px 16px 52px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            font-size: 17px;
            letter-spacing: -0.01em;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            margin: 16px 0;
            position: relative;
            line-height: 1.4;
        }
        
        .visit-date::before {
            content: 'üìÖ';
            position: absolute;
            left: 18px;
            font-size: 20px;
            opacity: 0.95;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .warning {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 4px solid;
            font-size: 13px;
            font-weight: 600;
        }
        
        .warning.weekend {
            background: #dcecfa;
            border-color: #5b9dd9;
            color: #1e40af;
        }
        
        .warning.holiday {
            background: #fef3c7;
            border-color: #57534e;
            color: #57534e;
        }
        
        .empty {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .notes {
            background: #fafafa;
            padding: 20px;
            margin: 20px;
            border-radius: 6px;
            border-left: 4px solid #e0e0e0;
        }
        
        .notes-title {
            font-weight: 600;
            color: #37352f;
            margin-bottom: 12px;
            font-size: 15px;
        }
        
        .notes ul {
            margin-left: 20px;
            font-size: 13px;
            color: #57534e;
            line-height: 1.9;
        }
        
        .notes li strong {
            color: #37352f;
        }
        
        /* ÊâãÊ©üÁâàÈù¢ÂÑ™Âåñ */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            .container {
                padding: 10px;
                max-width: 100%;
            }
            
            .header {
                padding: 18px 12px;
                position: relative;
            }
            
            .header h1 {
                font-size: 18px;
                margin-bottom: 6px;
            }
            
            .header .subtitle {
                font-size: 11px;
                line-height: 1.4;
            }
            
            .action-bar {
                padding: 10px 12px;
                justify-content: center;
            }
            
            .clear-btn {
                padding: 8px 16px;
                font-size: 13px;
                width: auto;
            }
            
            .form-group {
                margin-bottom: 16px;
            }
            
            .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
                display: block;
            }
            
            .form-group select,
            .form-group input[type="date"] {
                font-size: 13px;
                padding: 12px 8px;
                width: 100%;
                box-sizing: border-box;
                height: 48px;
            }
            
            .form-group select {
                padding-left: 32px;
                padding-right: 32px;
                font-size: 13px;
            }
            
            .form-group select option {
                font-size: 13px;
                padding: 10px 8px;
                white-space: nowrap;
            }
            
            /* ÊåâÈàïÁµÑ - ÂûÇÁõ¥ÊéíÂàó */
            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-top: 12px;
            }
            
            .btn-group button {
                width: 100%;
                font-size: 13px;
                padding: 12px 16px;
                white-space: normal;
                text-align: center;
                line-height: 1.4;
                min-height: 48px; /* Â¢ûÂä†ÊúÄÂ∞èÈ´òÂ∫¶ÔºåÊõ¥ÂÆπÊòìÈªûÊìä */
                word-wrap: break-word;
                box-sizing: border-box;
            }
            
            /* Âª∫Ë≠∞Ê°ÜÂÑ™Âåñ */
            .suggestion-box {
                padding: 12px;
                font-size: 12px;
                margin-top: 12px;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .suggestion-label {
                font-size: 13px;
                margin-bottom: 8px;
                font-weight: 600;
            }
            
            .suggestion-value {
                font-size: 12px;
                line-height: 1.6;
            }
            
            .v1a-label {
                font-size: 13px;
                margin-bottom: 8px;
                display: block;
                font-weight: 600;
            }
            
            /* V1a Ëº∏ÂÖ•Ê°ÜÂÑ™Âåñ */
            #v1aInput {
                font-size: 14px !important;
                padding: 12px !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* Ë®™Ë¶ñÂç°ÁâáÂÑ™Âåñ */
            .visit-card {
                padding: 16px;
                margin-bottom: 16px;
                border-radius: 6px;
            }
            
            .visit-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding-bottom: 10px;
            }
            }
            
            .visit-name {
                font-size: 18px;
                font-weight: 700;
                line-height: 1.3;
            }
            
            .visit-date {
                font-size: 16px;
                margin: 12px 0;
                padding: 14px 16px 14px 44px;
                line-height: 1.4;
            }
            
            .visit-date::before {
                font-size: 18px;
                left: 14px;
            }
            
            .visit-info {
                font-size: 13px;
                line-height: 1.6;
                font-weight: 500;
            }
            
            .badge {
                font-size: 11px;
                padding: 5px 12px;
                line-height: 1;
            }
            
            /* Ë≠¶ÂëäË®äÊÅØÂÑ™Âåñ */
            .warning {
                font-size: 12px;
                padding: 10px 12px;
                margin-top: 8px;
                line-height: 1.5;
            }
            
            .validation-msg {
                font-size: 12px;
                padding: 10px 12px;
                line-height: 1.5;
            }
            
            /* ‰ΩøÁî®Ë™™ÊòéÂÑ™Âåñ */
            .notes {
                padding: 14px;
                margin-top: 16px;
            }
            
            .notes-title {
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .notes ul {
                font-size: 12px;
                margin-left: 20px;
                line-height: 1.8;
            }
            
            .notes li {
                margin-bottom: 8px;
            }
            
            .empty {
                font-size: 13px;
                padding: 30px 16px;
            }
            
            /* Êó•ÊúüÈÅ∏ÊìáÂô®ÊâãÊ©üÂÑ™Âåñ */
            .date-selector {
                padding: 8px;
            }
            
            .date-selector-label {
                font-size: 11px;
            }
            
            .date-options {
                flex-direction: column;
                gap: 8px;
            }
            
            .date-option {
                min-width: 100%;
                padding: 10px 8px;
                font-size: 12px;
            }
            
            .date-option-date {
                font-size: 13px;
            }
            
            .date-option-label {
                font-size: 10px;
            }
            
            /* Êô∫ËÉΩÂä©ÊâãÊåâÈàïÊâãÊ©üÂÑ™Âåñ */
            button[onclick="autoAvoidHolidays()"] {
                width: 90% !important;
                padding: 14px 20px !important;
                font-size: 15px !important;
            }
            
            /* Á¢∫‰øùÊâÄÊúâ inline style ÁöÑÂÖÉÁ¥†‰πüÈüøÊáâ */
            div[style*="display: flex"] {
                flex-wrap: wrap;
            }
        }
        
        /* Ë∂ÖÂ∞èÂ±èÂπïÂÑ™Âåñ (iPhone SE Á≠â) */
        @media (max-width: 375px) {
            .container {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .action-bar {
                padding: 8px;
            }
            
            .clear-btn {
                padding: 7px 14px;
                font-size: 12px;
            }
            
            .form-group select,
            .form-group input[type="date"] {
                font-size: 13px;
                padding: 10px;
                height: 44px;
            }
            
            .form-group select {
                padding-left: 35px;
                padding-right: 35px;
            }
            
            .btn-group button {
                font-size: 12px;
                padding: 10px 14px;
                min-height: 44px;
            }
            
            .suggestion-box {
                padding: 10px;
                font-size: 11px;
            }
            
            .visit-card {
                padding: 12px;
            }
            
            .date-option {
                padding: 8px 6px;
                font-size: 11px;
            }
        }
        
        /* Toast ÈÄöÁü•Á≥ªÁµ± */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        
        .toast {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            pointer-events: auto;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        /* üé® Ê≠•È©üÊåáÁ§∫Âô®ËÑàÂãïÂãïÁï´ */
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(102, 126, 234, 0);
            }
        }
        
        .toast-success {
            border-left: 4px solid #0b6ac9;
        }
        
        .toast-error {
            border-left: 4px solid #ef4444;
        }
        
        .toast-warning {
            border-left: 4px solid #57534e;
        }
        
        .toast-info {
            border-left: 4px solid #5b9dd9;
        }
        
        .toast-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        .toast-success .toast-icon {
            background: #e9f3ff;
            color: #0b6ac9;
        }
        
        .toast-error .toast-icon {
            background: #fee2e2;
            color: #ef4444;
        }
        
        .toast-warning .toast-icon {
            background: #fef3c7;
            color: #57534e;
        }
        
        .toast-info .toast-icon {
            background: #dcecfa;
            color: #5b9dd9;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #111827;
            font-size: 14px;
        }
        
        .toast-message {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }
        
        /* ÁßªÂãïÁ´Ø Toast */
        @media (max-width: 768px) {
            .toast-container {
                top: 60px;
                right: 10px;
                left: 10px;
            }
            
            .toast {
                min-width: auto;
                width: 100%;
            }
        }
        
        /* Modal Á≥ªÁµ± */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .modal-content {
            background: white;
            border-radius: 6px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: scaleIn 0.3s ease;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .modal-icon-success {
            background: #e9f3ff;
            color: #0b6ac9;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }
        
        .modal-body {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .modal-btn-primary {
            background: #0b6ac9;
            color: white;
        }
        
        .modal-btn-primary:hover {
            background: #0959a8;
        }
        
        .modal-btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .modal-btn-secondary:hover {
            background: #e5e7eb;
        }
        
        /* ========================================
           UI ÂÖ®Èù¢ÂÑ™ÂåñÊ®£Âºè
           ======================================== */
        
        /* ÈÄ≤Â∫¶ÊåáÁ§∫Âô® */
        .progress-wrapper {
            background: white;
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .progress-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: var(--space-2);
            position: relative;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.1) 0%, 
                rgba(255,255,255,0.3) 50%, 
                rgba(255,255,255,0.1) 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, 
                var(--primary-600) 0%, 
                var(--primary-500) 50%,
                var(--primary-400) 100%);
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0;
            position: relative;
            box-shadow: 0 0 12px rgba(102, 126, 234, 0.5);
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 20px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255,255,255,0.4) 100%);
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-2);
        }
        
        .progress-text {
            font-size: 13px;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .progress-percentage {
            font-size: 14px;
            color: var(--primary-600);
            font-weight: 700;
        }
        
        /* Â¢ûÂº∑ clear-btn */
        .clear-btn {
            position: relative;
            overflow: hidden;
        }
        
        .clear-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .clear-btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .clear-btn:focus {
            outline: none;
            box-shadow: 
                0 0 0 4px var(--primary-100),
                0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* Â¢ûÂº∑Ëº∏ÂÖ•Ê°Ü */
        select:hover:not(:focus), 
        input[type="date"]:hover:not(:focus) {
            border-color: var(--primary-300);
        }
        
        /* Valid ÁãÄÊÖã */
        select.valid, 
        input[type="date"].valid {
            border-color: var(--success-500);
            background: var(--success-50);
        }
        
        /* Invalid ÁãÄÊÖã */
        select.invalid, 
        input[type="date"].invalid {
            border-color: var(--error-500);
            background: var(--error-50);
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        
        /* Â¢ûÂº∑Âç°ÁâáÊïàÊûú */
        .visit-card {
            position: relative;
        }
        
        .visit-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 6px;
            padding: 2px;
            background: linear-gradient(135deg, 
                transparent 0%, 
                var(--primary-200) 100%);
            -webkit-mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity var(--transition-base);
        }
        
        .visit-card:hover::before {
            opacity: 1;
        }
        
        /* Â¢ûÂº∑ÊåâÈàïÊïàÊûú */
        .btn-primary {
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary:focus {
            outline: none;
            box-shadow: 
                0 0 0 4px rgba(79, 70, 229, 0.2),
                0 4px 8px rgba(79, 70, 229, 0.3);
        }
        
        /* Loading ÁãÄÊÖã */
        .btn-loading {
            pointer-events: none;
            opacity: 0.7;
            position: relative;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            right: 12px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: btn-spin 0.6s linear infinite;
        }
        
        @keyframes btn-spin {
            to { transform: rotate(360deg); }
        }
        
        /* Â¢ûÂº∑ Toast */
        .toast {
            border-left: 4px solid;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.12),
                0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .toast-success {
            border-left-color: var(--success-500);
        }
        
        .toast-success .toast-icon {
            background: linear-gradient(135deg, 
                var(--success-100) 0%, 
                var(--success-200) 100%);
            color: var(--success-600);
            width: 32px;
            height: 32px;
        }
        
        .toast-error {
            border-left-color: var(--error-500);
        }
        
        .toast-error .toast-icon {
            background: linear-gradient(135deg, 
                var(--error-100) 0%, 
                var(--error-200) 100%);
            color: var(--error-600);
        }
        
        .toast-warning {
            border-left-color: var(--warning-500);
        }
        
        .toast-warning .toast-icon {
            background: linear-gradient(135deg, 
                var(--warning-100) 0%, 
                var(--warning-200) 100%);
            color: var(--warning-600);
        }
        
        /* Êô∫ËÉΩÊèêÁ§∫Âç°Áâá */
        .smart-tip {
            background: linear-gradient(135deg, 
                var(--primary-50) 0%, 
                #f0f4ff 100%);
            border: 2px solid var(--primary-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            display: flex;
            gap: var(--space-3);
            animation: slideInUp 0.5s ease;
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(20px);
                opacity: 0;
            }
        }
        
        .smart-tip-icon {
            font-size: 24px;
            flex-shrink: 0;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .smart-tip-content {
            flex: 1;
        }
        
        .smart-tip-title {
            font-weight: 600;
            color: var(--primary-700);
            margin-bottom: var(--space-1);
            font-size: 14px;
        }
        
        .smart-tip-message {
            font-size: 13px;
            color: var(--primary-600);
            line-height: 1.6;
        }
        
        /* Ë≥áË®äÂç°Áâá */
        .info-card {
            background: #f0f7fd;
            border: 1px solid #93c5fd;
            border-left: 3px solid #5b9dd9;
            border-radius: 6px;
            padding: 16px 20px;
            margin: 16px 0;
            display: flex;
            gap: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .info-card-icon {
            font-size: 22px;
            flex-shrink: 0;
            line-height: 1;
        }
        
        .info-card-content {
            flex: 1;
        }
        
        .info-card-title {
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 8px;
            font-size: 15px;
            line-height: 1.4;
        }
        
        .info-card-text {
            font-size: 13px;
            color: #5b9dd9;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        
        .info-card-text:last-child {
            margin-bottom: 0;
        }
        
        .info-card-highlight {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--info-700);
            font-weight: 500;
            border-left: 3px solid var(--info-500);
        }
        
        /* Á©∫ÁãÄÊÖã */
        .empty-state {
            text-align: center;
            padding: var(--space-8) var(--space-5);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 2px dashed var(--gray-300);
            margin: var(--space-5) 0;
        }
        
        .empty-icon {
            font-size: 72px;
            margin-bottom: var(--space-4);
            opacity: 0.6;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }
        
        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-2);
        }
        
        .empty-message {
            font-size: 14px;
            color: var(--gray-500);
            line-height: 1.6;
            max-width: 400px;
            margin: 0 auto;
        }
        
        /* È†ÅÈù¢Âä†ËºâÂô® */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        .page-loader.hide {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary-100);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loader-text {
            margin-top: var(--space-4);
            color: var(--gray-600);
            font-weight: 500;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Ëá™ÂÆöÁæ©ÊªæÂãïÊ¢ù */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--gray-100);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-300);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-400);
        }
        
        /* Focus ÂèØË¶ãÊÄß */
        *:focus-visible {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
        }
        
        /* ÈÅ∏ÊìáÊñáÂ≠óÈ°èËâ≤ */
        ::selection {
            background: var(--primary-200);
            color: var(--primary-900);
        }
        
        /* üì± ÈüøÊáâÂºèÂÑ™Âåñ - ÂÖ®Èù¢Âº∑Âåñ */
        @media (max-width: 768px) {
            /* ÂÆπÂô®ÂÑ™Âåñ */
            .container {
                padding: 12px;
                max-width: 100%;
            }
            
            /* Ê®ôÈ°åÂÑ™Âåñ */
            .header {
                padding: 20px 16px;
            }
            
            .title {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 13px;
            }
            
            /* ÈÄ≤Â∫¶Ê¢ùÂÑ™Âåñ */
            .progress-wrapper {
                padding: var(--space-3);
            }
            
            .progress-bar {
                height: 8px;
            }
            
            /* Ê≠•È©üÊåáÁ§∫Âô®ÂÑ™Âåñ */
            .step-item {
                min-width: 80px !important;
                padding: 6px !important;
            }
            
            .step-item > div:first-child {
                font-size: 20px !important;
            }
            
            .step-item > div:last-child {
                font-size: 11px !important;
            }
            
            /* Ë°®ÂñÆÂÑ™Âåñ */
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                font-size: 15px !important;
            }
            
            /* Ëº∏ÂÖ•Ê°ÜÂÑ™Âåñ */
            select, input[type="text"], .date-input-button {
                font-size: 16px !important;  /* Èò≤Ê≠¢iOSÁ∏ÆÊîæ */
                min-height: 48px !important;
                padding: 12px 16px !important;
            }
            
            /* ÊåâÈàïÂÑ™Âåñ */
            .btn, .v2-suggestion-btn {
                min-height: 48px !important;
                font-size: 15px !important;
                padding: 12px 16px !important;
                border-radius: 6px !important;
            }
            
            /* ToastÂÑ™Âåñ */
            .toast {
                min-width: auto;
                width: calc(100% - 32px);
                max-width: none;
                margin: 0 16px;
            }
            
            /* VisitÂç°ÁâáÂÑ™Âåñ */
            .visit-card {
                padding: 16px;
                margin: 12px 0;
            }
            
            .visit-card:hover {
                transform: translateY(-2px);
            }
            
            .visit-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .visit-name {
                font-size: 16px;
            }
            
            .visit-date {
                font-size: 18px;
            }
            
            /* ÊúàÊõÜÂúñ‰æãÂÑ™Âåñ */
            .legend-item {
                font-size: 11px !important;
                padding: 6px 10px !important;
            }
            
            /* ÊúÄÁµÇÊëòË¶ÅÂÑ™Âåñ */
            #finalSummary {
                margin: 20px 12px;
                padding: 16px;
            }
            
            #finalSummaryContent {
                font-size: 14px;
                line-height: 2;
            }
            
            /* Êó•ÊõÜÂΩàÁ™óÂÑ™Âåñ */
            #datePickerOverlay {
                padding: 12px !important;
            }
            
            .calendar-day {
                height: 44px !important;
                font-size: 15px !important;
            }
            
            /* ÂãïÁï´ÊÄßËÉΩÂÑ™Âåñ */
            * {
                animation-duration: 0.3s !important;
                transition-duration: 0.3s !important;
            }
            
            /* Èö±Ëóè‰∏çÂøÖË¶ÅÂÖÉÁ¥† */
            .action-bar {
                position: sticky;
                top: 0;
                z-index: 100;
                background: white;
                padding: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
        }
        
        /* üì± Â∞èÂ±èÂπïÂÑ™Âåñ (< 480px) */
        @media (max-width: 480px) {
            .step-item {
                min-width: 70px !important;
            }
            
            .step-item > div:last-child {
                font-size: 10px !important;
            }
            
            /* Èö±ËóèÁÆ≠È†≠ */
            .step-item + div {
                display: none;
            }
        }
        
        /* ÈÅéÊ∏°ÂãïÁï´ÊÄßËÉΩÂÑ™Âåñ */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* ========================================
           üé® È†ÇÁ¥öË®≠Ë®àÁ≥ªÁµ± - Ê•µËá¥Ë≥™ÊÑü
           ======================================== */
        
        /* Ê≠•È©üÂÆπÂô® */
        .step-item {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 6px;
            background: #ffffff !important;
            border: 1px solid #e8e8e8 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04) !important;
        }
        
        .step-item:hover {
            border-color: #d0d0d0 !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06) !important;
        }
        
        /* Ê≠•È©üÊï∏Â≠óÂúìÂúà */
        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f8f8f8 !important;
            border: none !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 600 !important;
            color: #a0a0a0 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: none !important;
        }
        
        /* Ê≠•È©üÊñáÂ≠ó */
        .step-label {
            font-size: 15px;
            font-weight: 500 !important;
            color: #555 !important;
            white-space: nowrap;
            letter-spacing: -0.02em;
        }
        
        /* Áï∂ÂâçÊ≠•È©üÔºöËóçËâ≤Êº∏Â±§ */
        .step-item.active {
            background: linear-gradient(135deg, #0b6ac9 0%, #0959a8 100%) !important;
            border-color: transparent !important;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.25) !important;
        }
        
        .step-item.active .step-number {
            background: rgba(255, 255, 255, 0.25) !important;
            color: white !important;
        }
        
        .step-item.active .step-label {
            color: white !important;
            font-weight: 600 !important;
        }
        
        /* ÂÆåÊàêÊ≠•È©üÔºöÁ¥îËâ≤ÂÑ™ÈõÖ */
        .step-item.completed {
            background: #ffffff !important;
            border-color: #0b6ac9 !important;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.12) !important;
        }
        
        .step-item.completed .step-number {
            background: #0b6ac9 !important;
            color: transparent !important;
            position: relative;
        }
        
        .step-item.completed .step-number::before {
            content: '‚úì';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-weight: 700;
            color: white !important;
        }
        
        .step-item.completed .step-label {
            color: #0b6ac9 !important;
            font-weight: 600 !important;
        }
        
        /* ÈÄ≤Â∫¶Ê¢ùÔºöÁèæ‰ª£Êº∏Â±§ */
        .progress-fill {
            background: linear-gradient(90deg, #0b6ac9 0%, #0959a8 100%);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        /* ÈÄ≤Â∫¶Ê¢ùÂÆπÂô®ÂÑ™Âåñ */
        .progress-bar {
            background: #f5f5f5 !important;
            border-radius: 6px !important;
            overflow: hidden;
            height: 6px !important;
        }
            font-weight: 700 !important;
        }
        
        /* ÈÄ≤Â∫¶Ê¢ù */
        .progress-fill {
            background: #5b9dd9;
            transition: width 0.5s ease;
        }
        
        /* Âç°ÁâáÊªëÂÖ•ÂãïÁï´ */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-group {
            animation: slideInUp 0.4s ease-out;
        }
        
        .form-group:nth-child(1) { animation-delay: 0s; }
        .form-group:nth-child(2) { animation-delay: 0.1s; }
        .form-group:nth-child(3) { animation-delay: 0.2s; }
        .form-group:nth-child(4) { animation-delay: 0.3s; }
        
        /* ÊåâÈàïÈªûÊìäÂèçÈ•ã */
        .btn:active, .v2-suggestion-btn:active {
            transform: scale(0.95);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Êá∏ÂÅú‰∏äÊµÆÊïàÊûú */
        .btn:hover, .v2-suggestion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        /* Ëº∏ÂÖ•Ê°ÜËÅöÁÑ¶ÂãïÁï´ */
        input:focus, select:focus {
            transform: scale(1.01);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            transition: all 0.2s ease;
        }
        
        /* VisitÂç°ÁâáÂá∫ÁèæÂãïÁï´ */
        .visit-card {
            animation: slideInUp 0.5s ease-out;
        }
        
        /* Ëá™ÂÆöÁæ©Êó•ÊõÜÈÅ∏ÊìáÂô®ÂãïÁï´ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        @keyframes zoomIn {
            from { 
                opacity: 0;
                transform: scale(0.8);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* üé® Âø´ÈÄüÂãùÂà©ÂÑ™ÂåñÂãïÁï´ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
                transform: scale(1.02);
            }
        }
        
        .step-complete {
            background: linear-gradient(135deg, #0b6ac9 0%, #0959a8 100%) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .step-complete > div {
            color: white !important;
        }
        
        .step-current {
            animation: pulse 2s infinite;
            border: 2px solid #0b6ac9;
            background: #f0f7fd !important;
        }
        
        .focus-hint {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <!-- Toast ÈÄöÁü•ÂÆπÂô® -->
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="container">
        <div class="header">
            <h1>BRM411 Ë®™Ë¶ñË®àÁÆóÂô®</h1>
            <p class="subtitle">Ëá®Â∫äË©¶È©óË®™Ë¶ñÊó•ÊúüË¶èÂäÉÂ∑•ÂÖ∑</p>
        </div>
        
        <!-- Êìç‰ΩúÊåâÈàïÂçÄ -->
        <div class="action-bar">
            <button class="clear-btn" onclick="clearAll()">‚Ü∫ Ê∏ÖÁ©∫ÈáçË®≠</button>
        </div>
        
        <!-- üé® Ê•µÁ∞°ÈÄ≤Â∫¶ÊåáÁ§∫Âô® -->
        <div class="progress-wrapper">
            <!-- Ê•µÁ∞°Ê≠•È©üÊ¢ù -->
            <div style="margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 8px; max-width: 600px; margin: 0 auto;">
                    <!-- Step 1 -->
                    <div class="step-item" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-label">ÂèóË©¶ËÄÖ</div>
                    </div>
                    
                    <!-- Arrow -->
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0; opacity: 0.3;">
                        <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    
                    <!-- Step 2 -->
                    <div class="step-item" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-label">Visit 1</div>
                    </div>
                    
                    <!-- Arrow -->
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0; opacity: 0.3;">
                        <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    
                    <!-- Step 3 -->
                    <div class="step-item" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-label">Visit 2</div>
                    </div>
                </div>
            </div>
            
            <!-- Ê•µÁ∞°ÈÄ≤Â∫¶Ê¢ù -->
            <div style="max-width: 600px; margin: 0 auto;">
                <div style="height: 6px; background: #f3f4f6; border-radius: 6px; overflow: hidden;">
                    <div id="progressFill" style="height: 100%; background: #0b6ac9; width: 0%; transition: width 0.5s ease;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                    <span id="progressText" style="font-size: 12px; color: #6b7280; font-weight: 500;">0/3 ÂÆåÊàê</span>
                    <span id="progressPercentage" style="font-size: 12px; color: #0b6ac9; font-weight: 700;">0%</span>
                </div>
            </div>
        </div>
        
        <div class="input-section">
            <div class="form-group">
                <label style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">ÂèóË©¶ËÄÖÈ°ûÂûã</label>
                <select id="subjectType" onchange="toggleDrugSelection(); validateDates(); updateProgress();">
                    <option value="">-- Ë´ãÈÅ∏Êìá --</option>
                    <option value="naive">Naive Êú™Áî®Ëó•ÂèóË©¶ËÄÖ</option>
                    <option value="washout">Washout Ê¥óÈô§ÊúüÂèóË©¶ËÄÖ</option>
                </select>
            </div>
            
            <div class="form-group" id="drugTypeGroup" style="display: none;">
                <label style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">ÈúÄÊ¥óÈô§ÁöÑËó•Áâ©È°ûÂûã</label>
                <select id="drugType" onchange="visit1aDate=''; calculateV2Suggestion(); validateDates(); updateProgress();">
                    <option value="">-- Ë´ãÈÅ∏ÊìáËó•Áâ©È°ûÂûã --</option>
                    <option value="28">Prostaglandins / Œ≤-blockers / Kinase inhibitors (28 Â§©)</option>
                    <option value="14">Adrenergic agonists (14 Â§©)</option>
                    <option value="7">Muscarinic agonists / Carbonic anhydrase inhibitors (7 Â§©)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Visit 1 Êó•Êúü (ÁØ©ÈÅ∏Êó•)</label>
                <div style="position: relative;">
                    <input type="text" 
                           id="visit1" 
                           readonly
                           onclick="showCustomDatePicker('visit1'); return false;"
                           placeholder="ÈªûÊìäÈÅ∏ÊìáÊó•Êúü"
                           class="date-input-button"
                           style="cursor: pointer !important; background: white !important; font-size: 16px; font-weight: 500; padding: 14px; border: 2px solid #d1d5db; border-radius: 6px; height: 52px; width: 100%; box-sizing: border-box; pointer-events: auto !important; color: #374151; transition: all 150ms ease; text-align: center;"
                           onchange="updateDateInputDisplay('visit1'); checkDateWarning('visit1'); calculateV2Suggestion(); validateDates(); if(visit1aDate) validateV1a(); checkV2EarlyWarning(); updateProgress();">
                </div>
                <div id="visit1Warning"></div>
            </div>
            
            <div class="form-group">
                <label style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Visit 2 Êó•Êúü (Âü∫Á∑öÊó•/Èö®Ê©üÂàÜÈÖçÊó•)</label>
                <div style="position: relative;">
                    <input type="text" 
                           id="visit2"
                           readonly
                           onclick="showCustomDatePicker('visit2'); return false;"
                           placeholder="ÈªûÊìäÈÅ∏ÊìáÊó•Êúü"
                           class="date-input-button"
                           style="cursor: pointer !important; background: white !important; font-size: 16px; font-weight: 500; padding: 14px; border: 2px solid #d1d5db; border-radius: 6px; height: 52px; width: 100%; box-sizing: border-box; pointer-events: auto !important; color: #374151; transition: all 150ms ease; text-align: center;"
                           onchange="updateDateInputDisplay('visit2'); checkDateWarning('visit2'); checkV2EarlyWarning(); calculateV2Suggestion(); validateDates(); if(visit1aDate) validateV1a(); updateProgress(); setTimeout(function() { checkAllVisitsHolidays(); smoothScrollToResults(); }, 600);">
                </div>
                <div id="visit2Warning"></div>
                <div id="v2EarlyWarning"></div>
                <div id="v2Suggestion"></div>
            </div>
            
            <!-- V1-V2 ÈñìÈöîÈ©óË≠â -->
            <div id="validation"></div>
            
            <!-- Âç≥ÊôÇÊèêÈÜíÊ°Ü - ÁßªÂà∞ V1a ‰πãÂâç -->
            <div id="allVisitsHolidayWarning" style="margin: 20px 0;"></div>
            
            <!-- V1aÂª∫Ë≠∞Ë®™Ë¶ñÊó•Êúü -->
            <div id="v1aSuggestion"></div>
        </div>
        
        <div class="results">
            <h2 class="results-title">Ë®™Ë¶ñÊéíÁ®ãÁ∏ΩË¶Ω</h2>
            
            <!-- V3~V6 Ë™™ÊòéÂç°Áâá -->
            <!-- üé® ÁßªÈô§Ë™™ÊòéÊ°ÜÔºåÊîπÁî®Âúñ‰æãË™™Êòé -->
            
            <div id="output"></div>
        </div>
        
        <!-- üèÜ ÊúÄÁµÇË®™Ë¶ñÊó•ÊúüÊëòË¶ÅÔºàÊîæÂú®ÊúÄÂæåÔºâ -->
        <div id="finalSummary" style="display: none; margin: 32px 20px; padding: 24px; background: #ffffff; border: 2px solid #e0e0e0; border-radius: 6px;">
            <h3 style="margin: 0 0 20px 0; font-size: 20px; font-weight: 600; color: #37352f; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">üìã</span>
                <span>ÊúÄÁµÇË®™Ë¶ñÊó•Êúü</span>
            </h3>
            <div id="finalSummaryContent" style="font-size: 15px; line-height: 2.2; color: #37352f; font-weight: 400; padding: 20px; background: #fafafa; border-radius: 6px; margin-bottom: 16px;"></div>
            <button onclick="copyFinalDates()" style="width: 100%; padding: 14px 20px; background: #37352f; color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#57534e'" onmouseout="this.style.background='#37352f'">
                üìã Ë§áË£ΩÂÖ®ÈÉ®Êó•ÊúüÂà∞Ââ™Ë≤ºÁ∞ø
            </button>
        </div>
        
        <div class="notes">
            <div class="notes-title">‰ΩøÁî®Ë™™Êòé</div>
            <ul>
                <li><strong>Step 1:</strong> ÈÅ∏ÊìáÂèóË©¶ËÄÖÈ°ûÂûã</li>
                <li><strong>Step 2:</strong> Â¶ÇÈÅ∏Êìá WashoutÔºåÈúÄÈÅ∏ÊìáËó•Áâ©È°ûÂûãÔºàÊ±∫ÂÆöÊ¥óÈô§ÊúüÈï∑Â∫¶Ôºâ</li>
                <li><strong>Step 3:</strong> Ëº∏ÂÖ• Visit 1 Êó•ÊúüÔºàÁØ©ÈÅ∏Êó•ÊúüÔºâ</li>
                <li><strong>Step 4:</strong> Ëº∏ÂÖ• Visit 2 Êó•ÊúüÔºàÂü∫Á∑öÊó•ÊúüÔºâ</li>
                <li><strong>Step 5:</strong> ÈÅ∏Êìá Visit 1a Êó•Êúü</li>
                <li><strong>Ê¥óÈô§ÊúüÈï∑Â∫¶Ôºö</strong>
                    <ul style="margin-top: 5px;">
                        <li>Prostaglandins / Œ≤-blockers / Kinase inhibitors: 28 Â§©</li>
                        <li>Adrenergic agonists: 14 Â§©</li>
                        <li>Muscarinic agonists / Carbonic anhydrase inhibitors: 7 Â§©</li>
                    </ul>
                </li>
                <li><strong>ÈóúÈçµÂ∑ÆÁï∞Ôºö</strong>
                    <ul style="margin-top: 5px;">
                        <li><strong>Naive:</strong> V1a ÂèØÂú® V1 Âíå V2 ‰πãÈñì‰ªªÈÅ∏ÔºàÈÄöÂ∏∏Ëàá V1 ÂêåÂ§©Ôºâ</li>
                        <li><strong>Washout:</strong> V1a ÂøÖÈ†àÂú® V2 Ââç 1-7 Â§©ÔºàDay -7 to -1Ôºâ</li>
                    </ul>
                </li>
                <li><strong>Naive:</strong> V1 Âà∞ V2 ÈúÄË¶Å 1-35 Â§©ÔºåV1 Âíå V1a ÈÄöÂ∏∏Âêå‰∏ÄÂ§©</li>
                <li><strong>Washout:</strong> V1 Âà∞ V2 ÊúÄÂ§ö 35 Â§©ÔºåV1 Âà∞ V1a Ëá≥Â∞ë = ÊúÄÂ∞èÊ¥óÈô§ÊúüÔºåV1a Âà∞ V2 ÈúÄ 1-7 Â§©</li>
                <li>‚ö†Ô∏è <strong>Âç≥ÊôÇÊèêÈÜíÔºö</strong>Ëº∏ÂÖ•Êó•ÊúüÂæåÁ´ãÂç≥Ê™¢Êü•ÈÄ±Êú´ÂíåÂè∞ÁÅ£ÂúãÂÆöÂÅáÊó•Ôºà2025-2027Ôºâ</li>
                <li>üéØ <strong>Êô∫ËÉΩÂª∫Ë≠∞Ôºö</strong>Á≥ªÁµ±Ëá™ÂãïÊèê‰æõ„ÄåÈÅøÈñãÂÅáÊó•„ÄçÊåâÈàïÔºåÂø´ÈÄüÈÅ∏ÊìáÂ∑•‰ΩúÊó•</li>
            </ul>
        </div>
    </div>
    
    <script>
        // ============================================
        // üèÜ Âø´ÈÄüÂãùÂà©ÂÑ™ÂåñÔºöÈÄ≤Â∫¶ËøΩËπ§Á≥ªÁµ±
        // ============================================
        function updateProgress() {
            var type = document.getElementById('subjectType').value;
            var v1 = document.getElementById('visit1').value;
            var v2 = document.getElementById('visit2').value;
            var drugType = document.getElementById('drugType') ? document.getElementById('drugType').value : null;
            
            var step1 = document.getElementById('step1');
            var step2 = document.getElementById('step2');
            var step3 = document.getElementById('step3');
            var progressFill = document.getElementById('progressFill');
            var progressText = document.getElementById('progressText');
            var progressPercentage = document.getElementById('progressPercentage');
            
            var completed = 0;
            var total = 3;
            
            // ÈáçÁΩÆÊâÄÊúâÁãÄÊÖã
            [step1, step2, step3].forEach(function(step) {
                step.className = 'step-item';
            });
            
            // Ê™¢Êü•Ê≠•È©ü1ÔºöÂèóË©¶ËÄÖÈ°ûÂûã
            if (type) {
                step1.classList.add('completed');
                completed++;
                
                // Â¶ÇÊûúÊòØWashoutÔºåÊ™¢Êü•Ëó•Áâ©È°ûÂûã
                if (type === 'washout' && !drugType) {
                    // Ëó•Áâ©È°ûÂûãÊú™ÈÅ∏ÔºåË¶ñÁÇ∫Êú™ÂÆåÊàê
                    completed--;
                }
            } else {
                step1.classList.add('active');
            }
            
            // Ê™¢Êü•Ê≠•È©ü2ÔºöV1
            if (v1) {
                if (type) {
                    step2.classList.add('completed');
                    completed++;
                } else {
                    step2.classList.add('active');
                }
            } else if (type && (type !== 'washout' || drugType)) {
                step2.classList.add('active');
                // Ê∑ªÂä†‰∏ã‰∏ÄÊ≠•ÊèêÁ§∫
                var v1FormGroup = document.getElementById('visit1').closest('.form-group');
                if (v1FormGroup) {
                    v1FormGroup.classList.add('next-step');
                }
            }
            
            // Ê™¢Êü•Ê≠•È©ü3ÔºöV2
            if (v2) {
                if (v1) {
                    step3.classList.add('completed');
                    completed++;
                } else {
                    step3.classList.add('active');
                }
            } else if (v1) {
                step3.classList.add('active');
                // Ê∑ªÂä†‰∏ã‰∏ÄÊ≠•ÊèêÁ§∫
                var v2FormGroup = document.getElementById('visit2').closest('.form-group');
                if (v2FormGroup) {
                    v2FormGroup.classList.add('next-step');
                }
            }
            
            // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù
            var percentage = Math.round((completed / total) * 100);
            progressFill.style.width = percentage + '%';
            progressText.textContent = completed + '/' + total + ' ÂÆåÊàê';
            progressPercentage.textContent = percentage + '%';
            
            // ÁßªÈô§ËàäÁöÑnext-stepÈ°û
            document.querySelectorAll('.form-group').forEach(function(fg) {
                if (!fg.querySelector('#visit1') && !fg.querySelector('#visit2')) {
                    fg.classList.remove('next-step');
                }
            });
        }
        
        // Âú®È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress();
        });
        
        // ============================================
        // Toast ÈÄöÁü•Á≥ªÁµ±
        // ============================================
        function showToast(type, title, message) {
            // Èò≤Ê≠¢Áü≠ÊôÇÈñìÂÖßÈáçË§áÈ°ØÁ§∫Áõ∏ÂêåË®äÊÅØ
            var messageKey = type + ':' + title + ':' + message;
            var now = Date.now();
            
            if (messageKey === lastToastMessage && now - lastToastTime < toastCooldown) {
                console.log('ToastÂÜ∑Âçª‰∏≠ÔºåË∑≥ÈÅéÁõ∏ÂêåË®äÊÅØ');
                return;
            }
            
            lastToastMessage = messageKey;
            lastToastTime = now;
            
            var container = document.getElementById('toastContainer');
            
            var icons = {
                'success': '‚úì',
                'error': '‚úï',
                'warning': '!',
                'info': 'i'
            };
            
            var toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.innerHTML = 
                '<div class="toast-icon">' + icons[type] + '</div>' +
                '<div class="toast-content">' +
                    '<div class="toast-title">' + title + '</div>' +
                    (message ? '<div class="toast-message">' + message + '</div>' : '') +
                '</div>';
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊúâÁõ∏ÂêåÂÖßÂÆπÁöÑToastÊ≠£Âú®È°ØÁ§∫
            var existingToasts = container.querySelectorAll('.toast');
            for (var i = 0; i < existingToasts.length; i++) {
                var existingTitle = existingToasts[i].querySelector('.toast-title');
                if (existingTitle && existingTitle.textContent === title) {
                    console.log('Â∑≤ÊúâÁõ∏ÂêåToastÂú®È°ØÁ§∫ÔºåË∑≥ÈÅé');
                    return;
                }
            }
            
            // ÈôêÂà∂ÊúÄÂ§öÈ°ØÁ§∫3ÂÄãToast
            if (existingToasts.length >= 3) {
                // ÁßªÈô§ÊúÄËàäÁöÑToast
                var oldestToast = existingToasts[0];
                if (oldestToast && oldestToast.parentNode) {
                    oldestToast.parentNode.removeChild(oldestToast);
                }
            }
            
            container.appendChild(toast);
            
            // 5ÁßíÂæåËá™ÂãïÊ∂àÂ§±
            setTimeout(function() {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(function() {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }
        
        // ============================================
        // Modal ÂΩàÁ™óÁ≥ªÁµ±
        // ============================================
        function showModal(type, title, message, onConfirm) {
            // Èò≤Ê≠¢ÈáçË§áÂΩàÁ™óÔºàÂÜ∑ÂçªÊôÇÈñìÊ™¢Êü•Ôºâ
            var now = Date.now();
            if (now - lastModalTime < modalCooldown) {
                console.log('ModalÂÜ∑Âçª‰∏≠ÔºåË∑≥ÈÅéÂΩàÂá∫');
                return;
            }
            lastModalTime = now;
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊúâModalÂú®È°ØÁ§∫
            if (document.querySelector('.modal-overlay')) {
                console.log('Â∑≤ÊúâModalÂú®È°ØÁ§∫ÔºåË∑≥ÈÅé');
                return;
            }
            
            var icons = {
                'success': '‚úì',
                'error': '‚úï',
                'warning': '!',
                'info': 'i'
            };
            
            var iconClass = 'modal-icon modal-icon-' + type;
            
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    closeModal();
                }
            };
            
            var modal = document.createElement('div');
            modal.className = 'modal-content';
            modal.innerHTML = 
                '<div class="modal-header">' +
                    '<div class="' + iconClass + '">' + icons[type] + '</div>' +
                    '<div class="modal-title">' + title + '</div>' +
                '</div>' +
                '<div class="modal-body">' + message + '</div>' +
                '<div class="modal-footer">' +
                    '<button class="modal-btn modal-btn-primary" onclick="closeModal(); ' + (onConfirm ? 'modalConfirmCallback();' : '') + '">Á¢∫ÂÆö</button>' +
                '</div>';
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // ‰øùÂ≠òÂõûË™øÂáΩÊï∏
            if (onConfirm) {
                window.modalConfirmCallback = onConfirm;
            }
            
            // ESCÈçµÈóúÈñâ
            var escHandler = function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        function closeModal() {
            var overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.style.animation = 'fadeOut 0.2s ease';
                setTimeout(function() {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 200);
            }
        }
        
        // ============================================
        // ÂÅáÊó•Ë≥áÊñô
        // ============================================
        
        // Èò≤Ê≠¢ÈáçË§áÂΩàÁ™óÁöÑÊ®ôÂøó
        var lastModalTime = 0;
        var modalCooldown = 1000; // 1ÁßíÂÜ∑ÂçªÊôÇÈñì
        
        // Èò≤Ê≠¢ToastÈáçË§áÁöÑÊ®ôÂøó
        var lastToastMessage = '';
        var lastToastTime = 0;
        var toastCooldown = 2000; // 2ÁßíÂÖß‰∏çÈ°ØÁ§∫Áõ∏ÂêåË®äÊÅØ
        var hasShownGeneratedToast = false; // Èò≤Ê≠¢„ÄåÂ∑≤ÁîüÊàê„ÄçToastÈáçË§áÈ°ØÁ§∫
        
        // Working weekends (Ë£úÁè≠Êó• - weekends that are working days)
        var workingWeekends = {
            '2025': [
                '01-04', // Ë£ú 1/28 (Êò•ÁØÄË™øÊï¥)
                '02-08'  // Ë£ú 2/3 (Êò•ÁØÄË™øÊï¥)
            ],
            '2026': [
                // 2026Âπ¥Ëµ∑Âè∞ÁÅ£ÂÖ®Èù¢ÂèñÊ∂àË£úÁè≠Êó•Âà∂Â∫¶
                // Êò•ÁØÄÈÄ£ÂÅá9Â§©Ôºà2/14ÂÖ≠-2/22Êó•Ôºâ‰∏çÈúÄË£úÁè≠
            ],
            '2027': [
                '01-23', // Ë£ú 1/29 (Êò•ÁØÄË™øÊï¥)
                '02-27'  // Ë£ú 3/1 (ÂíåÂπ≥Á¥ÄÂøµÊó•Ë™øÊï¥)
            ]
        };
        
        var holidays = {
            '2025': {
                '01-01': 'ÂÖÉÊó¶',
                '01-28': 'Êò•ÁØÄ(Èô§Â§ï)', '01-29': 'Êò•ÁØÄ(Âàù‰∏Ä)', '01-30': 'Êò•ÁØÄ(Âàù‰∫å)',
                '01-31': 'Êò•ÁØÄ(Âàù‰∏â)', '02-01': 'Êò•ÁØÄ(ÂàùÂõõ)', '02-02': 'Êò•ÁØÄ(Âàù‰∫î)', '02-03': 'Êò•ÁØÄ(ÂàùÂÖ≠)',
                '02-28': 'ÂíåÂπ≥Á¥ÄÂøµÊó•',
                '04-03': 'ÂÖíÁ´•ÁØÄ', '04-04': 'Ê∏ÖÊòéÁØÄ', '04-05': 'Ê∏ÖÊòéÁØÄË£úÂÅá', '04-06': 'ÂÖíÁ´•ÁØÄË£úÂÅá',
                '05-01': 'ÂãûÂãïÁØÄ',
                '05-31': 'Á´ØÂçàÁØÄ', '06-02': 'Á´ØÂçàÁØÄË£úÂÅá',
                '10-06': '‰∏≠ÁßãÁØÄ', '10-07': '‰∏≠ÁßãÁØÄË£úÂÅá',
                '10-10': 'ÂúãÊÖ∂Êó•', '10-11': 'ÂúãÊÖ∂Êó•Ë£úÂÅá',
                '12-25': 'Ë°åÊÜ≤Á¥ÄÂøµÊó•'
            },
            '2026': {
                '01-01': 'ÂÖÉÊó¶',
                // Êò•ÁØÄÈÄ£ÂÅá9Â§©Ôºà2/14ÂÖ≠-2/22Êó•Ôºâ- 2026Âπ¥ÂÖçË£úÁè≠
                '02-14': 'Êò•ÁØÄÈÄ£ÂÅá', '02-15': 'Êò•ÁØÄÈÄ£ÂÅá', '02-16': 'Êò•ÁØÄ(Èô§Â§ï)', 
                '02-17': 'Êò•ÁØÄ(Âàù‰∏Ä)', '02-18': 'Êò•ÁØÄ(Âàù‰∫å)', '02-19': 'Êò•ÁØÄ(Âàù‰∏â)', 
                '02-20': 'Êò•ÁØÄ(ÂàùÂõõ)', '02-21': 'Êò•ÁØÄ(Âàù‰∫î)', '02-22': 'Êò•ÁØÄÈÄ£ÂÅá',
                '02-27': 'ÂíåÂπ≥Á¥ÄÂøµÊó•Ë£úÂÅá', '02-28': 'ÂíåÂπ≥Á¥ÄÂøµÊó•',
                '03-01': 'ÂíåÂπ≥Á¥ÄÂøµÊó•ÂÅá',
                '04-03': 'ÂÖíÁ´•ÁØÄË£úÂÅá', '04-04': 'ÂÖíÁ´•ÁØÄ', '04-05': 'Ê∏ÖÊòéÁØÄ', '04-06': 'Ê∏ÖÊòéÁØÄË£úÂÅá',
                '05-01': 'ÂãûÂãïÁØÄ', '05-02': 'ÂãûÂãïÁØÄË£úÂÅá', '05-03': 'ÂãûÂãïÁØÄË£úÂÅá',
                '06-19': 'Á´ØÂçàÁØÄ', '06-20': 'Á´ØÂçàÁØÄÂΩàÊÄßÊîæÂÅá', '06-21': 'Á´ØÂçàÁØÄË£úÂÅá',
                '09-25': '‰∏≠ÁßãÁØÄË£úÂÅá', '09-26': '‰∏≠ÁßãÁØÄË£úÂÅá', '09-27': '‰∏≠ÁßãÁØÄ', '09-28': '‰∏≠ÁßãÁØÄË£úÂÅá',
                '10-09': 'ÂúãÊÖ∂Êó•ÂΩàÊÄßÊîæÂÅá', '10-10': 'ÂúãÊÖ∂Êó•', '10-11': 'ÂúãÊÖ∂Êó•Ë£úÂÅá',
                '10-24': 'ÂÖâÂæ©ÁØÄË£úÂÅá', '10-25': 'ÂÖâÂæ©ÁØÄ', '10-26': 'ÂÖâÂæ©ÁØÄË£úÂÅá',
                '12-25': 'Ë°åÊÜ≤Á¥ÄÂøµÊó•', '12-26': 'Ë°åÊÜ≤Á¥ÄÂøµÊó•Ë£úÂÅá', '12-27': 'Ë°åÊÜ≤Á¥ÄÂøµÊó•Ë£úÂÅá'
            },
            '2027': {
                '01-01': 'ÂÖÉÊó¶', '01-02': 'ÂÖÉÊó¶Ë£úÂÅá', '01-03': 'ÂÖÉÊó¶Ë£úÂÅá',
                '02-04': 'Êò•ÁØÄ(ÂΩàÊÄßÊîæÂÅá)', '02-05': 'Êò•ÁØÄ(Èô§Â§ï)', '02-06': 'Êò•ÁØÄ(Âàù‰∏Ä)', 
                '02-07': 'Êò•ÁØÄ(Âàù‰∫å)', '02-08': 'Êò•ÁØÄ(Âàù‰∏â)', '02-09': 'Êò•ÁØÄ(ÂàùÂõõ)', 
                '02-10': 'Êò•ÁØÄ(Âàù‰∫î)',
                '02-27': 'ÂíåÂπ≥Á¥ÄÂøµÊó•Ë£úÂÅá', '02-28': 'ÂíåÂπ≥Á¥ÄÂøµÊó•',
                '03-01': 'ÂíåÂπ≥Á¥ÄÂøµÊó•Ë£úÂÅá',
                '04-03': 'ÂÖíÁ´•ÁØÄË£úÂÅá', '04-04': 'ÂÖíÁ´•ÁØÄ', '04-05': 'Ê∏ÖÊòéÁØÄ', '04-06': 'Ê∏ÖÊòéÁØÄË£úÂÅá',
                '04-30': 'ÂãûÂãïÁØÄË£úÂÅá', '05-01': 'ÂãûÂãïÁØÄ', '05-02': 'ÂãûÂãïÁØÄË£úÂÅá',
                '06-09': 'Á´ØÂçàÁØÄ',
                '10-09': 'ÂúãÊÖ∂Êó•Ë£úÂÅá', '10-10': 'ÂúãÊÖ∂Êó•', '10-11': 'ÂúãÊÖ∂Êó•Ë£úÂÅá',
                '10-23': 'ÂÖâÂæ©ÁØÄË£úÂÅá', '10-24': 'ÂÖâÂæ©ÁØÄ', '10-25': 'ÂÖâÂæ©ÁØÄË£úÂÅá',
                '12-24': 'Ë°åÊÜ≤Á¥ÄÂøµÊó•Ë£úÂÅá', '12-25': 'Ë°åÊÜ≤Á¥ÄÂøµÊó•', '12-26': 'Ë°åÊÜ≤Á¥ÄÂøµÊó•Ë£úÂÅá'
            }
        };
        
        var visit1aDate = '';
        var selectedV2 = null; // User selected Visit 2 date
        var selectedV3 = null; // User selected Visit 3 date
        var selectedV4 = null; // User selected Visit 4 date
        var selectedV5 = null; // User selected Visit 5 date
        var selectedV6 = null; // User selected Visit 6 date
        var updatedVisits = []; // Track which visits were updated by suggestions
        var oldV2 = null; // Track old V2 for comparison
        
        // Select a visit date (V2, V3, V4, or V5)
        function selectVisitDate(visitNum, dateStr) {
            console.log('üìÖ ÈÅ∏ÊìáÊó•Êúü:', 'Visit', visitNum, '‚Üí', dateStr);
            console.log('üîÑ ÈÅ∏ÊìáÂâçÁãÄÊÖã:', { V2: selectedV2, V3: selectedV3, V4: selectedV4, V5: selectedV5, V6: selectedV6 });
            
            // Êõ¥Êñ∞ÈÅ∏ÊìáÁöÑÊó•Êúü
            if (visitNum === 2) {
                selectedV2 = dateStr;
                console.log('‚úì selectedV2 Â∑≤Êõ¥Êñ∞:', selectedV2);
                // Êõ¥Êñ∞Ëº∏ÂÖ•Ê°Ü
                document.getElementById('visit2').value = dateStr;
            }
            else if (visitNum === 3) {
                selectedV3 = dateStr;
                console.log('‚úì selectedV3 Â∑≤Êõ¥Êñ∞:', selectedV3);
            }
            else if (visitNum === 4) {
                selectedV4 = dateStr;
                console.log('‚úì selectedV4 Â∑≤Êõ¥Êñ∞:', selectedV4);
            }
            else if (visitNum === 5) {
                selectedV5 = dateStr;
                console.log('‚úì selectedV5 Â∑≤Êõ¥Êñ∞:', selectedV5);
            }
            else if (visitNum === 6) {
                selectedV6 = dateStr;
                console.log('‚úì selectedV6 Â∑≤Êõ¥Êñ∞:', selectedV6);
            }
            
            console.log('üîÑ ÈÅ∏ÊìáÂæåÁãÄÊÖã:', { V2: selectedV2, V3: selectedV3, V4: selectedV4, V5: selectedV5, V6: selectedV6 });
            
            console.log('üîÑ Âç≥Â∞áË™øÁî® calculateVisits()');
            // ÈáçÊñ∞Ë®àÁÆó‰ª•Êõ¥Êñ∞ UI
            calculateVisits();
            console.log('üîÑ calculateVisits() Ë™øÁî®ÂÆåÊàê');
            
        }
 
        document.addEventListener('DOMContentLoaded', function() {
            // üé® ÂàùÂßãÂåñÈÄ≤Â∫¶Á≥ªÁµ±
            updateProgress();
            
            // Áõ£ËÅΩÊâÄÊúâË°®ÂñÆËÆäÂåñ
            document.getElementById('subjectType').addEventListener('change', updateProgress);
            document.getElementById('visit1').addEventListener('change', updateProgress);
            document.getElementById('visit2').addEventListener('change', updateProgress);
            
            document.body.addEventListener('click', function(e) {
                var btn = e.target.closest('button.date-option');
                if (btn && !btn.classList.contains('disabled')) {
                    var visitNum = parseInt(btn.getAttribute('data-visit'));
                    var dateStr = btn.getAttribute('data-date');
                    if (visitNum && dateStr) {
                        console.log('üéØ ÂÖ®ÂüüÂßîÊ¥æÊçïÁç≤ÈªûÊìä:', visitNum, dateStr);
                        e.preventDefault();
                        e.stopPropagation();
                        selectVisitDate(visitNum, dateStr);
                    }
                }
            }, true); // ‰ΩøÁî®ÊçïÁç≤ÈöéÊÆµ
        });
        
        // üé® Âø´ÈÄüÂãùÂà©ÔºöÊô∫ËÉΩÈÄ≤Â∫¶Êõ¥Êñ∞Á≥ªÁµ±
        function updateProgress() {
            var type = document.getElementById('subjectType').value;
            var v1 = document.getElementById('visit1').value;
            var v2 = document.getElementById('visit2').value;
            
            var completed = 0;
            var step1 = document.getElementById('step1');
            var step2 = document.getElementById('step2');
            var step3 = document.getElementById('step3');
            var step1Status = document.getElementById('step1Status');
            var step2Status = document.getElementById('step2Status');
            var step3Status = document.getElementById('step3Status');
            var smartHint = document.getElementById('smartHint');
            var hintText = document.getElementById('hintText');
            
            // ÈáçÁΩÆÊâÄÊúâÊ≠•È©ü
            [step1, step2, step3].forEach(function(step) {
                step.className = 'step-item';
                step.style.flex = '1';
                step.style.minWidth = '120px';
                step.style.textAlign = 'center';
                step.style.padding = '12px';
                step.style.borderRadius = '8px';
                step.style.transition = 'all 0.3s';
                step.style.background = 'white';
            });
            
            // Ê≠•È©ü1
            if (type) {
                completed++;
                step1.classList.add('step-complete');
                step1Status.textContent = '‚úì Â∑≤ÂÆåÊàê';
                step1Status.style.color = 'white';
            } else {
                step1.classList.add('step-current');
                step1Status.textContent = 'Ë´ãÈÅ∏Êìá';
                step1Status.style.color = '#0b6ac9';
                smartHint.style.display = 'block';
                hintText.textContent = 'Ë´ãÂÖàÈÅ∏ÊìáÂèóË©¶ËÄÖÈ°ûÂûãÔºàNaive Êàñ WashoutÔºâ';
                return;
            }
            
            // Ê≠•È©ü2
            if (v1) {
                completed++;
                step2.classList.add('step-complete');
                step2Status.textContent = '‚úì Â∑≤ÂÆåÊàê';
                step2Status.style.color = 'white';
            } else {
                step2.classList.add('step-current');
                step2Status.textContent = 'Ë´ãÈÅ∏Êìá';
                step2Status.style.color = '#0b6ac9';
                smartHint.style.display = 'block';
                hintText.textContent = 'Ë´ãÈÅ∏Êìá Visit 1 Êó•ÊúüÔºàÁØ©ÈÅ∏Ë®™Ë¶ñÊó•ÊúüÔºâ';
                // Ê∑ªÂä†ËÑàÂãïÊïàÊûúÂà∞Visit 1Ëº∏ÂÖ•Ê°Ü
                document.getElementById('visit1').classList.add('focus-hint');
                return;
            }
            
            // Ê≠•È©ü3
            if (v2) {
                completed++;
                step3.classList.add('step-complete');
                step3Status.textContent = '‚úì Â∑≤ÂÆåÊàê';
                step3Status.style.color = 'white';
                smartHint.style.display = 'none';
            } else {
                step3.classList.add('step-current');
                step3Status.textContent = 'Ë´ãÈÅ∏Êìá';
                step3Status.style.color = '#0b6ac9';
                smartHint.style.display = 'block';
                hintText.textContent = 'ÊúÄÂæå‰∏ÄÊ≠•ÔºÅË´ãÈÅ∏Êìá Visit 2 Êó•ÊúüÔºàÂü∫Á∑öÊó•/Èö®Ê©üÂàÜÈÖçÊó•Ôºâ';
                // Ê∑ªÂä†ËÑàÂãïÊïàÊûúÂà∞Visit 2Ëº∏ÂÖ•Ê°Ü
                document.getElementById('visit2').classList.add('focus-hint');
                return;
            }
            
            // ÂÖ®ÈÉ®ÂÆåÊàê
            if (completed === 3) {
                smartHint.style.display = 'block';
                smartHint.style.background = '#f0f4f8';
                smartHint.style.borderColor = '#0b6ac9';
                hintText.innerHTML = '<span style="color: #0b6ac9;">üéâ Â§™Ê£í‰∫ÜÔºÅÊâÄÊúâË≥áÊñôÂ∑≤ÂÆåÊàêÔºåÂæåÁ∫åË®™Ë¶ñÊó•ÊúüÂ∑≤Ëá™ÂãïË®àÁÆóÂÆåÊàê</span>';
            }
        }
        
        // È°ØÁ§∫Â∑•‰ΩúÊó•ÈÅ∏ÊìáÂô® for Visit 1 and Visit 2
        // Check if a date conflicts with other visits
        function checkDateConflict(dateStr, excludeVisit, allVisits) {
            var date = parseDate(dateStr);
            
            for (var i = 0; i < allVisits.length; i++) {
                var visit = allVisits[i];
                if (visit.name === excludeVisit) continue; // Skip the visit being checked
                
                if (visit.date && formatDate(parseDate(visit.date)) === dateStr) {
                    return visit.name; // Return conflicting visit name
                }
            }
            
            return null; // No conflict
        }
        
        // Generate date selector buttons for a visit
        function generateDateSelector(visitNum, centerDate, v1OrV2, allVisits) {
            var visitName = 'Visit ' + visitNum;
            var selectedDate = null;
            if (visitNum === 2) selectedDate = selectedV2;
            else if (visitNum === 3) selectedDate = selectedV3;
            else if (visitNum === 4) selectedDate = selectedV4;
            else if (visitNum === 5) selectedDate = selectedV5;
            
            // Validate that selectedDate is reasonable (within ¬±14 days is acceptable)
            if (selectedDate) {
                var selectedDateObj = parseDate(selectedDate);
                var daysDiff = getDaysDiff(centerDate, selectedDateObj);
                
                // If selected date is way outside range (¬±14 days), clear it
                if (Math.abs(daysDiff) > 14) {
                    console.log('‚ö†Ô∏è ' + visitName + ' ÈÅ∏ÊìáÁöÑÊó•Êúü ' + selectedDate + ' Ë∂ÖÂá∫ÂêàÁêÜÁØÑÂúçÔºåÊ∏ÖÈô§‰∏¶ÈáçÊñ∞Ë®àÁÆó');
                    selectedDate = null;
                    if (visitNum === 2) selectedV2 = null;
                    else if (visitNum === 3) selectedV3 = null;
                    else if (visitNum === 4) selectedV4 = null;
                    else if (visitNum === 5) selectedV5 = null;
                }
            }
            
            // If no selection, use center date (or nearest workday within ¬±7 days)
            if (!selectedDate) {
                var suggestedDate = centerDate;
                
                // If center date is holiday, find nearest workday WITHIN ¬±7 days
                if (checkHoliday(centerDate)) {
                    var foundWorkday = null;
                    
                    // Search within ¬±7 days window
                    for (var offset = 1; offset <= 7; offset++) {
                        // Try forward first
                        var forwardDate = addDays(centerDate, offset);
                        if (!checkHoliday(forwardDate)) {
                            foundWorkday = forwardDate;
                            break;
                        }
                        
                        // Then try backward
                        var backwardDate = addDays(centerDate, -offset);
                        if (!checkHoliday(backwardDate)) {
                            foundWorkday = backwardDate;
                            break;
                        }
                    }
                    
                    // Only use found workday if it's within the window
                    if (foundWorkday) {
                        suggestedDate = foundWorkday;
                    }
                    // If no workday found in ¬±7 window, keep centerDate
                }
                
                selectedDate = formatDate(suggestedDate);
                // Auto-select suggested date on first render
                if (visitNum === 2) selectedV2 = selectedDate;
                else if (visitNum === 3) selectedV3 = selectedDate;
                else if (visitNum === 4) selectedV4 = selectedDate;
                else if (visitNum === 5) selectedV5 = selectedDate;
            }
            
            var html = '<div class="date-selector">';
            html += '<div class="date-selector-label">ÈÅ∏ÊìáË®™Ë¶ñÊó•ÊúüÔºà¬±2 Â§©ÂΩàÊÄßÁ™óÂè£Ôºâ</div>';
            
            // Êî∂ÈõÜÊâÄÊúâÂèØÈÅ∏Êó•ÊúüÂèäÂÖ∂ÁãÄÊÖã
            var dateOptions = [];
            
            // Generate 5 options: -2, -1, 0, +1, +2
            for (var i = -2; i <= 2; i++) {
                var optionDate = addDays(centerDate, i);
                var optionDateStr = formatDate(optionDate);
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Âë®Êú´Ôºà‰∏¶‰∏î‰∏çÊòØË£úÁè≠Êó•Ôºâ
                var dayOfWeek = optionDate.getDay();
                var isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                
                // Â¶ÇÊûúÊòØÂë®Êú´ÔºåÊ™¢Êü•ÊòØÂê¶ÁÇ∫Ë£úÁè≠Êó•
                var skip = false;
                if (isWeekend) {
                    var year = optionDate.getFullYear().toString();
                    var monthDay = ('0' + (optionDate.getMonth() + 1)).slice(-2) + '-' + ('0' + optionDate.getDate()).slice(-2);
                    var isWorkingWeekend = workingWeekends[year] && workingWeekends[year].indexOf(monthDay) !== -1;
                    if (!isWorkingWeekend) {
                        skip = true;
                    }
                }
                
                if (!skip) {
                    var isSelected = (optionDateStr === selectedDate);
                    var conflict = checkDateConflict(optionDateStr, visitName, allVisits);
                    var holiday = checkHoliday(optionDate);
                    var isDisabled = conflict || holiday;
                    
                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫„ÄåÂÆåÁæé„ÄçÈÅ∏ÊìáÔºàÂæåÁ∫åË®™Ë¶ñÈÉΩÊúâÂ∑•‰ΩúÊó•ÂèØÈÅ∏Ôºâ
                    var isPerfect = true;
                    if (visitNum === 3) {
                        // Ê™¢Êü•V4 (V3+7) Âíå V5 (V3+21) ÁØÑÂúçÊòØÂê¶ÊúâÂ∑•‰ΩúÊó•
                        var testV4Center = addDays(optionDate, 7);
                        var testV5Center = addDays(optionDate, 21);
                        if (countWorkdaysInWindow(testV4Center) === 0 || countWorkdaysInWindow(testV5Center) === 0) {
                            isPerfect = false;
                        }
                    } else if (visitNum === 4) {
                        // Ê™¢Êü•V5 (V4+14) ÁØÑÂúçÊòØÂê¶ÊúâÂ∑•‰ΩúÊó•
                        var testV5Center = addDays(optionDate, 14);
                        if (countWorkdaysInWindow(testV5Center) === 0) {
                            isPerfect = false;
                        }
                    }
                    // V5 Ê≤íÊúâÂæåÁ∫åË®™Ë¶ñÔºåÊâÄ‰ª•ÈÉΩÊòØÂÆåÁæéÁöÑ
                    
                    var label = '';
                    if (i === -2) label = 'ÂæÄÂâç2Â§©';
                    else if (i === -1) label = 'ÂæÄÂâç1Â§©';
                    else if (i === 0) label = 'Âª∫Ë≠∞';
                    else if (i === 1) label = 'ÂæÄÂæå1Â§©';
                    else if (i === 2) label = 'ÂæÄÂæå2Â§©';
                    
                    dateOptions.push({
                        date: optionDate,
                        dateStr: optionDateStr,
                        label: label,
                        isSelected: isSelected,
                        isDisabled: isDisabled,
                        isPerfect: isPerfect,
                        conflict: conflict,
                        holiday: holiday
                    });
                }
            }
            
            // üèÜ ‰ΩøÁî®V2Áµ±‰∏ÄÊ®£ÂºèÔºöÁ∂†Ëâ≤ÂÆåÁæé + Ê©òËâ≤ÂèØÈÅ∏ + ËóçËâ≤Áï∂Ââç
            if (dateOptions.length > 0) {
                html += '<div style="display: flex; flex-direction: column; gap: 8px; margin-top: 16px;">';
                
                for (var i = 0; i < dateOptions.length; i++) {
                    var opt = dateOptions[i];
                    
                    if (opt.isDisabled) {
                        // Á¶ÅÁî®ÁöÑÊåâÈàï - Notion ÁÅ∞Ëâ≤
                        html += '<button type="button" class="btn" style="';
                        html += 'background: #f7f6f3; color: #9b9a97; border: 1px solid #e9e9e7; ';
                        html += 'cursor: not-allowed; pointer-events: none; padding: 14px 20px; border-radius: 6px;">';
                        html += '<span style="display: flex; align-items: center; justify-content: space-between;">';
                        html += '<span style="font-size: 15px;">' + formatDateWithWeekday(opt.date) + '</span>';
                        if (opt.conflict) {
                            html += '<span style="font-size: 11px; color: #e05c5c;">‚ö†Ô∏è Ë°ùÁ™Å</span>';
                        } else if (opt.holiday) {
                            html += '<span style="font-size: 11px; color: #e05c5c;">üö´ ÂÅáÊó•</span>';
                        }
                        html += '</span></button>';
                    } else {
                        // üé® ÁúüÊ≠£ÁöÑ Notion È¢®Ê†º
                        var btnStyle = '';
                        
                        if (opt.isSelected) {
                            // Â∑≤ÈÅ∏ÊìáÔºöÊ∑∫ÁÅ∞Â∫ï + Ê∑±ÁÅ∞Á≤óÊ°Ü
                            btnStyle = 'background: #0b6ac9; border: none; color: #ffffff !important;';
                        } else {
                            // Êú™ÈÅ∏ÊìáÔºöÁôΩÂ∫ï + Ê•µÊ∑°ÁÅ∞Ê°Ü + Ê∑±ÁÅ∞Â≠ó
                            btnStyle = 'background: #ffffff; border: 1px solid #e0e0e0; color: #37352f !important;';
                        }
                        
                        html += '<button type="button" ';
                        html += 'onclick="selectVisitDate(' + visitNum + ', \'' + opt.dateStr + '\'); event.stopPropagation(); return false;" ';
                        html += 'class="btn btn-primary v2-suggestion-btn" ';
                        html += 'style="' + btnStyle + ' pointer-events: auto !important; cursor: pointer !important; padding: 14px 20px; border-radius: 6px; font-weight: 500; letter-spacing: -0.01em; transition: all 0.15s ease;" ';
                        html += 'data-visit="' + visitNum + '" data-date="' + opt.dateStr + '"';
                        html += 'onmouseover="' + (opt.isSelected ? '' : 'this.style.background=\'#f7f6f3\';') + '" ';
                        html += 'onmouseout="' + (opt.isSelected ? '' : 'this.style.background=\'#ffffff\';') + '">';
                        
                        html += '<div style="font-size: 15px; text-align: center;">' + formatDateWithWeekday(opt.date) + '</div>';
                        
                        html += '</button>';
                    }
                }
                
                html += '</div>';
                
                // ÂÖ®Êñ∞Áõ¥Ë¶∫Âúñ‰æã
                
                // ÁÑ°ÈúÄÂúñ‰æã
                html += '';
            } else {
                html += '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 6px;">';
                html += '<div style="font-weight: 600; font-size: 13px; color: #dc2626;">‚ö†Ô∏è ÁØÑÂúçÂÖßÁÑ°ÂèØÁî®Êó•Êúü</div>';
                html += '</div>';
            }
            
            html += '</div>';
            
            // If all options are disabled, suggest adjusting V2 or V1
            if (dateOptions.length === 0 || dateOptions.every(function(opt) { return opt.isDisabled; })) {
                var v1Input = document.getElementById('visit1').value;
                var v2Input = document.getElementById('visit2').value;
                var v1Date = parseDate(v1Input);
                var v2Date = parseDate(v2Input);
                
                // Find a better V2 date
                var suggestedV2 = findBetterV2Date(v2Date, visitNum);
                
                html += '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 6px;">';
                html += '<div style="font-weight: 600; font-size: 13px; color: #dc2626; margin-bottom: 6px;">‚ö†Ô∏è ÊâÄÊúâÊó•ÊúüÈÉΩÁÑ°Ê≥ïÈÅ∏Êìá</div>';
                
                if (suggestedV2) {
                    html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">Âª∫Ë≠∞Ë™øÊï¥ Visit 2 Êó•Êúü‰ª•Áç≤ÂæóÂèØÁî®ÈÅ∏È†Ö</div>';
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #57534e; margin-bottom: 6px;">üí° Á≥ªÁµ±Âª∫Ë≠∞Ôºö</div>';
                    html += '<div style="font-size: 13px; font-weight: 600; color: #1f2937;">Â∞á Visit 2 ÊîπÁÇ∫Ôºö<span style="color: #dc2626;">' + formatDate(suggestedV2) + '</span></div>';
                    html += '<button class="btn btn-primary" style="width: 100%; margin-top: 8px; background: #dc2626;" onclick="adjustV2Date(\'' + formatDate(suggestedV2) + '\')">';
                    html += '‚ú® Êé°Áî®Âª∫Ë≠∞‰∏¶ÈáçÊñ∞Ë®àÁÆó';
                    html += '</button>';
                    html += '</div>';
                } else {
                    // If no suitable V2 adjustment found, suggest moving to nearest workday
                    var nearestV1 = findNearestWorkday(v1Date);
                    var nearestV2 = findNearestWorkday(v2Date);
                    
                    html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">Âú® ¬±10 Â§©ÁØÑÂúçÂÖßÊâæ‰∏çÂà∞ÂêàÈÅ©ÁöÑ V2 Ë™øÊï¥</div>';
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #57534e; margin-bottom: 8px;">üí° Âª∫Ë≠∞Ë™øÊï¥Âà∞ÊúÄËøëÁöÑÂ∑•‰ΩúÊó•Ôºö</div>';
                    
                    // Suggest V1
                    if (nearestV1 && formatDate(nearestV1) !== formatDate(v1Date)) {
                        html += '<div style="margin-bottom: 8px;">';
                        html += '<div style="font-size: 12px; font-weight: 600; color: #1f2937; margin-bottom: 4px;">ÊñπÊ°à AÔºöË™øÊï¥ Visit 1</div>';
                        html += '<div style="font-size: 13px; color: #1f2937;">Âæû ' + formatDate(v1Date) + ' ‚Üí <span style="color: #dc2626; font-weight: 600;">' + formatDate(nearestV1) + '</span></div>';
                        html += '<button class="btn btn-primary" style="width: 100%; margin-top: 6px; background: #dc2626; font-size: 12px;" onclick="adjustV1Date(\'' + formatDate(nearestV1) + '\')">';
                        html += 'Êé°Áî®ÊñπÊ°à A';
                        html += '</button>';
                        html += '</div>';
                    }
                    
                    // Suggest V2
                    if (nearestV2 && formatDate(nearestV2) !== formatDate(v2Date)) {
                        html += '<div style="margin-bottom: 8px;">';
                        html += '<div style="font-size: 12px; font-weight: 600; color: #1f2937; margin-bottom: 4px;">ÊñπÊ°à BÔºöË™øÊï¥ Visit 2</div>';
                        html += '<div style="font-size: 13px; color: #1f2937;">Âæû ' + formatDate(v2Date) + ' ‚Üí <span style="color: #dc2626; font-weight: 600;">' + formatDate(nearestV2) + '</span></div>';
                        html += '<button class="btn btn-primary" style="width: 100%; margin-top: 6px; background: #dc2626; font-size: 12px;" onclick="adjustV2Date(\'' + formatDate(nearestV2) + '\')">';
                        html += 'Êé°Áî®ÊñπÊ°à B';
                        html += '</button>';
                        html += '</div>';
                    }
                    
                    if ((!nearestV1 || formatDate(nearestV1) === formatDate(v1Date)) && 
                        (!nearestV2 || formatDate(nearestV2) === formatDate(v2Date))) {
                        html += '<div style="font-size: 12px; color: #991b1b;">V1 Âíå V2 Â∑≤Á∂ìÊòØÊúÄËøëÁöÑÂ∑•‰ΩúÊó•ÔºåÂª∫Ë≠∞ÈáçÊñ∞Ë¶èÂäÉÊï¥È´îÊéíÁ®ã</div>';
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            
            // üèÜ Ê∑ªÂä†Èö±Ëóèinput‰ª•ÊîØÊåÅÊúÄÁµÇÊó•ÊúüÊëòË¶Å
            var inputId = 'v' + visitNum + 'Input';
            var currentDateValue = selectedDate ? formatDateWithWeekday(parseDate(selectedDate)) : '';
            html += '<input type="hidden" id="' + inputId + '" value="' + currentDateValue + '">';
            
            return html;
        }
        
        // Find nearest workday from a given date (forward search)
        function findNearestWorkday(date) {
            var maxSearch = 30; // Search up to 30 days
            var testDate = new Date(date);
            
            for (var i = 0; i < maxSearch; i++) {
                if (i > 0) {
                    testDate = addDays(testDate, 1);
                }
                if (!checkHoliday(testDate)) {
                    return testDate;
                }
            }
            
            return null; // Could not find workday
        }
        
        // Find a better V2 date that allows valid options for this visit
        function findBetterV2Date(currentV2, visitNum) {
            var daysOffset;
            if (visitNum === 3) daysOffset = 7;
            else if (visitNum === 4) daysOffset = 14;
            else if (visitNum === 5) daysOffset = 28;
            
            // Get V1 and subject type to validate V1-V2 interval
            var v1Input = document.getElementById('visit1').value;
            var type = document.getElementById('subjectType').value;
            
            if (!v1Input || !type) {
                return null;
            }
            
            var v1 = parseDate(v1Input);
            var minDays = 1;
            var maxDays = 35;
            
            // Calculate minimum days based on subject type
            if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                if (!drugType) {
                    return null;
                }
                var washoutDays = parseInt(drugType);
                minDays = washoutDays + 1;
            }
            
            // Try adjusting V2 forward and backward
            var maxAdjust = 10; // Try up to 10 days adjustment
            
            for (var adjust = 1; adjust <= maxAdjust; adjust++) {
                // Try moving V2 forward
                var newV2Forward = addDays(currentV2, adjust);
                var v1_v2_forward = getDaysDiff(v1, newV2Forward);
                
                // Check V1-V2 interval validity
                if (v1_v2_forward >= minDays && v1_v2_forward <= maxDays) {
                    // CRITICAL: V2 itself must be a workday
                    if (!checkHoliday(newV2Forward) && hasValidOptions(newV2Forward, daysOffset)) {
                        return newV2Forward;
                    }
                }
                
                // Try moving V2 backward
                var newV2Backward = addDays(currentV2, -adjust);
                var v1_v2_backward = getDaysDiff(v1, newV2Backward);
                
                // Check V1-V2 interval validity
                if (v1_v2_backward >= minDays && v1_v2_backward <= maxDays) {
                    // CRITICAL: V2 itself must be a workday
                    if (!checkHoliday(newV2Backward) && hasValidOptions(newV2Backward, daysOffset)) {
                        return newV2Backward;
                    }
                }
            }
            
            return null; // Could not find better date within range
        }
        
        // Check if a V2 date would give valid options for a visit
        function hasValidOptions(v2Date, daysOffset) {
            var centerDate = addDays(v2Date, daysOffset);
            
            // Check if any date in the ¬±2 range is valid (not holiday)
            for (var i = -2; i <= 2; i++) {
                var testDate = addDays(centerDate, i);
                if (!checkHoliday(testDate)) {
                    return true; // Found at least one non-holiday
                }
            }
            
            return false; // All dates are holidays
        }
        
        // Adjust V1 date and recalculate
        function adjustV1Date(newV1) {
            document.getElementById('visit1').value = newV1;
            
            // Clear previous selections
            visit1aDate = '';
            selectedV3 = null;
            selectedV4 = null;
            selectedV5 = null;
            
            // Mark that dates were auto-adjusted
            window.autoAdjustedV1 = true;
            window.autoAdjustedV2 = false;
            
            // Recalculate
            checkDateWarning('visit1');
            calculateV2Suggestion();
            document.getElementById('v1aSuggestion').innerHTML = '';
            document.getElementById('validation').innerHTML = '';
            document.getElementById('v2EarlyWarning').innerHTML = '';
            calculateVisits();
            
            // Recheck for conflicts with delay for rendering
            setTimeout(function() {
                checkAllVisitsHolidays();
            }, 50);
            
            // Auto-clear the markers after 5 seconds
            setTimeout(function() {
                window.autoAdjustedV1 = false;
                window.autoAdjustedV2 = false;
                calculateVisits();
            }, 5000);
        }
        
        // Adjust V2 date and recalculate
        function adjustV2Date(newV2) {
            document.getElementById('visit2').value = newV2;
            
            // Clear previous selections
            selectedV3 = null;
            selectedV4 = null;
            selectedV5 = null;
            
            // Mark that dates were auto-adjusted
            window.autoAdjustedV1 = false;
            window.autoAdjustedV2 = true;
            
            // Recalculate
            checkDateWarning('visit2');
            checkV2EarlyWarning();
            calculateV2Suggestion();
            validateDates();
            
            // Re-validate V1a if it exists
            if (visit1aDate) {
                validateV1a();
            }
            
            document.getElementById('v2EarlyWarning').innerHTML = '';
            calculateVisits();
            
            // Recheck for conflicts with delay for rendering
            setTimeout(function() {
                checkAllVisitsHolidays();
            }, 50);
            
            // Auto-clear the markers after 5 seconds
            setTimeout(function() {
                window.autoAdjustedV1 = false;
                window.autoAdjustedV2 = false;
                calculateVisits();
            }, 5000);
        }
        
        // Format date in short form (MM/DD)
        function formatDateShort(date) {
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            return month + '/' + day;
        }
        
        // Auto-adjust all visits to avoid holidays (one-click)
        function autoAvoidHolidays(silent) {
            var v2Input = document.getElementById('visit2').value;
            if (!v2Input) {
                if (!silent) {
                    showToast('warning', 'Ë´ãÂÖàËº∏ÂÖ•Êó•Êúü', 'Ë´ãÂÖàËº∏ÂÖ• Visit 2 Êó•Êúü');
                }
                return;
            }
            
            var v2 = parseDate(v2Input);
            var changed = false;
            
            console.log('ü§ñ autoAvoidHolidays Âü∑Ë°å - Áï∂Ââç selectedV3:', selectedV3);
            
            // Visit 3: Day 8 (V2 + 7)
            var v3_center = addDays(v2, 7);
            
            // Âè™Âú® selectedV3 ÁÇ∫Á©∫ÊôÇËá™ÂãïË®≠ÁΩÆÔºåÂê¶Ââá‰øùÁïôÁî®Êà∂ÈÅ∏Êìá
            if (!selectedV3) {
                console.log('   V3 Êú™Ë®≠ÁΩÆÔºåËá™ÂãïË®àÁÆó...');
                if (checkHoliday(v3_center)) {
                    var v3_workday = getNextWorkday(v3_center);
                    // Make sure still in range (V2+5 to V2+9)
                    if (v3_workday <= addDays(v2, 9)) {
                        selectedV3 = formatDate(v3_workday);
                        changed = true;
                        console.log('   ‚úÖ V3 Ëá™ÂãïË®≠ÁΩÆÁÇ∫:', selectedV3);
                    }
                } else {
                    selectedV3 = formatDate(v3_center);
                    console.log('   ‚úÖ V3 Ëá™ÂãïË®≠ÁΩÆÁÇ∫:', selectedV3);
                }
            } else {
                console.log('   ‚ö†Ô∏è V3 Â∑≤ÊúâÁî®Êà∂ÈÅ∏ÊìáÔºå‰øùÁïô:', selectedV3);
            }
            
            // Visit 4: Day 15 (V2 + 14)
            var v4_center = addDays(v2, 14);
            
            // Âè™Âú® selectedV4 ÁÇ∫Á©∫ÊôÇËá™ÂãïË®≠ÁΩÆ
            if (!selectedV4) {
                console.log('   V4 Êú™Ë®≠ÁΩÆÔºåËá™ÂãïË®àÁÆó...');
                if (checkHoliday(v4_center)) {
                    var v4_workday = getNextWorkday(v4_center);
                    // Make sure still in range (V2+12 to V2+16)
                    if (v4_workday <= addDays(v2, 16)) {
                        selectedV4 = formatDate(v4_workday);
                        changed = true;
                        console.log('   ‚úÖ V4 Ëá™ÂãïË®≠ÁΩÆÁÇ∫:', selectedV4);
                    }
                } else {
                    selectedV4 = formatDate(v4_center);
                    console.log('   ‚úÖ V4 Ëá™ÂãïË®≠ÁΩÆÁÇ∫:', selectedV4);
                }
            } else {
                console.log('   ‚ö†Ô∏è V4 Â∑≤ÊúâÁî®Êà∂ÈÅ∏ÊìáÔºå‰øùÁïô:', selectedV4);
            }
            
            // Visit 5: Day 29 (V2 + 28)
            var v5_center = addDays(v2, 28);
            
            // Âè™Âú® selectedV5 ÁÇ∫Á©∫ÊôÇËá™ÂãïË®≠ÁΩÆ
            if (!selectedV5) {
                console.log('   V5 Êú™Ë®≠ÁΩÆÔºåËá™ÂãïË®àÁÆó...');
                if (checkHoliday(v5_center)) {
                    var v5_workday = getNextWorkday(v5_center);
                    // Make sure still in range (V2+26 to V2+30)
                    if (v5_workday <= addDays(v2, 30)) {
                        selectedV5 = formatDate(v5_workday);
                        changed = true;
                        console.log('   ‚úÖ V5 Ëá™ÂãïË®≠ÁΩÆÁÇ∫:', selectedV5);
                    }
                } else {
                    selectedV5 = formatDate(v5_center);
                    console.log('   ‚úÖ V5 Ëá™ÂãïË®≠ÁΩÆÁÇ∫:', selectedV5);
                }
            } else {
                console.log('   ‚ö†Ô∏è V5 Â∑≤ÊúâÁî®Êà∂ÈÅ∏ÊìáÔºå‰øùÁïô:', selectedV5);
            }
            
            console.log('ü§ñ autoAvoidHolidays ÂÆåÊàê - ÊúÄÁµÇÁãÄÊÖã:', {V3: selectedV3, V4: selectedV4, V5: selectedV5});
            
            calculateVisits(); // Recalculate to update UI
            
            // Recheck for conflicts after auto-adjustment with delay
            setTimeout(function() {
                checkAllVisitsHolidays();
            }, 50);
            
            // Âè™Âú®ÈùûÈùúÈªòÊ®°Âºè‰∏ãÈ°ØÁ§∫ToastÔºàÂç≥Áî®Êà∂‰∏ªÂãïÈªûÊìäÊåâÈàïÊôÇÔºâ
            if (!silent) {
                if (changed) {
                    showToast('success', 'ÊàêÂäü', 'Â∑≤Ëá™ÂãïË™øÊï¥ Visit Êó•ÊúüÈÅøÈñãÂÅáÊó•');
                } else {
                    showToast('success', 'ÂÆåÊàê', 'ÊâÄÊúâ Visit Êó•ÊúüÂ∑≤ÊòØÂ∑•‰ΩúÊó•');
                }
            }
        }
        
        function clearAll() {
            // Clear all form inputs
            document.getElementById('subjectType').value = '';
            document.getElementById('drugType').value = '';
            document.getElementById('visit1').value = '';
            document.getElementById('visit2').value = '';
            
            // Clear V1a date
            visit1aDate = '';
            
            // Clear selected visit dates
            selectedV2 = null;
            selectedV3 = null;
            selectedV4 = null;
            selectedV5 = null;
            
            // Hide drug type selection
            document.getElementById('drugTypeGroup').style.display = 'none';
            
            // Clear all display areas
            document.getElementById('v2Suggestion').innerHTML = '';
            document.getElementById('validation').innerHTML = '';
            document.getElementById('v1aSuggestion').innerHTML = '';
            document.getElementById('output').innerHTML = '<div class="empty">Ë´ãÂ°´ÂØ´ÊâÄÊúâÊ¨Ñ‰Ωç‰ª•Ë®àÁÆóË®™Ë¶ñÊó•Êúü</div>';
            
            // Clear ALL warnings
            document.getElementById('visit1Warning').innerHTML = '';
            document.getElementById('visit2Warning').innerHTML = '';
            document.getElementById('v2EarlyWarning').innerHTML = '';
            document.getElementById('allVisitsHolidayWarning').innerHTML = '';
            
            // Èö±Ëóè V3~V6 Ë™™ÊòéÂç°Áâá
            const visitInfoCard = document.getElementById('visitInfoCard');
            if (visitInfoCard) {
                visitInfoCard.style.display = 'none';
            }
            
            // Clear auto-adjusted flags
            window.autoAdjustedV1 = false;
            window.autoAdjustedV2 = false;
            
            // ÈáçÁΩÆ„ÄåÂ∑≤ÁîüÊàê„ÄçToast Ê®ôÂøó
            hasShownGeneratedToast = false;
            
            clearV1aValidation();
        }
        
        function checkDateWarning(inputId) {
            var warningDivId = inputId + 'Warning';
            var warningDiv = document.getElementById(warningDivId);
            
            if (!warningDiv) {
                return;
            }
            
            var dateValue = '';
            if (inputId === 'v1a') {
                dateValue = visit1aDate;
            } else {
                var inputElement = document.getElementById(inputId);
                if (!inputElement) {
                    return;
                }
                dateValue = inputElement.value;
            }
            
            if (!dateValue) {
                warningDiv.innerHTML = '';
                return;
            }
            
            var date = parseDate(dateValue);
            var holidayInfo = checkHoliday(date);
            
            if (holidayInfo) {
                warningDiv.innerHTML = '<div style="margin-top: 12px; padding: 16px; background: #fee2e2; border: 3px solid #dc2626; border-radius: 6px; text-align: center;">' +
                    '<div style="font-size: 24px; margin-bottom: 8px;">üö´</div>' +
                    '<div style="font-size: 15px; font-weight: 700; color: #dc2626; margin-bottom: 8px;">' + holidayInfo.msg + '</div>' +
                    '<div style="font-size: 13px; color: #991b1b; font-weight: 600;">Ë®™Ë¶ñÂøÖÈ†àÂú®Â∑•‰ΩúÊó•ÈÄ≤Ë°åÔºåË´ãÈÅ∏ÊìáÂÖ∂‰ªñÊó•Êúü</div>' +
                    '</div>';
            } else {
                warningDiv.innerHTML = '';
            }
        }
        
        function toggleDrugSelection() {
            var type = document.getElementById('subjectType').value;
            var drugTypeGroup = document.getElementById('drugTypeGroup');
            
            if (type === 'washout') {
                drugTypeGroup.style.display = 'block';
            } else {
                drugTypeGroup.style.display = 'none';
                document.getElementById('drugType').value = '';
            }
            
            // Clear V1a date and suggestion when type changes
            visit1aDate = '';
            var v1aSuggDiv = document.getElementById('v1aSuggestion');
            if (v1aSuggDiv) {
                v1aSuggDiv.innerHTML = '';
            }
            
            calculateV2Suggestion();
        }
        
        // ============================================
        // V2Âª∫Ë≠∞ÊåâÈàïÁîüÊàêËºîÂä©ÂáΩÊï∏
        // ============================================
        // üèÜ ‰∏ñÁïåÂÜ†ËªçÁ¥öÊåâÈàïË®≠Ë®à
        // ============================================
        function createV2SuggestionButton(dateStr, workdayDate, isPerfect, isCurrentlySelected) {
            // üé® Áµ±‰∏ÄÈÅ∏ÊìáÊ®£Âºè
            var btnStyle = '';
            
            if (isCurrentlySelected) {
                // Â∑≤ÈÅ∏ÊìáÔºöÊ∑∫ÁÅ∞Â∫ï + Ê∑±ÁÅ∞Á≤óÊ°Ü
                btnStyle = 'background: #0b6ac9; border: none; color: #ffffff !important;';
            } else {
                // Êú™ÈÅ∏ÊìáÔºöÁôΩÂ∫ï + Ê•µÊ∑°ÁÅ∞Ê°Ü + Ê∑±ÁÅ∞Â≠ó
                btnStyle = 'background: #ffffff; border: 1px solid #e0e0e0; color: #37352f !important;';
            }
            
            var html = '<button type="button" ';
            html += 'onclick="useV2Date(\'' + dateStr + '\'); event.stopPropagation(); return false;" ';
            html += 'class="btn btn-primary v2-suggestion-btn" ';
            html += 'style="' + btnStyle + ' pointer-events: auto !important; cursor: pointer !important; padding: 14px 20px; border-radius: 6px; font-weight: 500; letter-spacing: -0.01em; transition: all 0.15s ease;" ';
            html += 'data-date="' + dateStr + '"';
            html += 'onmouseover="' + (isCurrentlySelected ? '' : 'this.style.background=\'#fafafa\';') + '" ';
            html += 'onmouseout="' + (isCurrentlySelected ? '' : 'this.style.background=\'#ffffff\';') + ';">';
            
            html += '<div style="font-size: 15px; text-align: center;">' + formatDateWithWeekday(workdayDate) + '</div>';
            
            html += '</button>';
            
            return html;
        }
        
        function calculateV2Suggestion() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2SuggDiv = document.getElementById('v2Suggestion');
            
            if (!type || !v1Input) {
                v2SuggDiv.innerHTML = '';
                return;
            }
            
            var v1 = parseDate(v1Input);
            var html = '';
            
            if (type === 'naive') {
                // Naive: V2 should be 1-35 days after V1
                var v2_min = addDays(v1, 1);
                var v2_max = addDays(v1, 35);
                
                // Find all workdays in range that won't cause problems
                var workdays = [];
                var currentDate = v2_min;
                while (currentDate <= v2_max) {
                    if (!checkHoliday(currentDate)) {
                        // Ê™¢Êü•ÈÄôÂÄã V2 ÊòØÂê¶ÊúÉÂ∞éËá¥ÂæåÁ∫å Visit ÁÑ°Ê≥ïÈÅ∏Êìá
                        var isViable = true;
                        
                        // Check V3 (Day 8¬±7): V2+1 to V2+14
                        var v3_center = addDays(currentDate, 7);
                        if (!hasValidOptionsInWindow(v3_center)) isViable = false;
                        
                        // Check V4 (Day 15¬±7): V2+8 to V2+21
                        var v4_center = addDays(currentDate, 14);
                        if (!hasValidOptionsInWindow(v4_center)) isViable = false;
                        
                        // Check V5 (Day 29¬±2): V2+26 to V2+30
                        var v5_center = addDays(currentDate, 28);
                        if (!hasValidOptionsInWindow(v5_center)) isViable = false;
                        
                        if (isViable) {
                            workdays.push(new Date(currentDate));
                        }
                    }
                    currentDate = addDays(currentDate, 1);
                }
                
                html = '';
                // üèÜ ‰∏ñÁïåÂÜ†ËªçÁ¥öÊ®ôÈ°åÔºàÁµ±‰∏ÄÊ®£ÂºèÔºâ
                html += '<div style="margin: 28px 0 20px 0;">';
                html += '<h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700; color: #1e293b;">Visit 2 Âª∫Ë≠∞Ë®™Ë¶ñÊó•Êúü</h3>';
                html += '<div style="font-size: 14px; color: #64748b;">ÂèØÈÅ∏ÁØÑÂúçÔºö' + formatDateWithWeekday(v2_min) + ' ~ ' + formatDateWithWeekday(v2_max) + '</div>';
                html += '<div style="font-size: 13px; color: #9b9a97; margin-top: 4px;">(' + workdays.length + ' ÂÄãÂ∑•‰ΩúÊó•)</div>';
                html += '</div>';
                
                // Áï∂ÂâçÈÅ∏ÊìáÊó•Êúü - Á∞°ÊΩîÈ°ØÁ§∫
                var currentV2Display = document.getElementById('visit2').value;
                if (currentV2Display) {
                    html += '<div style="margin-bottom: 20px;">';
                    html += '<div style="font-size: 15px; font-weight: 500; color: #37352f;">Â∑≤ÈÅ∏Ôºö' + formatDateWithWeekday(parseDate(currentV2Display)) + '</div>';
                    html += '</div>';
                }
                
                if (workdays.length > 0) {
                    html += '<div class="btn-group" style="display: flex; flex-direction: column; gap: 8px;">';
                    
                    // If too many workdays, show first 3, smart pick, and last 3
                    if (workdays.length > 7) {
                        // Show first 3
                        for (var i = 0; i < 3; i++) {
                            var isPerfect = true;
                            var testV2 = workdays[i];
                            var dateStr = formatDate(workdays[i]);
                            
                            // Quick check if this V2 is perfect
                            if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                isPerfect = false;
                            }
                            
                            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Áï∂ÂâçÈÅ∏‰∏≠ÁöÑÊó•Êúü
                            var v2Input = document.getElementById('visit2');
                            var isCurrentlySelected = (v2Input && v2Input.value === dateStr);
                            
                            html += createV2SuggestionButton(dateStr, workdays[i], isPerfect, isCurrentlySelected);
                        }
                        
                        html += '<span style="padding: 8px;">...</span>';
                        
                        // Show last 3
                        for (var i = workdays.length - 3; i < workdays.length; i++) {
                            var isPerfect = true;
                            var testV2 = workdays[i];
                            var dateStr = formatDate(workdays[i]);
                            
                            if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                isPerfect = false;
                            }
                            
                            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Áï∂ÂâçÈÅ∏‰∏≠ÁöÑÊó•Êúü
                            var v2Input = document.getElementById('visit2');
                            var isCurrentlySelected = (v2Input && v2Input.value === dateStr);
                            
                            html += createV2SuggestionButton(dateStr, workdays[i], isPerfect, isCurrentlySelected);
                        }
                    } else {
                        // Show all workdays
                        for (var i = 0; i < workdays.length; i++) {
                            var isPerfect = true;
                            var testV2 = workdays[i];
                            var dateStr = formatDate(workdays[i]);
                            
                            // Check if this V2 leads to perfect outcome
                            if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                isPerfect = false;
                            }
                            
                            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Áï∂ÂâçÈÅ∏‰∏≠ÁöÑÊó•Êúü
                            var v2Input = document.getElementById('visit2');
                            var isCurrentlySelected = (v2Input && v2Input.value === dateStr);
                            
                            html += createV2SuggestionButton(dateStr, workdays[i], isPerfect, isCurrentlySelected);
                        }
                    }
                    
                    html += '</div>';
                    
                    // ÁÑ°ÈúÄÂúñ‰æã - Á∞°ÊΩîÂç≥Áæé
                    
                    // Build a map of workdays with their perfect status for calendar
                    var workdayPerfectMap = {};
                    for (var i = 0; i < workdays.length; i++) {
                        var testV2 = workdays[i];
                        var isPerfect = true;
                        
                        // Check if this V2 leads to perfect outcome
                        if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                            countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                            countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                            isPerfect = false;
                        }
                        
                        workdayPerfectMap[formatDate(testV2)] = isPerfect;
                    }
                    
                    // üèÜ Á∞°ÊΩîÊúàÊõÜ
                    html += '<div style="margin-top: 24px;">';
                    html += '<div style="font-size: 14px; font-weight: 600; color: #64748b; margin-bottom: 12px;">üìÖ ÂèØÁî®Êó•Êúü</div>';
                    
                    // Âúñ‰æãÂ∑≤ÁßªÈô§ - ‰øùÊåÅÁ∞°ÊΩî
                    
                    html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 11px;">';
                    
                    // Áç≤ÂèñÁï∂ÂâçÈÅ∏‰∏≠ÁöÑ V2 Êó•Êúü
                    var v2Input = document.getElementById('visit2');
                    
                    // Get date range for calendar (from v2_min to v2_max)
                    var calStartDate = new Date(v2_min);
                    calStartDate.setDate(calStartDate.getDate() - calStartDate.getDay()); // Start from Sunday
                    
                    var calEndDate = new Date(v2_max);
                    var endDay = calEndDate.getDay();
                    if (endDay !== 6) {
                        calEndDate.setDate(calEndDate.getDate() + (6 - endDay)); // End on Saturday
                    }
                    
                    // Add weekday headers
                    var weekdayHeaders = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
                    for (var i = 0; i < 7; i++) {
                        html += '<div style="text-align: center; font-weight: 600; color: #9ca3af; padding: 4px;">' + weekdayHeaders[i] + '</div>';
                    }
                    
                    // Add date cells
                    var currentCalDate = new Date(calStartDate);
                    while (currentCalDate <= calEndDate) {
                        var dateStr = formatDate(currentCalDate);
                        var isInRange = currentCalDate >= v2_min && currentCalDate <= v2_max;
                        var isWorkday = workdayPerfectMap.hasOwnProperty(dateStr);
                        var isPerfectDate = workdayPerfectMap[dateStr] === true;
                        var isSelected = (v2Input && v2Input.value && formatDate(parseDate(v2Input.value)) === dateStr);
                        
                        var cellStyle = 'text-align: center; padding: 6px 4px; border-radius: 6px; ';
                        if (isWorkday) {
                            if (isSelected) {
                                // Â∑≤ÈÅ∏ÔºöËóçËâ≤Â∫ï + ÁôΩÂ≠ó
                                cellStyle += 'background: #0b6ac9; border: none; color: #ffffff; font-weight: 600; cursor: pointer;';
                            } else {
                                // ÂèØÈÅ∏Êó•Êúü - ÁôΩÂ∫ï + Ê∑°ÁÅ∞Ê°Ü + Ê∑±ÁÅ∞Â≠ó
                                cellStyle += 'background: #ffffff; border: 1px solid #e0e0e0; color: #37352f; font-weight: 500; cursor: pointer;';
                            }
                        } else if (isInRange) {
                            // ÁØÑÂúçÂÖß‰ΩÜ‰∏çÂèØÈÅ∏ÔºàÂÅáÊó•Ôºâ- Ê∑°ÁÅ∞Â∫ïÊ∑°ÁÅ∞Â≠ó
                            cellStyle += 'background: #f5f5f5; color: #9b9a97;';
                        } else {
                            // ÁØÑÂúçÂ§ñ - Ê•µÊ∑°ÁÅ∞
                            cellStyle += 'background: #fafafa; color: #d0d0d0;';
                        }
                        
                        var onclick = isWorkday ? ' onclick="useV2Date(\'' + dateStr + '\')"' : '';
                        html += '<div style="' + cellStyle + '"' + onclick + '>' + currentCalDate.getDate() + '</div>';
                        
                        currentCalDate.setDate(currentCalDate.getDate() + 1);
                    }
                    
                    html += '</div>';
                    html += '</div>';
                } else {
                    html += '<div style="margin-top: 12px; padding: 16px; background: #fee2e2; border: 3px solid #dc2626; border-radius: 6px; text-align: center;">';
                    html += '<div style="font-size: 24px; margin-bottom: 8px;">‚ö†Ô∏è</div>';
                    html += '<div style="font-size: 15px; font-weight: 700; color: #dc2626;">Âª∫Ë≠∞ÁØÑÂúçÂÖßÊ≤íÊúâÂèØÁî®ÁöÑÂ∑•‰ΩúÊó•</div>';
                    html += '</div>';
                }
                
                v2SuggDiv.innerHTML = html;
            } else if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                
                if (drugType) {
                    var washoutDays = parseInt(drugType);
                    var v2_min = addDays(v1, washoutDays + 1);
                    var v2_max = addDays(v1, Math.min(washoutDays + 7, 35)); // Maximum 35 days from V1
                    
                    // Find all workdays in range that won't cause problems
                    var workdays = [];
                    var currentDate = v2_min;
                    while (currentDate <= v2_max) {
                        if (!checkHoliday(currentDate)) {
                            // Ê™¢Êü•ÈÄôÂÄã V2 ÊòØÂê¶ÊúÉÂ∞éËá¥ÂæåÁ∫å Visit ÁÑ°Ê≥ïÈÅ∏Êìá
                            var isViable = true;
                            
                            // Check V3 (Day 8¬±7)
                            var v3_center = addDays(currentDate, 7);
                            if (!hasValidOptionsInWindow(v3_center)) isViable = false;
                            
                            // Check V4 (Day 15¬±7)
                            var v4_center = addDays(currentDate, 14);
                            if (!hasValidOptionsInWindow(v4_center)) isViable = false;
                            
                            // Check V5 (Day 29¬±2)
                            var v5_center = addDays(currentDate, 28);
                            if (!hasValidOptionsInWindow(v5_center)) isViable = false;
                            
                            if (isViable) {
                                workdays.push(new Date(currentDate));
                            }
                        }
                        currentDate = addDays(currentDate, 1);
                    }
                    
                    // Filter workdays to only include those where V1a range has workdays
                    var validV2s = [];
                    for (var i = 0; i < workdays.length; i++) {
                        var testV2 = workdays[i];
                        
                        // Check if V1a range (V2-7 to V2-1) has any workdays
                        var v1a_early = addDays(testV2, -7);
                        var v1a_late = addDays(testV2, -1);
                        var hasV1aWorkday = false;
                        
                        var checkDate = v1a_early;
                        while (checkDate <= v1a_late) {
                            var washout_check = getDaysDiff(v1, checkDate);
                            if (washout_check >= washoutDays && !checkHoliday(checkDate)) {
                                hasV1aWorkday = true;
                                break;
                            }
                            checkDate = addDays(checkDate, 1);
                        }
                        
                        if (hasV1aWorkday) {
                            validV2s.push(testV2);
                        }
                    }
                    
                    html = '';
                    // üèÜ ‰∏ñÁïåÂÜ†ËªçÁ¥öÊ®ôÈ°åÔºàÁµ±‰∏ÄÊ®£ÂºèÔºâ
                    html += '<div style="margin: 28px 0 20px 0;">';
                    html += '<h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700; color: #1e293b;">Visit 2 Âª∫Ë≠∞Ë®™Ë¶ñÊó•Êúü</h3>';
                    html += '<div style="font-size: 14px; color: #64748b;">ÂèØÈÅ∏ÁØÑÂúçÔºö' + formatDateWithWeekday(v2_min) + ' ~ ' + formatDateWithWeekday(v2_max) + '</div>';
                    html += '<div style="font-size: 13px; color: #9b9a97; margin-top: 4px;">(' + validV2s.length + ' ÂÄãÂèØÁî®Êó•Êúü)</div>';
                    html += '</div>';
                    
                    // Áï∂ÂâçÈÅ∏ÊìáÊó•Êúü - Á∞°ÊΩîÈ°ØÁ§∫
                    var currentV2Display = document.getElementById('visit2').value;
                    if (currentV2Display) {
                        html += '<div style="margin-bottom: 20px;">';
                        html += '<div style="font-size: 15px; font-weight: 500; color: #37352f;">Â∑≤ÈÅ∏Ôºö' + formatDateWithWeekday(parseDate(currentV2Display)) + '</div>';
                        html += '</div>';
                    }
                    
                    if (workdays.length > 0) {
                        
                        if (validV2s.length > 0) {
                            html += '<div class="btn-group" style="display: flex; flex-direction: column; gap: 8px;">';
                            
                            // If too many valid V2s, show first 3 and last 3
                            if (validV2s.length > 7) {
                                // Show first 3
                                for (var i = 0; i < 3; i++) {
                                    var isPerfect = true;
                                    var testV2 = validV2s[i];
                                    var dateStr = formatDate(validV2s[i]);
                                    
                                    // Quick check if this V2 is perfect
                                    if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                        isPerfect = false;
                                    }
                                    
                                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Áï∂ÂâçÈÅ∏‰∏≠ÁöÑÊó•Êúü
                                    var v2Input = document.getElementById('visit2');
                                    var isCurrentlySelected = (v2Input && v2Input.value === dateStr);
                                    
                                    html += createV2SuggestionButton(dateStr, validV2s[i], isPerfect, isCurrentlySelected);
                                }
                                
                                html += '<span style="padding: 8px;">...</span>';
                                
                                // Show last 3
                                for (var i = validV2s.length - 3; i < validV2s.length; i++) {
                                    var isPerfect = true;
                                    var testV2 = validV2s[i];
                                    var dateStr = formatDate(validV2s[i]);
                                    
                                    if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                        isPerfect = false;
                                    }
                                    
                                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Áï∂ÂâçÈÅ∏‰∏≠ÁöÑÊó•Êúü
                                    var v2Input = document.getElementById('visit2');
                                    var isCurrentlySelected = (v2Input && v2Input.value === dateStr);
                                    
                                    html += createV2SuggestionButton(dateStr, validV2s[i], isPerfect, isCurrentlySelected);
                                }
                            } else {
                                // Show all valid V2s
                                for (var i = 0; i < validV2s.length; i++) {
                                    var isPerfect = true;
                                    var testV2 = validV2s[i];
                                    var dateStr = formatDate(validV2s[i]);
                                    
                                    // Check if this V2 leads to perfect outcome
                                    if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                        isPerfect = false;
                                    }
                                    
                                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Áï∂ÂâçÈÅ∏‰∏≠ÁöÑÊó•Êúü
                                    var v2Input = document.getElementById('visit2');
                                    var isCurrentlySelected = (v2Input && v2Input.value === dateStr);
                                    
                                    html += createV2SuggestionButton(dateStr, validV2s[i], isPerfect, isCurrentlySelected);
                                }
                            }
                            
                            html += '</div>';
                            
                            // ÁÑ°ÈúÄÂúñ‰æã - Á∞°ÊΩîÂç≥Áæé
                            
                            // Build a map of validV2s with their perfect status for calendar
                            var validV2PerfectMap = {};
                            for (var i = 0; i < validV2s.length; i++) {
                                var testV2 = validV2s[i];
                                var isPerfect = true;
                                
                                // Check if this V2 leads to perfect outcome
                                if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                    countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                    countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                    isPerfect = false;
                                }
                                
                                validV2PerfectMap[formatDate(testV2)] = isPerfect;
                            }
                            
                            // üèÜ Á∞°ÊΩîÊúàÊõÜÔºàËàáV2 NaiveÂíåV1aÁµ±‰∏ÄÔºâ
                            html += '<div style="margin-top: 24px;">';
                            html += '<div style="font-size: 14px; font-weight: 600; color: #64748b; margin-bottom: 12px;">üìÖ ÂèØÁî®Êó•Êúü</div>';
                            
                            // Âúñ‰æãÂ∑≤ÁßªÈô§ - ‰øùÊåÅÁ∞°ÊΩî
                            
                            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 11px;">';
                            
                            // Áç≤ÂèñÁï∂ÂâçÈÅ∏‰∏≠ÁöÑ V2 Êó•Êúü
                            var v2Input = document.getElementById('visit2');
                            
                            // Get date range for calendar (from v2_min to v2_max)
                            var calStartDate = new Date(v2_min);
                            calStartDate.setDate(calStartDate.getDate() - calStartDate.getDay()); // Start from Sunday
                            
                            var calEndDate = new Date(v2_max);
                            var endDay = calEndDate.getDay();
                            if (endDay !== 6) {
                                calEndDate.setDate(calEndDate.getDate() + (6 - endDay)); // End on Saturday
                            }
                            
                            // Add weekday headers
                            var weekdayHeaders = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
                            for (var i = 0; i < 7; i++) {
                                html += '<div style="text-align: center; font-weight: 600; color: #9ca3af; padding: 4px;">' + weekdayHeaders[i] + '</div>';
                            }
                            
                            // Add date cells
                            var currentCalDate = new Date(calStartDate);
                            while (currentCalDate <= calEndDate) {
                                var dateStr = formatDate(currentCalDate);
                                var isInRange = currentCalDate >= v2_min && currentCalDate <= v2_max;
                                var isValidV2 = validV2PerfectMap.hasOwnProperty(dateStr);
                                var isPerfectDate = validV2PerfectMap[dateStr] === true;
                                var isSelected = (v2Input && v2Input.value && formatDate(parseDate(v2Input.value)) === dateStr);
                                
                                var cellStyle = 'text-align: center; padding: 6px 4px; border-radius: 6px; ';
                                if (isValidV2) {
                                    if (isSelected) {
                                        // Â∑≤ÈÅ∏ÔºöËóçËâ≤Â∫ï + ÁôΩÂ≠ó
                                        cellStyle += 'background: #0b6ac9; border: none; color: #ffffff; font-weight: 600; cursor: pointer;';
                                    } else if (isPerfectDate) {
                                        // ÂèØÈÅ∏Êó•Êúü - ÁôΩÂ∫ï + Ê∑°ÁÅ∞Ê°Ü + Ê∑±ÁÅ∞Â≠ó
                                        cellStyle += 'background: #ffffff; border: 1px solid #e0e0e0; color: #37352f; font-weight: 500; cursor: pointer;';
                                    } else {
                                        // ÂèØÈÅ∏‰ΩÜÈùûÂÆåÁæé - ÁôΩÂ∫ï + Ê∑°ÁÅ∞Ê°Ü + Ê∑±ÁÅ∞Â≠ó
                                        cellStyle += 'background: #ffffff; border: 1px solid #e0e0e0; color: #37352f; font-weight: 500; cursor: pointer;';
                                    }
                                } else if (isInRange) {
                                    cellStyle += 'background: #f5f5f5; color: #9b9a97;';
                                } else {
                                    cellStyle += 'background: #fafafa; color: #d0d0d0;';
                                }
                                
                                var onclick = isValidV2 ? ' onclick="useV2Date(\'' + dateStr + '\')"' : '';
                                html += '<div style="' + cellStyle + '"' + onclick + '>' + currentCalDate.getDate() + '</div>';
                                
                                currentCalDate.setDate(currentCalDate.getDate() + 1);
                            }
                            
                            html += '</div>';
                            html += '</div>';
                        } else {
                            // No valid V2s - all would result in V1a having no workdays
                            html += '<div style="margin-top: 12px; padding: 16px; background: #fee2e2; border: 3px solid #dc2626; border-radius: 6px; text-align: center;">';
                            html += '<div style="font-size: 24px; margin-bottom: 8px;">‚ö†Ô∏è</div>';
                            html += '<div style="font-size: 15px; font-weight: 700; color: #dc2626; margin-bottom: 8px;">ÁÑ°ÂèØÁî®ÁöÑ V2 Êó•Êúü</div>';
                            html += '<div style="font-size: 13px; color: #991b1b; font-weight: 600;">ÊâÄÊúâÂÄôÈÅ∏Êó•ÊúüÈÉΩÊúÉÂ∞éËá¥ V1a ÁØÑÂúçÂÖßÊ≤íÊúâÂ∑•‰ΩúÊó•<br>Ë´ãË™øÊï¥ V1 Âà∞Êõ¥ÊôöÁöÑÊó•Êúü</div>';
                            html += '</div>';
                        }
                    } else {
                        html += '<div style="margin-top: 12px; padding: 16px; background: #fee2e2; border: 3px solid #dc2626; border-radius: 6px; text-align: center;">';
                        html += '<div style="font-size: 24px; margin-bottom: 8px;">‚ö†Ô∏è</div>';
                        html += '<div style="font-size: 15px; font-weight: 700; color: #dc2626;">Âª∫Ë≠∞ÁØÑÂúçÂÖßÊ≤íÊúâÂèØÁî®ÁöÑÂ∑•‰ΩúÊó•</div>';
                        html += '</div>';
                    }
                    
                    html += '</div>';
                }
            }
            
            v2SuggDiv.innerHTML = html;
        }
        
        // Check all visits for holiday conflicts immediately after V1/V2 input
        function checkAllVisitsHolidays() {
            console.log('=== checkAllVisitsHolidays Ë¢´Ë™øÁî® ===');
            
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var warningDiv = document.getElementById('allVisitsHolidayWarning');
            
            console.log('V1 Ëº∏ÂÖ•:', v1Input);
            console.log('V2 Ëº∏ÂÖ•:', v2Input);
            
            // Clear previous warning
            warningDiv.innerHTML = '';
            
            if (!v1Input || !v2Input) {
                console.log('‚ö†Ô∏è V1 Êàñ V2 Êú™Ëº∏ÂÖ•ÔºåÊ∏ÖÈô§Ë≠¶Âëä‰∏¶ÈÄÄÂá∫');
                console.log('   ÈúÄË¶ÅÂÖ©ËÄÖÈÉΩËº∏ÂÖ•ÂæåÊâçÊúÉÈ°ØÁ§∫Ë≠¶Âëä');
                return;
            }
            
            console.log('‚úÖ V1 Âíå V2 ÈÉΩÂ∑≤Ëº∏ÂÖ•ÔºåÈñãÂßãÊ™¢Êü•...');
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            
            // Collect all problems
            var allProblems = [];
            
            // Check V1
            var v1Holiday = checkHoliday(v1);
            if (v1Holiday) {
                allProblems.push({ visit: 'Visit 1', date: formatDate(v1), reason: v1Holiday.msg, canAdjust: false });
            }
            
            // Check V2
            var v2Holiday = checkHoliday(v2);
            if (v2Holiday) {
                allProblems.push({ visit: 'Visit 2', date: formatDate(v2), reason: v2Holiday.msg, canAdjust: false });
            }
            
            // Check V1a (if exists and needed)
            // V1a can be selected by user, we'll check suggested date
            
            // Check Day 2
            var day2 = addDays(v2, 1);
            var day2Holiday = checkHoliday(day2);
            if (day2Holiday) {
                allProblems.push({ visit: 'Day 2', date: formatDate(day2), reason: day2Holiday.msg, canAdjust: false });
            }
            
            // Check Visit 3 (V2+7, with ¬±2 flexibility)
            var v3_center = addDays(v2, 7);
            var v3Holiday = checkHoliday(v3_center);
            var v3HasOptions = hasValidOptionsInWindow(v3_center);
            if (v3Holiday || !v3HasOptions) {
                allProblems.push({ 
                    visit: 'Visit 3', 
                    date: formatDate(v3_center), 
                    reason: v3Holiday ? v3Holiday.msg : 'ÂΩàÊÄßÁ™óÂè£ÂÖßÂÖ®ÊòØÂÅáÊó•',
                    canAdjust: v3HasOptions,
                    noOptions: !v3HasOptions
                });
            }
            
            // Check Visit 4 (V2+14, with ¬±2 flexibility)
            var v4_center = addDays(v2, 14);
            var v4Holiday = checkHoliday(v4_center);
            var v4HasOptions = hasValidOptionsInWindow(v4_center);
            if (v4Holiday || !v4HasOptions) {
                allProblems.push({ 
                    visit: 'Visit 4', 
                    date: formatDate(v4_center), 
                    reason: v4Holiday ? v4Holiday.msg : 'ÂΩàÊÄßÁ™óÂè£ÂÖßÂÖ®ÊòØÂÅáÊó•',
                    canAdjust: v4HasOptions,
                    noOptions: !v4HasOptions
                });
            }
            
            // Check Visit 5 (V2+28, with ¬±2 flexibility)
            var v5_center = addDays(v2, 28);
            var v5Holiday = checkHoliday(v5_center);
            var v5HasOptions = hasValidOptionsInWindow(v5_center);
            if (v5Holiday || !v5HasOptions) {
                allProblems.push({ 
                    visit: 'Visit 5', 
                    date: formatDate(v5_center), 
                    reason: v5Holiday ? v5Holiday.msg : 'ÂΩàÊÄßÁ™óÂè£ÂÖßÂÖ®ÊòØÂÅáÊó•',
                    canAdjust: v5HasOptions,
                    noOptions: !v5HasOptions
                });
            }
            
            // Check Visit 6 (first day of range V2+29)
            var v6_start = addDays(v2, 29);
            var v6Holiday = checkHoliday(v6_start);
            if (v6Holiday) {
                allProblems.push({ 
                    visit: 'Visit 6 (Day 29)', 
                    date: formatDate(v6_start), 
                    reason: v6Holiday.msg,
                    canAdjust: true
                });
            }
            
            console.log('üìã Ê™¢Êü•ÂÆåÊàêÔºåÁôºÁèæÁöÑÂïèÈ°åÊï∏Èáè:', allProblems.length);
            if (allProblems.length > 0) {
                console.log('ÂïèÈ°åË©≥ÊÉÖ:', allProblems);
            }
            
            // Display warnings and solutions if any problems found
            if (allProblems.length > 0) {
                console.log('üö® ÈñãÂßãÁîüÊàêË≠¶Âëä HTML...');
                
                var html = '';
                
                // Show problem summary
                html += '<div class="holiday-warning-box" style="padding: 20px; background: #fef2f2; border: 3px solid #dc2626; border-radius: 6px; margin: 20px 0; position: relative;">';
                html += '<button onclick="document.getElementById(\'allVisitsHolidayWarning\').innerHTML=\'\'" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; color: #dc2626; cursor: pointer; padding: 0; width: 30px; height: 30px; line-height: 30px; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background=\'rgba(220,38,38,0.1)\'" onmouseout="this.style.background=\'none\'">√ó</button>';
                html += '<div style="text-align: center; font-weight: 700; font-size: 20px; color: #dc2626; margin-bottom: 15px; padding-right: 30px;">‚ö†Ô∏è ÁôºÁèæÊó•ÊúüË°ùÁ™Å</div>';
                html += '<div style="text-align: center; font-size: 14px; color: #991b1b; margin-bottom: 15px;">‰ª•‰∏ãË®™Ë¶ñÁöÑÊó•ÊúüÈÅáÂà∞ÂÅáÊó•ÊàñÈÄ±Êú´</div>';
                
                // Problem table
                html += '<table style="width: 100%; font-size: 13px; border-collapse: collapse; margin-bottom: 15px; background: white;">';
                html += '<thead><tr style="background: #dc2626; color: white;">';
                html += '<th style="padding: 10px; text-align: center;">Ë®™Ë¶ñ</th>';
                html += '<th style="padding: 10px; text-align: center;">ÁõÆÂâçÊó•Êúü</th>';
                html += '<th style="padding: 10px; text-align: center;">ÂïèÈ°å</th>';
                html += '<th style="padding: 10px; text-align: center;">ÁãÄÊÖã</th>';
                html += '</tr></thead><tbody>';
                
                for (var i = 0; i < allProblems.length; i++) {
                    var p = allProblems[i];
                    html += '<tr style="background: #fff5f5; border-bottom: 2px solid #fee2e2;">';
                    html += '<td style="padding: 10px; text-align: center; font-weight: 600; color: #dc2626;">' + p.visit + '</td>';
                    html += '<td style="padding: 10px; text-align: center;">' + p.date + '</td>';
                    html += '<td style="padding: 10px; text-align: center; color: #dc2626;">' + p.reason + '</td>';
                    
                    if (p.noOptions) {
                        html += '<td style="padding: 10px; text-align: center; color: #dc2626; font-weight: 600; font-size: 12px;">‚õî ÂΩàÊÄßÁ™óÂè£ÂÖßÁÑ°ÂèØÁî®Êó•Êúü</td>';
                    } else if (p.canAdjust) {
                        html += '<td style="padding: 10px; text-align: center; color: #57534e; font-size: 12px;">‚ö†Ô∏è ÂèØÂú®ÂΩàÊÄßÁ™óÂè£ÂÖßË™øÊï¥</td>';
                    } else {
                        html += '<td style="padding: 10px; text-align: center; color: #dc2626; font-size: 12px;">‚ùå Âõ∫ÂÆöÊó•Êúü</td>';
                    }
                    html += '</tr>';
                }
                html += '</tbody></table>';
                
                // Find comprehensive solution
                console.log('üîç Â∞ãÊâæÂÆåÊï¥Ëß£Ê±∫ÊñπÊ°à...');
                var comprehensiveSolution = findComprehensiveSolution(v1, v2, allProblems);
                
                if (comprehensiveSolution) {
                    console.log('‚úÖ ÊâæÂà∞ÂÆåÊï¥Ëß£Ê±∫ÊñπÊ°à:', comprehensiveSolution);
                    
                    // Display solution
                    html += '<div style="background: #f0f7fd; padding: 15px; border-radius: 6px; border: 2px solid #5b9dd9; margin-top: 15px;">';
                    html += '<div style="font-size: 15px; font-weight: 700; color: #1e40af; margin-bottom: 10px;">üí° ÂÆåÊï¥Ëß£Ê±∫ÊñπÊ°à</div>';
                    
                    if (comprehensiveSolution.needsV1Change) {
                        html += '<div style="font-size: 13px; color: #1e40af; margin-bottom: 10px;">';
                        html += 'Â∞á <strong>V1</strong> Âæû ' + formatDate(v1) + ' ÊîπÁÇ∫ <strong>' + comprehensiveSolution.newV1 + '</strong><br>';
                        html += 'Â∞á <strong>V2</strong> Âæû ' + formatDate(v2) + ' ÊîπÁÇ∫ <strong>' + comprehensiveSolution.newV2 + '</strong>';
                        html += '</div>';
                    } else {
                        html += '<div style="font-size: 13px; color: #1e40af; margin-bottom: 10px;">';
                        html += 'Â∞á <strong>V2</strong> Âæû ' + formatDate(v2) + ' ÊîπÁÇ∫ <strong>' + comprehensiveSolution.newV2 + '</strong>';
                        html += '<br><span style="font-size: 12px;">ÔºàV1 ‰øùÊåÅ ' + formatDate(v1) + ' ‰∏çËÆäÔºâ</span>';
                        html += '</div>';
                    }
                    
                    // Show what will be resolved
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 12px;">';
                    html += '<div style="font-weight: 600; color: #1e40af; margin-bottom: 5px;">Ê≠§ÊñπÊ°àÂ∞áÁ¢∫‰øùÔºö</div>';
                    html += '<ul style="margin: 5px 0; padding-left: 20px; color: #1e40af;">';
                    html += '<li>ÊâÄÊúâË®™Ë¶ñÊó•ÊúüÈÉΩÈÅøÈñãÂÅáÊó•ÂíåÈÄ±Êú´</li>';
                    html += '<li>ÊâÄÊúâÂΩàÊÄßÁ™óÂè£ÂÖßÈÉΩÊúâÂèØÁî®ÁöÑÂ∑•‰ΩúÊó•</li>';
                    html += '<li>‰∏çÊúÉÁî¢ÁîüÊñ∞ÁöÑÊó•ÊúüË°ùÁ™Å</li>';
                    html += '</ul>';
                    html += '</div>';
                    
                    // Apply button
                    html += '<button onclick=\'applyComprehensiveSolution(' + JSON.stringify(comprehensiveSolution) + ')\' ';
                    html += 'style="width: 100%; padding: 14px; background: #5b9dd9; color: white; border: none; border-radius: 6px; ';
                    html += 'font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);" ';
                    html += 'onmouseover="this.style.background=\'#4285c4\'; this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 8px rgba(59, 130, 246, 0.4)\'" ';
                    html += 'onmouseout="this.style.background=\'#5b9dd9\'; this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 6px rgba(59, 130, 246, 0.3)\'">';
                    html += '‚ú® Â•óÁî®ÂÆåÊï¥Ëß£Ê±∫ÊñπÊ°à';
                    html += '</button>';
                    html += '</div>';
                } else {
                    console.log('‚ùå ÁÑ°Ê≥ïÊâæÂà∞ÂÆåÊï¥Ëß£Ê±∫ÊñπÊ°à');
                    
                    // No automatic solution found
                    html += '<div style="background: #fff3cd; padding: 15px; border-radius: 6px; border: 2px solid #57534e; margin-top: 15px;">';
                    html += '<div style="font-size: 15px; font-weight: 700; color: #57534e; margin-bottom: 10px;">‚ö†Ô∏è ÁÑ°Ê≥ïËá™ÂãïËß£Ê±∫</div>';
                    html += '<div style="font-size: 13px; color: #78350f; margin-bottom: 10px;">';
                    html += 'Á≥ªÁµ±Âú®ÂêàÁêÜÁØÑÂúçÂÖßÔºàV2 ¬±14Â§©ÔºâÊâæ‰∏çÂà∞ËÉΩÂÆåÂÖ®Ëß£Ê±∫ÊâÄÊúâË°ùÁ™ÅÁöÑÊó•Êúü„ÄÇ';
                    html += '</div>';
                    html += '<div style="font-size: 12px; color: #78350f; background: white; padding: 10px; border-radius: 6px;">';
                    html += '<strong>Âª∫Ë≠∞Ôºö</strong><br>';
                    html += '‚Ä¢ ÊâãÂãïË™øÊï¥ V1 Êàñ V2 Âà∞ÈÅ†Èõ¢ÂÅáÊó•ÂØÜÈõÜÊúü<br>';
                    html += '‚Ä¢ ÊàñÂú®‰∏ãÊñπË®™Ë¶ñÊéíÁ®ã‰∏≠‰ΩøÁî®Êó•ÊúüÈÅ∏ÊìáÂô®ÈÄêÂÄãË™øÊï¥';
                    html += '</div>';
                    html += '</div>';
                }
                
                html += '</div>'; // End main warning box
                
                console.log('üìù HTML Â∑≤ÁîüÊàêÔºåÈï∑Â∫¶:', html.length, 'Â≠óÂÖÉ');
                
                warningDiv.innerHTML = html;
                
                console.log('‚úÖ innerHTML Â∑≤Ë®≠ÁΩÆ');
                console.log('Ë≠¶ÂëäÊ°ÜÂÖßÂÆπÈï∑Â∫¶:', warningDiv.innerHTML.length);
                
                // ‰∏çËá™Âä®ÊªöÂä®ÔºåËÆ©Áî®Êà∑ÂèØ‰ª•Ëá™Áî±Êü•ÁúãÈ°µÈù¢
                // setTimeout(function() {
                //     console.log('üìú Ëá™ÂãïÊªæÂãïÂà∞Ë≠¶ÂëäÊ°Ü');
                //     warningDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                // }, 200);
            } else {
                console.log('‚ÑπÔ∏è Ê≤íÊúâÁôºÁèæ‰ªª‰ΩïÂïèÈ°åÔºåÊ∏ÖÈô§Ë≠¶ÂëäÊ°Ü');
                warningDiv.innerHTML = '';
            }
        }
        
        // Find a comprehensive solution that solves ALL problems without creating new ones
        function findComprehensiveSolution(currentV1, currentV2, allProblems) {
            // Strategy 1: Try adjusting only V2 (keep V1)
            console.log('ÂòóË©¶Á≠ñÁï• 1ÔºöÂè™Ë™øÊï¥ V2');
            for (var offset = 1; offset <= 14; offset++) {
                // Try forward
                var testV2 = addDays(currentV2, offset);
                if (isCompletelyValidV2(testV2)) {
                    return {
                        needsV1Change: false,
                        newV1: formatDate(currentV1),
                        newV2: formatDate(testV2)
                    };
                }
                
                // Try backward
                testV2 = addDays(currentV2, -offset);
                if (isCompletelyValidV2(testV2)) {
                    return {
                        needsV1Change: false,
                        newV1: formatDate(currentV1),
                        newV2: formatDate(testV2)
                    };
                }
            }
            
            // Strategy 2: Try adjusting both V1 and V2
            console.log('ÂòóË©¶Á≠ñÁï• 2ÔºöÂêåÊôÇË™øÊï¥ V1 Âíå V2');
            for (var v1Offset = 1; v1Offset <= 7; v1Offset++) {
                var testV1 = addDays(currentV1, v1Offset);
                
                // V1 must be a workday
                if (checkHoliday(testV1)) continue;
                
                // Try different V2 dates for this V1
                for (var v2Offset = 1; v2Offset <= 35; v2Offset++) {
                    var testV2 = addDays(testV1, v2Offset);
                    
                    // Check if this V2 is valid and solves everything
                    if (isCompletelyValidV2(testV2)) {
                        return {
                            needsV1Change: true,
                            newV1: formatDate(testV1),
                            newV2: formatDate(testV2)
                        };
                    }
                }
            }
            
            return null; // No solution found
        }
        
        // Check if a V2 date results in NO conflicts for any visit
        function isCompletelyValidV2(v2Date) {
            // First, check if V1-V2 interval meets subject type requirements
            var v1Input = document.getElementById('visit1').value;
            var type = document.getElementById('subjectType').value;
            
            if (!v1Input || !type) {
                return false;
            }
            
            var v1 = parseDate(v1Input);
            var v1_v2_days = getDaysDiff(v1, v2Date);
            
            // Validate V1-V2 interval based on subject type
            if (type === 'naive') {
                // Naive: 1-35 days
                if (v1_v2_days < 1 || v1_v2_days > 35) {
                    return false;
                }
            } else if (type === 'washout') {
                // Washout: washoutDays+1 to 35 days
                var drugType = document.getElementById('drugType').value;
                if (!drugType) {
                    return false;
                }
                var washoutDays = parseInt(drugType);
                var minDays = washoutDays + 1;
                
                if (v1_v2_days < minDays || v1_v2_days > 35) {
                    console.log('V2ÂÄôÈÅ∏Êó•Êúü‰∏çÁ¨¶ÂêàWashoutË¶ÅÊ±Ç:', formatDate(v2Date), 'V1-V2ÈñìÈöî:', v1_v2_days, 'Â§©ÔºåÈúÄË¶Å:', minDays, '-35Â§©');
                    return false;
                }
            }
            
            // V2 itself must be a workday
            if (checkHoliday(v2Date)) {
                return false;
            }
            
            // Day 2 (V2+1) must be a workday
            var day2 = addDays(v2Date, 1);
            if (checkHoliday(day2)) {
                return false;
            }
            
            // Visit 3 (V2+7 ¬±2) must have at least one workday in window
            var v3_center = addDays(v2Date, 7);
            if (!hasValidOptionsInWindow(v3_center)) {
                return false;
            }
            // And the best date in V3 window must be a workday
            var v3_best = findBestDateInWindow(v3_center);
            if (!v3_best || checkHoliday(v3_best)) {
                return false;
            }
            
            // Visit 4 (V2+14 ¬±2) must have at least one workday in window
            var v4_center = addDays(v2Date, 14);
            if (!hasValidOptionsInWindow(v4_center)) {
                return false;
            }
            var v4_best = findBestDateInWindow(v4_center);
            if (!v4_best || checkHoliday(v4_best)) {
                return false;
            }
            
            // Visit 5 (V2+28 ¬±2) must have at least one workday in window
            var v5_center = addDays(v2Date, 28);
            if (!hasValidOptionsInWindow(v5_center)) {
                return false;
            }
            var v5_best = findBestDateInWindow(v5_center);
            if (!v5_best || checkHoliday(v5_best)) {
                return false;
            }
            
            // Visit 6 (first day V2+29) should ideally be a workday
            var v6_start = addDays(v2Date, 29);
            // V6 is less critical but check if there's a workday in first few days
            var v6HasWorkday = false;
            for (var i = 0; i < 3; i++) {
                if (!checkHoliday(addDays(v6_start, i))) {
                    v6HasWorkday = true;
                    break;
                }
            }
            if (!v6HasWorkday) {
                return false;
            }
            
            return true; // All checks passed
        }
        
        // Apply comprehensive solution
        function applyComprehensiveSolution(solution) {
            var confirmMsg = 'Ê≠§Êìç‰ΩúÂ∞áÔºö\n\n';
            if (solution.needsV1Change) {
                confirmMsg += 'V1: ' + document.getElementById('visit1').value + ' ‚Üí ' + solution.newV1 + '\n';
            }
            confirmMsg += 'V2: ' + document.getElementById('visit2').value + ' ‚Üí ' + solution.newV2 + '\n\n';
            confirmMsg += 'ÊâÄÊúâË®™Ë¶ñÊó•ÊúüÂ∞áÈáçÊñ∞Ë®àÁÆóÔºåÁ¢∫‰øùÊ≤íÊúâÂÅáÊó•Ë°ùÁ™Å„ÄÇ\n\nÁ¢∫ÂÆöË¶ÅÂ•óÁî®ÂóéÔºü';
            
            if (confirm(confirmMsg)) {
                console.log('‚úÖ Áî®Êà∂Á¢∫Ë™çÂ•óÁî®ÂÆåÊï¥Ëß£Ê±∫ÊñπÊ°à');
                
                if (solution.needsV1Change) {
                    document.getElementById('visit1').value = solution.newV1;
                }
                document.getElementById('visit2').value = solution.newV2;
                
                // Clear all selections
                selectedV3 = null;
                selectedV4 = null;
                selectedV5 = null;
                
                // Recalculate everything
                validateDates();
                
                // Clear warning
                document.getElementById('allVisitsHolidayWarning').innerHTML = '';
                
                // Âè™È°ØÁ§∫‰∏ÄÊ¨°ToastÔºå‰∏çÈúÄË¶ÅÁ≠âÂæÖÊ™¢Êü•
                showToast('success', 'ÂÆåÊàêÔºÅ', 'ÊâÄÊúâÊó•ÊúüÂ∑≤Â•óÁî®ÔºåË´ãÊ™¢Êü•‰∏ãÊñπÁöÑË®™Ë¶ñÊéíÁ®ã');
            }
        }
        
        // Quick fix functions for buttons in warning table
        
        
        
        // Add CSS animation for pulse effect
        var style = document.createElement('style');
        style.textContent = '@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }';
        document.head.appendChild(style);
        
        // Wrapper function to trigger V2 adjustment from warning
        function showV2AdjustmentOptionsFromWarning() {
            // Scroll to V2 input area first
            document.getElementById('visit2').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Trigger the existing V2 early warning check after a delay
            setTimeout(function() {
                checkV2EarlyWarning();
            }, 500);
        }
        
        // Auto-fill V2 with suggested date and show adjustment options
        function showEarlyAdjustmentSuggestion(suggestedV2) {
            // Parse the suggested date
            var v2Date = parseDate(suggestedV2);
            
            // Get V1 and calculate minimum required interval
            var v1Input = document.getElementById('visit1').value;
            var type = document.getElementById('subjectType').value;
            var minDays = 1;
            
            if (v1Input && type) {
                var v1 = parseDate(v1Input);
                
                if (type === 'washout') {
                    var drugType = document.getElementById('drugType').value;
                    if (drugType) {
                        var washoutDays = parseInt(drugType);
                        minDays = washoutDays + 1;
                    }
                }
                
                // If suggested date is a holiday, find next workday
                if (checkHoliday(v2Date)) {
                    var nextWorkday = getNextWorkday(v2Date);
                    if (nextWorkday) {
                        v2Date = nextWorkday;
                    }
                }
                
                // Ensure V2 meets minimum interval requirement
                var v1_v2_days = getDaysDiff(v1, v2Date);
                if (v1_v2_days < minDays) {
                    // Calculate minimum valid V2
                    v2Date = addDays(v1, minDays);
                    
                    // If minimum V2 is a holiday, find next workday
                    if (checkHoliday(v2Date)) {
                        var nextWorkday = getNextWorkday(v2Date);
                        if (nextWorkday) {
                            v2Date = nextWorkday;
                        }
                    }
                }
                
                suggestedV2 = formatDate(v2Date);
            }
            
            // Fill in V2 date
            document.getElementById('visit2').value = suggestedV2;
            
            // Trigger validations
            checkDateWarning('visit2');
            checkV2EarlyWarning();
            validateDates();
            
            // Scroll to warning area
            setTimeout(function() {
                var warningDiv = document.getElementById('v2EarlyWarning');
                if (warningDiv && warningDiv.innerHTML) {
                    warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300);
        }
        
        // Early warning check after V2 is entered
        function checkV2EarlyWarning() {
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var warningDiv = document.getElementById('v2EarlyWarning');
            
            // Clear previous warning
            warningDiv.innerHTML = '';
            
            if (!v1Input || !v2Input) {
                return;
            }
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            
            // Get subject type and calculate minimum V1-V2 interval
            var type = document.getElementById('subjectType').value;
            var minDays = 1;
            var maxDays = 35;
            
            if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                if (drugType) {
                    var washoutDays = parseInt(drugType);
                    minDays = washoutDays + 1;
                }
            }
            
            // FIRST: Check V1-V2 interval
            var v1_v2_days = getDaysDiff(v1, v2);
            
            if (v1_v2_days < minDays || v1_v2_days > maxDays) {
                var html = '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 6px;">';
                html += '<div style="font-weight: 600; font-size: 14px; color: #dc2626; margin-bottom: 6px;">‚ö†Ô∏è V1 Âà∞ V2 ÈñìÈöî‰∏çÁ¨¶ÂêàË¶ÅÊ±Ç</div>';
                
                if (v1_v2_days < minDays) {
                    if (type === 'washout') {
                        var drugType = document.getElementById('drugType').value;
                        var washoutDays = parseInt(drugType);
                        html += '<div style="font-size: 13px; color: #991b1b; margin-bottom: 10px;">ÁõÆÂâçÈñìÈöîÔºö' + v1_v2_days + ' Â§©<br>';
                        html += 'ÈúÄË¶ÅËá≥Â∞ëÔºö' + minDays + ' Â§©Ôºà' + washoutDays + ' Â§©Ê¥óÈô§Êúü + 1 Â§©Ôºâ</div>';
                    } else {
                        html += '<div style="font-size: 13px; color: #991b1b; margin-bottom: 10px;">ÁõÆÂâçÈñìÈöîÔºö' + v1_v2_days + ' Â§©<br>';
                        html += 'ÈúÄË¶ÅËá≥Â∞ëÔºö1 Â§©</div>';
                    }
                    
                    // Suggest new V2
                    var suggestedV2 = addDays(v1, minDays);
                    if (checkHoliday(suggestedV2)) {
                        var nextWorkday = getNextWorkday(suggestedV2);
                        if (nextWorkday && getDaysDiff(v1, nextWorkday) <= maxDays) {
                            suggestedV2 = nextWorkday;
                        }
                    }
                    
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #57534e; margin-bottom: 6px;">üí° Á≥ªÁµ±Âª∫Ë≠∞Ôºö</div>';
                    html += '<div style="font-size: 13px; color: #1f2937;">Â∞á Visit 2 ÊîπÁÇ∫Ôºö<span style="color: #dc2626; font-weight: 600;">' + formatDate(suggestedV2) + '</span></div>';
                    html += '<button onclick="adjustV2Date(\'' + formatDate(suggestedV2) + '\')" class="btn btn-primary" style="width: 100%; margin-top: 8px; background: #dc2626;">';
                    html += '‚ú® Êé°Áî®Âª∫Ë≠∞‰∏¶ÈáçÊñ∞Ë®àÁÆó';
                    html += '</button>';
                    html += '</div>';
                } else {
                    html += '<div style="font-size: 13px; color: #991b1b; margin-bottom: 10px;">ÁõÆÂâçÈñìÈöîÔºö' + v1_v2_days + ' Â§©<br>';
                    html += 'ÊúÄÂ§öÂÖÅË®±Ôºö35 Â§©</div>';
                }
                
                html += '</div>';
                warningDiv.innerHTML = html;
                return; // Stop here
            }
            
            // SECOND: Check if V2 itself is a holiday/weekend
            var v2Holiday = checkHoliday(v2);
            if (v2Holiday) {
                var html = '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 6px;">';
                html += '<div style="font-weight: 600; font-size: 14px; color: #dc2626; margin-bottom: 6px;">‚ö†Ô∏è Visit 2 Êó•Êúü‰∏çÂèØÁî®</div>';
                html += '<div style="font-size: 13px; color: #991b1b; margin-bottom: 10px;">' + v2Holiday.msg + '</div>';
                html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">Visit 2 ÂøÖÈ†àÂú®Â∑•‰ΩúÊó•ÈÄ≤Ë°å</div>';
                
                // Find next workday for V2 that meets minimum interval requirement
                var nextV2 = getNextWorkday(v2);
                
                // Validate that nextV2 meets V1-V2 interval requirements
                if (nextV2) {
                    var v1_nextV2_days = getDaysDiff(v1, nextV2);
                    
                    // If nextV2 doesn't meet minimum interval, find a date that does
                    if (v1_nextV2_days < minDays) {
                        // Calculate the minimum valid V2 date
                        var minV2Date = addDays(v1, minDays);
                        
                        // Find next workday from minV2Date
                        if (checkHoliday(minV2Date)) {
                            nextV2 = getNextWorkday(minV2Date);
                        } else {
                            nextV2 = minV2Date;
                        }
                    }
                    
                    // Also check if nextV2 is within 35 days limit
                    if (nextV2) {
                        v1_nextV2_days = getDaysDiff(v1, nextV2);
                        if (v1_nextV2_days > maxDays) {
                            nextV2 = null; // Too far, can't suggest
                        }
                    }
                }
                
                if (nextV2) {
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #57534e; margin-bottom: 6px;">üí° Á≥ªÁµ±Âª∫Ë≠∞Ôºö</div>';
                    html += '<div style="font-size: 13px; color: #1f2937;">Â∞á Visit 2 ÊîπÁÇ∫Ôºö<span style="color: #dc2626; font-weight: 600;">' + formatDate(nextV2) + '</span></div>';
                    html += '<button onclick="adjustV2Date(\'' + formatDate(nextV2) + '\')" class="btn btn-primary" style="width: 100%; margin-top: 8px; background: #dc2626;">';
                    html += '‚ú® Êé°Áî®Âª∫Ë≠∞‰∏¶ÈáçÊñ∞Ë®àÁÆó';
                    html += '</button>';
                    html += '</div>';
                } else {
                    html += '<div style="font-size: 12px; color: #991b1b; margin-top: 10px;">‚ö†Ô∏è ÁÑ°Ê≥ïÊâæÂà∞Á¨¶ÂêàÊ¥óÈô§ÊúüË¶ÅÊ±ÇÁöÑÊõø‰ª£Êó•Êúü</div>';
                }
                
                html += '</div>';
                warningDiv.innerHTML = html;
                return; // Stop here, don't check further visits
            }
            
            // THIRD: Check if any of Visit 3, 4, 5 will have problems
            var problems = [];
            
            // Visit 3: Day 8 (V2 + 7)
            var v3_center = addDays(v2, 7);
            if (!hasValidOptionsInWindow(v3_center)) {
                problems.push({ visit: 'Visit 3', center: v3_center, day: 8 });
            }
            
            // Visit 4: Day 15 (V2 + 14)
            var v4_center = addDays(v2, 14);
            if (!hasValidOptionsInWindow(v4_center)) {
                problems.push({ visit: 'Visit 4', center: v4_center, day: 15 });
            }
            
            // Visit 5: Day 29 (V2 + 28)
            var v5_center = addDays(v2, 28);
            if (!hasValidOptionsInWindow(v5_center)) {
                problems.push({ visit: 'Visit 5', center: v5_center, day: 29 });
            }
            
            if (problems.length > 0) {
                var html = '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 6px;">';
                html += '<div style="font-weight: 600; font-size: 14px; color: #dc2626; margin-bottom: 6px;">‚ö†Ô∏è ÂæåÁ∫åË®™Ë¶ñÊó•ÊúüÈÉΩÁÑ°Ê≥ïÈÅ∏Êìá</div>';
                html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">Âª∫Ë≠∞Ë™øÊï¥ Visit 2 Êó•Êúü‰ª•Áç≤ÂæóÂèØÁî®ÈÅ∏È†Ö</div>';
                
                html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 8px;">‰ª•‰∏ã Visit ÁöÑÂΩàÊÄßÁ™óÂè£ÂÖßÊ≤íÊúâÂèØÁî®Êó•ÊúüÔºö</div>';
                html += '<ul style="margin: 0 0 10px 20px; padding: 0; font-size: 12px; color: #991b1b;">';
                for (var i = 0; i < problems.length; i++) {
                    var p = problems[i];
                    var rangeStart = addDays(p.center, -2);
                    var rangeEnd = addDays(p.center, 2);
                    html += '<li style="margin-bottom: 4px;">' + p.visit + ' (Day ' + p.day + '¬±2): ' + formatDate(rangeStart) + ' ~ ' + formatDate(rangeEnd) + '</li>';
                }
                html += '</ul>';
                
                html += '<button onclick="showV2AdjustmentOptions()" class="btn btn-primary" style="width: 100%; background: #dc2626; font-weight: 600;">';
                html += 'üí° Êü•ÁúãË™øÊï¥Âª∫Ë≠∞';
                html += '</button>';
                
                html += '</div>';
                
                warningDiv.innerHTML = html;
            }
        }
        
        // Check if a date's ¬±2 window has any valid options
        function hasValidOptionsInWindow(centerDate) {
            for (var i = -2; i <= 2; i++) {
                var testDate = addDays(centerDate, i);
                if (!checkHoliday(testDate)) {
                    return true; // Found at least one workday
                }
            }
            return false; // All dates are holidays/weekends
        }
        
        // Count how many workdays are available in a ¬±2 window
        function countWorkdaysInWindow(centerDate) {
            var count = 0;
            for (var i = -2; i <= 2; i++) {
                var testDate = addDays(centerDate, i);
                if (!checkHoliday(testDate)) {
                    count++;
                }
            }
            return count;
        }
        
        // Show V2 adjustment options (prioritize V1 unchanged, then V1 changed)
        function showV2AdjustmentOptions() {
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var warningDiv = document.getElementById('v2EarlyWarning');
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            
            var html = '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 6px;">';
            html += '<div style="font-weight: 600; font-size: 14px; color: #dc2626; margin-bottom: 6px;">‚ö†Ô∏è ÊâÄÊúâÊó•ÊúüÈÉΩÁÑ°Ê≥ïÈÅ∏Êìá</div>';
            html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">Âª∫Ë≠∞Ë™øÊï¥ Visit 2 Êó•Êúü‰ª•Áç≤ÂæóÂèØÁî®ÈÅ∏È†Ö</div>';
            
            // Priority 1: Keep V1, adjust V2
            var betterV2 = findBetterV2KeepingV1(v2);
            
            if (betterV2) {
                html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px;">';
                html += '<div style="font-size: 13px; font-weight: 600; color: #1f2937; margin-bottom: 6px;">üí° Á≥ªÁµ±Âª∫Ë≠∞Ôºö</div>';
                html += '<div style="font-size: 12px; color: #1f2937; margin-bottom: 8px;">Â∞á Visit 2 ÊîπÁÇ∫Ôºö<span style="color: #dc2626; font-weight: 600;">' + formatDate(betterV2) + '</span></div>';
                html += '<button onclick="adjustV2Date(\'' + formatDate(betterV2) + '\')" class="btn btn-primary" style="width: 100%; background: #dc2626;">';
                html += '‚ú® Êé°Áî®Âª∫Ë≠∞‰∏¶ÈáçÊñ∞Ë®àÁÆó';
                html += '</button>';
                html += '</div>';
            } else {
                // Priority 2: Adjust both V1 and V2
                var betterV1 = findNearestWorkday(v1);
                var betterV2ForNewV1 = betterV1 ? findBetterV2KeepingV1(addDays(betterV1, 1)) : null;
                
                html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">Âú® ¬±10 Â§©ÁØÑÂúçÂÖßÊâæ‰∏çÂà∞ÂêàÈÅ©ÁöÑ V2 Ë™øÊï¥</div>';
                html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                html += '<div style="font-size: 12px; color: #57534e; margin-bottom: 8px;">üí° Âª∫Ë≠∞Ë™øÊï¥ V1 Âíå V2Ôºö</div>';
                
                if (betterV1 && betterV2ForNewV1) {
                    html += '<div style="margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #1f2937; margin-bottom: 4px;">ÂæûÔºö</div>';
                    html += '<div style="font-size: 13px; color: #666;">V1 = ' + formatDate(v1) + '</div>';
                    html += '<div style="font-size: 13px; color: #666;">V2 = ' + formatDate(v2) + '</div>';
                    html += '<div style="font-size: 12px; color: #1f2937; margin: 8px 0 4px 0;">ÊîπÁÇ∫Ôºö</div>';
                    html += '<div style="font-size: 13px; color: #dc2626; font-weight: 600;">V1 = ' + formatDate(betterV1) + '</div>';
                    html += '<div style="font-size: 13px; color: #dc2626; font-weight: 600;">V2 = ' + formatDate(betterV2ForNewV1) + '</div>';
                    html += '<button onclick="adjustBothV1V2(\'' + formatDate(betterV1) + '\', \'' + formatDate(betterV2ForNewV1) + '\')" class="btn btn-primary" style="width: 100%; margin-top: 8px; background: #dc2626;">';
                    html += '‚ú® Êé°Áî®Âª∫Ë≠∞‰∏¶ÈáçÊñ∞Ë®àÁÆó';
                    html += '</button>';
                    html += '</div>';
                } else {
                    html += '<div style="font-size: 12px; color: #991b1b;">ÁÑ°Ê≥ïÊâæÂà∞ÂêàÈÅ©ÁöÑË™øÊï¥ÔºåÂª∫Ë≠∞ÈáçÊñ∞Ë¶èÂäÉÊï¥È´îÊéíÁ®ã</div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            warningDiv.innerHTML = html;
        }
        
        // Find better V2 while keeping V1 unchanged
        function findBetterV2KeepingV1(currentV2) {
            var v1Input = document.getElementById('visit1').value;
            var type = document.getElementById('subjectType').value;
            
            if (!v1Input || !type) {
                return null;
            }
            
            var v1 = parseDate(v1Input);
            var minDays = 1;
            var maxDays = 35;
            
            // Calculate minimum days based on subject type
            if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                if (!drugType) {
                    return null;
                }
                var washoutDays = parseInt(drugType);
                minDays = washoutDays + 1;
            }
            
            var maxAdjust = 10;
            
            for (var adjust = 1; adjust <= maxAdjust; adjust++) {
                // Try forward
                var newV2 = addDays(currentV2, adjust);
                var v1_v2_forward = getDaysDiff(v1, newV2);
                
                // Check V1-V2 interval validity
                if (v1_v2_forward >= minDays && v1_v2_forward <= maxDays) {
                    if (!checkHoliday(newV2) && canSolveAllVisitProblems(newV2)) {
                        return newV2;
                    }
                }
                
                // Try backward
                newV2 = addDays(currentV2, -adjust);
                var v1_v2_backward = getDaysDiff(v1, newV2);
                
                // Check V1-V2 interval validity
                if (v1_v2_backward >= minDays && v1_v2_backward <= maxDays) {
                    if (!checkHoliday(newV2) && canSolveAllVisitProblems(newV2)) {
                        return newV2;
                    }
                }
            }
            
            return null;
        }
        
        // Check if a V2 date solves all visit problems
        function canSolveAllVisitProblems(v2Date) {
            // First check V1-V2 interval
            var v1Input = document.getElementById('visit1').value;
            var type = document.getElementById('subjectType').value;
            
            if (v1Input && type) {
                var v1 = parseDate(v1Input);
                var v1_v2_days = getDaysDiff(v1, v2Date);
                var minDays = 1;
                var maxDays = 35;
                
                if (type === 'washout') {
                    var drugType = document.getElementById('drugType').value;
                    if (drugType) {
                        var washoutDays = parseInt(drugType);
                        minDays = washoutDays + 1;
                    }
                }
                
                // If V1-V2 interval doesn't meet requirements, this V2 won't work
                if (v1_v2_days < minDays || v1_v2_days > maxDays) {
                    return false;
                }
            }
            
            // Check Visit 3
            var v3_center = addDays(v2Date, 7);
            if (!hasValidOptionsInWindow(v3_center)) {
                return false;
            }
            
            // Check Visit 4
            var v4_center = addDays(v2Date, 14);
            if (!hasValidOptionsInWindow(v4_center)) {
                return false;
            }
            
            // Check Visit 5
            var v5_center = addDays(v2Date, 28);
            if (!hasValidOptionsInWindow(v5_center)) {
                return false;
            }
            
            return true; // All visits have valid options
        }
        
        // Adjust both V1 and V2
        function adjustBothV1V2(newV1, newV2) {
            document.getElementById('visit1').value = newV1;
            document.getElementById('visit2').value = newV2;
            
            // Clear selections
            visit1aDate = '';
            selectedV3 = null;
            selectedV4 = null;
            selectedV5 = null;
            
            // Mark that both dates were auto-adjusted
            window.autoAdjustedV1 = true;
            window.autoAdjustedV2 = true;
            
            // Recalculate everything
            checkDateWarning('visit1');
            checkDateWarning('visit2');
            checkV2EarlyWarning();
            calculateV2Suggestion();
            validateDates();
            document.getElementById('v1aSuggestion').innerHTML = '';
            document.getElementById('validation').innerHTML = '';
            document.getElementById('v2EarlyWarning').innerHTML = '';
            calculateVisits();
            
            // Recheck for conflicts
            setTimeout(function() {
                checkAllVisitsHolidays();
            }, 50);
            
            // Auto-clear the markers after 5 seconds
            setTimeout(function() {
                window.autoAdjustedV1 = false;
                window.autoAdjustedV2 = false;
                calculateVisits();
            }, 5000);
        }
        
        function useV2Date(date) {
            console.log('useV2Date called with:', date); // Ë™øË©¶‰ø°ÊÅØ
            
            const visit2Input = document.getElementById('visit2');
            if (!visit2Input) {
                console.error('visit2 input not found');
                return;
            }
            
            visit2Input.value = date;
            
            // Êõ¥Êñ∞Ëº∏ÂÖ•Ê°ÜÈ°ØÁ§∫
            updateDateInputDisplay('visit2');
            
            // Ê∑ªÂä†Á∂†Ëâ≤È©óË≠âÁãÄÊÖã
            visit2Input.classList.add('valid');
            visit2Input.classList.remove('invalid');
            
            checkDateWarning('visit2');
            checkV2EarlyWarning();
            
            // ‚úÖ ÈóúÈçµÔºöÈáçÊñ∞È°ØÁ§∫V2Âª∫Ë≠∞ÔºåËÆìÁî®Êà∂ÂèØ‰ª•ÁπºÁ∫åÈÅ∏ÊìáÂÖ∂‰ªñÊó•Êúü
            // ‰ΩøÁî®setTimeoutÁ¢∫‰øùDOMÊõ¥Êñ∞ÂÆåÊàêÂæåÂÜçË™øÁî®
            setTimeout(function() {
                calculateV2Suggestion();
            }, 10);
            
            validateDates();
            
            // Êõ¥Êñ∞ÈÄ≤Â∫¶
            if (typeof updateProgress === 'function') {
                updateProgress();
            }
            
            // Re-validate V1a if it exists
            if (visit1aDate) {
                validateV1a();
            }
            
            // Recheck for conflicts after a delay
            setTimeout(function() {
                checkAllVisitsHolidays();
            }, 50);
            
            // Á¢∫‰øùÂª∫Ë≠∞ÂçÄÂüüÂèØË¶ã
            var v2SuggDiv = document.getElementById('v2Suggestion');
            if (v2SuggDiv) {
                v2SuggDiv.style.display = 'block';
                v2SuggDiv.style.pointerEvents = 'auto';
            }
            
            console.log('useV2Date completed'); // Ë™øË©¶‰ø°ÊÅØ
        }
        
        // ============================================
        // Êó•ÊúüËº∏ÂÖ•Ê°ÜÈ°ØÁ§∫ÂÑ™Âåñ
        // ============================================
        function updateDateInputDisplay(inputId) {
            var input = document.getElementById(inputId);
            if (input.value) {
                // ÊúâÂÄºÊôÇÈ°ØÁ§∫ÁÇ∫ÊåâÈàïÊ®£Âºè
                input.style.background = 'linear-gradient(135deg, var(--primary-50) 0%, white 100%)';
                input.style.borderColor = 'var(--primary-400)';
                input.style.color = 'var(--primary-700)';
            } else {
                // ÁÑ°ÂÄºÊôÇÈ°ØÁ§∫ÁÇ∫Á©∫ÁôΩÊ®£Âºè
                input.style.background = 'white';
                input.style.borderColor = 'var(--primary-300)';
                input.style.color = 'var(--gray-500)';
            }
        }
        
        // ============================================
        // Ëá™ÂÆöÁæ©Êó•ÊõÜÈÅ∏ÊìáÂô®ÔºàÈªûÈÅ∏Âç≥Á¢∫Ë™çÔºâ
        // ============================================
        function showCustomDatePicker(inputId) {
            console.log('üîç ÊâìÈñãÊó•ÊõÜ:', inputId);
            
            // ÂÖàÂèñÂæó‰ªäÂ§©ÔºàÂº∑Âà∂Ë®≠ÁΩÆÁÇ∫0ÈªûÔºâ
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            console.log('üìÖ ‰ªäÂ§©Êó•Êúü:', formatDate(today));
            
            // ËôïÁêÜv1aÁöÑÁâπÊÆäÊÉÖÊ≥Å
            var actualInputId = inputId;
            if (inputId === 'v1a') {
                actualInputId = 'v1aInput';
            }
            
            var input = document.getElementById(actualInputId);
            if (!input) {
                console.error('‚ùå Êâæ‰∏çÂà∞input:', actualInputId);
                return;
            }
            
            var currentDate;
            
            // Ê±∫ÂÆöÂàùÂßãÈ°ØÁ§∫Âì™ÂÄãÊúà‰ªΩ
            if (input.value && input.value.trim() !== '') {
                console.log('üìù Ëº∏ÂÖ•Ê°ÜÊúâÂÄº:', input.value);
                currentDate = parseDate(input.value);
            } else {
                console.log('üìù Ëº∏ÂÖ•Ê°ÜÁÑ°ÂÄºÔºå‰ΩøÁî®‰ªäÂ§©');
                // Ê≤íÊúâÂÄºÊôÇÔºå‰ΩøÁî®‰ªäÂ§©
                currentDate = new Date(today);
            }
            
            console.log('üóìÔ∏è ÊúÄÁµÇÈ°ØÁ§∫Êúà‰ªΩ:', currentDate.getFullYear() + '-' + (currentDate.getMonth() + 1));
            
            // ÂâµÂª∫ÈÅÆÁΩ©Â±§
            var overlay = document.createElement('div');
            overlay.id = 'datePickerOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s; padding: 20px;';
            
            // ÂâµÂª∫Êó•ÊõÜÂÆπÂô®
            var calendar = document.createElement('div');
            calendar.style.cssText = 'background: white; border-radius: 6px; padding: 20px; max-width: 400px; width: 100%; animation: zoomIn 0.3s; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
            
            // Áï∂ÂâçÈ°ØÁ§∫ÁöÑÂπ¥Êúà
            var displayDate = new Date(currentDate);
            
            function renderCalendar() {
                calendar.innerHTML = '';
                
                // Ê®ôÈ°åÊ¨Ñ
                var header = document.createElement('div');
                header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;';
                
                // ‰∏äÂÄãÊúàÊåâÈàï
                var prevBtn = document.createElement('button');
                prevBtn.innerHTML = '‚óÄ';
                prevBtn.style.cssText = 'width: 44px; height: 44px; border: 2px solid var(--gray-200); background: white; border-radius: 6px; font-size: 18px; cursor: pointer; color: var(--gray-600); transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05);';
                prevBtn.onmouseover = function() { 
                    this.style.background = 'var(--primary-50)';
                    this.style.borderColor = 'var(--primary-300)';
                    this.style.color = 'var(--primary-600)';
                    this.style.transform = 'translateY(-2px) scale(1.05)';
                    this.style.boxShadow = '0 4px 8px rgba(102, 126, 234, 0.2)';
                };
                prevBtn.onmouseout = function() { 
                    this.style.background = 'white';
                    this.style.borderColor = 'var(--gray-200)';
                    this.style.color = 'var(--gray-600)';
                    this.style.transform = 'translateY(0) scale(1)';
                    this.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
                };
                prevBtn.onmousedown = function() {
                    this.style.transform = 'translateY(0) scale(0.95)';
                };
                prevBtn.onmouseup = function() {
                    this.style.transform = 'translateY(-2px) scale(1.05)';
                };
                prevBtn.onclick = function(e) {
                    e.stopPropagation();
                    displayDate.setMonth(displayDate.getMonth() - 1);
                    renderCalendar();
                };
                
                // Âπ¥ÊúàÊ®ôÈ°å + ‰ªäÂ§©ÊåâÈàïÂÆπÂô®
                var titleContainer = document.createElement('div');
                titleContainer.style.cssText = 'display: flex; flex-direction: column; align-items: center; gap: 8px;';
                
                var title = document.createElement('div');
                title.style.cssText = 'font-size: 18px; font-weight: 600; color: #4a5fc1;';
                var months = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
                title.textContent = displayDate.getFullYear() + 'Âπ¥ ' + months[displayDate.getMonth()];
                
                // ‰ªäÂ§©ÊåâÈàï
                var todayBtn = document.createElement('button');
                var today = new Date();
                today.setHours(0, 0, 0, 0);
                todayBtn.textContent = '‰ªäÂ§©';
                todayBtn.style.cssText = 'padding: 4px 12px; background: #f0f7fd; color: #5b9dd9; border: 1px solid #93c5fd; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s;';
                todayBtn.onmouseover = function() {
                    this.style.background = '#dcecfa';
                    this.style.borderColor = '#60a5fa';
                };
                todayBtn.onmouseout = function() {
                    this.style.background = '#f0f7fd';
                    this.style.borderColor = '#93c5fd';
                };
                todayBtn.onclick = function(e) {
                    e.stopPropagation();
                    var newToday = new Date();
                    newToday.setHours(0, 0, 0, 0);
                    displayDate = new Date(newToday);
                    renderCalendar();
                };
                
                titleContainer.appendChild(title);
                titleContainer.appendChild(todayBtn);
                
                // ‰∏ãÂÄãÊúàÊåâÈàï
                var nextBtn = document.createElement('button');
                nextBtn.innerHTML = '‚ñ∂';
                nextBtn.style.cssText = 'width: 44px; height: 44px; border: 2px solid var(--gray-200); background: white; border-radius: 6px; font-size: 18px; cursor: pointer; color: var(--gray-600); transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05);';
                nextBtn.onmouseover = function() { 
                    this.style.background = 'var(--primary-50)';
                    this.style.borderColor = 'var(--primary-300)';
                    this.style.color = 'var(--primary-600)';
                    this.style.transform = 'translateY(-2px) scale(1.05)';
                    this.style.boxShadow = '0 4px 8px rgba(102, 126, 234, 0.2)';
                };
                nextBtn.onmouseout = function() { 
                    this.style.background = 'white';
                    this.style.borderColor = 'var(--gray-200)';
                    this.style.color = 'var(--gray-600)';
                    this.style.transform = 'translateY(0) scale(1)';
                    this.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
                };
                nextBtn.onmousedown = function() {
                    this.style.transform = 'translateY(0) scale(0.95)';
                };
                nextBtn.onmouseup = function() {
                    this.style.transform = 'translateY(-2px) scale(1.05)';
                };
                nextBtn.onclick = function(e) {
                    e.stopPropagation();
                    displayDate.setMonth(displayDate.getMonth() + 1);
                    renderCalendar();
                };
                
                header.appendChild(prevBtn);
                header.appendChild(titleContainer);
                header.appendChild(nextBtn);
                calendar.appendChild(header);
                
                // ÊòüÊúüÊ®ôÈ°å
                var weekHeader = document.createElement('div');
                weekHeader.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;';
                var weekDays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
                for (var i = 0; i < 7; i++) {
                    var dayLabel = document.createElement('div');
                    dayLabel.style.cssText = 'text-align: center; font-size: 12px; font-weight: 600; color: #6b7280; padding: 8px 0;';
                    dayLabel.textContent = weekDays[i];
                    weekHeader.appendChild(dayLabel);
                }
                calendar.appendChild(weekHeader);
                
                // Êó•ÊúüÁ∂≤Ê†º
                var daysGrid = document.createElement('div');
                daysGrid.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;';
                
                // Ë®àÁÆóË©≤ÊúàÁ¨¨‰∏ÄÂ§©ÊòØÊòüÊúüÂπæ
                var firstDay = new Date(displayDate.getFullYear(), displayDate.getMonth(), 1);
                var startDayOfWeek = firstDay.getDay();
                
                // Ë®àÁÆóË©≤ÊúàÊúâÂ§öÂ∞ëÂ§©
                var lastDay = new Date(displayDate.getFullYear(), displayDate.getMonth() + 1, 0);
                var daysInMonth = lastDay.getDate();
                
                // Â°´ÂÖÖÁ©∫ÁôΩÊ†º
                for (var i = 0; i < startDayOfWeek; i++) {
                    var emptyDay = document.createElement('div');
                    emptyDay.style.cssText = 'height: 44px;';
                    daysGrid.appendChild(emptyDay);
                }
                
                // Â°´ÂÖÖÊó•Êúü
                for (var day = 1; day <= daysInMonth; day++) {
                    var date = new Date(displayDate.getFullYear(), displayDate.getMonth(), day);
                    var dateStr = formatDate(date);
                    var holiday = checkHoliday(date);
                    var dayOfWeek = date.getDay();
                    var isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                    
                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ë£úÁè≠Êó•
                    var isWorkingWeekend = false;
                    if (isWeekend) {
                        var year = date.getFullYear().toString();
                        var monthDay = ('0' + (date.getMonth() + 1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2);
                        isWorkingWeekend = workingWeekends[year] && workingWeekends[year].indexOf(monthDay) !== -1;
                    }
                    
                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÈÅéÂéªÊó•ÊúüÔºàÂè™ÈáùÂ∞çVisit 2, Visit 6Á≠âÔºåVisit 1ÂèØ‰ª•ÈÅ∏ÈÅéÂéªÔºâ
                    var today = new Date();
                    today.setHours(0, 0, 0, 0);
                    var todayStr = formatDate(today);  // ‰ΩøÁî®Âêå‰∏ÄÂÄãtodayËÆäÈáè
                    
                    var isPastDate = false;
                    if (inputId !== 'visit1') {
                        isPastDate = (date < today);
                    }
                    
                    // Ê™¢Êü•V2ÊòØÂê¶Êó©ÊñºV1ÔºàV2‰∏çËÉΩÊó©ÊñºV1Ôºâ
                    var isBeforeV1 = false;
                    if (inputId === 'visit2') {
                        var v1Input = document.getElementById('visit1');
                        if (v1Input && v1Input.value) {
                            var v1Date = parseDate(v1Input.value);
                            v1Date.setHours(0, 0, 0, 0);
                            if (date < v1Date) {
                                isBeforeV1 = true;
                            }
                        }
                    }
                    
                    var isDisabled = (holiday || (isWeekend && !isWorkingWeekend) || isPastDate || isBeforeV1);
                    var isSelected = (input.value === dateStr);
                    var isToday = (todayStr === dateStr);  // ‰ΩøÁî®ÊèêÂâçË®àÁÆóÁöÑtodayStr
                    
                    var dayBtn = document.createElement('div');
                    dayBtn.textContent = day;
                    
                    if (isDisabled) {
                        // ÂÅáÊó•„ÄÅÈÄ±Êú´ÊàñÈÅéÂéªÊó•ÊúüÔºöÁÅ∞Ëâ≤ÔºåÂÆåÂÖ®‰∏çÂèØÈªûÊìä
                        var disableReason = isPastDate ? 'Ê≠§Êó•ÊúüÂ∑≤ÈÅéÊúü' : 
                                           (isBeforeV1 ? 'Ê≠§Êó•ÊúüÊó©ÊñºVisit 1' : 
                                           'Ê≠§Êó•Êúü‰∏çÂèØÈÅ∏ÔºàÂÅáÊó•ÊàñÈÄ±Êú´Ôºâ');
                        dayBtn.style.cssText = 'height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 15px; color: #d1d5db; background: repeating-linear-gradient(45deg, #f9fafb, #f9fafb 5px, #f3f4f6 5px, #f3f4f6 10px); text-decoration: line-through; cursor: not-allowed; pointer-events: none; opacity: 0.6; user-select: none; border: 1px solid #e5e7eb;';
                        dayBtn.setAttribute('disabled', 'true');
                        dayBtn.setAttribute('aria-disabled', 'true');
                        dayBtn.title = disableReason;
                    } else {
                        // ÂèØÈÅ∏Êó•Êúü
                        var bgColor = isSelected ? '#0b6ac9' : (isToday ? '#dbeafe' : 'white');
                        var textColor = isSelected ? 'white' : (isToday ? '#1e40af' : '#1e40af');
                        var border = isToday && !isSelected ? '3px solid #0b6ac9' : (isSelected ? '2px solid #0b6ac9' : '1px solid #e5e7eb');
                        var fontWeight = isToday ? '700' : '600';
                        var boxShadow = isToday && !isSelected ? '0 0 0 3px rgba(11, 106, 201, 0.2)' : 'none';
                        
                        dayBtn.style.cssText = 'height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 15px; font-weight: ' + fontWeight + '; color: ' + textColor + '; background: ' + bgColor + '; border: ' + border + '; box-shadow: ' + boxShadow + '; cursor: pointer !important; transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); user-select: none; pointer-events: auto !important;';
                        dayBtn.title = isToday ? '‰ªäÂ§© - ÈªûÊìäÈÅ∏Êìá' : 'ÈªûÊìäÈÅ∏ÊìáÊ≠§Êó•Êúü';
                        
                        dayBtn.onmouseover = function() {
                            if (!this.isSelected) {
                                this.style.background = 'var(--primary-50)';
                                this.style.borderColor = 'var(--primary-400)';
                                this.style.transform = 'scale(1.1)';
                                this.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.25)';
                                this.style.zIndex = '10';
                            }
                        };
                        dayBtn.onmouseout = function() {
                            if (!this.isSelected) {
                                this.style.background = this.isToday ? '#f0f4ff' : 'white';
                                this.style.borderColor = this.isToday ? '#0b6ac9' : '#e5e7eb';
                                this.style.transform = 'scale(1)';
                                this.style.boxShadow = 'none';
                                this.style.zIndex = '1';
                            }
                        };
                        dayBtn.onmousedown = function() {
                            this.style.transform = 'scale(0.95)';
                        };
                        dayBtn.onmouseup = function() {
                            this.style.transform = 'scale(1.1)';
                        };
                        
                        dayBtn.isSelected = isSelected;
                        dayBtn.isToday = isToday;
                        
                        dayBtn.onclick = (function(d, ds) {
                            return function(e) {
                                e.stopPropagation();
                                // Â¶ÇÊûúÊòØv1aÔºåË®≠ÁΩÆÊ†ºÂºèÂåñÁöÑÊó•ÊúüÊñáÂ≠ó
                                if (inputId === 'v1a' || inputId === 'v1aInput') {
                                    input.value = formatDateWithWeekday(d);
                                    visit1aDate = ds;
                                } else {
                                    input.value = ds;
                                }
                                var event = new Event('change');
                                input.dispatchEvent(event);
                                document.body.removeChild(overlay);
                            };
                        })(date, dateStr);
                    }
                    
                    daysGrid.appendChild(dayBtn);
                }
                
                calendar.appendChild(daysGrid);
                
                // ÂèñÊ∂àÊåâÈàï
                var cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'ÂèñÊ∂à';
                cancelBtn.style.cssText = 'width: 100%; padding: 16px; margin-top: 20px; background: var(--gray-100); border: 2px solid var(--gray-200); border-radius: 6px; font-size: 16px; font-weight: 600; color: var(--gray-700); cursor: pointer; transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 1px 2px rgba(0,0,0,0.05); user-select: none;';
                cancelBtn.onmouseover = function() { 
                    this.style.background = 'var(--gray-200)';
                    this.style.borderColor = 'var(--gray-300)';
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                };
                cancelBtn.onmouseout = function() { 
                    this.style.background = 'var(--gray-100)';
                    this.style.borderColor = 'var(--gray-200)';
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
                };
                cancelBtn.onmousedown = function() {
                    this.style.transform = 'translateY(0) scale(0.97)';
                };
                cancelBtn.onmouseup = function() {
                    this.style.transform = 'translateY(-2px) scale(1)';
                };
                cancelBtn.onclick = function() {
                    document.body.removeChild(overlay);
                };
                calendar.appendChild(cancelBtn);
            }
            
            renderCalendar();
            
            overlay.appendChild(calendar);
            document.body.appendChild(overlay);
            
            // ÈªûÊìäÈÅÆÁΩ©Â±§ÈóúÈñâ
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            };
        }
        
        function parseDate(dateStr) {
            // Parse YYYY-MM-DD without timezone issues
            var parts = dateStr.split('-');
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }
        
        function addDays(date, days) {
            var result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }
        
        function formatDate(date) {
            var y = date.getFullYear();
            var m = String(date.getMonth() + 1).padStart(2, '0');
            var d = String(date.getDate()).padStart(2, '0');
            return y + '-' + m + '-' + d;
        }
        
        function formatDateWithWeekday(date) {
            var weekdays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            var day = date.getDay();
            var y = date.getFullYear();
            var m = String(date.getMonth() + 1).padStart(2, '0');
            var d = String(date.getDate()).padStart(2, '0');
            return y + '-' + m + '-' + d + ' (' + weekdays[day] + ')';
        }
        
        function getDaysDiff(date1, date2) {
            var diff = Math.floor((date2 - date1) / (1000 * 60 * 60 * 24));
            return diff;
        }
        
        function checkHoliday(date) {
            if (!date || isNaN(date.getTime())) {
                return null;
            }
            
            var day = date.getDay();
            var weekdays = ['ÈÄ±Êó•', 'ÈÄ±‰∏Ä', 'ÈÄ±‰∫å', 'ÈÄ±‰∏â', 'ÈÄ±Âõõ', 'ÈÄ±‰∫î', 'ÈÄ±ÂÖ≠'];
            
            var year = String(date.getFullYear());
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var dateStr = String(date.getDate()).padStart(2, '0');
            var key = month + '-' + dateStr;
            
            // Check if it's a working weekend (Ë£úÁè≠Êó•)
            if ((day === 0 || day === 6) && workingWeekends[year] && workingWeekends[year].includes(key)) {
                return null; // It's a working weekend, not a holiday
            }
            
            // Check if it's a weekend
            if (day === 0 || day === 6) {
                return { type: 'weekend', msg: '‚ö†Ô∏è ' + weekdays[day] + ' (ÈÄ±Êú´)' };
            }
            
            // Check if it's a holiday
            if (holidays[year] && holidays[year][key]) {
                return { type: 'holiday', msg: '‚ö†Ô∏è ' + holidays[year][key] + ' (ÂúãÂÆöÂÅáÊó•)' };
            }
            
            return null;
        }
        
        function getNextWorkday(date) {
            // Find next workday (not weekend, not holiday)
            var nextDate = new Date(date);
            var maxAttempts = 14; // Avoid infinite loop
            var attempts = 0;
            
            while (attempts < maxAttempts) {
                nextDate = addDays(nextDate, 1);
                var holidayInfo = checkHoliday(nextDate);
                
                if (!holidayInfo) {
                    // Found a workday
                    return nextDate;
                }
                attempts++;
            }
            
            // If couldn't find workday in 14 days, return original date + 1
            return addDays(date, 1);
        }
        
        function getHolidayWarningHtml(holidayInfo) {
            if (!holidayInfo) return '';
            return '<div class="warning ' + holidayInfo.type + '">' + holidayInfo.msg + '</div>';
        }
        
        function validateDates() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var validationDiv = document.getElementById('validation');
            var v1aSuggDiv = document.getElementById('v1aSuggestion');
            
            // Clear all validation messages and suggestions at start
            validationDiv.innerHTML = '';
            clearV1aValidation();
            
            if (!type || !v1Input || !v2Input) {
                v1aSuggDiv.innerHTML = '';
                calculateVisits();
                return;
            }
            
            // For Washout, drug type must be selected
            if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                if (!drugType) {
                    validationDiv.innerHTML = '<div class="validation-msg error">Ë´ãÂÖàÈÅ∏ÊìáÈúÄÊ¥óÈô§ÁöÑËó•Áâ©È°ûÂûã</div>';
                    v1aSuggDiv.innerHTML = '';
                    calculateVisits();
                    return;
                }
            }
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            var daysDiff = getDaysDiff(v1, v2);
            
            var isValid = false;
            var message = '';
            var msgClass = '';
            
            if (type === 'naive') {
                if (daysDiff < 1) {
                    message = '‚ùå V1 Âà∞ V2 ÈñìÈöîÈÅéÁü≠Ôºà' + daysDiff + ' Â§©Ôºâ„ÄÇNaive ÂèóË©¶ËÄÖÈúÄË¶Å 1-35 Â§©„ÄÇ';
                    msgClass = 'error';
                } else if (daysDiff > 35) {
                    message = '‚ùå V1 Âà∞ V2 ÈñìÈöîÈÅéÈï∑Ôºà' + daysDiff + ' Â§©Ôºâ„ÄÇNaive ÂèóË©¶ËÄÖÈúÄË¶Å 1-35 Â§©„ÄÇ';
                    msgClass = 'error';
                } else {
                    message = '‚úì V1-V2 Á¨¶ÂêàË¶èÂÆöÔºà' + daysDiff + ' Â§©Ôºâ';
                    msgClass = 'success';
                    isValid = true;
                }
            } else if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                var washoutDays = parseInt(drugType);
                var minDays = washoutDays + 1;  // washout + 1 day to V2
                var maxDays = Math.min(washoutDays + 7, 35);  // washout + 7 days to V2, but max 35 days total
                
                if (daysDiff < minDays) {
                    message = '‚ùå V1 Âà∞ V2 ÈñìÈöîÈÅéÁü≠Ôºà' + daysDiff + ' Â§©Ôºâ„ÄÇÈúÄË¶Å ' + minDays + '-' + maxDays + ' Â§©Ôºà' + washoutDays + 'Â§©Ê¥óÈô§Êúü + 1-7Â§©Âà∞V2Ôºâ„ÄÇ';
                    msgClass = 'error';
                } else if (daysDiff > 35) {
                    message = '‚ùå V1 Âà∞ V2 ÈñìÈöîÈÅéÈï∑Ôºà' + daysDiff + ' Â§©Ôºâ„ÄÇWashout ÂèóË©¶ËÄÖ V1 Âà∞ V2 ÊúÄÂ§ö 35 Â§©„ÄÇ';
                    msgClass = 'error';
                } else if (daysDiff > maxDays) {
                    message = '‚ùå V1 Âà∞ V2 ÈñìÈöîÈÅéÈï∑Ôºà' + daysDiff + ' Â§©Ôºâ„ÄÇÈúÄË¶Å ' + minDays + '-' + maxDays + ' Â§©„ÄÇ';
                    msgClass = 'error';
                } else {
                    message = '‚úì V1-V2 Á¨¶ÂêàË¶èÂÆöÔºà' + daysDiff + ' Â§©Ôºâ';
                    msgClass = 'success';
                    isValid = true;
                }
            }
            
            validationDiv.innerHTML = '<div class="validation-msg ' + msgClass + '">' + message + '</div>';
            
            // Show V1a suggestion
            // Â∞çÊñº NaiveÔºöÂè™Ë¶ÅÊúâ V1 Â∞±ÂèØ‰ª•È°ØÁ§∫ V1aÔºàÂç≥‰Ωø V2 ÈÇÑÊ≤íÈÅ∏Ôºâ
            // Â∞çÊñº WashoutÔºöÈúÄË¶Å V1-V2 È©óË≠âÈÄöÈÅéÊâçÈ°ØÁ§∫
            var canShowV1a = false;
            if (type === 'naive' && v1) {
                canShowV1a = true;
            } else if (type === 'washout' && isValid) {
                canShowV1a = true;
            }
            
            if (canShowV1a) {
                var html = '';
                
                if (type === 'naive') {
                    // Naive: V1a can be anywhere between V1 and V2
                    
                    // üèÜ Ê∑ªÂä†Ê®ôÈ°åÂíåÁØÑÂúçË™™Êòé
                    html += '<div style="margin: 28px 0 20px 0;">';
                    html += '<h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700; color: #1e293b;">Visit 1a Âª∫Ë≠∞Ë®™Ë¶ñÊó•Êúü</h3>';
                    
                    // Â¶ÇÊûúÈÇÑÊ≤íÊúâ V2ÔºåÈ°ØÁ§∫ÊèêÁ§∫
                    if (!v2 || !isValid) {
                        html += '<div style="font-size: 14px; color: #9b9a97;">Ë´ãÂÖàÈÅ∏Êìá V1 Âíå V2ÔºåÁ¢∫ÂÆöÁØÑÂúçÂæåÂèØÈÅ∏Êìá V1a</div>';
                        html += '</div>';
                        v1aSuggDiv.innerHTML = html;
                        return;
                    }
                    
                    var v2_before = addDays(v2, -1);
                    html += '<div style="font-size: 14px; color: #64748b;">ÂèØÈÅ∏ÁØÑÂúçÔºö' + formatDateWithWeekday(v1) + ' ~ ' + formatDateWithWeekday(v2_before) + 'ÔºàV2 ‰πãÂâçÔºâ</div>';
                    html += '</div>';
                    
                    // Find best V1a: ÂÑ™ÂÖà‰ΩøÁî®Áî®Êà∂ÈÅ∏ÊìáÁöÑÊó•Êúü
                    var bestV1a = v1;
                    
                    // Â¶ÇÊûúÁî®Êà∂Â∑≤Á∂ìÈÅ∏Êìá‰∫ÜÊó•ÊúüÔºå‰ΩøÁî®Áî®Êà∂ÁöÑÈÅ∏Êìá
                    if (visit1aDate) {
                        try {
                            var selectedDate = parseDate(visit1aDate);
                            // Á¢∫‰øùÈÅ∏ÊìáÁöÑÊó•ÊúüÂú®ÊúâÊïàÁØÑÂúçÂÖß
                            if (selectedDate >= v1 && selectedDate < v2) {
                                bestV1a = selectedDate;
                            }
                        } catch (e) {
                            // Â¶ÇÊûúËß£ÊûêÂ§±ÊïóÔºå‰ΩøÁî®ÈªòË™çÈÇèËºØ
                        }
                    }
                    
                    // Â¶ÇÊûúÊ≤íÊúâÁî®Êà∂ÈÅ∏ÊìáÔºåÂâáËá™ÂãïË®àÁÆó
                    if (!visit1aDate || bestV1a === v1) {
                        var isV1Holiday = checkHoliday(v1);
                        var autoAdjusted = false;
                        
                        if (isV1Holiday) {
                            var v1_workday = getNextWorkday(v1);
                            // Make sure workday is before V2
                            if (v1_workday && v1_workday < v2) {
                                bestV1a = v1_workday;
                                autoAdjusted = true;
                            }
                        }
                    }
                    
                    // html += '<div class="suggestion-box">';
                    // html += '<div class="suggestion-label">ÂΩàÊÄßÁØÑÂúç</div>';
                    // html += '<div class="suggestion-value">' + formatDateWithWeekday(v1) + ' ~ ' + formatDateWithWeekday(v2) + '<br>';
                    // html += 'Naive ÂèóË©¶ËÄÖÁöÑ V1a Ê≤íÊúâÂõ∫ÂÆöÈôêÂà∂ÔºåÂª∫Ë≠∞ÈÅ∏Êìá V1 Áï∂Â§©ÊàñÈÑ∞ËøëÂ∑•‰ΩúÊó•</div>';
                    // html += '</div>';
                    
                    // Show explanation if V1 is a holiday
                    if (autoAdjusted) {
                        html += '<div style="margin-top: 8px; padding: 8px; background: #dcecfa; border: 1px solid #5b9dd9; border-radius: 6px; font-size: 12px; color: #1e40af;">';
                        html += 'üí° V1 (' + formatDateWithWeekday(v1) + ') ÁÇ∫ÂÅáÊó•ÔºåÂ∑≤Ëá™ÂãïÈÅ∏Êìá‰∏ã‰∏ÄÂÄãÂ∑•‰ΩúÊó•';
                        html += '</div>';
                    }
                    
                    // üèÜ ÁßªÈô§inputÊ°ÜÔºå‰ΩøÁî®Áµ±‰∏ÄÁöÑÊåâÈàïÁ≥ªÁµ±
                    // html += '<input type="text" id="v1aInput" readonly value="' + formatDateWithWeekday(bestV1a) + '" onclick="showCustomDatePicker(\'v1a\'); return false;" style="cursor: pointer !important; background: white !important; font-size: 16px; font-weight: 600; padding: 16px; border: 2px solid #5b9dd9; border-radius: 6px; height: 56px; width: 100%; box-sizing: border-box; text-align: center; color: #1e40af; transition: all 150ms ease; box-shadow: 0 2px 8px rgba(59,130,246,0.2); margin-top: 16px;" onchange="visit1aDate=this.value; checkDateWarning(\'v1a\'); validateV1a(); calculateVisits();">';
                    
                    // ÁîüÊàêV1Âà∞V2‰πãÈñìÁöÑÊâÄÊúâÂ∑•‰ΩúÊó•
                    var naiveWorkdays = [];
                    var currentDate = new Date(v1);
                    while (currentDate < v2) {
                        if (!checkHoliday(currentDate)) {
                            naiveWorkdays.push(new Date(currentDate));
                        }
                        currentDate = addDays(currentDate, 1);
                    }
                    
                    // üî• ÊèêÂâçË®≠ÁΩÆ visit1aDateÔºàÂú®ÁîüÊàêÊåâÈàïÂâçÔºâ
                    if (!visit1aDate || visit1aDate === '') {
                        visit1aDate = formatDate(bestV1a);
                    }
                    
                    // È°ØÁ§∫Â∑•‰ΩúÊó•Êï∏Èáè
                    if (naiveWorkdays.length > 0) {
                        html += '<div style="font-size: 13px; color: #9b9a97; margin-top: 4px;">(' + naiveWorkdays.length + ' ÂÄãÂ∑•‰ΩúÊó•)</div>';
                    }
                    
                    // È°ØÁ§∫ÊåâÈàïÂàóË°®
                    if (naiveWorkdays.length > 0) {
                        html += '<div class="btn-group" style="display: flex; flex-direction: column; gap: 8px; margin-top: 16px;">';
                        for (var i = 0; i < naiveWorkdays.length; i++) {
                            var workday = naiveWorkdays[i];
                            var dateStr = formatDate(workday);
                            // Áµ±‰∏Ä‰ΩøÁî® visit1aDate ‰æÜÂà§Êñ∑ÈÅ∏‰∏≠ÁãÄÊÖã
                            var isCurrentlySelected = (visit1aDate && visit1aDate === dateStr);
                            
                            // Áõ¥Êé•ÁîüÊàêÊåâÈàïÔºå‰∏ç‰ΩøÁî®ÊõøÊèõ
                            var btnStyle = '';
                            if (isCurrentlySelected) {
                                btnStyle = 'background: #0b6ac9; border: none; color: #ffffff !important;';
                            } else {
                                btnStyle = 'background: #ffffff; border: 1px solid #e0e0e0; color: #37352f !important;';
                            }
                            
                            html += '<button type="button" ';
                            html += 'onclick="useDate(\'' + dateStr + '\'); event.stopPropagation(); return false;" ';
                            html += 'class="btn btn-primary" ';
                            html += 'style="' + btnStyle + ' cursor: pointer; padding: 14px 20px; border-radius: 6px; font-weight: 500; transition: all 0.15s ease;" ';
                            html += 'onmouseover="' + (isCurrentlySelected ? '' : 'this.style.background=\'#fafafa\';') + '" ';
                            html += 'onmouseout="' + (isCurrentlySelected ? '' : 'this.style.background=\'#ffffff\';') + ';">';
                            html += '<div style="font-size: 15px; text-align: center;">' + formatDateWithWeekday(workday) + '</div>';
                            html += '</button>';
                        }
                        html += '</div>';
                        
                        // üèÜ Ê∑ªÂä†Êó•ÊõÜÔºàËàá V2 Áµ±‰∏ÄÔºâ
                        html += '<div style="margin-top: 24px;">';
                        html += '<div style="font-size: 14px; font-weight: 600; color: #64748b; margin-bottom: 12px;">üìÖ ÂèØÁî®Êó•Êúü</div>';
                        
                        html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 11px;">';
                        
                        // Get date range for calendar (from v1 to v2)
                        var calStartDate = new Date(v1);
                        calStartDate.setDate(calStartDate.getDate() - calStartDate.getDay()); // Start from Sunday
                        
                        var v2_before = addDays(v2, -1);
                        var calEndDate = new Date(v2_before);
                        var endDay = calEndDate.getDay();
                        if (endDay !== 6) {
                            calEndDate.setDate(calEndDate.getDate() + (6 - endDay)); // End on Saturday
                        }
                        
                        // Add weekday headers
                        var weekdayHeaders = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
                        for (var i = 0; i < 7; i++) {
                            html += '<div style="text-align: center; font-weight: 600; color: #9ca3af; padding: 4px;">' + weekdayHeaders[i] + '</div>';
                        }
                        
                        // Add date cells
                        var currentCalDate = new Date(calStartDate);
                        while (currentCalDate <= calEndDate) {
                            var dateStr = formatDate(currentCalDate);
                            var isInRange = currentCalDate >= v1 && currentCalDate < v2;
                            var isWorkday = !checkHoliday(currentCalDate) && isInRange;
                            var isSelected = (visit1aDate && visit1aDate === dateStr);
                            
                            var cellStyle = 'text-align: center; padding: 6px 4px; border-radius: 6px; ';
                            if (isWorkday) {
                                if (isSelected) {
                                    // Â∑≤ÈÅ∏ÔºöËóçËâ≤Â∫ï + ÁôΩÂ≠ó
                                    cellStyle += 'background: #0b6ac9; border: none; color: #ffffff; font-weight: 600; cursor: pointer;';
                                } else {
                                    // ÂèØÈÅ∏Êó•Êúü - ÁôΩÂ∫ï + Ê∑°ÁÅ∞Ê°Ü + Ê∑±ÁÅ∞Â≠ó
                                    cellStyle += 'background: #ffffff; border: 1px solid #e0e0e0; color: #37352f; font-weight: 500; cursor: pointer;';
                                }
                            } else if (isInRange) {
                                // ÁØÑÂúçÂÖß‰ΩÜ‰∏çÂèØÈÅ∏ÔºàÂÅáÊó•Ôºâ- Ê∑°ÁÅ∞Â∫ïÊ∑°ÁÅ∞Â≠ó
                                cellStyle += 'background: #f5f5f5; color: #9b9a97;';
                            } else {
                                // ÁØÑÂúçÂ§ñ - Ê•µÊ∑°ÁÅ∞
                                cellStyle += 'background: #fafafa; color: #d0d0d0;';
                            }
                            
                            var onclick = isWorkday ? ' onclick="useDate(\'' + dateStr + '\')"' : '';
                            html += '<div style="' + cellStyle + '"' + onclick + '>' + currentCalDate.getDate() + '</div>';
                            
                            currentCalDate.setDate(currentCalDate.getDate() + 1);
                        }
                        
                        html += '</div>';
                        html += '</div>';
                    }
                    
                    html += '<div id="v1aWarning" style="margin-top: 8px;"></div>';
                } else if (type === 'washout') {
                    // Washout: V1a must be 1-7 days before V2
                    
                    var drugType = document.getElementById('drugType').value;
                    var washoutDays = parseInt(drugType);
                    
                    // Calculate the recommended V2 (same logic as in calculateV2Suggestion)
                    var recommendedV2 = null;
                    var v2_min = addDays(v1, washoutDays + 1);
                    var v2_max = addDays(v1, 35);
                    
                    // Find workdays in V2 range
                    var v2_workdays = [];
                    var currentDate = v2_min;
                    while (currentDate <= v2_max) {
                        // Must meet minimum washout interval
                        var v1_test_days = getDaysDiff(v1, currentDate);
                        if (v1_test_days >= (washoutDays + 1) && !checkHoliday(currentDate)) {
                            v2_workdays.push(new Date(currentDate));
                        }
                        currentDate = addDays(currentDate, 1);
                    }
                    
                    // Find best V2 (same scoring logic)
                    if (v2_workdays.length > 0) {
                        // First filter to only V2s where V1a range has workdays
                        var validV2s = [];
                        for (var i = 0; i < v2_workdays.length; i++) {
                            var testV2 = v2_workdays[i];
                            
                            // Check if V1a range (V2-7 to V2-1) has any workdays
                            var v1a_early = addDays(testV2, -7);
                            var v1a_late = addDays(testV2, -1);
                            var hasV1aWorkday = false;
                            
                            var checkDate = v1a_early;
                            while (checkDate <= v1a_late) {
                                var washout_check = getDaysDiff(v1, checkDate);
                                if (washout_check >= washoutDays && !checkHoliday(checkDate)) {
                                    hasV1aWorkday = true;
                                    break;
                                }
                                checkDate = addDays(checkDate, 1);
                            }
                            
                            if (hasV1aWorkday) {
                                validV2s.push(testV2);
                            }
                        }
                        
                        // Now score the valid V2s
                        if (validV2s.length > 0) {
                            var maxScore = -1;
                            for (var i = 0; i < validV2s.length; i++) {
                                var testV2 = validV2s[i];
                                var score = 0;
                                score += countWorkdaysInWindow(addDays(testV2, 7));
                                score += countWorkdaysInWindow(addDays(testV2, 14));
                                score += countWorkdaysInWindow(addDays(testV2, 28));
                                
                                if (score > maxScore) {
                                    maxScore = score;
                                    recommendedV2 = testV2;
                                }
                            }
                        }
                    }
                    
                    // Use recommended V2 if user hasn't entered V2 yet, otherwise use user's V2
                    var effectiveV2 = v2 ? v2 : recommendedV2;
                    
                    if (!effectiveV2) {
                        html += '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #dc2626; border-radius: 6px;">';
                        html += '<div style="font-size: 14px; font-weight: 600; color: #dc2626; margin-bottom: 6px;">ÁÑ°Ê≥ïË®àÁÆó V1a</div>';
                        html += '<div style="font-size: 12px; color: #991b1b;">Ë´ãÂÖàË™øÊï¥ V1 ÊàñÁ≠âÂæÖ V2 Âª∫Ë≠∞</div>';
                        html += '</div>';
                        html += '</div>';
                        v1aSuggDiv.innerHTML = html;
                        return;
                    }
                    
                    var v1a_calculated = addDays(v1, washoutDays);
                    var v1a_early = addDays(effectiveV2, -7);
                    var v1a_late = addDays(effectiveV2, -1);
                    
                    var drugTypeName = '';
                    if (washoutDays === 28) drugTypeName = 'Prostaglandins / Œ≤-blockers / Kinase inhibitors';
                    else if (washoutDays === 14) drugTypeName = 'Adrenergic agonists';
                    else if (washoutDays === 7) drugTypeName = 'Muscarinic agonists / Carbonic anhydrase inhibitors';
                    
                    // Find all workdays in the valid V1a range
                    var v1a_workdays = [];
                    var defaultV1a = v1a_calculated;
                    
                    if (v1a_calculated >= v1a_early && v1a_calculated <= v1a_late) {
                        var currentDate = v1a_calculated;
                        while (currentDate <= v1a_late) {
                            var washout_check = getDaysDiff(v1, currentDate);
                            if (washout_check >= washoutDays && !checkHoliday(currentDate)) {
                                v1a_workdays.push(new Date(currentDate));
                            }
                            currentDate = addDays(currentDate, 1);
                        }
                        
                        // üî• ÂÑ™ÂÖà‰ΩøÁî®Á¨¨‰∏ÄÂÄãÂ∑•‰ΩúÊó•ÔºàÊúÄÊó©ÁöÑÂèØÁî®Êó•ÊúüÔºâ
                        if (v1a_workdays.length > 0) {
                            defaultV1a = v1a_workdays[0];
                        }
                    }
                    
                    // üî• ÊèêÂâçË®≠ÁΩÆ visit1aDateÔºàÂú®ÁîüÊàêÊó•ÊõÜÂâçÔºâ
                    if (!visit1aDate || visit1aDate === '') {
                        visit1aDate = formatDate(defaultV1a);
                    }
                    
                    // üèÜ ‰∏ñÁïåÂÜ†ËªçÁ¥öÊ®ôÈ°åÔºàËàáV2ÂÆåÂÖ®Áµ±‰∏ÄÔºâ
                    html += '<div style="margin: 28px 0 20px 0;">';
                    html += '<h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700; color: #1e293b;">Visit 1a Âª∫Ë≠∞Ë®™Ë¶ñÊó•Êúü</h3>';
                    html += '<div style="font-size: 14px; color: #64748b;">ÂèØÈÅ∏ÁØÑÂúçÔºö' + formatDateWithWeekday(v1a_early) + ' ~ ' + formatDateWithWeekday(v1a_late) + '</div>';
                    html += '<div style="font-size: 13px; color: #9b9a97; margin-top: 4px;">(' + v1a_workdays.length + ' ÂÄãÂ∑•‰ΩúÊó•)</div>';
                    html += '</div>';
                    
                    // üèÜ Áï∂ÂâçÈÅ∏ÊìáÊó•ÊúüÈ°ØÁ§∫Ê¨Ñ‰Ωç - ÁßªÈô§Ê°ÜÊ°ÜÔºåÁõ¥Êé•È°ØÁ§∫ÊåâÈàï
                    // html += '<div style="margin-bottom: 16px; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">';
                    // html += '<div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">Áï∂ÂâçÈÅ∏Êìá</div>';
                    // html += '<div style="font-size: 16px; font-weight: 600; color: #1e293b;">' + formatDateWithWeekday(defaultV1a) + '</div>';
                    // html += '</div>';
                    
                    if (v1a_workdays.length > 0) {
                        html += '<div class="btn-group" style="display: flex; flex-direction: column; gap: 8px;">';
                        
                        // Show all V1a workdays
                        for (var i = 0; i < v1a_workdays.length; i++) {
                            var workday = v1a_workdays[i];
                            var dateStr = formatDate(workday);
                            var isPerfect = (i === 0); // üèÜ Á¨¨‰∏ÄÂÄãÊòØÂÆåÁæé
                            
                            // Check if currently selected
                            var isCurrentlySelected = visit1aDate && (formatDate(parseDate(visit1aDate)) === dateStr);
                            
                            // üèÜ Áµ±‰∏Ä‰ΩøÁî®V2ÊåâÈàïÂáΩÊï∏ÔºåÊ≠£Á¢∫ÂÇ≥ÈÅûisPerfect
                            html += createV2SuggestionButton(dateStr, workday, isPerfect, isCurrentlySelected).replace('useV2Date', 'useDate');
                        }
                        
                        html += '</div>';
                        
                        // ÁÑ°ÈúÄÂúñ‰æã - Á∞°ÊΩîÂç≥Áæé
                        
                        // Build a map of V1a workdays with their perfect status for calendar
                        var v1aWorkdayPerfectMap = {};
                        for (var i = 0; i < v1a_workdays.length; i++) {
                            var testV1a = v1a_workdays[i];
                            var isPerfect = (i === 0); // First one is perfect
                            v1aWorkdayPerfectMap[formatDate(testV1a)] = isPerfect;
                        }
                        
                        // üèÜ Á∞°ÊΩîÊúàÊõÜ
                        html += '<div style="margin-top: 24px;">';
                        html += '<div style="font-size: 14px; font-weight: 600; color: #64748b; margin-bottom: 12px;">üìÖ ÂèØÁî®Êó•Êúü</div>';
                        
                        // Âúñ‰æãÂ∑≤ÁßªÈô§ - ‰øùÊåÅÁ∞°ÊΩî
                        
                        html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 11px;">';
                        
                        // Get date range for calendar
                        var calStartDate = new Date(v1a_early);
                        calStartDate.setDate(calStartDate.getDate() - calStartDate.getDay()); // Start from Sunday
                        
                        var calEndDate = new Date(v1a_late);
                        var endDay = calEndDate.getDay();
                        if (endDay !== 6) {
                            calEndDate.setDate(calEndDate.getDate() + (6 - endDay)); // End on Saturday
                        }
                        
                        // Add weekday headers
                        var weekdayHeaders = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
                        for (var i = 0; i < 7; i++) {
                            html += '<div style="text-align: center; font-weight: 600; color: #9ca3af; padding: 4px;">' + weekdayHeaders[i] + '</div>';
                        }
                        
                        // Add date cells
                        var currentCalDate = new Date(calStartDate);
                        while (currentCalDate <= calEndDate) {
                            var dateStr = formatDate(currentCalDate);
                            var isInRange = currentCalDate >= v1a_early && currentCalDate <= v1a_late;
                            var isWorkday = v1aWorkdayPerfectMap.hasOwnProperty(dateStr);
                            var isPerfectDate = v1aWorkdayPerfectMap[dateStr] === true;
                            var isSelected = (visit1aDate && formatDate(parseDate(visit1aDate)) === dateStr);
                            
                            var cellStyle = 'text-align: center; padding: 6px 4px; border-radius: 6px; ';
                            if (isWorkday) {
                                if (isSelected) {
                                    // Â∑≤ÈÅ∏ÔºöËóçËâ≤Â∫ï + ÁôΩÂ≠ó
                                    cellStyle += 'background: #0b6ac9; border: none; color: #ffffff; font-weight: 600; cursor: pointer;';
                                } else if (isPerfectDate) {
                                    // ÂèØÈÅ∏Êó•Êúü - ÁôΩÂ∫ï + Ê∑°ÁÅ∞Ê°Ü + Ê∑±ÁÅ∞Â≠ó
                                    cellStyle += 'background: #ffffff; border: 1px solid #e0e0e0; color: #37352f; font-weight: 500; cursor: pointer;';
                                } else {
                                    // ÂèØÈÅ∏Êó•Êúü - ÁôΩÂ∫ï + Ê∑°ÁÅ∞Ê°Ü + Ê∑±ÁÅ∞Â≠ó
                                    cellStyle += 'background: #ffffff; border: 1px solid #e0e0e0; color: #37352f; font-weight: 500; cursor: pointer;';
                                }
                            } else if (isInRange) {
                                cellStyle += 'background: #f5f5f5; color: #9b9a97;';
                            } else {
                                cellStyle += 'background: #fafafa; color: #d0d0d0;';
                            }
                            
                            var onclick = isWorkday ? ' onclick="useDate(\'' + dateStr + '\')"' : '';
                            html += '<div style="' + cellStyle + '"' + onclick + '>' + currentCalDate.getDate() + '</div>';
                            
                            currentCalDate.setDate(currentCalDate.getDate() + 1);
                        }
                        
                        html += '</div>';
                        html += '</div>';
                    }
                    
                    // Èö±ËóèÁöÑinputÁî®ÊñºÂ≠òÂÑ≤ÂÄº
                    html += '<input type="text" id="v1aInput" readonly value="' + formatDateWithWeekday(defaultV1a) + '" style="display: none;" onchange="visit1aDate=this.value; checkDateWarning(\'v1a\'); validateV1a(); calculateVisits();">';
                    
                    html += '<div id="v1aWarning" style="margin-top: 8px;"></div>';
                    
                    // Only show button if V1a is valid (within V2 -7 to -1 range)
                    if (v1a_calculated >= v1a_early && v1a_calculated <= v1a_late) {
                        // Only show button if user might need to reset (i.e., if they change the input)
                        // For now, we hide the button since input already has correct default
                        if (v1a_workdays.length === 0) {
                            // No workdays available in valid range
                            html += '<div style="margin-top: 12px; padding: 12px; background: #fee2e2; border: 2px solid #dc2626; border-radius: 6px; text-align: center;">';
                            html += '<div style="font-size: 14px; font-weight: 600; color: #dc2626; margin-bottom: 6px;">‚ö†Ô∏è ÁÑ°ÂèØÁî®Â∑•‰ΩúÊó•</div>';
                            html += '<div style="font-size: 12px; color: #991b1b;">V1a ÂèØÈÅ∏ÁØÑÂúçÂÖßÊ≤íÊúâÂ∑•‰ΩúÊó•ÂèØÈÅ∏</div>';
                            html += '<div style="font-size: 12px; color: #991b1b; margin-top: 6px;">Ë´ãË™øÊï¥ V1 Êàñ V2 Êó•Êúü</div>';
                            html += '</div>';
                        }
                    }
                }
                
                // html += '</div>'; // ÁßªÈô§Ê°ÜÊ°Ü
                
                v1aSuggDiv.innerHTML = html;
                
                // Auto validate V1a if it's set
                if (visit1aDate) {
                    validateV1a();
                    // Check for holidays immediately
                    setTimeout(function() {
                        checkDateWarning('v1a');
                    }, 50);
                }
            } else {
                v1aSuggDiv.innerHTML = '';
            }
            
            calculateVisits();
        }
        
        function useDate(date) {
            visit1aDate = date;
            var v1aInput = document.getElementById('v1aInput');
            if (v1aInput) {
                v1aInput.value = date;
            }
            checkDateWarning('v1a');
            validateV1a();
            validateDates(); // ÈáçÊñ∞ÁîüÊàê V1a Êó•ÊõÜ‰ª•Êõ¥Êñ∞ÈÅ∏‰∏≠ÁãÄÊÖã
            calculateVisits();
        }
        
        function useV1ForV1a() {
            var v1 = document.getElementById('visit1').value;
            if (v1) {
                visit1aDate = v1;
                document.getElementById('v1aInput').value = v1;
                checkDateWarning('v1a');
                validateV1a();
                calculateVisits();
            }
        }
        
        function validateV1a() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            
            if (!type || !v1Input || !v2Input || !visit1aDate) {
                // Clear V1a validation if no V1a date
                clearV1aValidation();
                return;
            }
            
            var v1 = parseDate(v1Input);
            var v1a = parseDate(visit1aDate);
            var v2 = parseDate(v2Input);
            
            var v1_v1a_diff = getDaysDiff(v1, v1a);
            var v1a_v2_diff = getDaysDiff(v1a, v2);
            
            var validationDiv = document.getElementById('validation');
            var v1aValidationDiv = document.getElementById('v1aValidation');
            
            // Create V1a validation div if it doesn't exist
            if (!v1aValidationDiv) {
                v1aValidationDiv = document.createElement('div');
                v1aValidationDiv.id = 'v1aValidation';
                validationDiv.appendChild(v1aValidationDiv);
            }
            
            var msgHtml = '';
            
            if (type === 'naive') {
                // For Naive: V1a just needs to be between V1 and V2
                if (v1_v1a_diff < 0) {
                    msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">‚ùå V1a ‰∏çËÉΩÊó©Êñº V1</div>';
                } else if (v1a_v2_diff < 0) {
                    msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">‚ùå V1a ‰∏çËÉΩÊôöÊñº V2</div>';
                } else {
                    if (v1_v1a_diff === 0) {
                        msgHtml = '<div class="validation-msg success" style="margin-top: 10px;">‚úì V1a Ëàá V1 ÂêåÂ§©</div>';
                    } else {
                        msgHtml = '<div class="validation-msg success" style="margin-top: 10px;">‚úì V1a Á¨¶ÂêàË¶èÂÆö</div>';
                    }
                }
            } else if (type === 'washout') {
                // For Washout: V1a must be 1-7 days before V2
                if (v1a_v2_diff < 1 || v1a_v2_diff > 7) {
                    msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">‚ùå V1a Âà∞ V2 ÈñìÈöî‰∏çÁ¨¶Ôºà' + v1a_v2_diff + ' Â§©Ôºâ„ÄÇWashout ÂøÖÈ†àÊòØ 1-7 Â§©„ÄÇ</div>';
                } else {
                    // Check if V1a meets minimum washout period
                    var drugType = document.getElementById('drugType').value;
                    var washoutDays = parseInt(drugType);
                    
                    if (v1_v1a_diff < washoutDays) {
                        msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">‚ùå V1 Âà∞ V1a ÈñìÈöî‰∏çË∂≥Ôºà' + v1_v1a_diff + ' Â§©Ôºâ„ÄÇÊúÄÂ∞èÊ¥óÈô§ÊúüÊòØ ' + washoutDays + ' Â§©„ÄÇ</div>';
                    } else {
                        msgHtml = '<div class="validation-msg success" style="margin-top: 10px;">‚úì V1a Á¨¶ÂêàË¶èÂÆöÔºàÊ¥óÈô§Êúü ' + v1_v1a_diff + ' Â§©Ôºâ</div>';
                    }
                }
            }
            
            v1aValidationDiv.innerHTML = msgHtml;
        }
        
        function clearV1aValidation() {
            var v1aValidationDiv = document.getElementById('v1aValidation');
            if (v1aValidationDiv) {
                v1aValidationDiv.innerHTML = '';
            }
        }
        
        function calculateVisits() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var output = document.getElementById('output');
            
            if (!type || !v1Input || !v2Input) {
                output.innerHTML = '<div class="empty">Ë´ãÂ°´ÂØ´ÊâÄÊúâÊ¨Ñ‰Ωç‰ª•Ë®àÁÆóË®™Ë¶ñÊó•Êúü</div>';
                return;
            }
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            var html = '';
            
            // Visit 1
            var w1 = checkHoliday(v1);
            var v1AutoAdjusted = window.autoAdjustedV1 === true;
            var v1CardStyle = v1AutoAdjusted ? 'style="border: 2px solid #0b6ac9; background: #f0f7fd;"' : '';
            html += '<div class="visit-card" ' + v1CardStyle + '>';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 1' + (v1AutoAdjusted ? ' <span style="color: #0b6ac9; font-weight: 600;">‚úì Â∑≤Êõ¥Êñ∞</span>' : '') + '</div>';
            html += '<div class="badge badge-screening">ÁØ©ÈÅ∏Êúü</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day -35 to -1<br>Ë™™Êòé: ÁØ©ÈÅ∏Ë®™Ë¶ñ</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(v1) + '</div>';
            html += getHolidayWarningHtml(w1);
            if (v1AutoAdjusted) {
                html += '<div style="margin-top: 8px; padding: 8px; background: #e9f3ff; border: 1px solid #0b6ac9; border-radius: 6px; font-size: 12px; color: #0b6ac9; font-weight: 500;">üéØ Á≥ªÁµ±Â∑≤Ëá™ÂãïË™øÊï¥Âà∞Â∑•‰ΩúÊó•</div>';
            }
            html += '</div>';
            
            // Visit 1a
            if (visit1aDate) {
                var v1a = parseDate(visit1aDate);
                var w1a = checkHoliday(v1a);
                html += '<div class="visit-card">';
                html += '<div class="visit-header">';
                html += '<div class="visit-name">Visit 1a</div>';
                html += '<div class="badge badge-screening">ÁØ©ÈÅ∏Êúü</div>';
                html += '</div>';
                html += '<div class="visit-info">';
                if (type === 'naive') {
                    html += 'Study Day: Day -35 to -1 (ÂΩàÊÄß)<br>Ë™™Êòé: Ë≥áÊ†ºÁ¢∫Ë™çÔºàÈÄöÂ∏∏Ëàá V1 ÂêåÂ§©Ôºâ';
                } else {
                    html += 'Study Day: Day -7 to -1<br>Ë™™Êòé: Ê¥óÈô§ÂæåË≥áÊ†ºÁ¢∫Ë™çÔºàÂøÖÈ†à V2 Ââç 1-7 Â§©Ôºâ';
                }
                html += '</div>';
                html += '<div class="visit-date">' + formatDateWithWeekday(v1a) + '</div>';
                html += getHolidayWarningHtml(w1a);
                html += '</div>';
            }
            
            // Visit 2
            var w2 = checkHoliday(v2);
            var v2AutoAdjusted = window.autoAdjustedV2 === true;
            var v2CardStyle = v2AutoAdjusted ? 'style="border: 2px solid #0b6ac9; background: #f0f7fd;"' : '';
            html += '<div class="visit-card" ' + v2CardStyle + '>';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 2' + (v2AutoAdjusted ? ' <span style="color: #0b6ac9; font-weight: 600;">‚úì Â∑≤Êõ¥Êñ∞</span>' : '') + '</div>';
            html += '<div class="badge badge-baseline">Âü∫Á∑öÊúü</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 1<br>Ë™™Êòé: Èö®Ê©üÂàÜÈÖç & Âü∫Á∑öË©ï‰º∞</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(v2) + '</div>';
            html += getHolidayWarningHtml(w2);
            if (v2AutoAdjusted) {
                html += '<div style="margin-top: 8px; padding: 8px; background: #e9f3ff; border-radius: 6px; font-size: 12px; color: #0b6ac9; font-weight: 600;">üéØ Á≥ªÁµ±Â∑≤Ëá™ÂãïË™øÊï¥Âà∞Â∑•‰ΩúÊó•</div>';
            }
            
            // ÁÇ∫ Naive È°ûÂûãÊ∑ªÂä†Êó•ÊúüÈÅ∏ÊìáÂô®
            if (type === 'naive') {
                // Ê∫ñÂÇô allVisits ‰æõË°ùÁ™ÅÊ™¢Êü•ÔºàÊ≠§ÊôÇÈÇÑÊ≤íÊúâV3-V5Ôºâ
                var allVisitsForV2 = [
                    { name: 'Visit 1', date: v1Input },
                    { name: 'Visit 1a', date: visit1aDate }
                ];
                html += generateDateSelector(2, v2, v1, allVisitsForV2);
            }
            
            html += '</div>';
            
            // Day 2
            var day2 = addDays(v2, 1);
            var wd2 = checkHoliday(day2);
            html += '<div class="visit-card">';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Day 2</div>';
            html += '<div class="badge badge-treatment">Ê≤ªÁôÇÊúü</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 2<br>Ë™™Êòé: ÈñãÂßãÊ≤ªÁôÇ</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(day2) + '</div>';
            
            // Day 2 holiday warning with explanation
            if (wd2) {
                html += '<div class="warning ' + wd2.type + '">' + wd2.msg + '</div>';
                html += '<div style="margin-top: 4px; padding: 6px 10px; background: #dcecfa; border-left: 3px solid #5b9dd9; font-size: 11px; color: #1e40af; border-radius: 6px;">';
                html += 'üíä Ê≠§Êó•ÊúüÁÇ∫Áµ¶Ëó•ÊúüÔºåÂèóË©¶ËÄÖÂú®ÂÆ∂‰ΩøÁî®Ëó•Áâ©ÔºåÂÅáÊó•ÂèØÊé•Âèó';
                html += '</div>';
            }
            
            html += '</div>';
            
            // Calculate all visit dates first
            var v3_center = addDays(v2, 7);
            var v4_center = addDays(v2, 14);
            var v5_center = addDays(v2, 28);
            
            // Validate and clean up selectedV3/V4/V5 if they're outside the ¬±2 window
            // Ë®ªÔºöÊåâÈàïÂ∑≤Á∂ìÈôêÂà∂Âú®¬±2Â§©ÁØÑÂúçÂÖßÔºåÊâÄ‰ª•Áî®Êà∂ÈÅ∏ÊìáÁöÑÊó•Êúü‰∏ÄÂÆöÊúâÊïà
            // ÈÄôË£°Âè™Ê™¢Êü•ÊòØÂê¶Âõ†ÁÇ∫V2ËÆäÂåñÂ∞éËá¥ÈÅ∏ÊìáÂ§±Êïà
            if (selectedV3) {
                var v3Diff = getDaysDiff(v3_center, parseDate(selectedV3));
                console.log('üîç Ê™¢Êü•V3ÈÅ∏Êìá:', selectedV3, '‰∏≠ÂøÉ:', formatDate(v3_center), 'Â∑ÆË∑ù:', v3Diff);
                // ‚úÖ ÊîæÂØ¨Ê™¢Êü•ÔºåÂÖÅË®±¬±2Â§©ÁØÑÂúçÂÖßÁöÑÊâÄÊúâÈÅ∏Êìá
                if (Math.abs(v3Diff) > 2) {
                    console.log('‚ö†Ô∏è Visit 3 ÈÅ∏ÊìáÁöÑÊó•ÊúüË∂ÖÂá∫Á™óÂè£ÔºåÊ∏ÖÈô§:', selectedV3);
                    selectedV3 = null;
                } else {
                    console.log('‚úÖ Visit 3 ÈÅ∏ÊìáÊúâÊïà:', selectedV3);
                }
            }
            if (selectedV4) {
                var v4Diff = getDaysDiff(v4_center, parseDate(selectedV4));
                console.log('üîç Ê™¢Êü•V4ÈÅ∏Êìá:', selectedV4, '‰∏≠ÂøÉ:', formatDate(v4_center), 'Â∑ÆË∑ù:', v4Diff);
                if (Math.abs(v4Diff) > 2) {
                    console.log('‚ö†Ô∏è Visit 4 ÈÅ∏ÊìáÁöÑÊó•ÊúüË∂ÖÂá∫Á™óÂè£ÔºåÊ∏ÖÈô§:', selectedV4);
                    selectedV4 = null;
                } else {
                    console.log('‚úÖ Visit 4 ÈÅ∏ÊìáÊúâÊïà:', selectedV4);
                }
            }
            if (selectedV5) {
                var v5Diff = getDaysDiff(v5_center, parseDate(selectedV5));
                console.log('üîç Ê™¢Êü•V5ÈÅ∏Êìá:', selectedV5, '‰∏≠ÂøÉ:', formatDate(v5_center), 'Â∑ÆË∑ù:', v5Diff);
                if (Math.abs(v5Diff) > 2) {
                    console.log('‚ö†Ô∏è Visit 5 ÈÅ∏ÊìáÁöÑÊó•ÊúüË∂ÖÂá∫Á™óÂè£ÔºåÊ∏ÖÈô§:', selectedV5);
                    selectedV5 = null;
                } else {
                    console.log('‚úÖ Visit 5 ÈÅ∏ÊìáÊúâÊïà:', selectedV5);
                }
            }
            
            // Get actual dates (use selected if available, otherwise use center)
            console.log('üìä Ë®àÁÆóÂØ¶ÈöõÊó•Êúü - selectedV3:', selectedV3, 'selectedV4:', selectedV4, 'selectedV5:', selectedV5);
            var v3_date = selectedV3 ? parseDate(selectedV3) : v3_center;
            var v4_date = selectedV4 ? parseDate(selectedV4) : v4_center;
            var v5_date = selectedV5 ? parseDate(selectedV5) : v5_center;
            console.log('üìä ÂØ¶ÈöõÊó•Êúü - V3:', formatDate(v3_date), 'V4:', formatDate(v4_date), 'V5:', formatDate(v5_date));
            
            // Collect all visit dates for conflict detection
            var allVisits = [
                { name: 'Visit 1', date: v1Input },
                { name: 'Visit 1a', date: visit1aDate },
                { name: 'Visit 2', date: v2Input },
                { name: 'Day 2', date: formatDate(day2) },
                { name: 'Visit 3', date: formatDate(v3_date) },
                { name: 'Visit 4', date: formatDate(v4_date) },
                { name: 'Visit 5', date: formatDate(v5_date) }
            ];
            
            // Visit 3
            // Ensure v3_date is within ¬±7 days of center (V2+0 to V2+14)
            var v3_range_start = addDays(v2, 0);
            var v3_range_end = addDays(v2, 14);
            if (v3_date < v3_range_start || v3_date > v3_range_end) {
                console.log('‚ö†Ô∏è Visit 3 Êó•ÊúüË∂ÖÂá∫ÁØÑÂúçÔºå‰ΩøÁî®‰∏≠ÂøÉÊó•:', formatDate(v3_date), '‚Üí', formatDate(v3_center));
                v3_date = v3_center;
                selectedV3 = formatDate(v3_center);
            }
            
            var w3 = checkHoliday(v3_date);
            var v3Updated = window.autoAdjustedV2 === true;
            var v3CardStyle = v3Updated ? 'style="border: 3px solid #5b9dd9; background: #f0f7fd;"' : '';
            html += '<div class="visit-card" ' + v3CardStyle + '>';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 3' + (v3Updated ? ' <span style="color: #5b9dd9; font-weight: 700;">‚úì Â∑≤ÈáçÊñ∞Ë®àÁÆó</span>' : '') + '</div>';
            html += '<div class="badge badge-treatment">Ê≤ªÁôÇÊúü</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 8 (¬±7Â§©)<br>ÂèØÈÅ∏ÁØÑÂúç: ' + formatDateWithWeekday(addDays(v2, 1)) + ' ~ ' + formatDateWithWeekday(addDays(v2, 14)) + '</div>';
            console.log('üé® Âç≥Â∞áÈ°ØÁ§∫V3Êó•Êúü:', formatDateWithWeekday(v3_date), 'ÂéüÂßãÂÄº:', v3_date);
            html += '<div class="visit-date">' + formatDateWithWeekday(v3_date) + '</div>';
            html += getHolidayWarningHtml(w3);
            if (v3Updated) {
                html += '<div style="margin-top: 8px; padding: 8px; background: #dcecfa; border-radius: 6px; font-size: 12px; color: #1e40af; font-weight: 600;">üîÑ Âõ† V2 Ë™øÊï¥ËÄåÈáçÊñ∞Ë®àÁÆó</div>';
            }
            html += generateDateSelector(3, v3_center, v2, allVisits);
            html += '</div>';
            
            // Visit 4
            // Ensure v4_date is within ¬±7 days of center (V2+7 to V2+21)
            var v4_range_start = addDays(v2, 7);
            var v4_range_end = addDays(v2, 21);
            if (v4_date < v4_range_start || v4_date > v4_range_end) {
                console.log('‚ö†Ô∏è Visit 4 Êó•ÊúüË∂ÖÂá∫ÁØÑÂúçÔºå‰ΩøÁî®‰∏≠ÂøÉÊó•:', formatDate(v4_date), '‚Üí', formatDate(v4_center));
                v4_date = v4_center;
                selectedV4 = formatDate(v4_center);
            }
            
            var w4 = checkHoliday(v4_date);
            var v4Updated = window.autoAdjustedV2 === true;
            var v4CardStyle = v4Updated ? 'style="border: 3px solid #5b9dd9; background: #f0f7fd;"' : '';
            html += '<div class="visit-card" ' + v4CardStyle + '>';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 4' + (v4Updated ? ' <span style="color: #5b9dd9; font-weight: 700;">‚úì Â∑≤ÈáçÊñ∞Ë®àÁÆó</span>' : '') + '</div>';
            html += '<div class="badge badge-treatment">Ê≤ªÁôÇÊúü</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 15 (¬±7Â§©)<br>ÂèØÈÅ∏ÁØÑÂúç: ' + formatDateWithWeekday(addDays(v2, 7)) + ' ~ ' + formatDateWithWeekday(addDays(v2, 21)) + '</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(v4_date) + '</div>';
            html += getHolidayWarningHtml(w4);
            if (v4Updated) {
                html += '<div style="margin-top: 8px; padding: 8px; background: #dcecfa; border-radius: 6px; font-size: 12px; color: #1e40af; font-weight: 600;">üîÑ Âõ† V2 Ë™øÊï¥ËÄåÈáçÊñ∞Ë®àÁÆó</div>';
            }
            html += generateDateSelector(4, v4_center, v2, allVisits);
            html += '</div>';
            
            // Visit 5
            // Ensure v5_date is within ¬±7 days of center (V2+21 to V2+35)
            var v5_range_start = addDays(v2, 21);
            var v5_range_end = addDays(v2, 35);
            if (v5_date < v5_range_start || v5_date > v5_range_end) {
                console.log('‚ö†Ô∏è Visit 5 Êó•ÊúüË∂ÖÂá∫ÁØÑÂúçÔºå‰ΩøÁî®‰∏≠ÂøÉÊó•:', formatDate(v5_date), '‚Üí', formatDate(v5_center));
                v5_date = v5_center;
                selectedV5 = formatDate(v5_center);
            }
            
            var w5 = checkHoliday(v5_date);
            var v5Updated = window.autoAdjustedV2 === true;
            var v5CardStyle = v5Updated ? 'style="border: 3px solid #5b9dd9; background: #f0f7fd;"' : '';
            html += '<div class="visit-card" ' + v5CardStyle + '>';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 5' + (v5Updated ? ' <span style="color: #5b9dd9; font-weight: 700;">‚úì Â∑≤ÈáçÊñ∞Ë®àÁÆó</span>' : '') + '</div>';
            html += '<div class="badge badge-treatment">Ê≤ªÁôÇÊúü</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 29 (¬±2) EOT<br>ÂèØÈÅ∏ÁØÑÂúç: ' + formatDateWithWeekday(addDays(v2, 26)) + ' ~ ' + formatDateWithWeekday(addDays(v2, 30)) + '</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(v5_date) + '</div>';
            html += getHolidayWarningHtml(w5);
            if (v5Updated) {
                html += '<div style="margin-top: 8px; padding: 8px; background: #dcecfa; border-radius: 6px; font-size: 12px; color: #1e40af; font-weight: 600;">üîÑ Âõ† V2 Ë™øÊï¥ËÄåÈáçÊñ∞Ë®àÁÆó</div>';
            }
            html += generateDateSelector(5, v5_center, v2, allVisits);
            html += '</div>';
            
            // Visit 6 - Á∞°ÂåñÁÇ∫ÂñÆÊó•ÈÅ∏Êìá
            var v6_range_start = addDays(v2, 29);  // Day 30 (V2+29Â§©)
            var v6_range_end = addDays(v2, 50);    // Day 51 (+7, V2+50Â§©)
            var selectedV6Date = selectedV6 ? parseDate(selectedV6) : v6_range_start;
            
            // Á¢∫‰øùÈÅ∏ÊìáÁöÑÊó•ÊúüÂú®ÁØÑÂúçÂÖß
            if (selectedV6Date < v6_range_start) selectedV6Date = v6_range_start;
            if (selectedV6Date > v6_range_end) selectedV6Date = v6_range_end;
            
            var w6 = checkHoliday(selectedV6Date);
            html += '<div class="visit-card">';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 6</div>';
            html += '<div class="badge badge-followup">ËøΩËπ§Êúü</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 30-51 (+7) EOS<br>Ë™™Êòé: End of Study<br>ÂèØÈÅ∏ÁØÑÂúçÔºö' + formatDateWithWeekday(v6_range_start) + ' ~ ' + formatDateWithWeekday(v6_range_end) + '</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(selectedV6Date) + '</div>';
            html += getHolidayWarningHtml(w6);
            
            // üèÜ V6‰ΩøÁî®ÂÆåÊï¥ÊúàÊõÜÔºàËàáV2/V1aÁµ±‰∏ÄÔºâ
            html += '<div style="margin-top: 24px;">';
            html += '<div style="font-size: 14px; font-weight: 600; color: #64748b; margin-bottom: 12px;">üìÖ ÈÅ∏ÊìáË®™Ë¶ñÊó•Êúü</div>';
            
            // Âúñ‰æãÂ∑≤ÁßªÈô§ - ‰øùÊåÅÁ∞°ÊΩî
            
            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 11px;">';
            
            // Ë®àÁÆóÊúàÊõÜÁØÑÂúç
            var calStartDate = new Date(v6_range_start);
            calStartDate.setDate(calStartDate.getDate() - calStartDate.getDay()); // ÂæûÈÄ±Êó•ÈñãÂßã
            
            var calEndDate = new Date(v6_range_end);
            var endDay = calEndDate.getDay();
            if (endDay !== 6) {
                calEndDate.setDate(calEndDate.getDate() + (6 - endDay)); // Âà∞ÈÄ±ÂÖ≠ÁµêÊùü
            }
            
            // Ê∑ªÂä†ÊòüÊúüÊ®ôÈ°å
            var weekdayHeaders = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            for (var i = 0; i < 7; i++) {
                html += '<div style="text-align: center; font-weight: 600; color: #9ca3af; padding: 4px;">' + weekdayHeaders[i] + '</div>';
            }
            
            // Ê∑ªÂä†Êó•ÊúüÊ†ºÂ≠ê
            var currentCalDate = new Date(calStartDate);
            while (currentCalDate <= calEndDate) {
                var dateStr = formatDate(currentCalDate);
                var isInRange = currentCalDate >= v6_range_start && currentCalDate <= v6_range_end;
                var isHoliday = checkHoliday(currentCalDate);
                var isSelected = formatDate(selectedV6Date) === dateStr;
                
                var cellStyle = 'text-align: center; padding: 6px 4px; border-radius: 6px; ';
                
                if (isInRange && !isHoliday) {
                    // ÂèØÈÅ∏Êó•Êúü - ÁôΩÂ∫ï + Ê∑°ÁÅ∞Ê°Ü + Ê∑±ÁÅ∞Â≠ó
                    cellStyle += 'background: #ffffff; border: 1px solid #e0e0e0; color: #37352f; font-weight: 500; cursor: pointer;';
                    if (isSelected) {
                        // Â∑≤ÈÅ∏ÔºöËóçËâ≤Â∫ï + ÁôΩÂ≠ó
                        cellStyle = 'text-align: center; padding: 6px 4px; border-radius: 6px; background: #0b6ac9; border: none; color: #ffffff; font-weight: 600; cursor: pointer;';
                    }
                } else if (isInRange && isHoliday) {
                    // ÁØÑÂúçÂÖßÂÅáÊó• - Ê∑°ÁÅ∞
                    cellStyle += 'background: #f5f5f5; color: #9b9a97;';
                } else {
                    // ÁØÑÂúçÂ§ñ - Ê•µÊ∑°ÁÅ∞
                    cellStyle += 'background: #fafafa; color: #d0d0d0;';
                }
                
                var onclick = (isInRange && !isHoliday) ? ' onclick="selectVisitDate(6, \'' + dateStr + '\')"' : '';
                html += '<div style="' + cellStyle + '"' + onclick + '>' + currentCalDate.getDate() + '</div>';
                
                currentCalDate.setDate(currentCalDate.getDate() + 1);
            }
            
            html += '</div>';
            html += '</div>';
            
            html += '<input type="hidden" id="v6Input" value="' + formatDateWithWeekday(selectedV6Date) + '">';
            html += '</div>';
            
            console.log('üèÅ Ê∫ñÂÇôÊõ¥Êñ∞DOM - selectedV3:', selectedV3, 'v3_date:', formatDate(v3_date));
            output.innerHTML = html;
            console.log('‚úÖ DOMÂ∑≤Êõ¥Êñ∞ÂÆåÊàê');
            
            // È°ØÁ§∫ V3~V6 Ë™™ÊòéÂç°Áâá
            const visitInfoCard = document.getElementById('visitInfoCard');
            if (visitInfoCard && html && html.length > 100) {
                visitInfoCard.style.display = 'flex';
                visitInfoCard.style.animation = 'slideInUp 0.5s ease';
            }
            
            // Ê∑ªÂä†ÁîüÊàêÊàêÂäüÁöÑÊèêÁ§∫ÔºàÂè™È°ØÁ§∫‰∏ÄÊ¨°Ôºâ
            if (html && html.length > 100 && !hasShownGeneratedToast) {
                // Âª∂ËøüÊòæÁ§∫ÔºåËÆ©DOMÊõ¥Êñ∞ÂÆåÊàê
                setTimeout(() => {
                    showToast('success', '‚úì Â∑≤ÁîüÊàê', 'Ë®™Ë¶ñÊéíÁ®ãÂ∑≤Âú®‰∏ãÊñπÁîüÊàê');
                    hasShownGeneratedToast = true; // Ë®≠ÁΩÆÊ®ôÂøóÔºåÈò≤Ê≠¢ÈáçË§áÈ°ØÁ§∫
                }, 200);
            }
            
            // Auto-avoid holidays for Visit 3, 4, 5 (ÈùúÈªòÊ®°ÂºèÔºå‰∏çÈ°ØÁ§∫Toast)
            setTimeout(function() {
                // autoAvoidHolidays(true); // ‚ö†Ô∏è Â∑≤Ë®ªÈáã - Èò≤Ê≠¢Ë¶ÜËìãÁî®Êà∂ÈÅ∏Êìá // true = ÈùúÈªòÊ®°Âºè
                updateFinalSummary(); // üèÜ Êõ¥Êñ∞ÊúÄÁµÇÊó•ÊúüÊëòË¶Å
            }, 50);
        }
        
        // Initialize
        validateDates();
        
        // ========================================
        // UI Â¢ûÂº∑ÂäüËÉΩ
        // ========================================
        
        // Êõ¥Êñ∞ÈÄ≤Â∫¶ÊåáÁ§∫Âô®
        function updateProgress() {
            let completed = 0;
            let total = 3; // ÈªòË™ç Naive: ÂèóË©¶ËÄÖÈ°ûÂûã + V1 + V2
            
            const subjectType = document.getElementById('subjectType').value;
            const drugType = document.getElementById('drugType').value;
            const visit1 = document.getElementById('visit1').value;
            const visit2 = document.getElementById('visit2').value;
            
            // Ê™¢Êü•ÂøÖÂ°´Ê¨Ñ‰Ωç
            if (subjectType) completed++;
            
            // Â¶ÇÊûúÊòØ WashoutÔºåÈúÄË¶ÅËó•Áâ©È°ûÂûãÔºàÁ∏ΩÂÖ±4È†ÖÔºâ
            if (subjectType === 'washout') {
                total = 4;
                if (drugType) completed++;
            }
            
            if (visit1) completed++;
            if (visit2) completed++;
            
            const percentage = Math.round((completed / total) * 100);
            
            // üé® Êõ¥Êñ∞Ê≠•È©üÊåáÁ§∫Âô®ÁãÄÊÖã
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            
            // ÈáçÁΩÆÊâÄÊúâÊ≠•È©ü
            [step1, step2, step3].forEach(step => {
                if (step) {
                    step.style.background = 'transparent';
                    step.style.transform = 'scale(1)';
                }
            });
            
            // Êõ¥Êñ∞Ê≠•È©ü1ÁãÄÊÖã
            if (step1) {
                if (subjectType && (subjectType === 'naive' || drugType)) {
                    // Â∑≤ÂÆåÊàê
                    step1.style.background = 'linear-gradient(135deg, #0b6ac9 0%, #0959a8 100%)';
                    step1.style.color = 'white';
                    step1.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
                    step1.querySelector('div:first-child').textContent = '‚úì';
                } else if (subjectType) {
                    // ÈÄ≤Ë°å‰∏≠
                    step1.style.background = 'linear-gradient(135deg, #fbbf24 0%, #57534e 100%)';
                    step1.style.color = 'white';
                    step1.style.transform = 'scale(1.05)';
                    step1.style.boxShadow = '0 4px 12px rgba(251, 191, 36, 0.4)';
                } else {
                    step1.style.background = '#f0f7fd';
                    step1.style.color = '#6b7280';
                }
            }
            
            // Êõ¥Êñ∞Ê≠•È©ü2ÁãÄÊÖã
            if (step2) {
                if (visit1) {
                    // Â∑≤ÂÆåÊàê
                    step2.style.background = 'linear-gradient(135deg, #0b6ac9 0%, #0959a8 100%)';
                    step2.style.color = 'white';
                    step2.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
                    step2.querySelector('div:first-child').textContent = '‚úì';
                } else if (subjectType && (subjectType === 'naive' || drugType)) {
                    // Áï∂ÂâçÊ≠•È©ü
                    step2.style.background = 'linear-gradient(135deg, #0b6ac9 0%, #0959a8 100%)';
                    step2.style.color = 'white';
                    step2.style.transform = 'scale(1.1)';
                    step2.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.3), 0 4px 12px rgba(102, 126, 234, 0.4)';
                    step2.style.animation = 'pulse 2s ease-in-out infinite';
                } else {
                    step2.style.background = '#f3f4f6';
                    step2.style.color = '#9ca3af';
                }
            }
            
            // Êõ¥Êñ∞Ê≠•È©ü3ÁãÄÊÖã
            if (step3) {
                if (visit2) {
                    // Â∑≤ÂÆåÊàê
                    step3.style.background = 'linear-gradient(135deg, #0b6ac9 0%, #0959a8 100%)';
                    step3.style.color = 'white';
                    step3.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
                    step3.querySelector('div:first-child').textContent = '‚úì';
                } else if (visit1) {
                    // Áï∂ÂâçÊ≠•È©ü
                    step3.style.background = 'linear-gradient(135deg, #0b6ac9 0%, #0959a8 100%)';
                    step3.style.color = 'white';
                    step3.style.transform = 'scale(1.1)';
                    step3.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.3), 0 4px 12px rgba(102, 126, 234, 0.4)';
                    step3.style.animation = 'pulse 2s ease-in-out infinite';
                } else {
                    step3.style.background = '#f3f4f6';
                    step3.style.color = '#9ca3af';
                }
            }
            
            // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressPercentage = document.getElementById('progressPercentage');
            
            if (progressFill) {
                progressFill.style.width = percentage + '%';
            }
            
            if (progressText) {
                let text = `Â∑≤ÂÆåÊàê ${completed}/${total} È†ÖÂøÖÂ°´Ê¨Ñ‰Ωç`;
                // Â¶ÇÊûúÂÖ®ÈÉ®ÂÆåÊàêÔºåÈ°ØÁ§∫È°çÂ§ñÊèêÁ§∫
                if (completed === total && visit2) {
                    text = `‚úì ÂøÖÂ°´È†ÖÂ∑≤ÂÆåÊàêÔºàV3~V6 Â∑≤Ëá™ÂãïË®àÁÆóÔºåÂèØÈªûÊìäÊó•ÊúüË™øÊï¥Ôºâ`;
                }
                progressText.textContent = text;
            }
            
            if (progressPercentage) {
                progressPercentage.textContent = percentage + '%';
            }
            
            // Ê∑ªÂä†È©óË≠âÁãÄÊÖãÈ°û
            const subjectTypeEl = document.getElementById('subjectType');
            const drugTypeEl = document.getElementById('drugType');
            const visit1El = document.getElementById('visit1');
            const visit2El = document.getElementById('visit2');
            
            if (subjectType) {
                subjectTypeEl.classList.add('valid');
                subjectTypeEl.classList.remove('invalid');
            } else {
                subjectTypeEl.classList.remove('valid', 'invalid');
            }
            
            // Ëó•Áâ©È°ûÂûãÈ©óË≠âÔºàÂÉÖ WashoutÔºâ
            if (subjectType === 'washout') {
                if (drugType) {
                    drugTypeEl.classList.add('valid');
                    drugTypeEl.classList.remove('invalid');
                } else {
                    drugTypeEl.classList.remove('valid', 'invalid');
                }
            }
            
            if (visit1) {
                visit1El.classList.add('valid');
                visit1El.classList.remove('invalid');
            } else {
                visit1El.classList.remove('valid', 'invalid');
            }
            
            if (visit2) {
                visit2El.classList.add('valid');
                visit2El.classList.remove('invalid');
            } else {
                visit2El.classList.remove('valid', 'invalid');
            }
        }
        
        // È°ØÁ§∫Êô∫ËÉΩÊèêÁ§∫
        function showSmartTip(message) {
            // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊúâÊèêÁ§∫
            const existingTip = document.querySelector('.smart-tip');
            if (existingTip) {
                existingTip.remove();
            }
            
            // ÂâµÂª∫ÊèêÁ§∫
            const tip = document.createElement('div');
            tip.className = 'smart-tip';
            tip.innerHTML = `
                <div class="smart-tip-icon">üí°</div>
                <div class="smart-tip-content">
                    <div class="smart-tip-title">ÊèêÁ§∫</div>
                    <div class="smart-tip-message">${message}</div>
                </div>
            `;
            
            // ÊèíÂÖ•Âà∞ÈÅ©Áï∂‰ΩçÁΩÆÔºàinput-sectionÁöÑÁ¨¨‰∏ÄÂÄã‰ΩçÁΩÆÔºâ
            const inputSection = document.querySelector('.input-section');
            if (inputSection) {
                inputSection.insertBefore(tip, inputSection.firstChild);
                
                // 5ÁßíÂæåËá™ÂãïÁßªÈô§
                setTimeout(() => {
                    tip.style.animation = 'slideOutDown 0.5s ease';
                    setTimeout(() => tip.remove(), 500);
                }, 5000);
            }
        }
        
        // È°ØÁ§∫È†ÅÈù¢Âä†ËºâÂô®
        function showPageLoader(text) {
            const loader = document.createElement('div');
            loader.className = 'page-loader';
            loader.id = 'pageLoader';
            loader.innerHTML = `
                <div class="spinner"></div>
                <div class="loader-text">${text || 'ËºâÂÖ•‰∏≠...'}</div>
            `;
            document.body.appendChild(loader);
        }
        
        // Èö±ËóèÈ†ÅÈù¢Âä†ËºâÂô®
        function hidePageLoader() {
            const loader = document.getElementById('pageLoader');
            if (loader) {
                loader.classList.add('hide');
                setTimeout(() => loader.remove(), 300);
            }
        }
        
        // Ê∑ªÂä†ÊåâÈàïÂä†ËºâÁãÄÊÖã
        function setButtonLoading(button, loading) {
            if (loading) {
                button.classList.add('btn-loading');
                button.disabled = true;
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }
        
        // Âπ≥ÊªëÊªöÂä®Âà∞ÂÖÉÁ¥†
        function smoothScrollTo(element) {
            if (element) {
                element.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }
        
        // ÊªöÂä®Âà∞ÁªìÊûúÂå∫Âüü
        function smoothScrollToResults() {
            const resultsDiv = document.querySelector('.results');
            const output = document.getElementById('output');
            if (resultsDiv && output && output.innerHTML && output.innerHTML !== '<div class="empty">Ë´ãÂ°´ÂØ´ÊâÄÊúâÊ¨Ñ‰Ωç‰ª•Ë®àÁÆóË®™Ë¶ñÊó•Êúü</div>') {
                setTimeout(() => {
                    resultsDiv.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);
            }
        }
        
        // ÊâãÂä®ÊªöÂä®Âà∞ÁªìÊûúÔºàÂ∏¶ÊèêÁ§∫Ôºâ
        function scrollToResults() {
            const output = document.getElementById('output');
            if (output && output.innerHTML && output.innerHTML.includes('visit-card')) {
                document.querySelector('.results').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                // Áü≠ÊöÇÈ´ò‰∫ÆÁªìÊûúÂå∫Âüü
                setTimeout(() => {
                    const results = document.querySelector('.results');
                    results.style.transition = 'background 0.5s';
                    results.style.background = 'rgba(102, 126, 234, 0.05)';
                    setTimeout(() => {
                        results.style.background = '';
                    }, 1000);
                }, 500);
            } else {
                showToast('warning', 'Ë´ãÂÖàÂ°´ÂØ´', 'Ë´ãÂÖàÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç‰ª•ÁîüÊàêÊéíÁ®ã');
                // ËÅöÁÑ¶Âà∞Á¨¨‰∏Ä‰∏™Á©∫ÁöÑËæìÂÖ•Ê°Ü
                const subjectType = document.getElementById('subjectType');
                const visit1 = document.getElementById('visit1');
                const visit2 = document.getElementById('visit2');
                
                if (!subjectType.value) {
                    subjectType.focus();
                    shakeElement(subjectType);
                } else if (!visit1.value) {
                    visit1.focus();
                    shakeElement(visit1);
                } else if (!visit2.value) {
                    visit2.focus();
                    shakeElement(visit2);
                }
            }
        }
        
        // ÊäñÂãïÊèêÁ§∫ÁÑ°ÊïàËº∏ÂÖ•
        function shakeElement(element) {
            element.classList.remove('invalid');
            void element.offsetWidth; // Ëß∏ÁôºÈáçÊéí
            element.classList.add('invalid');
        }
        
        // Ë¶ÜËìãÂéüÊúâÁöÑ clearAll ÂáΩÊï∏ÔºåÊ∑ªÂä†ÈÄ≤Â∫¶Êõ¥Êñ∞
        const originalClearAll = window.clearAll;
        window.clearAll = function() {
            originalClearAll();
            
            // Êõ¥Êñ∞ÈÄ≤Â∫¶
            updateProgress();
            
            // ÁßªÈô§È©óË≠âÁãÄÊÖã
            document.querySelectorAll('.valid, .invalid').forEach(el => {
                el.classList.remove('valid', 'invalid');
            });
            
            // ÁßªÈô§Êô∫ËÉΩÊèêÁ§∫
            const smartTip = document.querySelector('.smart-tip');
            if (smartTip) {
                smartTip.remove();
            }
        };
        
        // ÂàùÂßãÂåñÊôÇÁöÑË®≠ÁΩÆ
        window.addEventListener('load', function() {
            // ÂàùÂßãÂåñÈÄ≤Â∫¶
            updateProgress();
            
            // ÁÇ∫ÊâÄÊúâËº∏ÂÖ•Ê°ÜÊ∑ªÂä†ÈÄ≤Â∫¶Êõ¥Êñ∞Áõ£ËÅΩ
            const subjectType = document.getElementById('subjectType');
            const drugType = document.getElementById('drugType');
            const visit1 = document.getElementById('visit1');
            const visit2 = document.getElementById('visit2');
            
            if (subjectType) {
                // ‰øùÂ≠òÂéüÊúâÁöÑ onchange
                const originalOnChange = subjectType.onchange;
                subjectType.onchange = function() {
                    if (originalOnChange) originalOnChange.call(this);
                    updateProgress();
                };
            }
            
            if (drugType) {
                const originalOnChange = drugType.onchange;
                drugType.onchange = function() {
                    if (originalOnChange) originalOnChange.call(this);
                    updateProgress();
                };
            }
            
            if (visit1) {
                const originalOnChange = visit1.onchange;
                visit1.onchange = function() {
                    if (originalOnChange) originalOnChange.call(this);
                    updateProgress();
                };
            }
            
            if (visit2) {
                const originalOnChange = visit2.onchange;
                visit2.onchange = function() {
                    if (originalOnChange) originalOnChange.call(this);
                    updateProgress();
                };
            }
            
            // È°ØÁ§∫Ê≠°ËøéÊèêÁ§∫
            setTimeout(() => {
                showSmartTip('Âª∫Ë≠∞ÈÅ∏ÊìáÈùûÂÅáÊó•ÁöÑÂ∑•‰ΩúÊó•‰ΩúÁÇ∫Ë®™Ë¶ñÊó•ÊúüÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïÂπ´ÊÇ®Ê™¢Êü•ÂÅáÊó•Ë°ùÁ™Å„ÄÇ');
            }, 1000);
        });
        
        // üèÜ Ë§áË£ΩÊúÄÁµÇÊó•ÊúüÂäüËÉΩ
        
        // üèÜ V6Êó•ÊúüÈÅ∏ÊìáÂáΩÊï∏
        function selectV6StartDate(dateStr) {
            const v6StartInput = document.getElementById('v6StartInput');
            if (v6StartInput) {
                const date = parseDate(dateStr);
                v6StartInput.value = formatDateWithWeekday(date);
                updateFinalSummary();
                calculateVisits(); // ÈáçÊñ∞Ê∏≤Êüì‰ª•Êõ¥Êñ∞Êó•ÊõÜÈ°ØÁ§∫
            }
        }
        
        function selectV6EndDate(dateStr) {
            const v6EndInput = document.getElementById('v6EndInput');
            if (v6EndInput) {
                const date = parseDate(dateStr);
                v6EndInput.value = formatDateWithWeekday(date);
                updateFinalSummary();
                calculateVisits(); // ÈáçÊñ∞Ê∏≤Êüì‰ª•Êõ¥Êñ∞Êó•ÊõÜÈ°ØÁ§∫
            }
        }
        
        function copyFinalDates() {
            const content = document.getElementById('finalSummaryContent');
            if (!content) return;
            
            const text = content.innerText;
            navigator.clipboard.writeText(text).then(() => {
                showSmartTip('‚úÖ Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø');
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showSmartTip('‚úÖ Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø');
            });
        }
        
        // üèÜ Êõ¥Êñ∞ÊúÄÁµÇÊó•ÊúüÊëòË¶Å
        function updateFinalSummary() {
            const summaryDiv = document.getElementById('finalSummary');
            const contentDiv = document.getElementById('finalSummaryContent');
            const output = document.getElementById('output');
            
            if (!summaryDiv || !contentDiv || !output) return;
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâÁµêÊûú
            if (!output.innerHTML || output.innerHTML.includes('empty')) {
                summaryDiv.style.display = 'none';
                return;
            }
            
            // Êî∂ÈõÜÊâÄÊúâÊó•Êúü
            const dates = [];
            const v1Input = document.getElementById('visit1');
            const v2Input = document.getElementById('visit2');
            const v1aInput = document.getElementById('v1aInput');
            const v3Input = document.getElementById('v3Input');
            const v4Input = document.getElementById('v4Input');
            const v5Input = document.getElementById('v5Input');
            const v6Input = document.getElementById('v6Input');
            
            // üèÜ V1ÂíåV2ÈúÄË¶ÅËΩâÊèõÁÇ∫Âê´ÊòüÊúüÊ†ºÂºè
            if (v1Input && v1Input.value) {
                dates.push('Visit 1Ôºö' + formatDateWithWeekday(parseDate(v1Input.value)));
            }
            if (v1aInput && v1aInput.value && v1aInput.value !== '') {
                // üîß ‰øÆÊ≠£ÔºöV1a‰πüÈúÄË¶ÅËΩâÊèõÁÇ∫Âê´ÊòüÊúüÊ†ºÂºè
                var v1aValue = v1aInput.value;
                // Ê™¢Êü•ÊòØÂê¶Â∑≤Âê´ÊòüÊúüÔºàÂåÖÂê´‰∏≠ÊñáÊã¨ËôüÔºâ
                if (v1aValue.indexOf('(') === -1) {
                    // ‰∏çÂê´ÊòüÊúüÔºåÈúÄË¶ÅËΩâÊèõ
                    dates.push('Visit 1aÔºö' + formatDateWithWeekday(parseDate(v1aValue)));
                } else {
                    // Â∑≤Âê´ÊòüÊúü
                    dates.push('Visit 1aÔºö' + v1aValue);
                }
            }
            if (v2Input && v2Input.value) {
                dates.push('Visit 2Ôºö' + formatDateWithWeekday(parseDate(v2Input.value)));
            }
            if (v3Input && v3Input.value) {
                dates.push('Visit 3Ôºö' + v3Input.value); // v3-v5 InputÂ∑≤Á∂ìÂê´ÊòüÊúü
            }
            if (v4Input && v4Input.value) {
                dates.push('Visit 4Ôºö' + v4Input.value);
            }
            if (v5Input && v5Input.value) {
                dates.push('Visit 5Ôºö' + v5Input.value);
            }
            if (v6Input && v6Input.value) {
                dates.push('Visit 6Ôºö' + v6Input.value); // v6InputÂ∑≤Á∂ìÂê´ÊòüÊúü
            }
            
            if (dates.length > 0) {
                contentDiv.innerHTML = dates.join('<br>');
                summaryDiv.style.display = 'block';
            } else {
                summaryDiv.style.display = 'none';
            }
        }
    </script>

</body>
</html>
