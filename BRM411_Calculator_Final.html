<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRM411 è¨ªè¦–è¨ˆç®—å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4a5fc1 0%, #5e4b9f 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .header .subtitle {
            font-size: 13px;
            opacity: 0.9;
        }
        
        /* æ“ä½œæŒ‰éˆ•å€ */
        .action-bar {
            padding: 12px 20px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .clear-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .clear-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .input-section {
            padding: 25px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #4a5fc1;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        select, input[type="date"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            transition: all 0.3s;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            height: 48px;
            line-height: 1.5;
        }
        
        /* ä¸ºselectæ·»åŠ ä¸‹æ‹‰ç®­å¤´ */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
            padding-left: 40px;
            text-align: center;
            text-align-last: center;
        }
        
        /* selectçš„optionä¹Ÿå±…ä¸­ */
        select option {
            text-align: center;
        }
        
        /* input[type="date"]ä¹Ÿå±…ä¸­ */
        input[type="date"] {
            text-align: center;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .validation-msg {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .validation-msg.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #dc2626;
        }
        
        .validation-msg.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .v1a-input {
            margin-top: 15px;
            padding: 15px;
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 10px;
        }
        
        .v1a-label {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .suggestion-box {
            background: white;
            border: 2px solid #fde68a;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .suggestion-label {
            font-weight: 600;
            color: #78350f;
            margin-bottom: 5px;
        }
        
        .suggestion-value {
            color: #92400e;
            line-height: 1.6;
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 10px 18px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 165px;
            width: 100%;
            text-align: left;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: block;
        }
        
        .btn-primary {
            background: #4f46e5;
            color: white;
        }
        
        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(79,70,229,0.3);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* æ—¥æœŸé¸æ“‡æŒ‰éˆ• */
        .date-selector {
            margin-top: 12px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .date-selector-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .date-options {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .date-option {
            flex: 1;
            min-width: 60px;
            padding: 8px 6px;
            font-size: 11px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .date-option:hover:not(.disabled) {
            border-color: #4f46e5;
            background: #eef2ff;
        }
        
        .date-option.selected {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
            font-weight: 600;
        }
        
        .date-option.disabled {
            background: #f3f4f6;
            color: #9ca3af;
            border-color: #e5e7eb;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .date-option.conflict {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fca5a5;
        }
        
        .date-option-date {
            display: block;
            font-weight: 600;
        }
        
        .date-option-label {
            display: block;
            font-size: 10px;
            margin-top: 2px;
        }
        
        .results {
            padding: 20px;
        }
        
        .results-title {
            font-size: 18px;
            font-weight: 600;
            color: #4a5fc1;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .visit-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .visit-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
            border-color: #d1d5db;
        }
        
        .visit-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .visit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .visit-name {
            font-weight: 600;
            font-size: 17px;
            color: #1f2937;
        }
        
        .badge {
            font-size: 11px;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .badge-screening {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-baseline {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-treatment {
            background: #dcfce7;
            color: #166534;
        }
        
        .badge-followup {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .visit-info {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.7;
            margin-bottom: 10px;
        }
        
        .visit-date {
            background: #f0f4ff;
            color: #667eea;
            padding: 10px 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 15px;
        }
        
        .warning {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            border-left: 4px solid;
            font-size: 13px;
            font-weight: 600;
        }
        
        .warning.weekend {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }
        
        .warning.holiday {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .empty {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .notes {
            background: #fffbeb;
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            border-left: 4px solid #fbbf24;
        }
        
        .notes-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 12px;
            font-size: 15px;
        }
        
        .notes ul {
            margin-left: 20px;
            font-size: 13px;
            color: #78350f;
            line-height: 1.9;
        }
        
        .notes li strong {
            color: #92400e;
        }
        
        /* æ‰‹æ©Ÿç‰ˆé¢å„ªåŒ– */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            .container {
                padding: 10px;
                max-width: 100%;
            }
            
            .header {
                padding: 18px 12px;
                position: relative;
            }
            
            .header h1 {
                font-size: 18px;
                margin-bottom: 6px;
            }
            
            .header .subtitle {
                font-size: 11px;
                line-height: 1.4;
            }
            
            .action-bar {
                padding: 10px 12px;
                justify-content: center;
            }
            
            .clear-btn {
                padding: 8px 16px;
                font-size: 13px;
                width: auto;
            }
            
            .form-group {
                margin-bottom: 16px;
            }
            
            .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
                display: block;
            }
            
            .form-group select,
            .form-group input[type="date"] {
                font-size: 14px;
                padding: 12px;
                width: 100%;
                box-sizing: border-box;
                height: 48px;
            }
            
            .form-group select {
                padding-left: 40px;
                padding-right: 40px;
            }
            
            /* æŒ‰éˆ•çµ„ - å‚ç›´æ’åˆ— */
            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-top: 12px;
            }
            
            .btn-group button {
                width: 100%;
                font-size: 13px;
                padding: 12px 16px;
                white-space: normal;
                text-align: center;
                line-height: 1.4;
                min-height: 48px; /* å¢åŠ æœ€å°é«˜åº¦ï¼Œæ›´å®¹æ˜“é»æ“Š */
                word-wrap: break-word;
                box-sizing: border-box;
            }
            
            /* å»ºè­°æ¡†å„ªåŒ– */
            .suggestion-box {
                padding: 12px;
                font-size: 12px;
                margin-top: 12px;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .suggestion-label {
                font-size: 13px;
                margin-bottom: 8px;
                font-weight: 600;
            }
            
            .suggestion-value {
                font-size: 12px;
                line-height: 1.6;
            }
            
            .v1a-label {
                font-size: 13px;
                margin-bottom: 8px;
                display: block;
                font-weight: 600;
            }
            
            /* V1a è¼¸å…¥æ¡†å„ªåŒ– */
            #v1aInput {
                font-size: 14px !important;
                padding: 12px !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* è¨ªè¦–å¡ç‰‡å„ªåŒ– */
            .visit-card {
                padding: 14px;
                margin-bottom: 12px;
            }
            
            .visit-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .visit-name {
                font-size: 15px;
            }
            
            .visit-date {
                font-size: 18px;
                margin: 10px 0;
            }
            
            .visit-info {
                font-size: 12px;
                line-height: 1.6;
            }
            
            .badge {
                font-size: 10px;
                padding: 4px 10px;
            }
            
            /* è­¦å‘Šè¨Šæ¯å„ªåŒ– */
            .warning {
                font-size: 12px;
                padding: 10px 12px;
                margin-top: 8px;
                line-height: 1.5;
            }
            
            .validation-msg {
                font-size: 12px;
                padding: 10px 12px;
                line-height: 1.5;
            }
            
            /* ä½¿ç”¨èªªæ˜å„ªåŒ– */
            .notes {
                padding: 14px;
                margin-top: 16px;
            }
            
            .notes-title {
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .notes ul {
                font-size: 12px;
                margin-left: 20px;
                line-height: 1.8;
            }
            
            .notes li {
                margin-bottom: 8px;
            }
            
            .empty {
                font-size: 13px;
                padding: 30px 16px;
            }
            
            /* æ—¥æœŸé¸æ“‡å™¨æ‰‹æ©Ÿå„ªåŒ– */
            .date-selector {
                padding: 8px;
            }
            
            .date-selector-label {
                font-size: 11px;
            }
            
            .date-options {
                flex-direction: column;
                gap: 8px;
            }
            
            .date-option {
                min-width: 100%;
                padding: 10px 8px;
                font-size: 12px;
            }
            
            .date-option-date {
                font-size: 13px;
            }
            
            .date-option-label {
                font-size: 10px;
            }
            
            /* æ™ºèƒ½åŠ©æ‰‹æŒ‰éˆ•æ‰‹æ©Ÿå„ªåŒ– */
            button[onclick="autoAvoidHolidays()"] {
                width: 90% !important;
                padding: 14px 20px !important;
                font-size: 15px !important;
            }
            
            /* ç¢ºä¿æ‰€æœ‰ inline style çš„å…ƒç´ ä¹ŸéŸ¿æ‡‰ */
            div[style*="display: flex"] {
                flex-wrap: wrap;
            }
        }
        
        /* è¶…å°å±å¹•å„ªåŒ– (iPhone SE ç­‰) */
        @media (max-width: 375px) {
            .container {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .action-bar {
                padding: 8px;
            }
            
            .clear-btn {
                padding: 7px 14px;
                font-size: 12px;
            }
            
            .form-group select,
            .form-group input[type="date"] {
                font-size: 13px;
                padding: 10px;
                height: 44px;
            }
            
            .form-group select {
                padding-left: 35px;
                padding-right: 35px;
            }
            
            .btn-group button {
                font-size: 12px;
                padding: 10px 14px;
                min-height: 44px;
            }
            
            .suggestion-box {
                padding: 10px;
                font-size: 11px;
            }
            
            .visit-card {
                padding: 12px;
            }
            
            .date-option {
                padding: 8px 6px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BRM411 è¨ªè¦–è¨ˆç®—å™¨</h1>
            <p class="subtitle">è‡¨åºŠè©¦é©—è¨ªè¦–æ—¥æœŸè¦åŠƒå·¥å…·</p>
        </div>
        
        <!-- æ“ä½œæŒ‰éˆ•å€ -->
        <div class="action-bar">
            <button class="clear-btn" onclick="clearAll()">ğŸ”„ æ¸…ç©ºé‡è¨­</button>
        </div>
        
        <div class="input-section">
            <div class="form-group">
                <label>å—è©¦è€…é¡å‹</label>
                <select id="subjectType" onchange="toggleDrugSelection(); validateDates()">
                    <option value="">-- è«‹é¸æ“‡ --</option>
                    <option value="naive">Naive (æœªç”¨è—¥å—è©¦è€…)</option>
                    <option value="washout">Washout (æ´—é™¤æœŸå—è©¦è€…)</option>
                </select>
            </div>
            
            <div class="form-group" id="drugTypeGroup" style="display: none;">
                <label>éœ€æ´—é™¤çš„è—¥ç‰©é¡å‹</label>
                <select id="drugType" onchange="visit1aDate=''; calculateV2Suggestion(); validateDates()">
                    <option value="">-- è«‹é¸æ“‡è—¥ç‰©é¡å‹ --</option>
                    <option value="28">Prostaglandins / Î²-blockers / Kinase inhibitors (28 å¤©)</option>
                    <option value="14">Adrenergic agonists (14 å¤©)</option>
                    <option value="7">Muscarinic agonists / Carbonic anhydrase inhibitors (7 å¤©)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Visit 1 æ—¥æœŸ (ç¯©é¸æ—¥)</label>
                <input type="date" id="visit1" onchange="checkDateWarning('visit1'); calculateV2Suggestion(); validateDates(); if(visit1aDate) validateV1a(); checkV2EarlyWarning();">
                <div id="visit1Warning"></div>
            </div>
            
            <div class="form-group">
                <label>Visit 2 æ—¥æœŸ (åŸºç·šæ—¥/éš¨æ©Ÿåˆ†é…æ—¥)</label>
                <input type="date" id="visit2" onchange="checkDateWarning('visit2'); checkV2EarlyWarning(); validateDates(); if(visit1aDate) validateV1a(); setTimeout(function() { checkAllVisitsHolidays(); }, 100);">
                <div id="visit2Warning"></div>
                <div id="v2EarlyWarning"></div>
                <div id="v2Suggestion"></div>
                <div id="validation"></div>
            </div>
            
            <!-- å³æ™‚æé†’æ¡† - ç§»åˆ° V1a ä¹‹å‰ -->
            <div id="allVisitsHolidayWarning" style="margin: 20px 0;"></div>
            
            <div id="v1aSuggestion"></div>
        </div>
        
        <div class="results">
            <h2 class="results-title">è¨ªè¦–æ’ç¨‹ç¸½è¦½</h2>
            <div id="output"></div>
        </div>
        
        <div class="notes">
            <div class="notes-title">ä½¿ç”¨èªªæ˜</div>
            <ul>
                <li><strong>Step 1:</strong> é¸æ“‡å—è©¦è€…é¡å‹</li>
                <li><strong>Step 2:</strong> å¦‚é¸æ“‡ Washoutï¼Œéœ€é¸æ“‡è—¥ç‰©é¡å‹ï¼ˆæ±ºå®šæ´—é™¤æœŸé•·åº¦ï¼‰</li>
                <li><strong>Step 3:</strong> è¼¸å…¥ Visit 1 æ—¥æœŸï¼ˆç¯©é¸æ—¥æœŸï¼‰</li>
                <li><strong>Step 4:</strong> è¼¸å…¥ Visit 2 æ—¥æœŸï¼ˆåŸºç·šæ—¥æœŸï¼‰</li>
                <li><strong>Step 5:</strong> é¸æ“‡ Visit 1a æ—¥æœŸ</li>
                <li><strong>æ´—é™¤æœŸé•·åº¦ï¼š</strong>
                    <ul style="margin-top: 5px;">
                        <li>Prostaglandins / Î²-blockers / Kinase inhibitors: 28 å¤©</li>
                        <li>Adrenergic agonists: 14 å¤©</li>
                        <li>Muscarinic agonists / Carbonic anhydrase inhibitors: 7 å¤©</li>
                    </ul>
                </li>
                <li><strong>é—œéµå·®ç•°ï¼š</strong>
                    <ul style="margin-top: 5px;">
                        <li><strong>Naive:</strong> V1a å¯åœ¨ V1 å’Œ V2 ä¹‹é–“ä»»é¸ï¼ˆé€šå¸¸èˆ‡ V1 åŒå¤©ï¼‰</li>
                        <li><strong>Washout:</strong> V1a å¿…é ˆåœ¨ V2 å‰ 1-7 å¤©ï¼ˆDay -7 to -1ï¼‰</li>
                    </ul>
                </li>
                <li><strong>Naive:</strong> V1 åˆ° V2 éœ€è¦ 1-35 å¤©ï¼ŒV1 å’Œ V1a é€šå¸¸åŒä¸€å¤©</li>
                <li><strong>Washout:</strong> V1 åˆ° V2 æœ€å¤š 35 å¤©ï¼ŒV1 åˆ° V1a è‡³å°‘ = æœ€å°æ´—é™¤æœŸï¼ŒV1a åˆ° V2 éœ€ 1-7 å¤©</li>
                <li>âš ï¸ <strong>å³æ™‚æé†’ï¼š</strong>è¼¸å…¥æ—¥æœŸå¾Œç«‹å³æª¢æŸ¥é€±æœ«å’Œå°ç£åœ‹å®šå‡æ—¥ï¼ˆ2025-2027ï¼‰</li>
                <li>ğŸ¯ <strong>æ™ºèƒ½å»ºè­°ï¼š</strong>ç³»çµ±è‡ªå‹•æä¾›ã€Œé¿é–‹å‡æ—¥ã€æŒ‰éˆ•ï¼Œå¿«é€Ÿé¸æ“‡å·¥ä½œæ—¥</li>
            </ul>
        </div>
    </div>
    
    <script>
        // Working weekends (è£œç­æ—¥ - weekends that are working days)
        var workingWeekends = {
            '2025': [
                '01-04', // è£œ 1/28 (æ˜¥ç¯€èª¿æ•´)
                '02-08'  // è£œ 2/3 (æ˜¥ç¯€èª¿æ•´)
            ],
            '2026': [
                // 2026å¹´èµ·å°ç£å…¨é¢å–æ¶ˆè£œç­æ—¥åˆ¶åº¦
                // æ˜¥ç¯€é€£å‡9å¤©ï¼ˆ2/14å…­-2/22æ—¥ï¼‰ä¸éœ€è£œç­
            ],
            '2027': [
                '01-23', // è£œ 1/29 (æ˜¥ç¯€èª¿æ•´)
                '02-27'  // è£œ 3/1 (å’Œå¹³ç´€å¿µæ—¥èª¿æ•´)
            ]
        };
        
        var holidays = {
            '2025': {
                '01-01': 'å…ƒæ—¦',
                '01-28': 'æ˜¥ç¯€(é™¤å¤•)', '01-29': 'æ˜¥ç¯€(åˆä¸€)', '01-30': 'æ˜¥ç¯€(åˆäºŒ)',
                '01-31': 'æ˜¥ç¯€(åˆä¸‰)', '02-01': 'æ˜¥ç¯€(åˆå››)', '02-02': 'æ˜¥ç¯€(åˆäº”)', '02-03': 'æ˜¥ç¯€(åˆå…­)',
                '02-28': 'å’Œå¹³ç´€å¿µæ—¥',
                '04-03': 'å…’ç«¥ç¯€', '04-04': 'æ¸…æ˜ç¯€', '04-05': 'æ¸…æ˜ç¯€è£œå‡', '04-06': 'å…’ç«¥ç¯€è£œå‡',
                '05-01': 'å‹å‹•ç¯€',
                '05-31': 'ç«¯åˆç¯€', '06-02': 'ç«¯åˆç¯€è£œå‡',
                '10-06': 'ä¸­ç§‹ç¯€', '10-07': 'ä¸­ç§‹ç¯€è£œå‡',
                '10-10': 'åœ‹æ…¶æ—¥', '10-11': 'åœ‹æ…¶æ—¥è£œå‡',
                '12-25': 'è¡Œæ†²ç´€å¿µæ—¥'
            },
            '2026': {
                '01-01': 'å…ƒæ—¦',
                // æ˜¥ç¯€é€£å‡9å¤©ï¼ˆ2/14å…­-2/22æ—¥ï¼‰- 2026å¹´å…è£œç­
                '02-14': 'æ˜¥ç¯€é€£å‡', '02-15': 'æ˜¥ç¯€é€£å‡', '02-16': 'æ˜¥ç¯€(é™¤å¤•)', 
                '02-17': 'æ˜¥ç¯€(åˆä¸€)', '02-18': 'æ˜¥ç¯€(åˆäºŒ)', '02-19': 'æ˜¥ç¯€(åˆä¸‰)', 
                '02-20': 'æ˜¥ç¯€(åˆå››)', '02-21': 'æ˜¥ç¯€(åˆäº”)', '02-22': 'æ˜¥ç¯€é€£å‡',
                '02-27': 'å’Œå¹³ç´€å¿µæ—¥è£œå‡', '02-28': 'å’Œå¹³ç´€å¿µæ—¥',
                '03-01': 'å’Œå¹³ç´€å¿µæ—¥å‡',
                '04-03': 'å…’ç«¥ç¯€è£œå‡', '04-04': 'å…’ç«¥ç¯€', '04-05': 'æ¸…æ˜ç¯€', '04-06': 'æ¸…æ˜ç¯€è£œå‡',
                '05-01': 'å‹å‹•ç¯€', '05-02': 'å‹å‹•ç¯€è£œå‡', '05-03': 'å‹å‹•ç¯€è£œå‡',
                '06-19': 'ç«¯åˆç¯€', '06-20': 'ç«¯åˆç¯€å½ˆæ€§æ”¾å‡', '06-21': 'ç«¯åˆç¯€è£œå‡',
                '09-25': 'ä¸­ç§‹ç¯€è£œå‡', '09-26': 'ä¸­ç§‹ç¯€è£œå‡', '09-27': 'ä¸­ç§‹ç¯€', '09-28': 'ä¸­ç§‹ç¯€è£œå‡',
                '10-09': 'åœ‹æ…¶æ—¥å½ˆæ€§æ”¾å‡', '10-10': 'åœ‹æ…¶æ—¥', '10-11': 'åœ‹æ…¶æ—¥è£œå‡',
                '10-24': 'å…‰å¾©ç¯€è£œå‡', '10-25': 'å…‰å¾©ç¯€', '10-26': 'å…‰å¾©ç¯€è£œå‡',
                '12-25': 'è¡Œæ†²ç´€å¿µæ—¥', '12-26': 'è¡Œæ†²ç´€å¿µæ—¥è£œå‡', '12-27': 'è¡Œæ†²ç´€å¿µæ—¥è£œå‡'
            },
            '2027': {
                '01-01': 'å…ƒæ—¦', '01-02': 'å…ƒæ—¦è£œå‡', '01-03': 'å…ƒæ—¦è£œå‡',
                '02-04': 'æ˜¥ç¯€(å½ˆæ€§æ”¾å‡)', '02-05': 'æ˜¥ç¯€(é™¤å¤•)', '02-06': 'æ˜¥ç¯€(åˆä¸€)', 
                '02-07': 'æ˜¥ç¯€(åˆäºŒ)', '02-08': 'æ˜¥ç¯€(åˆä¸‰)', '02-09': 'æ˜¥ç¯€(åˆå››)', 
                '02-10': 'æ˜¥ç¯€(åˆäº”)',
                '02-27': 'å’Œå¹³ç´€å¿µæ—¥è£œå‡', '02-28': 'å’Œå¹³ç´€å¿µæ—¥',
                '03-01': 'å’Œå¹³ç´€å¿µæ—¥è£œå‡',
                '04-03': 'å…’ç«¥ç¯€è£œå‡', '04-04': 'å…’ç«¥ç¯€', '04-05': 'æ¸…æ˜ç¯€', '04-06': 'æ¸…æ˜ç¯€è£œå‡',
                '04-30': 'å‹å‹•ç¯€è£œå‡', '05-01': 'å‹å‹•ç¯€', '05-02': 'å‹å‹•ç¯€è£œå‡',
                '06-09': 'ç«¯åˆç¯€',
                '10-09': 'åœ‹æ…¶æ—¥è£œå‡', '10-10': 'åœ‹æ…¶æ—¥', '10-11': 'åœ‹æ…¶æ—¥è£œå‡',
                '10-23': 'å…‰å¾©ç¯€è£œå‡', '10-24': 'å…‰å¾©ç¯€', '10-25': 'å…‰å¾©ç¯€è£œå‡',
                '12-24': 'è¡Œæ†²ç´€å¿µæ—¥è£œå‡', '12-25': 'è¡Œæ†²ç´€å¿µæ—¥', '12-26': 'è¡Œæ†²ç´€å¿µæ—¥è£œå‡'
            }
        };
        
        var visit1aDate = '';
        var selectedV3 = null; // User selected Visit 3 date
        var selectedV4 = null; // User selected Visit 4 date
        var selectedV5 = null; // User selected Visit 5 date
        var updatedVisits = []; // Track which visits were updated by suggestions
        var oldV2 = null; // Track old V2 for comparison
        
        // Select a visit date (V3, V4, or V5)
        function selectVisitDate(visitNum, dateStr) {
            if (visitNum === 3) selectedV3 = dateStr;
            else if (visitNum === 4) selectedV4 = dateStr;
            else if (visitNum === 5) selectedV5 = dateStr;
            
            calculateVisits(); // Recalculate to update UI
            
            // Recheck for conflicts after selection with delay for rendering
            setTimeout(function() {
                checkAllVisitsHolidays();
            }, 100);
        }
        
        // Check if a date conflicts with other visits
        function checkDateConflict(dateStr, excludeVisit, allVisits) {
            var date = parseDate(dateStr);
            
            for (var i = 0; i < allVisits.length; i++) {
                var visit = allVisits[i];
                if (visit.name === excludeVisit) continue; // Skip the visit being checked
                
                if (visit.date && formatDate(parseDate(visit.date)) === dateStr) {
                    return visit.name; // Return conflicting visit name
                }
            }
            
            return null; // No conflict
        }
        
        // Generate date selector buttons for a visit
        function generateDateSelector(visitNum, centerDate, v2, allVisits) {
            var visitName = 'Visit ' + visitNum;
            var selectedDate = null;
            if (visitNum === 3) selectedDate = selectedV3;
            else if (visitNum === 4) selectedDate = selectedV4;
            else if (visitNum === 5) selectedDate = selectedV5;
            
            // Validate that selectedDate is within Â±2 days window
            if (selectedDate) {
                var selectedDateObj = parseDate(selectedDate);
                var daysDiff = getDaysDiff(centerDate, selectedDateObj);
                
                // If selected date is outside Â±2 window, clear it
                if (Math.abs(daysDiff) > 2) {
                    console.log('âš ï¸ ' + visitName + ' é¸æ“‡çš„æ—¥æœŸ ' + selectedDate + ' è¶…å‡ºå½ˆæ€§çª—å£ï¼Œæ¸…é™¤ä¸¦é‡æ–°è¨ˆç®—');
                    selectedDate = null;
                    if (visitNum === 3) selectedV3 = null;
                    else if (visitNum === 4) selectedV4 = null;
                    else if (visitNum === 5) selectedV5 = null;
                }
            }
            
            // If no selection, use center date (or nearest workday within Â±2 window)
            if (!selectedDate) {
                var suggestedDate = centerDate;
                
                // If center date is holiday, find nearest workday WITHIN Â±2 window
                if (checkHoliday(centerDate)) {
                    var foundWorkday = null;
                    
                    // Search within Â±2 days window
                    for (var offset = 1; offset <= 2; offset++) {
                        // Try forward first
                        var forwardDate = addDays(centerDate, offset);
                        if (!checkHoliday(forwardDate)) {
                            foundWorkday = forwardDate;
                            break;
                        }
                        
                        // Then try backward
                        var backwardDate = addDays(centerDate, -offset);
                        if (!checkHoliday(backwardDate)) {
                            foundWorkday = backwardDate;
                            break;
                        }
                    }
                    
                    // Only use found workday if it's within the window
                    if (foundWorkday) {
                        suggestedDate = foundWorkday;
                    }
                    // If no workday found in Â±2 window, keep centerDate (will be shown as disabled)
                }
                
                selectedDate = formatDate(suggestedDate);
                // Auto-select suggested date on first render
                if (visitNum === 3) selectedV3 = selectedDate;
                else if (visitNum === 4) selectedV4 = selectedDate;
                else if (visitNum === 5) selectedV5 = selectedDate;
            }
            
            var html = '<div class="date-selector">';
            html += '<div class="date-selector-label">é¸æ“‡è¨ªè¦–æ—¥æœŸï¼ˆÂ±2 å¤©å½ˆæ€§çª—å£ï¼‰</div>';
            html += '<div class="date-options">';
            
            // Track if all options are disabled
            var allDisabled = true;
            var optionsHtml = '';
            
            // Generate 5 options: -2, -1, 0, +1, +2
            for (var i = -2; i <= 2; i++) {
                var optionDate = addDays(centerDate, i);
                var optionDateStr = formatDate(optionDate);
                var isSelected = (optionDateStr === selectedDate);
                var conflict = checkDateConflict(optionDateStr, visitName, allVisits);
                var holiday = checkHoliday(optionDate);
                
                var btnClass = 'date-option';
                var isDisabled = false;
                
                if (isSelected) {
                    btnClass += ' selected';
                }
                
                // Holidays and conflicts are both disabled
                if (conflict || holiday) {
                    btnClass += ' disabled';
                    isDisabled = true;
                    if (conflict) btnClass += ' conflict';
                } else {
                    allDisabled = false; // Found at least one enabled option
                }
                
                var label = '';
                if (i === -2) label = 'å¾€å‰2å¤©';
                else if (i === -1) label = 'å¾€å‰1å¤©';
                else if (i === 0) label = 'å»ºè­°';
                else if (i === 1) label = 'å¾€å¾Œ1å¤©';
                else if (i === 2) label = 'å¾€å¾Œ2å¤©';
                
                optionsHtml += '<button class="' + btnClass + '"';
                if (!isDisabled) {
                    optionsHtml += ' onclick="selectVisitDate(' + visitNum + ', \'' + optionDateStr + '\')"';
                }
                optionsHtml += '>';
                optionsHtml += '<span class="date-option-date">' + formatDateShort(optionDate) + '</span>';
                optionsHtml += '<span class="date-option-label">' + label + '</span>';
                
                if (conflict) {
                    optionsHtml += '<span class="date-option-label" style="color: #dc2626;">âš ï¸ è¡çª</span>';
                } else if (holiday) {
                    optionsHtml += '<span class="date-option-label" style="color: #dc2626;">ğŸš« å‡æ—¥</span>';
                }
                optionsHtml += '</button>';
            }
            
            html += optionsHtml;
            html += '</div>';
            
            // If all options are disabled, suggest adjusting V2 or V1
            if (allDisabled) {
                var v1Input = document.getElementById('visit1').value;
                var v2Input = document.getElementById('visit2').value;
                var v1Date = parseDate(v1Input);
                var v2Date = parseDate(v2Input);
                
                // Find a better V2 date
                var suggestedV2 = findBetterV2Date(v2Date, visitNum);
                
                html += '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 8px;">';
                html += '<div style="font-weight: 600; font-size: 13px; color: #dc2626; margin-bottom: 6px;">âš ï¸ æ‰€æœ‰æ—¥æœŸéƒ½ç„¡æ³•é¸æ“‡</div>';
                
                if (suggestedV2) {
                    html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">å»ºè­°èª¿æ•´ Visit 2 æ—¥æœŸä»¥ç²å¾—å¯ç”¨é¸é …</div>';
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #92400e; margin-bottom: 6px;">ğŸ’¡ ç³»çµ±å»ºè­°ï¼š</div>';
                    html += '<div style="font-size: 13px; font-weight: 600; color: #1f2937;">å°‡ Visit 2 æ”¹ç‚ºï¼š<span style="color: #dc2626;">' + formatDate(suggestedV2) + '</span></div>';
                    html += '<button class="btn btn-primary" style="width: 100%; margin-top: 8px; background: #dc2626;" onclick="adjustV2Date(\'' + formatDate(suggestedV2) + '\')">';
                    html += 'âœ¨ æ¡ç”¨å»ºè­°ä¸¦é‡æ–°è¨ˆç®—';
                    html += '</button>';
                    html += '</div>';
                } else {
                    // If no suitable V2 adjustment found, suggest moving to nearest workday
                    var nearestV1 = findNearestWorkday(v1Date);
                    var nearestV2 = findNearestWorkday(v2Date);
                    
                    html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">åœ¨ Â±10 å¤©ç¯„åœå…§æ‰¾ä¸åˆ°åˆé©çš„ V2 èª¿æ•´</div>';
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #92400e; margin-bottom: 8px;">ğŸ’¡ å»ºè­°èª¿æ•´åˆ°æœ€è¿‘çš„å·¥ä½œæ—¥ï¼š</div>';
                    
                    // Suggest V1
                    if (nearestV1 && formatDate(nearestV1) !== formatDate(v1Date)) {
                        html += '<div style="margin-bottom: 8px;">';
                        html += '<div style="font-size: 12px; font-weight: 600; color: #1f2937; margin-bottom: 4px;">æ–¹æ¡ˆ Aï¼šèª¿æ•´ Visit 1</div>';
                        html += '<div style="font-size: 13px; color: #1f2937;">å¾ ' + formatDate(v1Date) + ' â†’ <span style="color: #dc2626; font-weight: 600;">' + formatDate(nearestV1) + '</span></div>';
                        html += '<button class="btn btn-primary" style="width: 100%; margin-top: 6px; background: #dc2626; font-size: 12px;" onclick="adjustV1Date(\'' + formatDate(nearestV1) + '\')">';
                        html += 'æ¡ç”¨æ–¹æ¡ˆ A';
                        html += '</button>';
                        html += '</div>';
                    }
                    
                    // Suggest V2
                    if (nearestV2 && formatDate(nearestV2) !== formatDate(v2Date)) {
                        html += '<div style="margin-bottom: 8px;">';
                        html += '<div style="font-size: 12px; font-weight: 600; color: #1f2937; margin-bottom: 4px;">æ–¹æ¡ˆ Bï¼šèª¿æ•´ Visit 2</div>';
                        html += '<div style="font-size: 13px; color: #1f2937;">å¾ ' + formatDate(v2Date) + ' â†’ <span style="color: #dc2626; font-weight: 600;">' + formatDate(nearestV2) + '</span></div>';
                        html += '<button class="btn btn-primary" style="width: 100%; margin-top: 6px; background: #dc2626; font-size: 12px;" onclick="adjustV2Date(\'' + formatDate(nearestV2) + '\')">';
                        html += 'æ¡ç”¨æ–¹æ¡ˆ B';
                        html += '</button>';
                        html += '</div>';
                    }
                    
                    if ((!nearestV1 || formatDate(nearestV1) === formatDate(v1Date)) && 
                        (!nearestV2 || formatDate(nearestV2) === formatDate(v2Date))) {
                        html += '<div style="font-size: 12px; color: #991b1b;">V1 å’Œ V2 å·²ç¶“æ˜¯æœ€è¿‘çš„å·¥ä½œæ—¥ï¼Œå»ºè­°é‡æ–°è¦åŠƒæ•´é«”æ’ç¨‹</div>';
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            
            return html;
        }
        
        // Find nearest workday from a given date (forward search)
        function findNearestWorkday(date) {
            var maxSearch = 30; // Search up to 30 days
            var testDate = new Date(date);
            
            for (var i = 0; i < maxSearch; i++) {
                if (i > 0) {
                    testDate = addDays(testDate, 1);
                }
                if (!checkHoliday(testDate)) {
                    return testDate;
                }
            }
            
            return null; // Could not find workday
        }
        
        // Find a better V2 date that allows valid options for this visit
        function findBetterV2Date(currentV2, visitNum) {
            var daysOffset;
            if (visitNum === 3) daysOffset = 7;
            else if (visitNum === 4) daysOffset = 14;
            else if (visitNum === 5) daysOffset = 28;
            
            // Get V1 and subject type to validate V1-V2 interval
            var v1Input = document.getElementById('visit1').value;
            var type = document.getElementById('subjectType').value;
            
            if (!v1Input || !type) {
                return null;
            }
            
            var v1 = parseDate(v1Input);
            var minDays = 1;
            var maxDays = 35;
            
            // Calculate minimum days based on subject type
            if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                if (!drugType) {
                    return null;
                }
                var washoutDays = parseInt(drugType);
                minDays = washoutDays + 1;
            }
            
            // Try adjusting V2 forward and backward
            var maxAdjust = 10; // Try up to 10 days adjustment
            
            for (var adjust = 1; adjust <= maxAdjust; adjust++) {
                // Try moving V2 forward
                var newV2Forward = addDays(currentV2, adjust);
                var v1_v2_forward = getDaysDiff(v1, newV2Forward);
                
                // Check V1-V2 interval validity
                if (v1_v2_forward >= minDays && v1_v2_forward <= maxDays) {
                    // CRITICAL: V2 itself must be a workday
                    if (!checkHoliday(newV2Forward) && hasValidOptions(newV2Forward, daysOffset)) {
                        return newV2Forward;
                    }
                }
                
                // Try moving V2 backward
                var newV2Backward = addDays(currentV2, -adjust);
                var v1_v2_backward = getDaysDiff(v1, newV2Backward);
                
                // Check V1-V2 interval validity
                if (v1_v2_backward >= minDays && v1_v2_backward <= maxDays) {
                    // CRITICAL: V2 itself must be a workday
                    if (!checkHoliday(newV2Backward) && hasValidOptions(newV2Backward, daysOffset)) {
                        return newV2Backward;
                    }
                }
            }
            
            return null; // Could not find better date within range
        }
        
        // Check if a V2 date would give valid options for a visit
        function hasValidOptions(v2Date, daysOffset) {
            var centerDate = addDays(v2Date, daysOffset);
            
            // Check if any date in the Â±2 range is valid (not holiday)
            for (var i = -2; i <= 2; i++) {
                var testDate = addDays(centerDate, i);
                if (!checkHoliday(testDate)) {
                    return true; // Found at least one non-holiday
                }
            }
            
            return false; // All dates are holidays
        }
        
        // Adjust V1 date and recalculate
        function adjustV1Date(newV1) {
            document.getElementById('visit1').value = newV1;
            
            // Clear previous selections
            visit1aDate = '';
            selectedV3 = null;
            selectedV4 = null;
            selectedV5 = null;
            
            // Mark that dates were auto-adjusted
            window.autoAdjustedV1 = true;
            window.autoAdjustedV2 = false;
            
            // Recalculate
            checkDateWarning('visit1');
            calculateV2Suggestion();
            document.getElementById('v1aSuggestion').innerHTML = '';
            document.getElementById('validation').innerHTML = '';
            document.getElementById('v2EarlyWarning').innerHTML = '';
            calculateVisits();
            
            // Recheck for conflicts with delay for rendering
            setTimeout(function() {
                checkAllVisitsHolidays();
            }, 100);
            
            // Auto-clear the markers after 5 seconds
            setTimeout(function() {
                window.autoAdjustedV1 = false;
                window.autoAdjustedV2 = false;
                calculateVisits();
            }, 5000);
        }
        
        // Adjust V2 date and recalculate
        function adjustV2Date(newV2) {
            document.getElementById('visit2').value = newV2;
            
            // Clear previous selections
            selectedV3 = null;
            selectedV4 = null;
            selectedV5 = null;
            
            // Mark that dates were auto-adjusted
            window.autoAdjustedV1 = false;
            window.autoAdjustedV2 = true;
            
            // Recalculate
            checkDateWarning('visit2');
            checkV2EarlyWarning();
            calculateV2Suggestion();
            validateDates();
            
            // Re-validate V1a if it exists
            if (visit1aDate) {
                validateV1a();
            }
            
            document.getElementById('v2EarlyWarning').innerHTML = '';
            calculateVisits();
            
            // Recheck for conflicts with delay for rendering
            setTimeout(function() {
                checkAllVisitsHolidays();
            }, 100);
            
            // Auto-clear the markers after 5 seconds
            setTimeout(function() {
                window.autoAdjustedV1 = false;
                window.autoAdjustedV2 = false;
                calculateVisits();
            }, 5000);
        }
        
        // Format date in short form (MM/DD)
        function formatDateShort(date) {
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            return month + '/' + day;
        }
        
        // Auto-adjust all visits to avoid holidays (one-click)
        function autoAvoidHolidays() {
            var v2Input = document.getElementById('visit2').value;
            if (!v2Input) {
                alert('è«‹å…ˆè¼¸å…¥ Visit 2 æ—¥æœŸ');
                return;
            }
            
            var v2 = parseDate(v2Input);
            var changed = false;
            
            // Visit 3: Day 8 (V2 + 7)
            var v3_center = addDays(v2, 7);
            if (checkHoliday(v3_center)) {
                var v3_workday = getNextWorkday(v3_center);
                // Make sure still in range (V2+5 to V2+9)
                if (v3_workday <= addDays(v2, 9)) {
                    selectedV3 = formatDate(v3_workday);
                    changed = true;
                }
            } else {
                selectedV3 = formatDate(v3_center);
            }
            
            // Visit 4: Day 15 (V2 + 14)
            var v4_center = addDays(v2, 14);
            if (checkHoliday(v4_center)) {
                var v4_workday = getNextWorkday(v4_center);
                // Make sure still in range (V2+12 to V2+16)
                if (v4_workday <= addDays(v2, 16)) {
                    selectedV4 = formatDate(v4_workday);
                    changed = true;
                }
            } else {
                selectedV4 = formatDate(v4_center);
            }
            
            // Visit 5: Day 29 (V2 + 28)
            var v5_center = addDays(v2, 28);
            if (checkHoliday(v5_center)) {
                var v5_workday = getNextWorkday(v5_center);
                // Make sure still in range (V2+26 to V2+30)
                if (v5_workday <= addDays(v2, 30)) {
                    selectedV5 = formatDate(v5_workday);
                    changed = true;
                }
            } else {
                selectedV5 = formatDate(v5_center);
            }
            
            calculateVisits(); // Recalculate to update UI
            
            // Recheck for conflicts after auto-adjustment with delay
            setTimeout(function() {
                checkAllVisitsHolidays();
            }, 100);
            
            if (changed) {
                alert('âœ… å·²è‡ªå‹•èª¿æ•´ Visit æ—¥æœŸé¿é–‹å‡æ—¥');
            } else {
                alert('âœ… æ‰€æœ‰ Visit æ—¥æœŸå·²æ˜¯å·¥ä½œæ—¥');
            }
        }
        
        function clearAll() {
            // Clear all form inputs
            document.getElementById('subjectType').value = '';
            document.getElementById('drugType').value = '';
            document.getElementById('visit1').value = '';
            document.getElementById('visit2').value = '';
            
            // Clear V1a date
            visit1aDate = '';
            
            // Clear selected visit dates
            selectedV3 = null;
            selectedV4 = null;
            selectedV5 = null;
            
            // Hide drug type selection
            document.getElementById('drugTypeGroup').style.display = 'none';
            
            // Clear all display areas
            document.getElementById('v2Suggestion').innerHTML = '';
            document.getElementById('validation').innerHTML = '';
            document.getElementById('v1aSuggestion').innerHTML = '';
            document.getElementById('output').innerHTML = '<div class="empty">è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ä»¥è¨ˆç®—è¨ªè¦–æ—¥æœŸ</div>';
            
            // Clear ALL warnings
            document.getElementById('visit1Warning').innerHTML = '';
            document.getElementById('visit2Warning').innerHTML = '';
            document.getElementById('v2EarlyWarning').innerHTML = '';
            document.getElementById('allVisitsHolidayWarning').innerHTML = '';
            
            // Clear auto-adjusted flags
            window.autoAdjustedV1 = false;
            window.autoAdjustedV2 = false;
            
            clearV1aValidation();
        }
        
        function checkDateWarning(inputId) {
            var warningDivId = inputId + 'Warning';
            var warningDiv = document.getElementById(warningDivId);
            
            if (!warningDiv) {
                return;
            }
            
            var dateValue = '';
            if (inputId === 'v1a') {
                dateValue = visit1aDate;
            } else {
                var inputElement = document.getElementById(inputId);
                if (!inputElement) {
                    return;
                }
                dateValue = inputElement.value;
            }
            
            if (!dateValue) {
                warningDiv.innerHTML = '';
                return;
            }
            
            var date = parseDate(dateValue);
            var holidayInfo = checkHoliday(date);
            
            if (holidayInfo) {
                warningDiv.innerHTML = '<div style="margin-top: 12px; padding: 16px; background: #fee2e2; border: 3px solid #dc2626; border-radius: 12px; text-align: center;">' +
                    '<div style="font-size: 24px; margin-bottom: 8px;">ğŸš«</div>' +
                    '<div style="font-size: 15px; font-weight: 700; color: #dc2626; margin-bottom: 8px;">' + holidayInfo.msg + '</div>' +
                    '<div style="font-size: 13px; color: #991b1b; font-weight: 600;">è¨ªè¦–å¿…é ˆåœ¨å·¥ä½œæ—¥é€²è¡Œï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ</div>' +
                    '</div>';
            } else {
                warningDiv.innerHTML = '';
            }
        }
        
        function toggleDrugSelection() {
            var type = document.getElementById('subjectType').value;
            var drugTypeGroup = document.getElementById('drugTypeGroup');
            
            if (type === 'washout') {
                drugTypeGroup.style.display = 'block';
            } else {
                drugTypeGroup.style.display = 'none';
                document.getElementById('drugType').value = '';
            }
            
            // Clear V1a date and suggestion when type changes
            visit1aDate = '';
            var v1aSuggDiv = document.getElementById('v1aSuggestion');
            if (v1aSuggDiv) {
                v1aSuggDiv.innerHTML = '';
            }
            
            calculateV2Suggestion();
        }
        
        function calculateV2Suggestion() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2SuggDiv = document.getElementById('v2Suggestion');
            
            if (!type || !v1Input) {
                v2SuggDiv.innerHTML = '';
                return;
            }
            
            var v1 = parseDate(v1Input);
            var html = '';
            
            if (type === 'naive') {
                // Naive: V2 should be 1-35 days after V1
                var v2_min = addDays(v1, 1);
                var v2_max = addDays(v1, 35);
                
                // Find all workdays in range
                var workdays = [];
                var currentDate = v2_min;
                while (currentDate <= v2_max) {
                    if (!checkHoliday(currentDate)) {
                        workdays.push(new Date(currentDate));
                    }
                    currentDate = addDays(currentDate, 1);
                }
                
                html = '<div style="margin-top: 12px; padding: 12px; background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 8px;">';
                html += '<div style="font-weight: 600; font-size: 13px; color: #1e40af; margin-bottom: 6px;">Visit 2 å»ºè­°</div>';
                html += '<div style="font-size: 12px; color: #3b82f6; margin-bottom: 8px;">å»ºè­°ç¯„åœï¼š' + formatDateWithWeekday(v2_min) + ' ~ ' + formatDateWithWeekday(v2_max);
                html += '<br>(V1 å¾Œ 1-35 å¤©ï¼ŒV1 åˆ° V2 æœ€å¤š 35 å¤©ï¼Œ<strong>å…± ' + workdays.length + ' å€‹å·¥ä½œæ—¥</strong>å¯é¸)</div>';
                
                if (workdays.length > 0) {
                    html += '<div class="btn-group" style="display: flex; flex-direction: column; gap: 8px;">';
                    
                    // If too many workdays, show first 3, smart pick, and last 3
                    if (workdays.length > 7) {
                        // Show first 3
                        for (var i = 0; i < 3; i++) {
                            var isPerfect = true;
                            var testV2 = workdays[i];
                            
                            // Quick check if this V2 is perfect
                            if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                isPerfect = false;
                            }
                            
                            var btnStyle = isPerfect ? '' : 'opacity: 0.7;';
                            html += '<button onclick="useV2Date(\'' + formatDate(workdays[i]) + '\')" class="btn btn-primary" style="' + btnStyle + '">' + formatDateWithWeekday(workdays[i]) + (isPerfect ? '' : ' âš ï¸') + '</button>';
                        }
                        
                        html += '<span style="padding: 8px;">...</span>';
                        
                        // Show last 3
                        for (var i = workdays.length - 3; i < workdays.length; i++) {
                            var isPerfect = true;
                            var testV2 = workdays[i];
                            
                            if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                isPerfect = false;
                            }
                            
                            var btnStyle = isPerfect ? '' : 'opacity: 0.7;';
                            html += '<button onclick="useV2Date(\'' + formatDate(workdays[i]) + '\')" class="btn btn-primary" style="' + btnStyle + '">' + formatDateWithWeekday(workdays[i]) + (isPerfect ? '' : ' âš ï¸') + '</button>';
                        }
                    } else {
                        // Show all workdays
                        for (var i = 0; i < workdays.length; i++) {
                            var isPerfect = true;
                            var testV2 = workdays[i];
                            
                            // Check if this V2 leads to perfect outcome
                            if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                isPerfect = false;
                            }
                            
                            var btnStyle = isPerfect ? 'background: #059669; border-color: #059669;' : 'opacity: 0.7;';
                            html += '<button onclick="useV2Date(\'' + formatDate(workdays[i]) + '\')" class="btn btn-primary" style="' + btnStyle + '">' + formatDateWithWeekday(workdays[i]) + (isPerfect ? ' âœ“' : ' âš ï¸') + '</button>';
                        }
                    }
                    
                    html += '</div>';
                    
                    // Add legend
                    html += '<div style="margin-top: 8px; font-size: 11px; color: #666;">';
                    html += 'âœ“ = å¾ŒçºŒè¨ªè¦–éƒ½å¯é¸ &nbsp;&nbsp; âš ï¸ = å¾ŒçºŒå¯èƒ½æœ‰è¡çª';
                    html += '</div>';
                    
                    // Build a map of workdays with their perfect status for calendar
                    var workdayPerfectMap = {};
                    for (var i = 0; i < workdays.length; i++) {
                        var testV2 = workdays[i];
                        var isPerfect = true;
                        
                        // Check if this V2 leads to perfect outcome
                        if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                            countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                            countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                            isPerfect = false;
                        }
                        
                        workdayPerfectMap[formatDate(testV2)] = isPerfect;
                    }
                    
                    // Add visual calendar for available dates
                    html += '<div style="margin-top: 12px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">';
                    html += '<div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">ğŸ“… å¯ç”¨æ—¥æœŸæ—¥æ›† (ç¶ è‰² = æ¨è–¦æ—¥æœŸ, é»ƒè‰² = å¯èƒ½è¡çª)</div>';
                    html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 10px;">';
                    
                    // Get date range for calendar (from v2_min to v2_max)
                    var calStartDate = new Date(v2_min);
                    calStartDate.setDate(calStartDate.getDate() - calStartDate.getDay()); // Start from Sunday
                    
                    var calEndDate = new Date(v2_max);
                    var endDay = calEndDate.getDay();
                    if (endDay !== 6) {
                        calEndDate.setDate(calEndDate.getDate() + (6 - endDay)); // End on Saturday
                    }
                    
                    // Add weekday headers
                    var weekdayHeaders = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                    for (var i = 0; i < 7; i++) {
                        html += '<div style="text-align: center; font-weight: 600; color: #9ca3af; padding: 4px;">' + weekdayHeaders[i] + '</div>';
                    }
                    
                    // Add date cells
                    var currentCalDate = new Date(calStartDate);
                    while (currentCalDate <= calEndDate) {
                        var dateStr = formatDate(currentCalDate);
                        var isInRange = currentCalDate >= v2_min && currentCalDate <= v2_max;
                        var isWorkday = workdayPerfectMap.hasOwnProperty(dateStr);
                        var isPerfectDate = workdayPerfectMap[dateStr] === true;
                        
                        var cellStyle = 'text-align: center; padding: 6px 4px; border-radius: 4px; ';
                        if (isWorkday) {
                            if (isPerfectDate) {
                                // Perfect date - green
                                cellStyle += 'background: #d1fae5; color: #065f46; font-weight: 600; cursor: pointer;';
                            } else {
                                // Workday but not perfect - yellow/orange
                                cellStyle += 'background: #fef3c7; color: #92400e; font-weight: 600; cursor: pointer;';
                            }
                        } else if (isInRange) {
                            cellStyle += 'background: #fee2e2; color: #991b1b;';
                        } else {
                            cellStyle += 'background: #f9fafb; color: #d1d5db;';
                        }
                        
                        var onclick = isWorkday ? ' onclick="useV2Date(\'' + dateStr + '\')"' : '';
                        html += '<div style="' + cellStyle + '"' + onclick + '>' + currentCalDate.getDate() + '</div>';
                        
                        currentCalDate.setDate(currentCalDate.getDate() + 1);
                    }
                    
                    html += '</div>';
                    html += '<div style="margin-top: 8px; font-size: 10px; color: #6b7280; display: flex; gap: 12px; flex-wrap: wrap;">';
                    html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #d1fae5; border-radius: 2px; margin-right: 4px;"></span>æ¨è–¦æ—¥æœŸ (âœ“)</span>';
                    html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #fef3c7; border-radius: 2px; margin-right: 4px;"></span>å¯èƒ½è¡çª (âš ï¸)</span>';
                    html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #fee2e2; border-radius: 2px; margin-right: 4px;"></span>å‡æ—¥/é€±æœ«</span>';
                    html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #f9fafb; border-radius: 2px; margin-right: 4px;"></span>ç¯„åœå¤–</span>';
                    html += '</div>';
                    html += '</div>';
                } else {
                    html += '<div style="margin-top: 12px; padding: 16px; background: #fee2e2; border: 3px solid #dc2626; border-radius: 12px; text-align: center;">';
                    html += '<div style="font-size: 24px; margin-bottom: 8px;">âš ï¸</div>';
                    html += '<div style="font-size: 15px; font-weight: 700; color: #dc2626;">å»ºè­°ç¯„åœå…§æ²’æœ‰å¯ç”¨çš„å·¥ä½œæ—¥</div>';
                    html += '</div>';
                }
                
                html += '</div>';
            } else if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                
                if (drugType) {
                    var washoutDays = parseInt(drugType);
                    var v2_min = addDays(v1, washoutDays + 1);
                    var v2_max = addDays(v1, Math.min(washoutDays + 7, 35)); // Maximum 35 days from V1
                    
                    // Find all workdays in range
                    var workdays = [];
                    var currentDate = v2_min;
                    while (currentDate <= v2_max) {
                        if (!checkHoliday(currentDate)) {
                            workdays.push(new Date(currentDate));
                        }
                        currentDate = addDays(currentDate, 1);
                    }
                    
                    // Filter workdays to only include those where V1a range has workdays
                    var validV2s = [];
                    for (var i = 0; i < workdays.length; i++) {
                        var testV2 = workdays[i];
                        
                        // Check if V1a range (V2-7 to V2-1) has any workdays
                        var v1a_early = addDays(testV2, -7);
                        var v1a_late = addDays(testV2, -1);
                        var hasV1aWorkday = false;
                        
                        var checkDate = v1a_early;
                        while (checkDate <= v1a_late) {
                            var washout_check = getDaysDiff(v1, checkDate);
                            if (washout_check >= washoutDays && !checkHoliday(checkDate)) {
                                hasV1aWorkday = true;
                                break;
                            }
                            checkDate = addDays(checkDate, 1);
                        }
                        
                        if (hasV1aWorkday) {
                            validV2s.push(testV2);
                        }
                    }
                    
                    html = '<div style="margin-top: 12px; padding: 12px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px;">';
                    html += '<div style="font-weight: 600; font-size: 13px; color: #92400e; margin-bottom: 6px;">Visit 2 å»ºè­°</div>';
                    html += '<div style="font-size: 12px; color: #92400e; margin-bottom: 8px;">å»ºè­°ç¯„åœï¼š' + formatDateWithWeekday(v2_min) + ' ~ ' + formatDateWithWeekday(v2_max);
                    html += '<br>(V1 å¾Œ ' + (washoutDays + 1) + '-' + Math.min(washoutDays + 7, 35) + ' å¤©ï¼Œ<strong>å…± ' + validV2s.length + ' å€‹å¯ç”¨æ—¥æœŸ</strong>)</div>';
                    
                    if (workdays.length > 0) {
                        
                        if (validV2s.length > 0) {
                            html += '<div class="btn-group" style="display: flex; flex-direction: column; gap: 8px;">';
                            
                            // If too many valid V2s, show first 3 and last 3
                            if (validV2s.length > 7) {
                                // Show first 3
                                for (var i = 0; i < 3; i++) {
                                    var isPerfect = true;
                                    var testV2 = validV2s[i];
                                    
                                    // Quick check if this V2 is perfect
                                    if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                        isPerfect = false;
                                    }
                                    
                                    var btnStyle = isPerfect ? '' : 'opacity: 0.7;';
                                    html += '<button onclick="useV2Date(\'' + formatDate(validV2s[i]) + '\')" class="btn btn-primary" style="' + btnStyle + '">' + formatDateWithWeekday(validV2s[i]) + (isPerfect ? '' : ' âš ï¸') + '</button>';
                                }
                                
                                html += '<span style="padding: 8px;">...</span>';
                                
                                // Show last 3
                                for (var i = validV2s.length - 3; i < validV2s.length; i++) {
                                    var isPerfect = true;
                                    var testV2 = validV2s[i];
                                    
                                    if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                        isPerfect = false;
                                    }
                                    
                                    var btnStyle = isPerfect ? '' : 'opacity: 0.7;';
                                    html += '<button onclick="useV2Date(\'' + formatDate(validV2s[i]) + '\')" class="btn btn-primary" style="' + btnStyle + '">' + formatDateWithWeekday(validV2s[i]) + (isPerfect ? '' : ' âš ï¸') + '</button>';
                                }
                            } else {
                                // Show all valid V2s
                                for (var i = 0; i < validV2s.length; i++) {
                                    var isPerfect = true;
                                    var testV2 = validV2s[i];
                                    
                                    // Check if this V2 leads to perfect outcome
                                    if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                        countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                        isPerfect = false;
                                    }
                                    
                                    var btnStyle = isPerfect ? 'background: #059669; border-color: #059669;' : 'opacity: 0.7;';
                                    html += '<button onclick="useV2Date(\'' + formatDate(validV2s[i]) + '\')" class="btn btn-primary" style="' + btnStyle + '">' + formatDateWithWeekday(validV2s[i]) + (isPerfect ? ' âœ“' : ' âš ï¸') + '</button>';
                                }
                            }
                            
                            html += '</div>';
                            
                            // Add legend
                            html += '<div style="margin-top: 8px; font-size: 11px; color: #666;">';
                            html += 'âœ“ = å¾ŒçºŒè¨ªè¦–éƒ½å¯é¸ &nbsp;&nbsp; âš ï¸ = å¾ŒçºŒå¯èƒ½æœ‰è¡çª';
                            html += '</div>';
                            
                            // Build a map of validV2s with their perfect status for calendar
                            var validV2PerfectMap = {};
                            for (var i = 0; i < validV2s.length; i++) {
                                var testV2 = validV2s[i];
                                var isPerfect = true;
                                
                                // Check if this V2 leads to perfect outcome
                                if (countWorkdaysInWindow(addDays(testV2, 7)) === 0 ||
                                    countWorkdaysInWindow(addDays(testV2, 14)) === 0 ||
                                    countWorkdaysInWindow(addDays(testV2, 28)) === 0) {
                                    isPerfect = false;
                                }
                                
                                validV2PerfectMap[formatDate(testV2)] = isPerfect;
                            }
                            
                            // Add visual calendar for available dates
                            html += '<div style="margin-top: 12px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">';
                            html += '<div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">ğŸ“… å¯ç”¨æ—¥æœŸæ—¥æ›† (ç¶ è‰² = æ¨è–¦æ—¥æœŸ, é»ƒè‰² = å¯èƒ½è¡çª)</div>';
                            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 10px;">';
                            
                            // Get date range for calendar (from v2_min to v2_max)
                            var calStartDate = new Date(v2_min);
                            calStartDate.setDate(calStartDate.getDate() - calStartDate.getDay()); // Start from Sunday
                            
                            var calEndDate = new Date(v2_max);
                            var endDay = calEndDate.getDay();
                            if (endDay !== 6) {
                                calEndDate.setDate(calEndDate.getDate() + (6 - endDay)); // End on Saturday
                            }
                            
                            // Add weekday headers
                            var weekdayHeaders = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                            for (var i = 0; i < 7; i++) {
                                html += '<div style="text-align: center; font-weight: 600; color: #9ca3af; padding: 4px;">' + weekdayHeaders[i] + '</div>';
                            }
                            
                            // Add date cells
                            var currentCalDate = new Date(calStartDate);
                            while (currentCalDate <= calEndDate) {
                                var dateStr = formatDate(currentCalDate);
                                var isInRange = currentCalDate >= v2_min && currentCalDate <= v2_max;
                                var isValidV2 = validV2PerfectMap.hasOwnProperty(dateStr);
                                var isPerfectDate = validV2PerfectMap[dateStr] === true;
                                
                                var cellStyle = 'text-align: center; padding: 6px 4px; border-radius: 4px; ';
                                if (isValidV2) {
                                    if (isPerfectDate) {
                                        // Perfect date - green
                                        cellStyle += 'background: #d1fae5; color: #065f46; font-weight: 600; cursor: pointer;';
                                    } else {
                                        // Valid but not perfect - yellow/orange
                                        cellStyle += 'background: #fef3c7; color: #92400e; font-weight: 600; cursor: pointer;';
                                    }
                                } else if (isInRange) {
                                    cellStyle += 'background: #fee2e2; color: #991b1b;';
                                } else {
                                    cellStyle += 'background: #f9fafb; color: #d1d5db;';
                                }
                                
                                var onclick = isValidV2 ? ' onclick="useV2Date(\'' + dateStr + '\')"' : '';
                                html += '<div style="' + cellStyle + '"' + onclick + '>' + currentCalDate.getDate() + '</div>';
                                
                                currentCalDate.setDate(currentCalDate.getDate() + 1);
                            }
                            
                            html += '</div>';
                            html += '<div style="margin-top: 8px; font-size: 10px; color: #6b7280; display: flex; gap: 12px; flex-wrap: wrap;">';
                            html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #d1fae5; border-radius: 2px; margin-right: 4px;"></span>æ¨è–¦æ—¥æœŸ (âœ“)</span>';
                            html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #fef3c7; border-radius: 2px; margin-right: 4px;"></span>å¯èƒ½è¡çª (âš ï¸)</span>';
                            html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #fee2e2; border-radius: 2px; margin-right: 4px;"></span>ä¸å¯é¸</span>';
                            html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #f9fafb; border-radius: 2px; margin-right: 4px;"></span>ç¯„åœå¤–</span>';
                            html += '</div>';
                            html += '</div>';
                        } else {
                            // No valid V2s - all would result in V1a having no workdays
                            html += '<div style="margin-top: 12px; padding: 16px; background: #fee2e2; border: 3px solid #dc2626; border-radius: 12px; text-align: center;">';
                            html += '<div style="font-size: 24px; margin-bottom: 8px;">âš ï¸</div>';
                            html += '<div style="font-size: 15px; font-weight: 700; color: #dc2626; margin-bottom: 8px;">ç„¡å¯ç”¨çš„ V2 æ—¥æœŸ</div>';
                            html += '<div style="font-size: 13px; color: #991b1b; font-weight: 600;">æ‰€æœ‰å€™é¸æ—¥æœŸéƒ½æœƒå°è‡´ V1a ç¯„åœå…§æ²’æœ‰å·¥ä½œæ—¥<br>è«‹èª¿æ•´ V1 åˆ°æ›´æ™šçš„æ—¥æœŸ</div>';
                            html += '</div>';
                        }
                    } else {
                        html += '<div style="margin-top: 12px; padding: 16px; background: #fee2e2; border: 3px solid #dc2626; border-radius: 12px; text-align: center;">';
                        html += '<div style="font-size: 24px; margin-bottom: 8px;">âš ï¸</div>';
                        html += '<div style="font-size: 15px; font-weight: 700; color: #dc2626;">å»ºè­°ç¯„åœå…§æ²’æœ‰å¯ç”¨çš„å·¥ä½œæ—¥</div>';
                        html += '</div>';
                    }
                    
                    html += '</div>';
                }
            }
            
            v2SuggDiv.innerHTML = html;
        }
        
        // Check all visits for holiday conflicts immediately after V1/V2 input
        function checkAllVisitsHolidays() {
            console.log('=== checkAllVisitsHolidays è¢«èª¿ç”¨ ===');
            
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var warningDiv = document.getElementById('allVisitsHolidayWarning');
            
            console.log('V1 è¼¸å…¥:', v1Input);
            console.log('V2 è¼¸å…¥:', v2Input);
            
            // Clear previous warning
            warningDiv.innerHTML = '';
            
            if (!v1Input || !v2Input) {
                console.log('âš ï¸ V1 æˆ– V2 æœªè¼¸å…¥ï¼Œæ¸…é™¤è­¦å‘Šä¸¦é€€å‡º');
                console.log('   éœ€è¦å…©è€…éƒ½è¼¸å…¥å¾Œæ‰æœƒé¡¯ç¤ºè­¦å‘Š');
                return;
            }
            
            console.log('âœ… V1 å’Œ V2 éƒ½å·²è¼¸å…¥ï¼Œé–‹å§‹æª¢æŸ¥...');
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            
            // Collect all problems
            var allProblems = [];
            
            // Check V1
            var v1Holiday = checkHoliday(v1);
            if (v1Holiday) {
                allProblems.push({ visit: 'Visit 1', date: formatDate(v1), reason: v1Holiday.msg, canAdjust: false });
            }
            
            // Check V2
            var v2Holiday = checkHoliday(v2);
            if (v2Holiday) {
                allProblems.push({ visit: 'Visit 2', date: formatDate(v2), reason: v2Holiday.msg, canAdjust: false });
            }
            
            // Check V1a (if exists and needed)
            // V1a can be selected by user, we'll check suggested date
            
            // Check Day 2
            var day2 = addDays(v2, 1);
            var day2Holiday = checkHoliday(day2);
            if (day2Holiday) {
                allProblems.push({ visit: 'Day 2', date: formatDate(day2), reason: day2Holiday.msg, canAdjust: false });
            }
            
            // Check Visit 3 (V2+7, with Â±2 flexibility)
            var v3_center = addDays(v2, 7);
            var v3Holiday = checkHoliday(v3_center);
            var v3HasOptions = hasValidOptionsInWindow(v3_center);
            if (v3Holiday || !v3HasOptions) {
                allProblems.push({ 
                    visit: 'Visit 3', 
                    date: formatDate(v3_center), 
                    reason: v3Holiday ? v3Holiday.msg : 'å½ˆæ€§çª—å£å…§å…¨æ˜¯å‡æ—¥',
                    canAdjust: v3HasOptions,
                    noOptions: !v3HasOptions
                });
            }
            
            // Check Visit 4 (V2+14, with Â±2 flexibility)
            var v4_center = addDays(v2, 14);
            var v4Holiday = checkHoliday(v4_center);
            var v4HasOptions = hasValidOptionsInWindow(v4_center);
            if (v4Holiday || !v4HasOptions) {
                allProblems.push({ 
                    visit: 'Visit 4', 
                    date: formatDate(v4_center), 
                    reason: v4Holiday ? v4Holiday.msg : 'å½ˆæ€§çª—å£å…§å…¨æ˜¯å‡æ—¥',
                    canAdjust: v4HasOptions,
                    noOptions: !v4HasOptions
                });
            }
            
            // Check Visit 5 (V2+28, with Â±2 flexibility)
            var v5_center = addDays(v2, 28);
            var v5Holiday = checkHoliday(v5_center);
            var v5HasOptions = hasValidOptionsInWindow(v5_center);
            if (v5Holiday || !v5HasOptions) {
                allProblems.push({ 
                    visit: 'Visit 5', 
                    date: formatDate(v5_center), 
                    reason: v5Holiday ? v5Holiday.msg : 'å½ˆæ€§çª—å£å…§å…¨æ˜¯å‡æ—¥',
                    canAdjust: v5HasOptions,
                    noOptions: !v5HasOptions
                });
            }
            
            // Check Visit 6 (first day of range V2+29)
            var v6_start = addDays(v2, 29);
            var v6Holiday = checkHoliday(v6_start);
            if (v6Holiday) {
                allProblems.push({ 
                    visit: 'Visit 6 (Day 29)', 
                    date: formatDate(v6_start), 
                    reason: v6Holiday.msg,
                    canAdjust: true
                });
            }
            
            console.log('ğŸ“‹ æª¢æŸ¥å®Œæˆï¼Œç™¼ç¾çš„å•é¡Œæ•¸é‡:', allProblems.length);
            if (allProblems.length > 0) {
                console.log('å•é¡Œè©³æƒ…:', allProblems);
            }
            
            // Display warnings and solutions if any problems found
            if (allProblems.length > 0) {
                console.log('ğŸš¨ é–‹å§‹ç”Ÿæˆè­¦å‘Š HTML...');
                
                var html = '';
                
                // Show problem summary
                html += '<div class="holiday-warning-box" style="padding: 20px; background: #fef2f2; border: 3px solid #dc2626; border-radius: 10px; margin: 20px 0; position: relative;">';
                html += '<button onclick="document.getElementById(\'allVisitsHolidayWarning\').innerHTML=\'\'" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; color: #dc2626; cursor: pointer; padding: 0; width: 30px; height: 30px; line-height: 30px; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background=\'rgba(220,38,38,0.1)\'" onmouseout="this.style.background=\'none\'">Ã—</button>';
                html += '<div style="text-align: center; font-weight: 700; font-size: 20px; color: #dc2626; margin-bottom: 15px; padding-right: 30px;">âš ï¸ ç™¼ç¾æ—¥æœŸè¡çª</div>';
                html += '<div style="text-align: center; font-size: 14px; color: #991b1b; margin-bottom: 15px;">ä»¥ä¸‹è¨ªè¦–çš„æ—¥æœŸé‡åˆ°å‡æ—¥æˆ–é€±æœ«</div>';
                
                // Problem table
                html += '<table style="width: 100%; font-size: 13px; border-collapse: collapse; margin-bottom: 15px; background: white;">';
                html += '<thead><tr style="background: #dc2626; color: white;">';
                html += '<th style="padding: 10px; text-align: center;">è¨ªè¦–</th>';
                html += '<th style="padding: 10px; text-align: center;">ç›®å‰æ—¥æœŸ</th>';
                html += '<th style="padding: 10px; text-align: center;">å•é¡Œ</th>';
                html += '<th style="padding: 10px; text-align: center;">ç‹€æ…‹</th>';
                html += '</tr></thead><tbody>';
                
                for (var i = 0; i < allProblems.length; i++) {
                    var p = allProblems[i];
                    html += '<tr style="background: #fff5f5; border-bottom: 2px solid #fee2e2;">';
                    html += '<td style="padding: 10px; text-align: center; font-weight: 600; color: #dc2626;">' + p.visit + '</td>';
                    html += '<td style="padding: 10px; text-align: center;">' + p.date + '</td>';
                    html += '<td style="padding: 10px; text-align: center; color: #dc2626;">' + p.reason + '</td>';
                    
                    if (p.noOptions) {
                        html += '<td style="padding: 10px; text-align: center; color: #dc2626; font-weight: 600; font-size: 12px;">â›” å½ˆæ€§çª—å£å…§ç„¡å¯ç”¨æ—¥æœŸ</td>';
                    } else if (p.canAdjust) {
                        html += '<td style="padding: 10px; text-align: center; color: #f59e0b; font-size: 12px;">âš ï¸ å¯åœ¨å½ˆæ€§çª—å£å…§èª¿æ•´</td>';
                    } else {
                        html += '<td style="padding: 10px; text-align: center; color: #dc2626; font-size: 12px;">âŒ å›ºå®šæ—¥æœŸ</td>';
                    }
                    html += '</tr>';
                }
                html += '</tbody></table>';
                
                // Find comprehensive solution
                console.log('ğŸ” å°‹æ‰¾å®Œæ•´è§£æ±ºæ–¹æ¡ˆ...');
                var comprehensiveSolution = findComprehensiveSolution(v1, v2, allProblems);
                
                if (comprehensiveSolution) {
                    console.log('âœ… æ‰¾åˆ°å®Œæ•´è§£æ±ºæ–¹æ¡ˆ:', comprehensiveSolution);
                    
                    // Display solution
                    html += '<div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border: 2px solid #10b981; margin-top: 15px;">';
                    html += '<div style="font-size: 15px; font-weight: 700; color: #065f46; margin-bottom: 10px;">ğŸ’¡ å®Œæ•´è§£æ±ºæ–¹æ¡ˆ</div>';
                    
                    if (comprehensiveSolution.needsV1Change) {
                        html += '<div style="font-size: 13px; color: #047857; margin-bottom: 10px;">';
                        html += 'å°‡ <strong>V1</strong> å¾ ' + formatDate(v1) + ' æ”¹ç‚º <strong>' + comprehensiveSolution.newV1 + '</strong><br>';
                        html += 'å°‡ <strong>V2</strong> å¾ ' + formatDate(v2) + ' æ”¹ç‚º <strong>' + comprehensiveSolution.newV2 + '</strong>';
                        html += '</div>';
                    } else {
                        html += '<div style="font-size: 13px; color: #047857; margin-bottom: 10px;">';
                        html += 'å°‡ <strong>V2</strong> å¾ ' + formatDate(v2) + ' æ”¹ç‚º <strong>' + comprehensiveSolution.newV2 + '</strong>';
                        html += '<br><span style="font-size: 12px;">ï¼ˆV1 ä¿æŒ ' + formatDate(v1) + ' ä¸è®Šï¼‰</span>';
                        html += '</div>';
                    }
                    
                    // Show what will be resolved
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 12px;">';
                    html += '<div style="font-weight: 600; color: #065f46; margin-bottom: 5px;">æ­¤æ–¹æ¡ˆå°‡ç¢ºä¿ï¼š</div>';
                    html += '<ul style="margin: 5px 0; padding-left: 20px; color: #047857;">';
                    html += '<li>æ‰€æœ‰è¨ªè¦–æ—¥æœŸéƒ½é¿é–‹å‡æ—¥å’Œé€±æœ«</li>';
                    html += '<li>æ‰€æœ‰å½ˆæ€§çª—å£å…§éƒ½æœ‰å¯ç”¨çš„å·¥ä½œæ—¥</li>';
                    html += '<li>ä¸æœƒç”¢ç”Ÿæ–°çš„æ—¥æœŸè¡çª</li>';
                    html += '</ul>';
                    html += '</div>';
                    
                    // Apply button
                    html += '<button onclick=\'applyComprehensiveSolution(' + JSON.stringify(comprehensiveSolution) + ')\' ';
                    html += 'style="width: 100%; padding: 14px; background: #10b981; color: white; border: none; border-radius: 8px; ';
                    html += 'font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);" ';
                    html += 'onmouseover="this.style.background=\'#059669\'; this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 8px rgba(16, 185, 129, 0.4)\'" ';
                    html += 'onmouseout="this.style.background=\'#10b981\'; this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 6px rgba(16, 185, 129, 0.3)\'">';
                    html += 'âœ¨ å¥—ç”¨å®Œæ•´è§£æ±ºæ–¹æ¡ˆ';
                    html += '</button>';
                    html += '</div>';
                } else {
                    console.log('âŒ ç„¡æ³•æ‰¾åˆ°å®Œæ•´è§£æ±ºæ–¹æ¡ˆ');
                    
                    // No automatic solution found
                    html += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 2px solid #f59e0b; margin-top: 15px;">';
                    html += '<div style="font-size: 15px; font-weight: 700; color: #92400e; margin-bottom: 10px;">âš ï¸ ç„¡æ³•è‡ªå‹•è§£æ±º</div>';
                    html += '<div style="font-size: 13px; color: #78350f; margin-bottom: 10px;">';
                    html += 'ç³»çµ±åœ¨åˆç†ç¯„åœå…§ï¼ˆV2 Â±14å¤©ï¼‰æ‰¾ä¸åˆ°èƒ½å®Œå…¨è§£æ±ºæ‰€æœ‰è¡çªçš„æ—¥æœŸã€‚';
                    html += '</div>';
                    html += '<div style="font-size: 12px; color: #78350f; background: white; padding: 10px; border-radius: 6px;">';
                    html += '<strong>å»ºè­°ï¼š</strong><br>';
                    html += 'â€¢ æ‰‹å‹•èª¿æ•´ V1 æˆ– V2 åˆ°é é›¢å‡æ—¥å¯†é›†æœŸ<br>';
                    html += 'â€¢ æˆ–åœ¨ä¸‹æ–¹è¨ªè¦–æ’ç¨‹ä¸­ä½¿ç”¨æ—¥æœŸé¸æ“‡å™¨é€å€‹èª¿æ•´';
                    html += '</div>';
                    html += '</div>';
                }
                
                html += '</div>'; // End main warning box
                
                console.log('ğŸ“ HTML å·²ç”Ÿæˆï¼Œé•·åº¦:', html.length, 'å­—å…ƒ');
                
                warningDiv.innerHTML = html;
                
                console.log('âœ… innerHTML å·²è¨­ç½®');
                console.log('è­¦å‘Šæ¡†å…§å®¹é•·åº¦:', warningDiv.innerHTML.length);
                
                // ä¸è‡ªåŠ¨æ»šåŠ¨ï¼Œè®©ç”¨æˆ·å¯ä»¥è‡ªç”±æŸ¥çœ‹é¡µé¢
                // setTimeout(function() {
                //     console.log('ğŸ“œ è‡ªå‹•æ»¾å‹•åˆ°è­¦å‘Šæ¡†');
                //     warningDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                // }, 200);
            } else {
                console.log('â„¹ï¸ æ²’æœ‰ç™¼ç¾ä»»ä½•å•é¡Œï¼Œæ¸…é™¤è­¦å‘Šæ¡†');
                warningDiv.innerHTML = '';
            }
        }
        
        // Find a comprehensive solution that solves ALL problems without creating new ones
        function findComprehensiveSolution(currentV1, currentV2, allProblems) {
            // Strategy 1: Try adjusting only V2 (keep V1)
            console.log('å˜—è©¦ç­–ç•¥ 1ï¼šåªèª¿æ•´ V2');
            for (var offset = 1; offset <= 14; offset++) {
                // Try forward
                var testV2 = addDays(currentV2, offset);
                if (isCompletelyValidV2(testV2)) {
                    return {
                        needsV1Change: false,
                        newV1: formatDate(currentV1),
                        newV2: formatDate(testV2)
                    };
                }
                
                // Try backward
                testV2 = addDays(currentV2, -offset);
                if (isCompletelyValidV2(testV2)) {
                    return {
                        needsV1Change: false,
                        newV1: formatDate(currentV1),
                        newV2: formatDate(testV2)
                    };
                }
            }
            
            // Strategy 2: Try adjusting both V1 and V2
            console.log('å˜—è©¦ç­–ç•¥ 2ï¼šåŒæ™‚èª¿æ•´ V1 å’Œ V2');
            for (var v1Offset = 1; v1Offset <= 7; v1Offset++) {
                var testV1 = addDays(currentV1, v1Offset);
                
                // V1 must be a workday
                if (checkHoliday(testV1)) continue;
                
                // Try different V2 dates for this V1
                for (var v2Offset = 1; v2Offset <= 35; v2Offset++) {
                    var testV2 = addDays(testV1, v2Offset);
                    
                    // Check if this V2 is valid and solves everything
                    if (isCompletelyValidV2(testV2)) {
                        return {
                            needsV1Change: true,
                            newV1: formatDate(testV1),
                            newV2: formatDate(testV2)
                        };
                    }
                }
            }
            
            return null; // No solution found
        }
        
        // Check if a V2 date results in NO conflicts for any visit
        function isCompletelyValidV2(v2Date) {
            // First, check if V1-V2 interval meets subject type requirements
            var v1Input = document.getElementById('visit1').value;
            var type = document.getElementById('subjectType').value;
            
            if (!v1Input || !type) {
                return false;
            }
            
            var v1 = parseDate(v1Input);
            var v1_v2_days = getDaysDiff(v1, v2Date);
            
            // Validate V1-V2 interval based on subject type
            if (type === 'naive') {
                // Naive: 1-35 days
                if (v1_v2_days < 1 || v1_v2_days > 35) {
                    return false;
                }
            } else if (type === 'washout') {
                // Washout: washoutDays+1 to 35 days
                var drugType = document.getElementById('drugType').value;
                if (!drugType) {
                    return false;
                }
                var washoutDays = parseInt(drugType);
                var minDays = washoutDays + 1;
                
                if (v1_v2_days < minDays || v1_v2_days > 35) {
                    console.log('V2å€™é¸æ—¥æœŸä¸ç¬¦åˆWashoutè¦æ±‚:', formatDate(v2Date), 'V1-V2é–“éš”:', v1_v2_days, 'å¤©ï¼Œéœ€è¦:', minDays, '-35å¤©');
                    return false;
                }
            }
            
            // V2 itself must be a workday
            if (checkHoliday(v2Date)) {
                return false;
            }
            
            // Day 2 (V2+1) must be a workday
            var day2 = addDays(v2Date, 1);
            if (checkHoliday(day2)) {
                return false;
            }
            
            // Visit 3 (V2+7 Â±2) must have at least one workday in window
            var v3_center = addDays(v2Date, 7);
            if (!hasValidOptionsInWindow(v3_center)) {
                return false;
            }
            // And the best date in V3 window must be a workday
            var v3_best = findBestDateInWindow(v3_center);
            if (!v3_best || checkHoliday(v3_best)) {
                return false;
            }
            
            // Visit 4 (V2+14 Â±2) must have at least one workday in window
            var v4_center = addDays(v2Date, 14);
            if (!hasValidOptionsInWindow(v4_center)) {
                return false;
            }
            var v4_best = findBestDateInWindow(v4_center);
            if (!v4_best || checkHoliday(v4_best)) {
                return false;
            }
            
            // Visit 5 (V2+28 Â±2) must have at least one workday in window
            var v5_center = addDays(v2Date, 28);
            if (!hasValidOptionsInWindow(v5_center)) {
                return false;
            }
            var v5_best = findBestDateInWindow(v5_center);
            if (!v5_best || checkHoliday(v5_best)) {
                return false;
            }
            
            // Visit 6 (first day V2+29) should ideally be a workday
            var v6_start = addDays(v2Date, 29);
            // V6 is less critical but check if there's a workday in first few days
            var v6HasWorkday = false;
            for (var i = 0; i < 3; i++) {
                if (!checkHoliday(addDays(v6_start, i))) {
                    v6HasWorkday = true;
                    break;
                }
            }
            if (!v6HasWorkday) {
                return false;
            }
            
            return true; // All checks passed
        }
        
        // Apply comprehensive solution
        function applyComprehensiveSolution(solution) {
            var confirmMsg = 'æ­¤æ“ä½œå°‡ï¼š\n\n';
            if (solution.needsV1Change) {
                confirmMsg += 'V1: ' + document.getElementById('visit1').value + ' â†’ ' + solution.newV1 + '\n';
            }
            confirmMsg += 'V2: ' + document.getElementById('visit2').value + ' â†’ ' + solution.newV2 + '\n\n';
            confirmMsg += 'æ‰€æœ‰è¨ªè¦–æ—¥æœŸå°‡é‡æ–°è¨ˆç®—ï¼Œç¢ºä¿æ²’æœ‰å‡æ—¥è¡çªã€‚\n\nç¢ºå®šè¦å¥—ç”¨å—ï¼Ÿ';
            
            if (confirm(confirmMsg)) {
                console.log('âœ… ç”¨æˆ¶ç¢ºèªå¥—ç”¨å®Œæ•´è§£æ±ºæ–¹æ¡ˆ');
                
                if (solution.needsV1Change) {
                    document.getElementById('visit1').value = solution.newV1;
                }
                document.getElementById('visit2').value = solution.newV2;
                
                // Clear all selections
                selectedV3 = null;
                selectedV4 = null;
                selectedV5 = null;
                
                // Recalculate everything
                validateDates();
                
                // Clear warning
                document.getElementById('allVisitsHolidayWarning').innerHTML = '';
                
                // Recheck after a delay
                setTimeout(function() {
                    checkAllVisitsHolidays();
                    if (document.getElementById('allVisitsHolidayWarning').innerHTML === '') {
                        alert('âœ… å®Œæˆï¼æ‰€æœ‰æ—¥æœŸè¡çªå·²è§£æ±ºã€‚\n\nè«‹æª¢æŸ¥ä¸‹æ–¹çš„è¨ªè¦–æ’ç¨‹ã€‚');
                    }
                }, 500);
            }
        }
        
        // Quick fix functions for buttons in warning table
        
        
        
        // Add CSS animation for pulse effect
        var style = document.createElement('style');
        style.textContent = '@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }';
        document.head.appendChild(style);
        
        // Wrapper function to trigger V2 adjustment from warning
        function showV2AdjustmentOptionsFromWarning() {
            // Scroll to V2 input area first
            document.getElementById('visit2').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Trigger the existing V2 early warning check after a delay
            setTimeout(function() {
                checkV2EarlyWarning();
            }, 500);
        }
        
        // Auto-fill V2 with suggested date and show adjustment options
        function showEarlyAdjustmentSuggestion(suggestedV2) {
            // Parse the suggested date
            var v2Date = parseDate(suggestedV2);
            
            // Get V1 and calculate minimum required interval
            var v1Input = document.getElementById('visit1').value;
            var type = document.getElementById('subjectType').value;
            var minDays = 1;
            
            if (v1Input && type) {
                var v1 = parseDate(v1Input);
                
                if (type === 'washout') {
                    var drugType = document.getElementById('drugType').value;
                    if (drugType) {
                        var washoutDays = parseInt(drugType);
                        minDays = washoutDays + 1;
                    }
                }
                
                // If suggested date is a holiday, find next workday
                if (checkHoliday(v2Date)) {
                    var nextWorkday = getNextWorkday(v2Date);
                    if (nextWorkday) {
                        v2Date = nextWorkday;
                    }
                }
                
                // Ensure V2 meets minimum interval requirement
                var v1_v2_days = getDaysDiff(v1, v2Date);
                if (v1_v2_days < minDays) {
                    // Calculate minimum valid V2
                    v2Date = addDays(v1, minDays);
                    
                    // If minimum V2 is a holiday, find next workday
                    if (checkHoliday(v2Date)) {
                        var nextWorkday = getNextWorkday(v2Date);
                        if (nextWorkday) {
                            v2Date = nextWorkday;
                        }
                    }
                }
                
                suggestedV2 = formatDate(v2Date);
            }
            
            // Fill in V2 date
            document.getElementById('visit2').value = suggestedV2;
            
            // Trigger validations
            checkDateWarning('visit2');
            checkV2EarlyWarning();
            validateDates();
            
            // Scroll to warning area
            setTimeout(function() {
                var warningDiv = document.getElementById('v2EarlyWarning');
                if (warningDiv && warningDiv.innerHTML) {
                    warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300);
        }
        
        // Early warning check after V2 is entered
        function checkV2EarlyWarning() {
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var warningDiv = document.getElementById('v2EarlyWarning');
            
            // Clear previous warning
            warningDiv.innerHTML = '';
            
            if (!v1Input || !v2Input) {
                return;
            }
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            
            // Get subject type and calculate minimum V1-V2 interval
            var type = document.getElementById('subjectType').value;
            var minDays = 1;
            var maxDays = 35;
            
            if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                if (drugType) {
                    var washoutDays = parseInt(drugType);
                    minDays = washoutDays + 1;
                }
            }
            
            // FIRST: Check V1-V2 interval
            var v1_v2_days = getDaysDiff(v1, v2);
            
            if (v1_v2_days < minDays || v1_v2_days > maxDays) {
                var html = '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 8px;">';
                html += '<div style="font-weight: 600; font-size: 14px; color: #dc2626; margin-bottom: 6px;">âš ï¸ V1 åˆ° V2 é–“éš”ä¸ç¬¦åˆè¦æ±‚</div>';
                
                if (v1_v2_days < minDays) {
                    if (type === 'washout') {
                        var drugType = document.getElementById('drugType').value;
                        var washoutDays = parseInt(drugType);
                        html += '<div style="font-size: 13px; color: #991b1b; margin-bottom: 10px;">ç›®å‰é–“éš”ï¼š' + v1_v2_days + ' å¤©<br>';
                        html += 'éœ€è¦è‡³å°‘ï¼š' + minDays + ' å¤©ï¼ˆ' + washoutDays + ' å¤©æ´—é™¤æœŸ + 1 å¤©ï¼‰</div>';
                    } else {
                        html += '<div style="font-size: 13px; color: #991b1b; margin-bottom: 10px;">ç›®å‰é–“éš”ï¼š' + v1_v2_days + ' å¤©<br>';
                        html += 'éœ€è¦è‡³å°‘ï¼š1 å¤©</div>';
                    }
                    
                    // Suggest new V2
                    var suggestedV2 = addDays(v1, minDays);
                    if (checkHoliday(suggestedV2)) {
                        var nextWorkday = getNextWorkday(suggestedV2);
                        if (nextWorkday && getDaysDiff(v1, nextWorkday) <= maxDays) {
                            suggestedV2 = nextWorkday;
                        }
                    }
                    
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #92400e; margin-bottom: 6px;">ğŸ’¡ ç³»çµ±å»ºè­°ï¼š</div>';
                    html += '<div style="font-size: 13px; color: #1f2937;">å°‡ Visit 2 æ”¹ç‚ºï¼š<span style="color: #dc2626; font-weight: 600;">' + formatDate(suggestedV2) + '</span></div>';
                    html += '<button onclick="adjustV2Date(\'' + formatDate(suggestedV2) + '\')" class="btn btn-primary" style="width: 100%; margin-top: 8px; background: #dc2626;">';
                    html += 'âœ¨ æ¡ç”¨å»ºè­°ä¸¦é‡æ–°è¨ˆç®—';
                    html += '</button>';
                    html += '</div>';
                } else {
                    html += '<div style="font-size: 13px; color: #991b1b; margin-bottom: 10px;">ç›®å‰é–“éš”ï¼š' + v1_v2_days + ' å¤©<br>';
                    html += 'æœ€å¤šå…è¨±ï¼š35 å¤©</div>';
                }
                
                html += '</div>';
                warningDiv.innerHTML = html;
                return; // Stop here
            }
            
            // SECOND: Check if V2 itself is a holiday/weekend
            var v2Holiday = checkHoliday(v2);
            if (v2Holiday) {
                var html = '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 8px;">';
                html += '<div style="font-weight: 600; font-size: 14px; color: #dc2626; margin-bottom: 6px;">âš ï¸ Visit 2 æ—¥æœŸä¸å¯ç”¨</div>';
                html += '<div style="font-size: 13px; color: #991b1b; margin-bottom: 10px;">' + v2Holiday.msg + '</div>';
                html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">Visit 2 å¿…é ˆåœ¨å·¥ä½œæ—¥é€²è¡Œ</div>';
                
                // Find next workday for V2 that meets minimum interval requirement
                var nextV2 = getNextWorkday(v2);
                
                // Validate that nextV2 meets V1-V2 interval requirements
                if (nextV2) {
                    var v1_nextV2_days = getDaysDiff(v1, nextV2);
                    
                    // If nextV2 doesn't meet minimum interval, find a date that does
                    if (v1_nextV2_days < minDays) {
                        // Calculate the minimum valid V2 date
                        var minV2Date = addDays(v1, minDays);
                        
                        // Find next workday from minV2Date
                        if (checkHoliday(minV2Date)) {
                            nextV2 = getNextWorkday(minV2Date);
                        } else {
                            nextV2 = minV2Date;
                        }
                    }
                    
                    // Also check if nextV2 is within 35 days limit
                    if (nextV2) {
                        v1_nextV2_days = getDaysDiff(v1, nextV2);
                        if (v1_nextV2_days > maxDays) {
                            nextV2 = null; // Too far, can't suggest
                        }
                    }
                }
                
                if (nextV2) {
                    html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #92400e; margin-bottom: 6px;">ğŸ’¡ ç³»çµ±å»ºè­°ï¼š</div>';
                    html += '<div style="font-size: 13px; color: #1f2937;">å°‡ Visit 2 æ”¹ç‚ºï¼š<span style="color: #dc2626; font-weight: 600;">' + formatDate(nextV2) + '</span></div>';
                    html += '<button onclick="adjustV2Date(\'' + formatDate(nextV2) + '\')" class="btn btn-primary" style="width: 100%; margin-top: 8px; background: #dc2626;">';
                    html += 'âœ¨ æ¡ç”¨å»ºè­°ä¸¦é‡æ–°è¨ˆç®—';
                    html += '</button>';
                    html += '</div>';
                } else {
                    html += '<div style="font-size: 12px; color: #991b1b; margin-top: 10px;">âš ï¸ ç„¡æ³•æ‰¾åˆ°ç¬¦åˆæ´—é™¤æœŸè¦æ±‚çš„æ›¿ä»£æ—¥æœŸ</div>';
                }
                
                html += '</div>';
                warningDiv.innerHTML = html;
                return; // Stop here, don't check further visits
            }
            
            // THIRD: Check if any of Visit 3, 4, 5 will have problems
            var problems = [];
            
            // Visit 3: Day 8 (V2 + 7)
            var v3_center = addDays(v2, 7);
            if (!hasValidOptionsInWindow(v3_center)) {
                problems.push({ visit: 'Visit 3', center: v3_center, day: 8 });
            }
            
            // Visit 4: Day 15 (V2 + 14)
            var v4_center = addDays(v2, 14);
            if (!hasValidOptionsInWindow(v4_center)) {
                problems.push({ visit: 'Visit 4', center: v4_center, day: 15 });
            }
            
            // Visit 5: Day 29 (V2 + 28)
            var v5_center = addDays(v2, 28);
            if (!hasValidOptionsInWindow(v5_center)) {
                problems.push({ visit: 'Visit 5', center: v5_center, day: 29 });
            }
            
            if (problems.length > 0) {
                var html = '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 8px;">';
                html += '<div style="font-weight: 600; font-size: 14px; color: #dc2626; margin-bottom: 6px;">âš ï¸ å¾ŒçºŒè¨ªè¦–æ—¥æœŸéƒ½ç„¡æ³•é¸æ“‡</div>';
                html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">å»ºè­°èª¿æ•´ Visit 2 æ—¥æœŸä»¥ç²å¾—å¯ç”¨é¸é …</div>';
                
                html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 8px;">ä»¥ä¸‹ Visit çš„å½ˆæ€§çª—å£å…§æ²’æœ‰å¯ç”¨æ—¥æœŸï¼š</div>';
                html += '<ul style="margin: 0 0 10px 20px; padding: 0; font-size: 12px; color: #991b1b;">';
                for (var i = 0; i < problems.length; i++) {
                    var p = problems[i];
                    var rangeStart = addDays(p.center, -2);
                    var rangeEnd = addDays(p.center, 2);
                    html += '<li style="margin-bottom: 4px;">' + p.visit + ' (Day ' + p.day + 'Â±2): ' + formatDate(rangeStart) + ' ~ ' + formatDate(rangeEnd) + '</li>';
                }
                html += '</ul>';
                
                html += '<button onclick="showV2AdjustmentOptions()" class="btn btn-primary" style="width: 100%; background: #dc2626; font-weight: 600;">';
                html += 'ğŸ’¡ æŸ¥çœ‹èª¿æ•´å»ºè­°';
                html += '</button>';
                
                html += '</div>';
                
                warningDiv.innerHTML = html;
            }
        }
        
        // Check if a date's Â±2 window has any valid options
        function hasValidOptionsInWindow(centerDate) {
            for (var i = -2; i <= 2; i++) {
                var testDate = addDays(centerDate, i);
                if (!checkHoliday(testDate)) {
                    return true; // Found at least one workday
                }
            }
            return false; // All dates are holidays/weekends
        }
        
        // Count how many workdays are available in a Â±2 window
        function countWorkdaysInWindow(centerDate) {
            var count = 0;
            for (var i = -2; i <= 2; i++) {
                var testDate = addDays(centerDate, i);
                if (!checkHoliday(testDate)) {
                    count++;
                }
            }
            return count;
        }
        
        // Show V2 adjustment options (prioritize V1 unchanged, then V1 changed)
        function showV2AdjustmentOptions() {
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var warningDiv = document.getElementById('v2EarlyWarning');
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            
            var html = '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 8px;">';
            html += '<div style="font-weight: 600; font-size: 14px; color: #dc2626; margin-bottom: 6px;">âš ï¸ æ‰€æœ‰æ—¥æœŸéƒ½ç„¡æ³•é¸æ“‡</div>';
            html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">å»ºè­°èª¿æ•´ Visit 2 æ—¥æœŸä»¥ç²å¾—å¯ç”¨é¸é …</div>';
            
            // Priority 1: Keep V1, adjust V2
            var betterV2 = findBetterV2KeepingV1(v2);
            
            if (betterV2) {
                html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px;">';
                html += '<div style="font-size: 13px; font-weight: 600; color: #1f2937; margin-bottom: 6px;">ğŸ’¡ ç³»çµ±å»ºè­°ï¼š</div>';
                html += '<div style="font-size: 12px; color: #1f2937; margin-bottom: 8px;">å°‡ Visit 2 æ”¹ç‚ºï¼š<span style="color: #dc2626; font-weight: 600;">' + formatDate(betterV2) + '</span></div>';
                html += '<button onclick="adjustV2Date(\'' + formatDate(betterV2) + '\')" class="btn btn-primary" style="width: 100%; background: #dc2626;">';
                html += 'âœ¨ æ¡ç”¨å»ºè­°ä¸¦é‡æ–°è¨ˆç®—';
                html += '</button>';
                html += '</div>';
            } else {
                // Priority 2: Adjust both V1 and V2
                var betterV1 = findNearestWorkday(v1);
                var betterV2ForNewV1 = betterV1 ? findBetterV2KeepingV1(addDays(betterV1, 1)) : null;
                
                html += '<div style="font-size: 12px; color: #991b1b; margin-bottom: 10px;">åœ¨ Â±10 å¤©ç¯„åœå…§æ‰¾ä¸åˆ°åˆé©çš„ V2 èª¿æ•´</div>';
                html += '<div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px;">';
                html += '<div style="font-size: 12px; color: #92400e; margin-bottom: 8px;">ğŸ’¡ å»ºè­°èª¿æ•´ V1 å’Œ V2ï¼š</div>';
                
                if (betterV1 && betterV2ForNewV1) {
                    html += '<div style="margin-bottom: 8px;">';
                    html += '<div style="font-size: 12px; color: #1f2937; margin-bottom: 4px;">å¾ï¼š</div>';
                    html += '<div style="font-size: 13px; color: #666;">V1 = ' + formatDate(v1) + '</div>';
                    html += '<div style="font-size: 13px; color: #666;">V2 = ' + formatDate(v2) + '</div>';
                    html += '<div style="font-size: 12px; color: #1f2937; margin: 8px 0 4px 0;">æ”¹ç‚ºï¼š</div>';
                    html += '<div style="font-size: 13px; color: #dc2626; font-weight: 600;">V1 = ' + formatDate(betterV1) + '</div>';
                    html += '<div style="font-size: 13px; color: #dc2626; font-weight: 600;">V2 = ' + formatDate(betterV2ForNewV1) + '</div>';
                    html += '<button onclick="adjustBothV1V2(\'' + formatDate(betterV1) + '\', \'' + formatDate(betterV2ForNewV1) + '\')" class="btn btn-primary" style="width: 100%; margin-top: 8px; background: #dc2626;">';
                    html += 'âœ¨ æ¡ç”¨å»ºè­°ä¸¦é‡æ–°è¨ˆç®—';
                    html += '</button>';
                    html += '</div>';
                } else {
                    html += '<div style="font-size: 12px; color: #991b1b;">ç„¡æ³•æ‰¾åˆ°åˆé©çš„èª¿æ•´ï¼Œå»ºè­°é‡æ–°è¦åŠƒæ•´é«”æ’ç¨‹</div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            warningDiv.innerHTML = html;
        }
        
        // Find better V2 while keeping V1 unchanged
        function findBetterV2KeepingV1(currentV2) {
            var v1Input = document.getElementById('visit1').value;
            var type = document.getElementById('subjectType').value;
            
            if (!v1Input || !type) {
                return null;
            }
            
            var v1 = parseDate(v1Input);
            var minDays = 1;
            var maxDays = 35;
            
            // Calculate minimum days based on subject type
            if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                if (!drugType) {
                    return null;
                }
                var washoutDays = parseInt(drugType);
                minDays = washoutDays + 1;
            }
            
            var maxAdjust = 10;
            
            for (var adjust = 1; adjust <= maxAdjust; adjust++) {
                // Try forward
                var newV2 = addDays(currentV2, adjust);
                var v1_v2_forward = getDaysDiff(v1, newV2);
                
                // Check V1-V2 interval validity
                if (v1_v2_forward >= minDays && v1_v2_forward <= maxDays) {
                    if (!checkHoliday(newV2) && canSolveAllVisitProblems(newV2)) {
                        return newV2;
                    }
                }
                
                // Try backward
                newV2 = addDays(currentV2, -adjust);
                var v1_v2_backward = getDaysDiff(v1, newV2);
                
                // Check V1-V2 interval validity
                if (v1_v2_backward >= minDays && v1_v2_backward <= maxDays) {
                    if (!checkHoliday(newV2) && canSolveAllVisitProblems(newV2)) {
                        return newV2;
                    }
                }
            }
            
            return null;
        }
        
        // Check if a V2 date solves all visit problems
        function canSolveAllVisitProblems(v2Date) {
            // First check V1-V2 interval
            var v1Input = document.getElementById('visit1').value;
            var type = document.getElementById('subjectType').value;
            
            if (v1Input && type) {
                var v1 = parseDate(v1Input);
                var v1_v2_days = getDaysDiff(v1, v2Date);
                var minDays = 1;
                var maxDays = 35;
                
                if (type === 'washout') {
                    var drugType = document.getElementById('drugType').value;
                    if (drugType) {
                        var washoutDays = parseInt(drugType);
                        minDays = washoutDays + 1;
                    }
                }
                
                // If V1-V2 interval doesn't meet requirements, this V2 won't work
                if (v1_v2_days < minDays || v1_v2_days > maxDays) {
                    return false;
                }
            }
            
            // Check Visit 3
            var v3_center = addDays(v2Date, 7);
            if (!hasValidOptionsInWindow(v3_center)) {
                return false;
            }
            
            // Check Visit 4
            var v4_center = addDays(v2Date, 14);
            if (!hasValidOptionsInWindow(v4_center)) {
                return false;
            }
            
            // Check Visit 5
            var v5_center = addDays(v2Date, 28);
            if (!hasValidOptionsInWindow(v5_center)) {
                return false;
            }
            
            return true; // All visits have valid options
        }
        
        // Adjust both V1 and V2
        function adjustBothV1V2(newV1, newV2) {
            document.getElementById('visit1').value = newV1;
            document.getElementById('visit2').value = newV2;
            
            // Clear selections
            visit1aDate = '';
            selectedV3 = null;
            selectedV4 = null;
            selectedV5 = null;
            
            // Mark that both dates were auto-adjusted
            window.autoAdjustedV1 = true;
            window.autoAdjustedV2 = true;
            
            // Recalculate everything
            checkDateWarning('visit1');
            checkDateWarning('visit2');
            checkV2EarlyWarning();
            calculateV2Suggestion();
            validateDates();
            document.getElementById('v1aSuggestion').innerHTML = '';
            document.getElementById('validation').innerHTML = '';
            document.getElementById('v2EarlyWarning').innerHTML = '';
            calculateVisits();
            
            // Recheck for conflicts
            setTimeout(function() {
                checkAllVisitsHolidays();
            }, 100);
            
            // Auto-clear the markers after 5 seconds
            setTimeout(function() {
                window.autoAdjustedV1 = false;
                window.autoAdjustedV2 = false;
                calculateVisits();
            }, 5000);
        }
        
        function useV2Date(date) {
            document.getElementById('visit2').value = date;
            checkDateWarning('visit2');
            checkV2EarlyWarning();
            validateDates();
            
            // Re-validate V1a if it exists
            if (visit1aDate) {
                validateV1a();
            }
            
            // Recheck for conflicts after a delay
            setTimeout(function() {
                checkAllVisitsHolidays();
            }, 100);
        }
        
        function parseDate(dateStr) {
            // Parse YYYY-MM-DD without timezone issues
            var parts = dateStr.split('-');
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }
        
        function addDays(date, days) {
            var result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }
        
        function formatDate(date) {
            var y = date.getFullYear();
            var m = String(date.getMonth() + 1).padStart(2, '0');
            var d = String(date.getDate()).padStart(2, '0');
            return y + '-' + m + '-' + d;
        }
        
        function formatDateWithWeekday(date) {
            var weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            var day = date.getDay();
            var y = date.getFullYear();
            var m = String(date.getMonth() + 1).padStart(2, '0');
            var d = String(date.getDate()).padStart(2, '0');
            return y + '-' + m + '-' + d + ' (' + weekdays[day] + ')';
        }
        
        function getDaysDiff(date1, date2) {
            var diff = Math.floor((date2 - date1) / (1000 * 60 * 60 * 24));
            return diff;
        }
        
        function checkHoliday(date) {
            if (!date || isNaN(date.getTime())) {
                return null;
            }
            
            var day = date.getDay();
            var weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            
            var year = String(date.getFullYear());
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var dateStr = String(date.getDate()).padStart(2, '0');
            var key = month + '-' + dateStr;
            
            // Check if it's a working weekend (è£œç­æ—¥)
            if ((day === 0 || day === 6) && workingWeekends[year] && workingWeekends[year].includes(key)) {
                return null; // It's a working weekend, not a holiday
            }
            
            // Check if it's a weekend
            if (day === 0 || day === 6) {
                return { type: 'weekend', msg: 'âš ï¸ ' + weekdays[day] + ' (é€±æœ«)' };
            }
            
            // Check if it's a holiday
            if (holidays[year] && holidays[year][key]) {
                return { type: 'holiday', msg: 'âš ï¸ ' + holidays[year][key] + ' (åœ‹å®šå‡æ—¥)' };
            }
            
            return null;
        }
        
        function getNextWorkday(date) {
            // Find next workday (not weekend, not holiday)
            var nextDate = new Date(date);
            var maxAttempts = 14; // Avoid infinite loop
            var attempts = 0;
            
            while (attempts < maxAttempts) {
                nextDate = addDays(nextDate, 1);
                var holidayInfo = checkHoliday(nextDate);
                
                if (!holidayInfo) {
                    // Found a workday
                    return nextDate;
                }
                attempts++;
            }
            
            // If couldn't find workday in 14 days, return original date + 1
            return addDays(date, 1);
        }
        
        function getHolidayWarningHtml(holidayInfo) {
            if (!holidayInfo) return '';
            return '<div class="warning ' + holidayInfo.type + '">' + holidayInfo.msg + '</div>';
        }
        
        function validateDates() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var validationDiv = document.getElementById('validation');
            var v1aSuggDiv = document.getElementById('v1aSuggestion');
            
            // Clear all validation messages and suggestions at start
            validationDiv.innerHTML = '';
            clearV1aValidation();
            
            if (!type || !v1Input || !v2Input) {
                v1aSuggDiv.innerHTML = '';
                calculateVisits();
                return;
            }
            
            // For Washout, drug type must be selected
            if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                if (!drugType) {
                    validationDiv.innerHTML = '<div class="validation-msg error">è«‹å…ˆé¸æ“‡éœ€æ´—é™¤çš„è—¥ç‰©é¡å‹</div>';
                    v1aSuggDiv.innerHTML = '';
                    calculateVisits();
                    return;
                }
            }
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            var daysDiff = getDaysDiff(v1, v2);
            
            var isValid = false;
            var message = '';
            var msgClass = '';
            
            if (type === 'naive') {
                if (daysDiff < 1) {
                    message = 'âŒ V1 åˆ° V2 é–“éš”éçŸ­ï¼ˆ' + daysDiff + ' å¤©ï¼‰ã€‚Naive å—è©¦è€…éœ€è¦ 1-35 å¤©ã€‚';
                    msgClass = 'error';
                } else if (daysDiff > 35) {
                    message = 'âŒ V1 åˆ° V2 é–“éš”éé•·ï¼ˆ' + daysDiff + ' å¤©ï¼‰ã€‚Naive å—è©¦è€…éœ€è¦ 1-35 å¤©ã€‚';
                    msgClass = 'error';
                } else {
                    message = 'âœ“ æ—¥æœŸé–“éš”ç¬¦åˆè¦å®šï¼ˆ' + daysDiff + ' å¤©ï¼Œç¯„åœ 1-35 å¤©ï¼‰';
                    msgClass = 'success';
                    isValid = true;
                }
            } else if (type === 'washout') {
                var drugType = document.getElementById('drugType').value;
                var washoutDays = parseInt(drugType);
                var minDays = washoutDays + 1;  // washout + 1 day to V2
                var maxDays = Math.min(washoutDays + 7, 35);  // washout + 7 days to V2, but max 35 days total
                
                if (daysDiff < minDays) {
                    message = 'âŒ V1 åˆ° V2 é–“éš”éçŸ­ï¼ˆ' + daysDiff + ' å¤©ï¼‰ã€‚éœ€è¦ ' + minDays + '-' + maxDays + ' å¤©ï¼ˆ' + washoutDays + 'å¤©æ´—é™¤æœŸ + 1-7å¤©åˆ°V2ï¼‰ã€‚';
                    msgClass = 'error';
                } else if (daysDiff > 35) {
                    message = 'âŒ V1 åˆ° V2 é–“éš”éé•·ï¼ˆ' + daysDiff + ' å¤©ï¼‰ã€‚Washout å—è©¦è€… V1 åˆ° V2 æœ€å¤š 35 å¤©ã€‚';
                    msgClass = 'error';
                } else if (daysDiff > maxDays) {
                    message = 'âŒ V1 åˆ° V2 é–“éš”éé•·ï¼ˆ' + daysDiff + ' å¤©ï¼‰ã€‚éœ€è¦ ' + minDays + '-' + maxDays + ' å¤©ã€‚';
                    msgClass = 'error';
                } else {
                    message = 'âœ“ æ—¥æœŸé–“éš”ç¬¦åˆè¦å®šï¼ˆ' + daysDiff + ' å¤©ï¼Œç¯„åœ ' + minDays + '-' + maxDays + ' å¤©ï¼‰';
                    msgClass = 'success';
                    isValid = true;
                }
            }
            
            validationDiv.innerHTML = '<div class="validation-msg ' + msgClass + '">' + message + '</div>';
            
            // Show V1a suggestion
            if (isValid) {
                var html = '<div class="v1a-input">';
                
                if (type === 'naive') {
                    // Naive: V1a can be anywhere between V1 and V2
                    html += '<div class="v1a-label">Visit 1a æ—¥æœŸï¼ˆå¯åœ¨ V1 å’Œ V2 ä¹‹é–“ä»»é¸ï¼‰</div>';
                    
                    // Find best V1a: V1 if it's a workday, otherwise next workday
                    var bestV1a = v1;
                    var isV1Holiday = checkHoliday(v1);
                    var autoAdjusted = false;
                    
                    if (isV1Holiday) {
                        var v1_workday = getNextWorkday(v1);
                        // Make sure workday is before V2
                        if (v1_workday && v1_workday < v2) {
                            bestV1a = v1_workday;
                            autoAdjusted = true;
                        }
                    }
                    
                    html += '<div class="suggestion-box">';
                    html += '<div class="suggestion-label">å½ˆæ€§ç¯„åœ</div>';
                    html += '<div class="suggestion-value">' + formatDateWithWeekday(v1) + ' ~ ' + formatDateWithWeekday(v2) + '<br>';
                    html += 'Naive å—è©¦è€…çš„ V1a æ²’æœ‰å›ºå®šé™åˆ¶ï¼Œå»ºè­°é¸æ“‡ V1 ç•¶å¤©æˆ–é„°è¿‘å·¥ä½œæ—¥</div>';
                    html += '</div>';
                    
                    // Show explanation if V1 is a holiday
                    if (autoAdjusted) {
                        html += '<div style="margin-top: 8px; padding: 8px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 6px; font-size: 12px; color: #1e40af;">';
                        html += 'ğŸ’¡ V1 (' + formatDateWithWeekday(v1) + ') ç‚ºå‡æ—¥ï¼Œå·²è‡ªå‹•é¸æ“‡ä¸‹ä¸€å€‹å·¥ä½œæ—¥';
                        html += '</div>';
                    }
                    
                    html += '<input type="date" id="v1aInput" value="' + formatDate(bestV1a) + '" onchange="visit1aDate=this.value; checkDateWarning(\'v1a\'); validateV1a(); calculateVisits();" style="width: 100%; padding: 10px; margin-top: 10px; border: 2px solid #fbbf24; border-radius: 8px;">';
                    html += '<div id="v1aWarning" style="margin-top: 5px;"></div>';
                    
                    // Update visit1aDate
                    visit1aDate = formatDate(bestV1a);
                } else if (type === 'washout') {
                    // Washout: V1a must be 1-7 days before V2
                    html += '<div class="v1a-label">Visit 1a æ—¥æœŸï¼ˆå¿…é ˆåœ¨ V2 å‰ 1-7 å¤©ï¼‰</div>';
                    
                    var drugType = document.getElementById('drugType').value;
                    var washoutDays = parseInt(drugType);
                    
                    // Calculate the recommended V2 (same logic as in calculateV2Suggestion)
                    var recommendedV2 = null;
                    var v2_min = addDays(v1, washoutDays + 1);
                    var v2_max = addDays(v1, 35);
                    
                    // Find workdays in V2 range
                    var v2_workdays = [];
                    var currentDate = v2_min;
                    while (currentDate <= v2_max) {
                        // Must meet minimum washout interval
                        var v1_test_days = getDaysDiff(v1, currentDate);
                        if (v1_test_days >= (washoutDays + 1) && !checkHoliday(currentDate)) {
                            v2_workdays.push(new Date(currentDate));
                        }
                        currentDate = addDays(currentDate, 1);
                    }
                    
                    // Find best V2 (same scoring logic)
                    if (v2_workdays.length > 0) {
                        // First filter to only V2s where V1a range has workdays
                        var validV2s = [];
                        for (var i = 0; i < v2_workdays.length; i++) {
                            var testV2 = v2_workdays[i];
                            
                            // Check if V1a range (V2-7 to V2-1) has any workdays
                            var v1a_early = addDays(testV2, -7);
                            var v1a_late = addDays(testV2, -1);
                            var hasV1aWorkday = false;
                            
                            var checkDate = v1a_early;
                            while (checkDate <= v1a_late) {
                                var washout_check = getDaysDiff(v1, checkDate);
                                if (washout_check >= washoutDays && !checkHoliday(checkDate)) {
                                    hasV1aWorkday = true;
                                    break;
                                }
                                checkDate = addDays(checkDate, 1);
                            }
                            
                            if (hasV1aWorkday) {
                                validV2s.push(testV2);
                            }
                        }
                        
                        // Now score the valid V2s
                        if (validV2s.length > 0) {
                            var maxScore = -1;
                            for (var i = 0; i < validV2s.length; i++) {
                                var testV2 = validV2s[i];
                                var score = 0;
                                score += countWorkdaysInWindow(addDays(testV2, 7));
                                score += countWorkdaysInWindow(addDays(testV2, 14));
                                score += countWorkdaysInWindow(addDays(testV2, 28));
                                
                                if (score > maxScore) {
                                    maxScore = score;
                                    recommendedV2 = testV2;
                                }
                            }
                        }
                    }
                    
                    // Use recommended V2 if user hasn't entered V2 yet, otherwise use user's V2
                    var effectiveV2 = v2 ? v2 : recommendedV2;
                    
                    if (!effectiveV2) {
                        html += '<div style="margin-top: 12px; padding: 12px; background: #fef2f2; border: 2px solid #dc2626; border-radius: 8px;">';
                        html += '<div style="font-size: 14px; font-weight: 600; color: #dc2626; margin-bottom: 6px;">ç„¡æ³•è¨ˆç®— V1a</div>';
                        html += '<div style="font-size: 12px; color: #991b1b;">è«‹å…ˆèª¿æ•´ V1 æˆ–ç­‰å¾… V2 å»ºè­°</div>';
                        html += '</div>';
                        html += '</div>';
                        v1aSuggDiv.innerHTML = html;
                        return;
                    }
                    
                    var v1a_calculated = addDays(v1, washoutDays);
                    var v1a_early = addDays(effectiveV2, -7);
                    var v1a_late = addDays(effectiveV2, -1);
                    
                    var drugTypeName = '';
                    if (washoutDays === 28) drugTypeName = 'Prostaglandins / Î²-blockers / Kinase inhibitors';
                    else if (washoutDays === 14) drugTypeName = 'Adrenergic agonists';
                    else if (washoutDays === 7) drugTypeName = 'Muscarinic agonists / Carbonic anhydrase inhibitors';
                    
                    html += '<div class="suggestion-box">';
                    html += '<div class="suggestion-label">Washout è¦å‰‡</div>';
                    html += '<div class="suggestion-value">';
                    html += 'â€¢ è—¥ç‰©é¡å‹ï¼š' + drugTypeName + '<br>';
                    html += 'â€¢ <strong>æœ€å°æ´—é™¤æœŸï¼š' + washoutDays + ' å¤©</strong>ï¼ˆå¯æ›´é•·ï¼‰<br>';
                    html += 'â€¢ <strong>V1a æœ€æ—©ï¼š</strong>V1 + ' + washoutDays + ' å¤© = <strong>' + formatDateWithWeekday(v1a_calculated) + '</strong><br>';
                    
                    if (recommendedV2 && !v2) {
                        html += 'â€¢ <strong>åŸºæ–¼æ¨è–¦çš„ V2ï¼š</strong>' + formatDateWithWeekday(recommendedV2) + '<br>';
                    }
                    
                    html += 'â€¢ <strong>V1a å¿…é ˆï¼š</strong>V2 å‰ 1-7 å¤© = <strong>' + formatDateWithWeekday(v1a_early) + ' ~ ' + formatDateWithWeekday(v1a_late) + '</strong><br>';
                    html += 'â€¢ <strong>å¯é¸ç¯„åœï¼š</strong>' + formatDateWithWeekday(v1a_calculated) + ' ~ ' + formatDateWithWeekday(v1a_late) + '<br><br>';
                    
                    // Check if calculated V1a is within valid range
                    if (v1a_calculated >= v1a_early && v1a_calculated <= v1a_late) {
                        html += 'âœ“ <strong style="color: #059669;">å»ºè­° ' + formatDateWithWeekday(v1a_calculated) + 'ï¼ˆæ´—é™¤æœŸå‰›å¥½ ' + washoutDays + ' å¤©ï¼‰</strong>';
                    } else {
                        html += 'âŒ <strong style="color: #dc2626;">æœ€æ—©å¯ç”¨çš„ V1a (' + formatDateWithWeekday(v1a_calculated) + ') ä¸åœ¨ V2 å‰ 1-7 å¤©ç¯„åœå…§</strong><br>';
                        html += '<span style="font-size: 12px; color: #92400e;">å»ºè­°ï¼šV1a æ‡‰é¸æ“‡ ' + formatDateWithWeekday(v1a_early) + ' ~ ' + formatDateWithWeekday(v1a_late) + ' ä¹‹é–“çš„å·¥ä½œæ—¥</span>';
                    }
                    html += '</div>';
                    html += '</div>';
                    
                    // Find all workdays in the valid V1a range BEFORE creating input
                    var v1a_workdays = [];
                    var defaultV1a = v1a_calculated;
                    var isCalculatedHoliday = false;
                    
                    if (v1a_calculated >= v1a_early && v1a_calculated <= v1a_late) {
                        var currentDate = v1a_calculated;
                        while (currentDate <= v1a_late) {
                            var washout_check = getDaysDiff(v1, currentDate);
                            // Must meet minimum washout requirement
                            if (washout_check >= washoutDays && !checkHoliday(currentDate)) {
                                v1a_workdays.push(new Date(currentDate));
                            }
                            currentDate = addDays(currentDate, 1);
                        }
                        
                        // If calculated date is a holiday but we have workdays, use first workday as default
                        if (checkHoliday(v1a_calculated) && v1a_workdays.length > 0) {
                            defaultV1a = v1a_workdays[0];
                            isCalculatedHoliday = true;
                        }
                    }
                    
                    // Show explanation if we auto-adjusted
                    if (isCalculatedHoliday) {
                        html += '<div style="margin-top: 8px; padding: 8px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 6px; font-size: 12px; color: #1e40af;">';
                        html += 'ğŸ’¡ V1 + ' + washoutDays + ' å¤© (' + formatDate(v1a_calculated) + ') ç‚ºå‡æ—¥ï¼Œå·²è‡ªå‹•é¸æ“‡æœ€æ—©å¯ç”¨å·¥ä½œæ—¥';
                        html += '</div>';
                    }
                    
                    html += '<input type="date" id="v1aInput" value="' + formatDate(defaultV1a) + '" onchange="visit1aDate=this.value; checkDateWarning(\'v1a\'); validateV1a(); calculateVisits();" style="width: 100%; padding: 10px; margin-top: 10px; border: 2px solid #fbbf24; border-radius: 8px;">';
                    html += '<div id="v1aWarning" style="margin-top: 5px;"></div>';
                    
                    // Update visit1aDate to the default value
                    visit1aDate = formatDate(defaultV1a);
                    
                    // Only show button if V1a is valid (within V2 -7 to -1 range)
                    if (v1a_calculated >= v1a_early && v1a_calculated <= v1a_late) {
                        // Only show button if user might need to reset (i.e., if they change the input)
                        // For now, we hide the button since input already has correct default
                        if (v1a_workdays.length === 0) {
                            // No workdays available in valid range
                            html += '<div style="margin-top: 12px; padding: 12px; background: #fee2e2; border: 2px solid #dc2626; border-radius: 8px; text-align: center;">';
                            html += '<div style="font-size: 14px; font-weight: 600; color: #dc2626; margin-bottom: 6px;">âš ï¸ ç„¡å¯ç”¨å·¥ä½œæ—¥</div>';
                            html += '<div style="font-size: 12px; color: #991b1b;">V1a æœ‰æ•ˆç¯„åœå…§æ²’æœ‰å·¥ä½œæ—¥å¯é¸</div>';
                            html += '<div style="font-size: 12px; color: #991b1b; margin-top: 6px;">è«‹èª¿æ•´ V1 æˆ– V2 æ—¥æœŸ</div>';
                            html += '</div>';
                        }
                    }
                }
                
                html += '</div>';
                
                v1aSuggDiv.innerHTML = html;
                
                // Auto validate V1a if it's set
                if (visit1aDate) {
                    validateV1a();
                    // Check for holidays immediately
                    setTimeout(function() {
                        checkDateWarning('v1a');
                    }, 100);
                }
            } else {
                v1aSuggDiv.innerHTML = '';
            }
            
            calculateVisits();
        }
        
        function useDate(date) {
            visit1aDate = date;
            document.getElementById('v1aInput').value = date;
            checkDateWarning('v1a');
            validateV1a();
            calculateVisits();
        }
        
        function useV1ForV1a() {
            var v1 = document.getElementById('visit1').value;
            if (v1) {
                visit1aDate = v1;
                document.getElementById('v1aInput').value = v1;
                checkDateWarning('v1a');
                validateV1a();
                calculateVisits();
            }
        }
        
        function validateV1a() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            
            if (!type || !v1Input || !v2Input || !visit1aDate) {
                // Clear V1a validation if no V1a date
                clearV1aValidation();
                return;
            }
            
            var v1 = parseDate(v1Input);
            var v1a = parseDate(visit1aDate);
            var v2 = parseDate(v2Input);
            
            var v1_v1a_diff = getDaysDiff(v1, v1a);
            var v1a_v2_diff = getDaysDiff(v1a, v2);
            
            var validationDiv = document.getElementById('validation');
            var v1aValidationDiv = document.getElementById('v1aValidation');
            
            // Create V1a validation div if it doesn't exist
            if (!v1aValidationDiv) {
                v1aValidationDiv = document.createElement('div');
                v1aValidationDiv.id = 'v1aValidation';
                validationDiv.appendChild(v1aValidationDiv);
            }
            
            var msgHtml = '';
            
            if (type === 'naive') {
                // For Naive: V1a just needs to be between V1 and V2
                if (v1_v1a_diff < 0) {
                    msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">âŒ V1a ä¸èƒ½æ—©æ–¼ V1</div>';
                } else if (v1a_v2_diff < 0) {
                    msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">âŒ V1a ä¸èƒ½æ™šæ–¼ V2</div>';
                } else {
                    if (v1_v1a_diff === 0) {
                        msgHtml = '<div class="validation-msg success" style="margin-top: 10px;">âœ“ V1a èˆ‡ V1 åŒä¸€å¤©ï¼ˆNaive å…è¨±ï¼‰</div>';
                    } else {
                        msgHtml = '<div class="validation-msg success" style="margin-top: 10px;">âœ“ V1a æ—¥æœŸç¬¦åˆè¦å®šï¼ˆV1 å¾Œ ' + v1_v1a_diff + ' å¤©ï¼ŒV2 å‰ ' + v1a_v2_diff + ' å¤©ï¼‰</div>';
                    }
                }
            } else if (type === 'washout') {
                // For Washout: V1a must be 1-7 days before V2
                if (v1a_v2_diff < 1 || v1a_v2_diff > 7) {
                    msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">âŒ V1a åˆ° V2 é–“éš”ä¸ç¬¦ï¼ˆ' + v1a_v2_diff + ' å¤©ï¼‰ã€‚Washout å¿…é ˆæ˜¯ 1-7 å¤©ã€‚</div>';
                } else {
                    // Check if V1a meets minimum washout period
                    var drugType = document.getElementById('drugType').value;
                    var washoutDays = parseInt(drugType);
                    
                    if (v1_v1a_diff < washoutDays) {
                        msgHtml = '<div class="validation-msg error" style="margin-top: 10px;">âŒ V1 åˆ° V1a é–“éš”ä¸è¶³ï¼ˆ' + v1_v1a_diff + ' å¤©ï¼‰ã€‚æœ€å°æ´—é™¤æœŸæ˜¯ ' + washoutDays + ' å¤©ã€‚</div>';
                    } else {
                        if (v1_v1a_diff === washoutDays) {
                            msgHtml = '<div class="validation-msg success" style="margin-top: 10px;">âœ“ V1a ç¬¦åˆè¦å®šï¼ˆæ´—é™¤æœŸ ' + washoutDays + ' å¤©ï¼ŒV1aåˆ°V2 ' + v1a_v2_diff + ' å¤©ï¼‰</div>';
                        } else {
                            msgHtml = '<div class="validation-msg success" style="margin-top: 10px;">âœ“ V1a ç¬¦åˆè¦å®šï¼ˆæ´—é™¤æœŸ ' + v1_v1a_diff + ' å¤© â‰¥ æœ€å° ' + washoutDays + ' å¤©ï¼ŒV1aåˆ°V2 ' + v1a_v2_diff + ' å¤©ï¼‰</div>';
                        }
                    }
                }
            }
            
            v1aValidationDiv.innerHTML = msgHtml;
        }
        
        function clearV1aValidation() {
            var v1aValidationDiv = document.getElementById('v1aValidation');
            if (v1aValidationDiv) {
                v1aValidationDiv.innerHTML = '';
            }
        }
        
        function calculateVisits() {
            var type = document.getElementById('subjectType').value;
            var v1Input = document.getElementById('visit1').value;
            var v2Input = document.getElementById('visit2').value;
            var output = document.getElementById('output');
            
            if (!type || !v1Input || !v2Input) {
                output.innerHTML = '<div class="empty">è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ä»¥è¨ˆç®—è¨ªè¦–æ—¥æœŸ</div>';
                return;
            }
            
            var v1 = parseDate(v1Input);
            var v2 = parseDate(v2Input);
            var html = '';
            
            // Visit 1
            var w1 = checkHoliday(v1);
            var v1AutoAdjusted = window.autoAdjustedV1 === true;
            var v1CardStyle = v1AutoAdjusted ? 'style="border: 3px solid #10b981; background: #f0fdf4;"' : '';
            html += '<div class="visit-card" ' + v1CardStyle + '>';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 1' + (v1AutoAdjusted ? ' <span style="color: #10b981; font-weight: 700;">âœ“ å·²æ›´æ–°</span>' : '') + '</div>';
            html += '<div class="badge badge-screening">ç¯©é¸æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day -35 to -1<br>èªªæ˜: ç¯©é¸è¨ªè¦–</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(v1) + '</div>';
            html += getHolidayWarningHtml(w1);
            if (v1AutoAdjusted) {
                html += '<div style="margin-top: 8px; padding: 8px; background: #d1fae5; border-radius: 6px; font-size: 12px; color: #065f46; font-weight: 600;">ğŸ¯ ç³»çµ±å·²è‡ªå‹•èª¿æ•´åˆ°å·¥ä½œæ—¥</div>';
            }
            html += '</div>';
            
            // Visit 1a
            if (visit1aDate) {
                var v1a = parseDate(visit1aDate);
                var w1a = checkHoliday(v1a);
                html += '<div class="visit-card">';
                html += '<div class="visit-header">';
                html += '<div class="visit-name">Visit 1a</div>';
                html += '<div class="badge badge-screening">ç¯©é¸æœŸ</div>';
                html += '</div>';
                html += '<div class="visit-info">';
                if (type === 'naive') {
                    html += 'Study Day: Day -35 to -1 (å½ˆæ€§)<br>èªªæ˜: è³‡æ ¼ç¢ºèªï¼ˆé€šå¸¸èˆ‡ V1 åŒå¤©ï¼‰';
                } else {
                    html += 'Study Day: Day -7 to -1<br>èªªæ˜: æ´—é™¤å¾Œè³‡æ ¼ç¢ºèªï¼ˆå¿…é ˆ V2 å‰ 1-7 å¤©ï¼‰';
                }
                html += '</div>';
                html += '<div class="visit-date">' + formatDateWithWeekday(v1a) + '</div>';
                html += getHolidayWarningHtml(w1a);
                html += '</div>';
            }
            
            // Visit 2
            var w2 = checkHoliday(v2);
            var v2AutoAdjusted = window.autoAdjustedV2 === true;
            var v2CardStyle = v2AutoAdjusted ? 'style="border: 3px solid #10b981; background: #f0fdf4;"' : '';
            html += '<div class="visit-card" ' + v2CardStyle + '>';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 2' + (v2AutoAdjusted ? ' <span style="color: #10b981; font-weight: 700;">âœ“ å·²æ›´æ–°</span>' : '') + '</div>';
            html += '<div class="badge badge-baseline">åŸºç·šæœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 1<br>èªªæ˜: éš¨æ©Ÿåˆ†é… & åŸºç·šè©•ä¼°</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(v2) + '</div>';
            html += getHolidayWarningHtml(w2);
            if (v2AutoAdjusted) {
                html += '<div style="margin-top: 8px; padding: 8px; background: #d1fae5; border-radius: 6px; font-size: 12px; color: #065f46; font-weight: 600;">ğŸ¯ ç³»çµ±å·²è‡ªå‹•èª¿æ•´åˆ°å·¥ä½œæ—¥</div>';
            }
            html += '</div>';
            
            // Day 2
            var day2 = addDays(v2, 1);
            var wd2 = checkHoliday(day2);
            html += '<div class="visit-card">';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Day 2</div>';
            html += '<div class="badge badge-treatment">æ²»ç™‚æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 2<br>èªªæ˜: é–‹å§‹æ²»ç™‚</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(day2) + '</div>';
            
            // Day 2 holiday warning with explanation
            if (wd2) {
                html += '<div class="warning ' + wd2.type + '">' + wd2.msg + '</div>';
                html += '<div style="margin-top: 4px; padding: 6px 10px; background: #dbeafe; border-left: 3px solid #3b82f6; font-size: 11px; color: #1e40af; border-radius: 4px;">';
                html += 'ğŸ’Š æ­¤æ—¥æœŸç‚ºçµ¦è—¥æœŸï¼Œå—è©¦è€…åœ¨å®¶ä½¿ç”¨è—¥ç‰©ï¼Œå‡æ—¥å¯æ¥å—';
                html += '</div>';
            }
            
            html += '</div>';
            
            // Calculate all visit dates first
            var v3_center = addDays(v2, 7);
            var v4_center = addDays(v2, 14);
            var v5_center = addDays(v2, 28);
            
            // Validate and clean up selectedV3/V4/V5 if they're outside the Â±2 window
            if (selectedV3) {
                var v3Diff = getDaysDiff(v3_center, parseDate(selectedV3));
                if (Math.abs(v3Diff) > 2) {
                    console.log('âš ï¸ Visit 3 é¸æ“‡çš„æ—¥æœŸè¶…å‡ºçª—å£ï¼Œæ¸…é™¤:', selectedV3);
                    selectedV3 = null;
                }
            }
            if (selectedV4) {
                var v4Diff = getDaysDiff(v4_center, parseDate(selectedV4));
                if (Math.abs(v4Diff) > 2) {
                    console.log('âš ï¸ Visit 4 é¸æ“‡çš„æ—¥æœŸè¶…å‡ºçª—å£ï¼Œæ¸…é™¤:', selectedV4);
                    selectedV4 = null;
                }
            }
            if (selectedV5) {
                var v5Diff = getDaysDiff(v5_center, parseDate(selectedV5));
                if (Math.abs(v5Diff) > 2) {
                    console.log('âš ï¸ Visit 5 é¸æ“‡çš„æ—¥æœŸè¶…å‡ºçª—å£ï¼Œæ¸…é™¤:', selectedV5);
                    selectedV5 = null;
                }
            }
            
            // Get actual dates (use selected if available, otherwise use center)
            var v3_date = selectedV3 ? parseDate(selectedV3) : v3_center;
            var v4_date = selectedV4 ? parseDate(selectedV4) : v4_center;
            var v5_date = selectedV5 ? parseDate(selectedV5) : v5_center;
            
            // Collect all visit dates for conflict detection
            var allVisits = [
                { name: 'Visit 1', date: v1Input },
                { name: 'Visit 1a', date: visit1aDate },
                { name: 'Visit 2', date: v2Input },
                { name: 'Day 2', date: formatDate(day2) },
                { name: 'Visit 3', date: formatDate(v3_date) },
                { name: 'Visit 4', date: formatDate(v4_date) },
                { name: 'Visit 5', date: formatDate(v5_date) }
            ];
            
            // Visit 3
            // Ensure v3_date is within Â±2 days of center (V2+5 to V2+9)
            var v3_range_start = addDays(v2, 5);
            var v3_range_end = addDays(v2, 9);
            if (v3_date < v3_range_start || v3_date > v3_range_end) {
                console.log('âš ï¸ Visit 3 æ—¥æœŸè¶…å‡ºç¯„åœï¼Œä½¿ç”¨ä¸­å¿ƒæ—¥:', formatDate(v3_date), 'â†’', formatDate(v3_center));
                v3_date = v3_center;
                selectedV3 = formatDate(v3_center);
            }
            
            var w3 = checkHoliday(v3_date);
            var v3Updated = window.autoAdjustedV2 === true;
            var v3CardStyle = v3Updated ? 'style="border: 3px solid #3b82f6; background: #eff6ff;"' : '';
            html += '<div class="visit-card" ' + v3CardStyle + '>';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 3' + (v3Updated ? ' <span style="color: #3b82f6; font-weight: 700;">âœ“ å·²é‡æ–°è¨ˆç®—</span>' : '') + '</div>';
            html += '<div class="badge badge-treatment">æ²»ç™‚æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 8 (Â±2)<br>ç¯„åœ: ' + formatDateWithWeekday(addDays(v2, 5)) + ' ~ ' + formatDateWithWeekday(addDays(v2, 9)) + '</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(v3_date) + '</div>';
            html += getHolidayWarningHtml(w3);
            if (v3Updated) {
                html += '<div style="margin-top: 8px; padding: 8px; background: #dbeafe; border-radius: 6px; font-size: 12px; color: #1e40af; font-weight: 600;">ğŸ”„ å›  V2 èª¿æ•´è€Œé‡æ–°è¨ˆç®—</div>';
            }
            html += generateDateSelector(3, v3_center, v2, allVisits);
            html += '</div>';
            
            // Visit 4
            // Ensure v4_date is within Â±2 days of center (V2+12 to V2+16)
            var v4_range_start = addDays(v2, 12);
            var v4_range_end = addDays(v2, 16);
            if (v4_date < v4_range_start || v4_date > v4_range_end) {
                console.log('âš ï¸ Visit 4 æ—¥æœŸè¶…å‡ºç¯„åœï¼Œä½¿ç”¨ä¸­å¿ƒæ—¥:', formatDate(v4_date), 'â†’', formatDate(v4_center));
                v4_date = v4_center;
                selectedV4 = formatDate(v4_center);
            }
            
            var w4 = checkHoliday(v4_date);
            var v4Updated = window.autoAdjustedV2 === true;
            var v4CardStyle = v4Updated ? 'style="border: 3px solid #3b82f6; background: #eff6ff;"' : '';
            html += '<div class="visit-card" ' + v4CardStyle + '>';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 4' + (v4Updated ? ' <span style="color: #3b82f6; font-weight: 700;">âœ“ å·²é‡æ–°è¨ˆç®—</span>' : '') + '</div>';
            html += '<div class="badge badge-treatment">æ²»ç™‚æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 15 (Â±2)<br>ç¯„åœ: ' + formatDateWithWeekday(addDays(v2, 12)) + ' ~ ' + formatDateWithWeekday(addDays(v2, 16)) + '</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(v4_date) + '</div>';
            html += getHolidayWarningHtml(w4);
            if (v4Updated) {
                html += '<div style="margin-top: 8px; padding: 8px; background: #dbeafe; border-radius: 6px; font-size: 12px; color: #1e40af; font-weight: 600;">ğŸ”„ å›  V2 èª¿æ•´è€Œé‡æ–°è¨ˆç®—</div>';
            }
            html += generateDateSelector(4, v4_center, v2, allVisits);
            html += '</div>';
            
            // Visit 5
            // Ensure v5_date is within Â±2 days of center (V2+26 to V2+30)
            var v5_range_start = addDays(v2, 26);
            var v5_range_end = addDays(v2, 30);
            if (v5_date < v5_range_start || v5_date > v5_range_end) {
                console.log('âš ï¸ Visit 5 æ—¥æœŸè¶…å‡ºç¯„åœï¼Œä½¿ç”¨ä¸­å¿ƒæ—¥:', formatDate(v5_date), 'â†’', formatDate(v5_center));
                v5_date = v5_center;
                selectedV5 = formatDate(v5_center);
            }
            
            var w5 = checkHoliday(v5_date);
            var v5Updated = window.autoAdjustedV2 === true;
            var v5CardStyle = v5Updated ? 'style="border: 3px solid #3b82f6; background: #eff6ff;"' : '';
            html += '<div class="visit-card" ' + v5CardStyle + '>';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 5' + (v5Updated ? ' <span style="color: #3b82f6; font-weight: 700;">âœ“ å·²é‡æ–°è¨ˆç®—</span>' : '') + '</div>';
            html += '<div class="badge badge-treatment">æ²»ç™‚æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 29 (Â±2) EOT<br>ç¯„åœ: ' + formatDateWithWeekday(addDays(v2, 26)) + ' ~ ' + formatDateWithWeekday(addDays(v2, 30)) + '</div>';
            html += '<div class="visit-date">' + formatDateWithWeekday(v5_date) + '</div>';
            html += getHolidayWarningHtml(w5);
            if (v5Updated) {
                html += '<div style="margin-top: 8px; padding: 8px; background: #dbeafe; border-radius: 6px; font-size: 12px; color: #1e40af; font-weight: 600;">ğŸ”„ å›  V2 èª¿æ•´è€Œé‡æ–°è¨ˆç®—</div>';
            }
            html += generateDateSelector(5, v5_center, v2, allVisits);
            html += '</div>';
            
            // Visit 6
            var v6_start = addDays(v2, 29);
            var v6_end = addDays(v2, 50);
            var w6 = checkHoliday(v6_start);
            html += '<div class="visit-card">';
            html += '<div class="visit-header">';
            html += '<div class="visit-name">Visit 6</div>';
            html += '<div class="badge badge-followup">è¿½è¹¤æœŸ</div>';
            html += '</div>';
            html += '<div class="visit-info">Study Day: Day 30-51 (+7) EOS<br>èªªæ˜: End of Study</div>';
            html += '<div class="visit-date">' + formatDate(v6_start) + ' ~ ' + formatDate(v6_end) + '</div>';
            html += getHolidayWarningHtml(w6);
            html += '</div>';
            
            output.innerHTML = html;
            
            // Auto-avoid holidays for Visit 3, 4, 5
            setTimeout(function() {
                autoAvoidHolidays();
            }, 100);
        }
        
        // Initialize
        validateDates();
    </script>

</body>
</html>
